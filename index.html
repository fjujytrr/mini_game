<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Hide & Seek — Premium Emoji (Updated)</title>
  <style>
:root{
  --accent-cyan:#00D8FF;
  --birch:#EDE4C8;
  --purple-frame:#7a4bff;
  --deep-purple:#5a2ecc;
  --glass:rgba(255,255,255,0.06);
}

/* --- базовая страница (сохранено ваше оформление) --- */
html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(120deg,#3b2a7a,#8aa7ff);background-size:200% 200%;animation:gradientBG 15s ease infinite;color:#fff;overflow:hidden}
@keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
body{display:flex;flex-direction:column;align-items:center;min-height:100vh}

/* header, house и остальные блоки — без изменений (сокращено в примере) */
header{width:95%;margin:15px 0;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.28);border-radius:12px;padding:10px;backdrop-filter:blur(5px)}
.level-bar{display:flex;gap:6px;background:rgba(0,0,0,0.2);padding:6px 10px;border-radius:12px;flex:1;justify-content:space-between}
.level{flex:1;text-align:center;padding:6px 0;font-size:14px;font-weight:700;color:#eee;border-radius:8px;background:rgba(255,255,255,0.06);transition:.25s;cursor:pointer}
.level.active{background:var(--accent-cyan);color:#000;box-shadow:0 0 8px var(--accent-cyan)}
.coin-panel{display:flex;align-items:center;gap:10px;background:rgba(0,0,0,0.28);padding:8px 12px;border-radius:16px;box-shadow:0 0 12px rgba(0,216,255,0.18)}
.coin-logo{width:40px;height:40px;border-radius:50%;object-fit:cover;border:3px solid var(--purple-frame);box-shadow:0 6px 18px rgba(122,75,255,0.18);background:#fff}
.coin-panel .val{font-weight:700;font-size:18px;color:var(--accent-cyan)}
.house{position:relative;width:95%;max-width:500px;margin:20px 0;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(4,1fr);gap:12px}
.room{background:rgba(255,255,255,0.06);border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:28px;color:#fff;cursor:pointer;transition:transform .3s,box-shadow .3s;position:relative;border:2px solid rgba(255,255,255,0.14)}
.room:hover{transform:scale(1.05);box-shadow:0 0 18px rgba(0,216,255,0.14)}
.room.selected{border-color:var(--accent-cyan);box-shadow:0 0 12px var(--accent-cyan)}
.room.found{border-color:#FF0054;box-shadow:0 0 12px #FF0054;animation:foundAnim 1s ease}
.room.safe{border-color:#39FF14;box-shadow:0 0 12px #39FF14;animation:safeAnim .8s ease}
.room.highlight{box-shadow:0 0 22px 4px var(--accent-cyan);transition:box-shadow .3s}
@keyframes foundAnim{0%{transform:scale(1)}50%{transform:rotate(10deg) scale(1.15)}100%{transform:scale(1)}}
@keyframes safeAnim{0%{transform:scale(1)}50%{transform:rotate(-10deg) scale(0.95)}100%{transform:scale(1)}}
.controls{width:90%;display:flex;justify-content:space-between;margin-bottom:15px}
button{flex:1;margin:0 5px;padding:14px;font-size:20px;border:none;border-radius:12px;cursor:pointer;color:#000;background:var(--accent-cyan);box-shadow:0 4px 12px rgba(0,216,255,0.25);transition:transform .2s,box-shadow .2s}
button:active{transform:scale(.98);box-shadow:0 2px 6px rgba(0,216,255,0.18)}
button.secondary{background:rgba(0,0,0,0.36);color:#fff;border:1px solid rgba(255,255,255,0.06);box-shadow:0 3px 8px rgba(0,216,255,0.12)}
.bottom-menu{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);width:90%;max-width:480px;display:flex;justify-content:space-around;gap:8px;background:rgba(0,0,0,0.28);padding:6px 0;border-radius:16px;backdrop-filter:blur(5px);box-shadow:0 0 12px rgba(0,216,255,0.18)}
.bottom-menu button{background:transparent;color:#fff;font-size:22px;transition:transform .2s}
.bottom-menu button:hover{transform:scale(1.16);color:var(--accent-cyan)}
.upgrade-panel{display:flex;gap:12px;margin:10px 0;overflow-x:auto;padding:12px 10px;width:95%;justify-content:flex-start;align-items:stretch}
.upgrade{flex:0 0 auto;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));padding:16px;border-radius:16px;text-align:left;min-width:220px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06);transition:transform .18s,box-shadow .18s}
.upgrade:hover{transform:translateY(-6px)}
.upgrade h3{margin:0 0 8px;font-size:16px;color:var(--accent-cyan)}
.upgrade p{margin:0;font-size:14px;color:#eee}
.upgrade .price{margin-top:10px;font-weight:800;color:var(--birch);font-size:16px}
.upgrade .badge{display:inline-block;margin-top:8px;padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.18);font-weight:700;color:#fff;font-size:12px}
.mining-info{margin:10px 0;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:14px;width:95%;text-align:center;box-shadow:0 2px 6px rgba(0,216,255,0.06)}

/* --- WS Modal: full screen, без верхнего фонового изображения --- */
#wsModalOverlay{
  --wm-accentA:#3b2a7a;
  --wm-accentB:#8aa7ff;
  --wm-accentC:#00D8FF;
  --wm-birch:#EDE4C8;

  position:fixed;
  inset:0; /* top:0;right:0;bottom:0;left:0; */
  width:100%;
  height:100%;
  z-index:2147483647; /* максимально высокий */
  display:flex;
  align-items:stretch; /* растягиваем чтобы .glass мог занять всю высоту */
  justify-content:center;
  background:linear-gradient(120deg,var(--wm-accentA),var(--wm-accentB));
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);
  box-sizing:border-box;
}

/* Убираем/скрываем bgImage (топовый фон), оставляем только градиент overlay */
#wsModalOverlay .bgLayer{ display:none !important; }
#wsModalOverlay .bgImage{ display:none !important; }

/* Glass растягивается на весь экран, без скругления */
#wsModalOverlay .glass{
  position:relative;
  width:100%;
  height:100%;
  max-width:none;
  margin:0;
  padding:calc(env(safe-area-inset-top,20px) + 18px) 20px calc(env(safe-area-inset-bottom,20px) + 18px) 20px;
  box-sizing:border-box;
  border-radius:0;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  overflow:auto;
}

/* header внутри модалки и карточки — без существенных изменений */
#wsModalOverlay .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; color:#ecf8ff; }
#wsModalOverlay .title{ font-size:20px; font-weight:800; letter-spacing:0.2px; display:flex; align-items:center; gap:10px; }
#wsModalOverlay .title .coinIcon{ width:36px; height:36px; border-radius:50%; background:linear-gradient(90deg,var(--wm-accentC),#00A8FF); display:inline-flex; align-items:center; justify-content:center; color:#000; font-weight:900; box-shadow:0 8px 28px rgba(0,216,255,0.12); }
#wsModalOverlay .sub{ color:var(--wm-birch); font-weight:700; font-size:14px; }

/* Rewards shell (сохранено) */
.rewardsShell{ height:calc(100% - 120px); display:flex; flex-direction:column; justify-content:flex-end; }
.rewardsContainer{ background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(255,255,255,0.02)); border-radius:14px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.36); border:1px solid rgba(255,255,255,0.04); }

.rewardsGridTop{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; }
.rewardsGridBottom{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
.rewardCard{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:12px; min-height:86px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; transition:transform .16s ease, box-shadow .16s ease; cursor:pointer; border:1px solid rgba(255,255,255,0.04); }
.rewardCard:hover{ transform:translateY(-6px); }
.rewardCard.pop{ animation:pop .26s ease; }
@keyframes pop{ 0%{ transform:scale(1); } 50%{ transform:scale(1.06);} 100%{ transform:scale(1); } }

.rewardCard .coinIconSmall{ width:44px; height:44px; border-radius:50%; background:linear-gradient(90deg,var(--wm-accentC),#00A8FF); display:flex; align-items:center; justify-content:center; font-weight:800; color:#000; margin-bottom:8px; border:2px solid rgba(255,255,255,0.06); box-shadow:0 8px 18px rgba(0,216,255,0.08); }
.rewardCard .dayLabel{ font-weight:800; color:#ecf8ff; margin-bottom:6px; }
.rewardCard .amount{ font-weight:900; font-size:16px; color:var(--wm-accentC); text-shadow: 0 6px 18px rgba(0,216,255,0.08); }
.rewardCard.locked{ opacity:0.36; pointer-events:auto; }
.rewardCard.locked .overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(0,0,0,0.36), rgba(0,0,0,0.6)); border-radius:12px; color:#fff; font-weight:800; text-align:center; padding:6px; font-size:13px; }
.rewardCard.unlocked{ box-shadow:0 10px 30px rgba(0,216,255,0.06); border:1px solid rgba(0,216,255,0.12); }
.rewardCard.claimed{ opacity:0.9; pointer-events:none; }
.rewardCard .claimBadge{ position:absolute; top:8px; right:8px; background:linear-gradient(90deg,#FFD54A,#FFC107); color:#000; padding:6px 8px; border-radius:999px; font-weight:800; box-shadow:0 6px 20px rgba(255,193,7,0.12); font-size:12px; }

.rewardCard.big{ min-height:120px; padding:18px; }

/* Bottom actions */
.wsActions{ display:flex; gap:12px; margin-top:12px; align-items:center; justify-content:space-between; }
.wsActions .left{ color:var(--wm-birch); font-weight:700; }
.btnPrimary{ padding:12px 18px; border-radius:12px; font-weight:900; border:none; cursor:pointer; background:linear-gradient(90deg,var(--wm-accentC),#00A8FF); color:#000; box-shadow:0 12px 36px rgba(0,216,255,0.18); }
.btnGhost{ padding:10px 14px; border-radius:12px; font-weight:800; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#ecf8ff; cursor:pointer; }

/* responsive */
@media (max-width:720px){
  .rewardsGridTop{ grid-template-columns:repeat(2,1fr); }
  .rewardsGridBottom{ grid-template-columns:repeat(2,1fr); }
  .glass{ padding:calc(env(safe-area-inset-top,20px) + 12px) 12px calc(env(safe-area-inset-bottom,20px) + 12px) 12px; }
  .rewardCard.big{ min-height:100px; }
}
  </style>
</head>
<body>
  <header>
    <div class="level-bar">
      <div class="level" data-val="10000">10K</div>
      <div class="level" data-val="100000">100K</div>
      <div class="level" data-val="1000000">1M</div>
      <div class="level" data-val="5000000">5M</div>
    </div>
    <div class="coin-panel">
      <img class="coin-logo" src="logo.png" alt="Coin logo" />
      <div class="val" id="coinsVal">0</div>
    </div>
  </header>

  <div class="house"></div>

  <div class="controls">
    <button id="startBtn">🏠</button>
    <button class="secondary" id="resetBtn">🔍</button>
  </div>

  <div class="upgrade-panel" id="upgradePanel">
    <div class="upgrade" data-key="x2Prize" data-base-price="20000">
      <h3>x2 Prize / x2 Loss</h3>
      <p>Double rewards & penalties</p>
      <div class="price">20,000</div>
      <div class="badge">Boost</div>
    </div>
    <div class="upgrade" data-key="check1" data-base-price="20000">
      <h3>Check 1 Room Only</h3>
      <p>Hunter checks 1 room only (1 min)</p>
      <div class="price">20,000</div>
      <div class="timer" id="check1Timer"></div>
    </div>
  </div>

  <div class="mining-info">
    <strong id="miningLabel">Mining Income:</strong> <span id="miningIncomeVal">0</span>/hr
  </div>

  <!-- Скрытая панель майнеров для совместимости -->
  <div class="miners-panel" id="minersPanelVisible" aria-hidden="true"></div>

  <!-- Модалка (FULLSCREEN) -->
  <div id="wsModalOverlay" aria-hidden="false" role="dialog" aria-label="Daily rewards modal">
    <!-- bgLayer/bgImage скрыты в CSS -->
    <div class="glass" role="document" aria-modal="true">
      <div class="header">
        <div class="title">
          <div class="coinIcon">💎</div>
          <div>
            <div style="font-size:18px">Premium Gifts</div>
            <div class="sub">7 days of rewards — claim one per day</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800;color:var(--wm-accentC);font-size:18px" id="wsModalCoinsDisplay">0</div>
          <div style="font-size:12px;color:var(--wm-birch)">Coins balance</div>
        </div>
      </div>

      <div class="rewardsShell" id="rewardsShell">
        <div class="rewardsContainer" id="rewardsContainer">
          <div class="rewardsGridTop" id="rewardsGridTop" aria-hidden="false"></div>
          <div style="height:8px"></div>
          <div class="rewardsGridBottom" id="rewardsGridBottom" aria-hidden="false"></div>

          <div class="wsActions">
            <div class="left">Unlocked: <span id="wsUnlockedCount" style="font-weight:900;color:var(--wm-accentC)">0</span>/7</div>
            <div style="display:flex;gap:10px">
              <button class="btnGhost" id="wsBtnRules">How it works</button>
              <button class="btnPrimary" id="wsBtnClose">Come back tomorrow</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-menu">
    <button id="infoBtn" class="secondary">ℹ</button>
    <button id="shopBtn" class="secondary">🛒</button>
    <button id="miningBtn" class="secondary">⛏</button>
    <button id="profileBtn" class="secondary">👤</button>
  </div>

  <script>
  /* ====== основной JS (сокращённо) ======
     сюда можно вставить вашу логику (локализация, апгрейды, майнеры и т.д.)
     Внизу — логика модалки (renderCards, hideMainUI, showMainUI) с minor-fixes:
     - при показе модалки запрещаем прокрутку документа (documentElement overflow hidden)
     - при скрытии возвращаем прежний стиль
  */
  (function(){
    // --- пример форматтера (оставьте ваш существующий) ---
    function formatNum(n){
      if (n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
      if (n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
      if (n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
      return String(n);
    }

    // ====== rewards modal logic (safe localStorage utils) ======
    const LS_FIRST = 'ws_first_seen_v2';
    const LS_CLAIMED = 'ws_claimed_v2';
    const MAX_DAYS = 7;
    const amounts = [30000,100000,500000,1000000,3000000,6000000,10000000];

    function safeGetJSON(key, fallback){
      try{ const raw = localStorage.getItem(key); if(!raw) return fallback; return JSON.parse(raw); }catch(e){ return fallback; }
    }
    function safeSetJSON(key, obj){
      try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
    }

    let firstSeen = +localStorage.getItem(LS_FIRST) || 0;
    if(!firstSeen || isNaN(firstSeen)){ firstSeen = Date.now(); try{ localStorage.setItem(LS_FIRST, String(firstSeen)); }catch(e){} }
    let claimed = safeGetJSON(LS_CLAIMED, null);
    if(!Array.isArray(claimed) || claimed.length !== MAX_DAYS){ claimed = new Array(MAX_DAYS).fill(false); safeSetJSON(LS_CLAIMED, claimed); }

    function daysSinceFirst(){ return Math.floor((Date.now() - firstSeen) / (24*60*60*1000)); }
    function availableCount(){ return Math.min(MAX_DAYS, daysSinceFirst() + 1); }

    // DOM refs
    const overlay = document.getElementById('wsModalOverlay');
    const gridTop = document.getElementById('rewardsGridTop');
    const gridBottom = document.getElementById('rewardsGridBottom');
    const unlockedCountEl = document.getElementById('wsUnlockedCount');
    const coinsDisplayEl = document.getElementById('wsModalCoinsDisplay');
    const btnClose = document.getElementById('wsBtnClose');
    const btnRules = document.getElementById('wsBtnRules');

    // manage body overflow when modal open
    let prevHtmlOverflow = document.documentElement.style.overflow || '';
    let hiddenTargets = [];

    function hideMainUI(){
      // hide all direct children of body except overlay
      const bodyChildren = Array.from(document.body.children);
      hiddenTargets = [];
      bodyChildren.forEach(ch=>{
        if (ch === overlay) return;
        hiddenTargets.push({el: ch, prev: ch.style.display || ''});
        ch.style.display = 'none';
      });
      // lock scroll on root to avoid background scrolling in some embed UIs
      prevHtmlOverflow = document.documentElement.style.overflow || '';
      document.documentElement.style.overflow = 'hidden';
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden','false');
    }

    function showMainUI(){
      hiddenTargets.forEach(item=>{
        try{ item.el.style.display = item.prev || ''; }catch(e){}
      });
      hiddenTargets.length = 0;
      document.documentElement.style.overflow = prevHtmlOverflow;
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
    }

    function renderCards(){
      const avail = availableCount();
      gridTop.innerHTML = '';
      gridBottom.innerHTML = '';
      for(let i=0;i<MAX_DAYS;i++){
        const day = i+1;
        const amount = amounts[i] || 0;
        const card = document.createElement('div');
        card.className = 'rewardCard' + (day===7 ? ' big' : '');
        card.innerHTML = `
          <div class="coinIconSmall">💰</div>
          <div class="dayLabel">Day ${day}</div>
          <div class="amount">${formatNum(amount)}</div>
        `;
        const isUnlocked = i < avail;
        const isClaimed = !!claimed[i];

        if(isClaimed){
          card.classList.add('claimed');
          const badge = document.createElement('div'); badge.className='claimBadge'; badge.textContent='Claimed'; card.appendChild(badge);
        } else if(isUnlocked){
          card.classList.add('unlocked');
        } else {
          card.classList.add('locked');
          const daysToUnlock = day - avail;
          const overlayEl = document.createElement('div'); overlayEl.className='overlay';
          overlayEl.textContent = daysToUnlock <= 1 ? `Unlock in ${daysToUnlock} day` : `Unlock in ${daysToUnlock} days`;
          card.appendChild(overlayEl);
        }

        card.addEventListener('click', ()=>{
          if(!isUnlocked || isClaimed) return;
          card.classList.add('pop');
          setTimeout(()=>card.classList.remove('pop'),260);
          claimed[i] = true;
          safeSetJSON(LS_CLAIMED, claimed);
          // добавить монеты в игру: если у вас есть функция claimRewardFromModal — она будет вызвана
          if(window.claimRewardFromModal instanceof Function){
            try{ window.claimRewardFromModal(amount); }catch(e){ console.warn(e); }
          } else {
            const cur = +(localStorage.getItem('coins')||0) + amount;
            localStorage.setItem('coins', String(cur));
          }
          const badge = document.createElement('div'); badge.className='claimBadge'; badge.textContent='Claimed'; card.appendChild(badge);
          card.classList.remove('unlocked'); card.classList.add('claimed'); card.style.pointerEvents='none';
          syncCoinsDisplay();
          renderUnlockedCount();
        });

        if(i < 4) gridTop.appendChild(card); else gridBottom.appendChild(card);
      }
      renderUnlockedCount();
    }

    function renderUnlockedCount(){
      unlockedCountEl.textContent = String(Math.min(MAX_DAYS, availableCount()));
    }

    function syncCoinsDisplay(){
      const coins = +localStorage.getItem('coins') || 0;
      coinsDisplayEl.textContent = formatNum(coins);
      const mainEl = document.getElementById('coinsVal');
      if(mainEl) mainEl.textContent = formatNum(coins);
    }

    btnClose.addEventListener('click', function(){ showMainUI(); /* можно вызвать save функции если нужно */ });
    btnRules.addEventListener('click', function(){ alert('Rewards unlock one per day since first visit. Click an unlocked card to claim its coins.'); });

    // Показываем модалку сразу (как в вашем сценарии). Если хотите вызывать вручную — удалите вызов.
    hideMainUI();
    renderCards();
    syncCoinsDisplay();

    // обновляем каждые 60s (чтобы обновлять доступность)
    setInterval(()=>{ renderCards(); }, 60*1000);

    // экспорт API для внешнего управления (если нужно)
    window._wsModal = {
      open: function(){ hideMainUI(); renderCards(); syncCoinsDisplay(); },
      close: function(){ showMainUI(); },
      state: function(){ return { firstSeen, claimed:claimed.slice(), available: availableCount() }; },
      reset: function(){ claimed = new Array(MAX_DAYS).fill(false); safeSetJSON(LS_CLAIMED,claimed); renderCards(); }
    };
  })();
  </script>
</body>
</html>
