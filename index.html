<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hide & Seek — Premium Emoji (Updated)</title>
  <style>
:root{
  --wm-accentA:#1b1b1f;
  --wm-accentB:#2b2b2f;
  --wm-accentC:#00D8FF;
  --wm-birch:#EDE4C8;
  --accent-cyan:#00D8FF;
  --birch:#EDE4C8;
  --purple-frame:#7a4bff;
  --deep-purple:#5a2ecc;
  --glass-weak: rgba(255,255,255,0.01);
  --glass-strong: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
  --bg-dark: linear-gradient(120deg,#1f2023,#2a2c31);
  --text-light: #ecf2ff;
  --profit-green: #39FF14;
  --logo-border-light: #dcdcdc; /* светло-серая обводка для логотипов */
}

/* Base page */
html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg-dark);color:var(--text-light);overflow:hidden}
body{display:flex;flex-direction:column;align-items:center;min-height:100vh}

/* ====== Apply rewards-modal "glass" aesthetic to main UI ====== */
header{
  width:95%;
  margin:15px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  background: var(--glass-strong);
  border-radius:18px;
  padding:12px 18px;
  backdrop-filter: blur(8px) saturate(1.05);
  box-shadow: 0 14px 40px rgba(0,0,0,0.65);
  border:1px solid rgba(255,255,255,0.03);
}

/* Energy panel (уменьшена) */
.energy-panel{
  display:flex;
  align-items:center;
  gap:8px;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  padding:6px 10px; /* уменьшенный padding */
  border-radius:10px;
  box-shadow:0 10px 30px rgba(0,0,0,0.6);
  min-width:100px;  /* уменьшили ширину */
  max-width:160px;
  font-weight:800;
  color:var(--text-light);
  border:1px solid rgba(255,255,255,0.02);
}
.energy-panel .icon{font-size:16px;margin-right:6px}
.energy-panel .val{font-size:14px;color:var(--wm-accentC);line-height:1}
.energy-panel .timer{font-size:11px;color:var(--birch);line-height:1}

/* Coin panel — растянута влево (теперь рядом с energy) */
.coin-panel{
  display:flex;
  align-items:center;
  gap:10px;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  padding:8px 12px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.6);
  margin-left:auto;
  min-width:140px;
  max-width:320px;           /* увеличил max, чтобы логотип не выходил */
  justify-content:flex-end;
  border:1px solid rgba(255,255,255,0.02);
  gap:10px;
}
.coin-logo, .ton-logo{display:inline-flex;align-items:center;justify-content:center;border-radius:50%;overflow:hidden;flex:0 0 auto}
/* Изменено: обводка логотипов — светло-серая; размеры удобнее */
.coin-logo{width:40px;height:40px;border:2px solid var(--logo-border-light);box-shadow:0 8px 18px rgba(122,75,255,0.06);background:#fff}
.coin-logo img{width:100%;height:100%;object-fit:cover;display:block}
.coin-panel .val{font-weight:900;font-size:14px;color:var(--wm-accentC);line-height:1}
.ton-panel{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:10px;background:transparent;margin-left:8px}
.ton-logo{width:34px;height:34px;border:2px solid var(--logo-border-light);box-shadow:0 8px 14px rgba(255,193,7,0.06);background:#fff}
.ton-logo img{width:100%;height:100%;object-fit:cover;display:block}
.ton-val{font-weight:800;font-size:13px;color:#ffeaa7;line-height:1}

/* House / rooms */
.house{position:relative;width:95%;max-width:560px;margin:20px 0;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(4,1fr);gap:14px}
.room{
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:28px;
  color:var(--text-light);
  cursor:pointer;
  transition:transform .28s,box-shadow .28s;
  position:relative;
  border:1px solid rgba(255,255,255,0.02);
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}
.room:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(0,0,0,0.7)}
.room.selected{border-color:var(--wm-accentC);box-shadow:0 0 18px var(--wm-accentC)}
.room.found{border-color:#FF0054;box-shadow:0 0 12px #FF0054;animation:foundAnim 1s ease}
.room.safe{border-color:var(--profit-green);box-shadow:0 0 12px var(--profit-green);animation:safeAnim .8s ease}
/* Modified: make hunter highlight brighter as requested */
.room.highlight{box-shadow:0 0 40px 12px rgba(0,216,255,0.18);transition:box-shadow .2s, transform .18s}
/* end highlight change */
@keyframes foundAnim{0%{transform:scale(1)}50%{transform:rotate(10deg) scale(1.15)}100%{transform:scale(1)}}
@keyframes safeAnim{0%{transform:scale(1)}50%{transform:rotate(-10deg) scale(0.95)}100%{transform:scale(1)}}

/* Controls — use rewards modal button style */
.controls{width:90%;display:flex;justify-content:space-between;margin-bottom:18px}
.btnPrimary{
  flex:1;margin:0 6px;padding:14px;font-size:18px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--wm-accentC),#00A8FF);color:#000;font-weight:900;box-shadow:0 12px 36px rgba(0,216,255,0.12);transition:transform .16s;
}
.btnPrimary:active{transform:scale(.98)}
.btnGhost{
  flex:1;margin:0 6px;padding:12px 14px;font-size:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text-light);font-weight:800;cursor:pointer;
}

/* Bottom menu (glass) */
.bottom-menu{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);width:90%;max-width:560px;display:flex;justify-content:space-around;gap:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));padding:12px;border-radius:16px;backdrop-filter:blur(8px);box-shadow:0 18px 50px rgba(0,0,0,0.65);border:1px solid rgba(255,255,255,0.02)}
.bottom-menu button{background:transparent;color:var(--text-light);font-size:20px;transition:transform .18s}
.bottom-menu button:hover{transform:scale(1.12);color:var(--wm-accentC)}

/* Upgrades panel (glass-like) */
.upgrade-panel{display:flex;gap:12px;margin:10px 0;overflow-x:auto;padding:14px 12px;width:95%;justify-content:flex-start;align-items:stretch}
.upgrade{flex:0 0 auto;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));padding:16px;border-radius:16px;text-align:left;min-width:220px;cursor:pointer;box-shadow:0 14px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02);transition:transform .18s}
.upgrade:hover{transform:translateY(-8px)}
.upgrade h3{margin:0 0 8px;font-size:16px;color:var(--wm-accentC)}
.upgrade p{margin:0;font-size:14px;color:#eaf5ff}
.upgrade .price{margin-top:10px;font-weight:900;color:var(--birch);font-size:16px}
.upgrade .badge{display:inline-block;margin-top:8px;padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.12);font-weight:700;color:#fff;font-size:12px}

/* Mining info (glass) */
.mining-info{margin:10px 0;padding:12px 14px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:14px;width:95%;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}

/* Miners panel hidden on main */
.miners-panel{display:none;width:95%;max-width:900px;gap:12px;padding:10px;overflow-x:auto;align-items:flex-start;margin-bottom:12px;background:transparent;border-radius:12px}
.miners-panel .miner-card{display:none}

/* Mining shop modal */
/* = A1 = Mining shop modal — fixed blurred background via pseudo-element */
#miningShop{
  display:none;
  position:fixed;
  inset:0;
  z-index:900;
  color:var(--text-light);
  padding:28px;
  box-sizing:border-box;
  overflow-y:auto; /* content scrolls, background stays fixed */
}

/* Fixed background with blur — stays in place while content scrolls */
#miningShop::before{
  content: '';
  position: fixed;
  inset: 0;
  z-index: -1;
  background-image: url('fon.png'); /* положи fon.png рядом с HTML или укажи путь */
  background-size: cover;
  background-position: center center;
  background-repeat: no-repeat;
  /* затемняющая накладка для читаемости карточек */
  background-color: rgba(6,10,14,0.56);
  background-blend-mode: overlay;

  /* размытие фона */
  filter: blur(8px) saturate(1.02);
  -webkit-filter: blur(8px) saturate(1.02);
}

#miningShop .close-top { position:absolute; top:18px; right:18px; border:none; background:transparent; color:var(--text-light); font-size:20px; cursor:pointer; padding:8px 10px; border-radius:8px; }
#miningShop h2{color:#ecf8ff;text-align:center;margin-bottom:10px}
/* = A2 = Make container visually gone — transparent and scrollable */
#miningShop .miners-container{
  display:flex;
  flex-wrap:wrap;
  gap:18px;
  justify-content:center;
  padding:18px 12px;
  margin:0;

  background: transparent !important;
  border: none !important;
  border-radius: 0 !important;
  box-shadow: none !important;

  max-height: calc(100vh - 200px); /* контейнер скроллится внутри модалки */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 40px;
}

#miningShop .miner-card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));color:#fff;border-radius:14px;padding:12px;width:160px;display:flex;flex-direction:column;align-items:center;gap:8px;box-shadow:0 18px 40px rgba(0,0,0,0.7);cursor:pointer;transition:transform .18s,box-shadow .18s;border:1px solid rgba(255,255,255,0.02)}
#miningShop .miner-card:hover{transform:translateY(-8px);box-shadow:0 26px 60px rgba(0,0,0,0.75)}
/* Changed: make miner card logo border white as requested */
#miningShop .card-logo{width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid #fff;background:#fff;box-shadow:0 8px 24px rgba(122,75,255,0.06)}
#miningShop .miner-card h3{margin:6px 0 2px;font-size:16px;color:#f0fbff}
#miningShop .miner-card .income{color:var(--birch);font-weight:900}
#miningShop .miner-card .bottom{width:100%;display:flex;justify-content:space-between;font-weight:900;font-size:14px;margin-top:6px}
#miningShop .price-pill{background:rgba(0,0,0,0.12);padding:6px 8px;border-radius:10px;font-weight:900}

/* Buy confirm */
#buyConfirm{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;background:transparent;padding:0;box-sizing:border-box}
#buyConfirm .confirm-box{max-width:520px;margin:0;background:linear-gradient(120deg, rgba(40,40,40,0.98), rgba(60,60,60,0.98));border:2px solid var(--wm-accentC);border-radius:12px;padding:14px;text-align:center;box-shadow:0 18px 50px rgba(0,0,0,0.7)}
#buyConfirm.show{display:block}
#buyConfirm p{color:#fff;margin:8px 0}
#buyConfirm button{margin:6px 6px;padding:8px 12px;font-weight:700;background:linear-gradient(90deg,var(--wm-accentC),#00A8FF);color:#000;border:none;border-radius:8px}

/* Info & Profile windows (glass-like fullscreen) */
#infoWindow, #profileWindow{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:800;background:linear-gradient(120deg,#1b1b1f,#2b2c2f);color:var(--text-light);padding:28px;box-sizing:border-box;Overflow-y:auto}
#infoWindow .content, #profileWindow .content{max-width:1100px;margin:24px auto;border-radius:16px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));color:#fff;box-shadow:0 18px 50px rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.02)}
#infoWindow h2, #profileWindow h2{color:#ecf8ff;margin-bottom:10px}
#infoWindow ul{color:#eaf2ff;padding-left:20px}
#infoWindow ul li::before{content:'• ';color:var(--wm-accentC);font-weight:600}
#infoWindow button, #profileWindow button{width:100%;margin-top:12px;padding:12px;font-size:18px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--wm-accentC),#00A8FF);color:#000;cursor:pointer;font-weight:900}

/* Profile sections improved */
.profile-section{
  margin-bottom:16px;
  padding:16px;
  border-radius:12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
  border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 12px 30px rgba(0,0,0,0.5);
}
.profile-section h3{margin:0 0 8px;color:#ecf8ff;font-size:18px}
.profile-section p{margin:0 0 12px;color:#eaf5ff}
.profile-section .row{display:flex;gap:8px;align-items:center}
.profile-section .meta{font-weight:700;color:var(--birch);font-size:13px}
.profile-section .sep{height:1px;background:rgba(255,255,255,0.03);margin:12px 0;border-radius:1px}

/* Withdraw modal (new) */
.withdraw-modal{display:none;position:fixed;inset:0;z-index:12000;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(10,10,12,0.75), rgba(20,20,24,0.85));backdrop-filter:blur(8px);padding:20px;box-sizing:border-box}
.withdraw-card{width:100%;max-width:820px;background:linear-gradient(180deg, rgba(18,18,20,0.98), rgba(34,34,36,0.98));border-radius:14px;padding:18px;box-shadow:0 30px 80px rgba(0,0,0,0.65);border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:14px}
.withdraw-header{display:flex;justify-content:space-between;align-items:center;color:#ecf8ff}
.withdraw-header .title{display:flex;align-items:center;gap:12px}
.withdraw-header .title .icon{width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,var(--wm-accentC),#7adcff);display:inline-flex;align-items:center;justify-content:center;font-weight:900;color:#000}
.withdraw-body{display:grid;grid-template-columns:1fr;gap:14px;align-items:start}
.withdraw-section{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 30px rgba(0,0,0,0.45)}
.withdraw-section .sec-title{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-weight:900;color:var(--wm-accentC)}
.withdraw-section .sec-desc{font-size:13px;color:var(--birch);margin-bottom:10px}
.addr-input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text-light);font-weight:800}
.small-note{font-size:13px;color:var(--birch);font-weight:700}
.copy-btn{padding:8px 10px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--wm-accentC),#00A8FF);color:#000;font-weight:900;cursor:pointer}
.withdraw-actions{display:flex;gap:8px;justify-content:flex-end}
.withdraw-warning{background:linear-gradient(180deg, rgba(255,165,0,0.03), rgba(255,255,255,0.00));padding:10px;border-radius:8px;border:1px solid rgba(255,165,0,0.04);color:#ffdb9c;font-weight:700}
.withdraw-success{background:linear-gradient(180deg, rgba(57,255,20,0.02), rgba(255,255,255,0.00));padding:10px;border-radius:8px;border:1px solid rgba(57,255,20,0.04);color:var(--profit-green);font-weight:900}

/* small screens */
@media (max-width:760px){
  .withdraw-body{grid-template-columns:1fr;}
  .withdraw-card{padding:12px}
  .withdraw-header .title .icon{width:36px;height:36px}
}

/* Casino modal (keeps readable look) */
.casino-modal{display:none;position:fixed;inset:0;z-index:11000;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(27,27,31,0.88), rgba(43,43,47,0.92));backdrop-filter:blur(6px);padding:20px;box-sizing:border-box}
.casino-modal .card{width:100%;max-width:820px;background:linear-gradient(180deg, rgba(28,28,30,0.98), rgba(36,36,38,0.98));border-radius:16px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.75);border:1px solid rgba(255,255,255,0.02);display:flex;gap:12px;flex-direction:column}
.casino-header{display:flex;justify-content:space-between;align-items:center;color:#ecf8ff}
.casino-body{display:flex;gap:18px;align-items:center;flex-wrap:wrap;justify-content:center}
.wheel-wrap{position:relative;width:380px;height:380px;display:flex;align-items:center;justify-content:center}
#wheelCanvas{width:100%;height:100%;border-radius:50%;box-shadow:0 12px 40px rgba(0,0,0,0.7)}
.wheel-pointer{position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:26px solid #fff;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.28))}
.casino-controls{display:flex;flex-direction:column;gap:8px;min-width:220px}
.spin-btn{padding:12px 18px;border-radius:12px;border:none;font-weight:900;cursor:pointer;background:linear-gradient(90deg,var(--wm-accentC),#00A8FF);color:#000;box-shadow:0 12px 36px rgba(0,216,255,0.12)}
.casino-note{color:var(--birch);font-weight:700}
.casino-result{font-weight:900;color:var(--wm-accentC);font-size:18px}
.spin-btn[disabled]{opacity:0.45;cursor:not-allowed;transform:none;box-shadow:none}

/* Rewards modal (original) */
#wsModalOverlay{ --wm-accentA:#1b1b1f; --wm-accentB:#2b2b2f; --wm-accentC:#00D8FF; --wm-birch:#EDE4C8; z-index:10000; position:fixed; inset:0; display:flex; align-items:flex-start; justify-content:center; font-family:Inter,system-ui,Arial,sans-serif; }
#wsModalOverlay.hidden{ display:none; }
#wsModalOverlay .bgLayer{ position:absolute; inset:0; background:linear-gradient(180deg,var(--wm-accentA),var(--wm-accentB)); display:block; overflow:hidden; }
#wsModalOverlay .bgImage{ position:absolute; inset:0; background-image:url('fon.png'); background-size:cover; background-position:center; filter:blur(6px) saturate(1.05); mix-blend-mode:overlay; opacity:0.28; }

#wsModalOverlay .glass{
  position:relative; width:100%; max-width:980px; margin:0 auto; box-sizing:border-box; padding:18px; border-radius:18px 18px 0 0; backdrop-filter: blur(8px) saturate(1.05);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); box-shadow: 0 -12px 40px rgba(0,0,0,0.45); display:flex; flex-direction:column; gap:12px; overflow:hidden;
}

#wsModalOverlay .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px; color:#ecf8ff; position:relative; z-index:3; }
#wsModalOverlay .title{ font-size:20px; font-weight:800; letter-spacing:0.2px; display:flex; align-items:center; gap:10px; }
#wsModalOverlay .title .coinIcon{ width:36px; height:36px; border-radius:50%; background:linear-gradient(90deg,var(--wm-accentC),#00A8FF); display:inline-flex; align-items:center; justify-content:center; color:#000; font-weight:900; box-shadow:0 8px 28px rgba(0,216,255,0.06); }

.rewardsShell{ display:flex; flex-direction:column; gap:12px; }
.rewardsContainer{ background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(255,255,255,0.00)); border-radius:14px; padding:12px; box-shadow:0 8px 30px rgba(0,0,0,0.36); border:1px solid rgba(255,255,255,0.04); max-height: calc(70vh - 110px); overflow:auto; }
.rewardsGridTop{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; }
.rewardsGridBottom{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
.rewardCard{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); border-radius:12px; padding:12px; min-height:86px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; transition:transform .16s ease, box-shadow .16s ease; cursor:pointer; border:1px solid rgba(255,255,255,0.04); }
.rewardCard:hover{ transform:translateY(-6px); }
.rewardCard.pop{ animation:pop .26s ease; }
@keyframes pop{ 0%{ transform:scale(1); } 50%{ transform:scale(1.06);} 100%{ transform:scale(1); } }

.rewardCard .coinIconSmall{ width:44px; height:44px; border-radius:50%; background:linear-gradient(90deg,var(--wm-accentC),#00A8FF); display:flex; align-items:center; justify-content:center; font-weight:800; color:#000; margin-bottom:8px; border:2px solid rgba(255,255,255,0.06); box-shadow:0 8px 18px rgba(0,216,255,0.08); }
.rewardCard .dayLabel{ font-weight:800; color:#ecf8ff; margin-bottom:6px; }
.rewardCard .amount{ font-weight:900; font-size:16px; color:var(--wm-accentC); text-shadow: 0 6px 18px rgba(0,216,255,0.08); }
.rewardCard.locked{ opacity:0.36; pointer-events:auto; }
.rewardCard.unlocked{ box-shadow:0 10px 30px rgba(0,216,255,0.06); border:1px solid rgba(0,216,255,0.12); }
.rewardCard.claimed{ opacity:0.9; pointer-events:none; }
.rewardCard .claimBadge{ position:absolute; top:8px; right:8px; background:linear-gradient(90deg,#FFD54A,#FFC107); color:#000; padding:6px 8px; border-radius:999px; font-weight:800; box-shadow:0 6px 20px rgba(255,193,7,0.12); font-size:12px; }

.rewardCard.big{ min-height:120px; padding:18px; }

.wsActions{ display:flex; gap:12px; margin-top:12px; align-items:center; justify-content:space-between; }
.wsActions .left{ color:var(--wm-birch); font-weight:700; }
.btnPrimarySmall{ padding:10px 14px; border-radius:12px; font-weight:900; border:none; cursor:pointer; background:linear-gradient(90deg,var(--wm-accentC),#00A8FF); color:#000; box-shadow:0 12px 36px rgba(0,216,255,0.08); }
.btnGhost{ padding:10px 14px; border-radius:12px; font-weight:800; border:1px solid rgba(255,255,255,0.03); background:transparent; color:#ecf8ff; cursor:pointer; }

@media (max-width:720px){
  .rewardsContainer{ max-height: calc(60vh - 90px); }
  .rewardsGridTop{ grid-template-columns:repeat(2,1fr); }
  .rewardsGridBottom{ grid-template-columns:repeat(2,1fr); }
  .glass{ padding:12px; border-radius:12px 12px 0 0; }
  .rewardCard.big{ min-height:100px; }
}

/* small screens tweak */
@media (max-width:520px){
  .coin-logo{width:32px;height:32px;border-width:2px}
  .btnPrimary{font-size:16px;padding:12px}
  #miningShop .miner-card{width:46%}
  .upgrade{min-width:160px}
  .coin-panel{min-width:100px;max-width:220px;padding:6px 6px}
  .coin-panel .val{font-size:12px}
}

/* ===========================
   New rules to prevent withdraw instruction expanding modal
   =========================== */

/* Constrain withdraw-card so modal won't grow beyond viewport */
.withdraw-card {
  max-height: calc(100vh - 120px);
  overflow: auto;
}

/* Constrain the instruction section so it becomes scrollable instead of expanding card
   (we removed the instruction block from the UI, but keep rule if needed) */
#withdrawInstruction {
  display: none; /* kept default hidden */
  max-height: 200px; /* limit height */
  overflow-y: auto;
  box-sizing: border-box;
  padding-right: 6px;
}

/* Prevent commission address from stretching layout */
#commissionAddr {
  display: block;
  max-width: 100%;
  word-break: break-word;
  overflow-wrap: anywhere;
  white-space: normal;
}
  </style>
</head>
<body>
  <header>
    <!-- Energy -->
    <div class="energy-panel" id="energyPanel" aria-live="polite" aria-atomic="true">
      <div class="icon">⚡</div>
      <div style="display:flex;flex-direction:column;align-items:flex-start;">
        <div style="font-size:11px;color:var(--birch);font-weight:800">Energy</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="val" id="energyVal">50</div>
          <div class="timer" id="energyTimer">—</div>
        </div>
      </div>
    </div>

    <!-- Coin panel (уменьшён) -->
    <div class="coin-panel" aria-live="polite" aria-atomic="true">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="coin-logo" title="XTR">
          <img src="logo.png" alt="XTR logo" />
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;line-height:1;">
          <div style="font-size:11px;color:var(--birch);font-weight:800">XTR</div>
          <div class="val" id="coinsVal">0</div>
        </div>
      </div>
       <div class="ton-panel" style="margin-left:6px;">
        <div class="ton-logo" title="TON">
          <img src="ton.png" alt="TON logo" />
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;line-height:1;">
          <div style="font-size:11px;color:var(--birch);font-weight:800">TON</div>
          <div class="ton-val" id="tonVal">0.00</div>
        </div>
      </div>
    </div>
  </header>

  <div class="house"></div>

  <div class="controls">
    <button id="startBtn" class="btnPrimary">🏠 Start</button>
    <button id="resetBtn" class="btnGhost">🔍 Hunt</button>
  </div>

  <div class="upgrade-panel" id="upgradePanel">
    <div class="upgrade" data-key="x2Prize" data-base-price="20000">
      <h3>x2 Prize / x2 Loss</h3>
      <p>Double rewards & penalties</p>
      <div class="price">20,000</div>
      <div class="badge">Boost</div>
    </div>
    <div class="upgrade" data-key="check1" data-base-price="20000">
      <h3>Check 1 Room Only</h3>
      <p>Hunter checks 1 room only (1 min)</p>
      <div class="price">20,000</div>
      <div class="timer" id="check1Timer"></div>
    </div>

    <div class="upgrade" data-key="shield" data-base-price="25000">
      <h3>Shield (1m)</h3>
      <p>Protects you from loss for 1 minute</p>
      <div class="price">25,000</div>
      <div class="timer" id="shieldTimer"></div>
      <div class="badge">Defence</div>
    </div>

    <div class="upgrade" data-key="incBoost" data-base-price="30000">
      <h3>Double Income (1m)</h3>
      <p>Mining income ×2 for 1 minute</p>
      <div class="price">30,000</div>
      <div class="timer" id="incTimer"></div>
      <div class="badge">Income</div>
    </div>

    <div class="upgrade" data-key="luck" data-base-price="22000">
      <h3>Lucky Escape (1m)</h3>
      <p>50% chance to evade if hunted (1 minute)</p>
      <div class="price">22,000</div>
      <div class="timer" id="luckTimer"></div>
      <div class="badge">Chance</div>
    </div>
  </div>

  <div class="mining-info">
    <strong id="miningLabel">Mining Income:</strong> <span id="miningIncomeVal">0</span>/hr
  </div>

  <div class="miners-panel" id="minersPanelVisible" aria-hidden="true"></div>

  <div id="miningShop" aria-hidden="true">
    <button id="closeMiningShopTop" class="close-top" title="Close">✕</button>
    <h2 id="shopTitle">Mining Shop</h2>
    <div class="miners-container"></div>
  </div>

  <div id="buyConfirm" aria-hidden="true">
    <div class="confirm-box">
      <p id="buyText"></p>
      <div style="display:flex;justify-content:center;">
        <button id="confirmBuy" class="btnPrimary">Buy</button>
        <button id="cancelBuy" class="btnGhost">Cancel</button>
      </div>
    </div>
  </div>

  <div id="infoWindow" aria-hidden="true">
    <div class="content">
      <h2 id="infoTitle">How to Play</h2>
      <ul id="infoList">
        <li>Select a room and then click the 🔍 button to hunt.</li>
        <li>The hunter searches 2 random rooms (1 if "Check 1 Room" is active).</li>
        <li>If your room is found, you lose coins (shown in red).</li>
        <li>If you evade the hunt, you gain coins (shown in green).</li>
        <li>Buy upgrades or miners to improve your chances and income.</li>
        <li>Claim daily rewards and complete quests for bonus coins.</li>
      </ul>
      <button id="closeInfo" class="btnPrimary">Close</button>
    </div>
  </div>

  <div id="profileWindow" aria-hidden="true">
    <div class="content">
      <h2 id="profileTitle">Profile</h2>

      <!-- Profile sections using unified .profile-section for clearer layout -->
      <div class="profile-section" id="profile-daily">
        <h3 id="dailyTitle">Daily Reward</h3>
        <p id="dailyText">Get 30,000 XTR once a day!</p>
        <div class="row">
          <button id="claimDaily" class="btnPrimary" style="flex:1;">Claim Daily</button>
        </div>
        <div class="sep"></div>
        <p class="meta" id="dailyStatus" style="text-align:center;margin-top:8px;"></p>
      </div>

      <div class="profile-section" id="profile-quest">
        <h3 id="questTitle">Quest</h3>
        <p id="questText">Complete quests to get bonus XTR!</p>
        <div class="row">
          <button id="claimQuest" class="btnPrimary" style="flex:1;">Claim Quest</button>
        </div>
        <div class="sep"></div>
        <p class="meta" id="questStatus" style="text-align:center;margin-top:8px;"></p>
      </div>

      <!-- NEW: Telegram subscribe quest -->
      <div class="profile-section" id="profile-tg">
        <h3 id="tgQuestTitle">Подписка в Telegram</h3>
        <p id="tgQuestText">Подпишитесь на канал, чтобы получить бонус.</p>
        <div class="row">
          <a id="openTgChannel" class="btnGhost" href="https://t.me/x_trade_news" target="_blank" rel="noopener">Открыть канал</a>
          <button id="claimTgSubscribe" class="btnPrimary" style="flex:1;">Claim</button>
        </div>
        <div class="sep"></div>
        <p class="meta" id="tgQuestStatus" style="text-align:center;margin-top:8px;"></p>
      </div>

      <div class="profile-section" id="profile-settings">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
          <div>
            <h3 id="settingsTitle">Settings</h3>
            <p id="settingsText">Change language and other preferences.</p>
          </div>
          <div>
            <select id="langSelect" class="select-lang" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text-light);">
              <option value="ru">Русский</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
      </div>

      <button id="closeProfile" class="btnPrimary" style="width:100%;">Close</button>
    </div>
  </div>

  <div class="bottom-menu">
    <button id="infoBtn" class="btnGhost">ℹ</button>
    <!-- кнопка 🛒 была удалена по просьбе -->
    <button id="miningBtn" class="btnGhost">⛏</button>
    <button id="profileBtn" class="btnGhost">👤</button>
    <button id="withdrawBtn" class="btnGhost" title="Вывод">💸</button>
    <button id="casinoBtn" class="btnGhost" title="Casino">🎰</button>
  </div>

  <!-- Rewards modal -->
  <div id="wsModalOverlay" aria-hidden="false" role="dialog" aria-label="Daily rewards modal">
    <div class="bgLayer" aria-hidden="true">
      <div class="bgImage" aria-hidden="true"></div>
    </div>

    <div class="glass" role="document" aria-modal="true">
      <div class="header">
        <div class="title">
          <div class="coinIcon">💎</div>
          <div>
            <div style="font-size:18px" id="wsTitle">Premium Gifts</div>
            <div class="sub">7 days of rewards — claim one per day</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800;color:var(--wm-accentC);font-size:18px" id="wsModalCoinsDisplay">0 XTR • 0.00 TON</div>
          <div style="font-size:12px;color:var(--wm-birch)">Coins balance</div>
        </div>
      </div>

      <div class="rewardsShell" id="rewardsShell">
        <div class="rewardsContainer" id="rewardsContainer">
          <div class="rewardsGridTop" id="rewardsGridTop" aria-hidden="false"></div>
          <div style="height:8px"></div>
          <div class="rewardsGridBottom" id="rewardsGridBottom" aria-hidden="false"></div>

          <div class="wsActions">
            <div class="left">Unlocked: <span id="wsUnlockedCount" style="font-weight:900;color:var(--wm-accentC)">0</span>/7</div>
            <div style="display:flex;gap:10px">
              <button class="btnGhost" id="wsBtnRules">How it works</button>
              <button class="btnPrimarySmall" id="wsBtnClose">Come back tomorrow</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Casino modal -->
  <div id="casinoModal" class="casino-modal" aria-hidden="true" role="dialog" aria-label="Casino wheel">
    <div class="card" role="document">
      <div class="casino-header">
        <div>
          <div id="casinoTitle" style="font-size:20px;font-weight:900">🎰 Казино</div>
          <div id="casinoSubtitle" style="color:var(--birch);font-weight:700">Spin the wheel — once every 2 hours</div>
        </div>
        <div id="casinoBalance" style="text-align:right;font-weight:800;color:var(--wm-accentC)">0 XTR • 0.00 TON</div>
      </div>

      <div class="casino-body">
        <div class="wheel-wrap">
          <canvas id="wheelCanvas" width="800" height="800" aria-hidden="false"></canvas>
          <div class="wheel-pointer" aria-hidden="true"></div>
        </div>

        <div class="casino-controls">
          <div class="casino-note">Next spin in: <span id="casinoCooldown">Ready</span></div>
          <button id="spinBtn" class="spin-btn">SPIN</button>
          <div>Result: <span id="casinoResult" class="casino-result">—</span></div>
          <button id="closeCasino" class="btnGhost" style="padding:8px 12px;border-radius:10px;">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Withdraw modal (simplified: only wallet connect/address container) -->
  <div id="withdrawModal" class="withdraw-modal" aria-hidden="true" role="dialog" aria-label="Вывод">
    <div class="withdraw-card" role="document">
      <div class="withdraw-header">
        <div class="title">
          <div class="icon">💸</div>
          <div>
            <div style="font-size:18px;font-weight:900">Вывод средств</div>
            <div style="font-size:13px;color:var(--birch)">Платежи проходят через TON</div>
          </div>
        </div>
        <div style="font-size:13px;color:var(--birch);">Доверие: выплаты оформляются администратором</div>
      </div>

      <div style="font-size:13px;color:var(--birch);margin-top:4px;">Все токены будут автоматически отправлены на указанный выше адрес в дату листинга монеты — <strong>15 декабря 2025</strong>.</div>

      <div class="withdraw-body">
        <!-- KEEP: only address / wallet connect container -->
        <div class="withdraw-section" aria-label="address-section">
          <div class="sec-title">📫 Адрес для выплат</div>
          <div class="sec-desc">Укажите TON-адрес. После сохранения адрес будет привязан.</div>

          <input id="withdrawAddressInput" class="addr-input" placeholder="UQ..." aria-label="TON address input" />
          <div style="height:10px"></div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button id="saveWithdrawAddr" class="btnPrimary">Сохранить</button>
            <button id="changeWithdrawAddr" class="btnGhost">Сменить</button>
            <button id="copyAddrBtn" class="copy-btn" style="margin-left:auto;">Копировать</button>
          </div>
          <div style="height:10px"></div>
          <div id="boundAddrInfo" class="small-note"></div>
          <!-- status for address/connect -->
          <div id="withdrawStatus" class="withdraw-warning" style="margin-top:8px;">Проверьте адрес</div>
        </div>

        <!-- Removed the previous withdraw-action-section (buttons for checking balance/withdrawal) per request.
             Only wallet/address container remains. -->
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:12px;">
        <button id="closeWithdraw" class="btnGhost">Закрыть</button>
      </div>
    </div>
  </div>

<script>
  /* ===========================
     Объединённый и отредактированный JS
     (с изменениями: XTR вместо ZEX, удалена кнопка 🛒, улучшен профиль,
      miner logo border set to white, expanded language switching)
  =========================== */

  // ======= Constants & storage keys =======
  const LS_COINS = 'coins';
  const LS_MAXCOINS = 'maxCoins';
  const LS_UPGRADES = 'upgrades';
  const LS_MINERS = 'minersState';
  const LS_LASTTIME = 'lastTime';
  const LS_TON = 'player_ton_v1';
  const LS_WITHDRAW_ADDR = 'player_withdraw_ton_addr_v1';
  const LS_WITHDRAW_LOG = 'player_withdraw_log_v1';

  // Conversion: 1 XTR -> 0.000001 TON  (so 1000 XTR = 0.001 TON)
  const ZEX_TO_TON = 0.000001;
  const TON_TO_ZEX = 1 / ZEX_TO_TON; // 1 TON = 1,000,000 XTR

  // ========== Localization ==========
  const i18n = {
  ru: {
    pickRoomFirst: 'Сначала выберите комнату!',
    notEnough: 'Недостаточно монет!',
    dailyAlready: 'Ежедневная награда уже получена!',
    questAlready: 'Квест уже выполнен!',
    miningIncome: 'Доход майнинга:',
    miningShop: 'Магазин майнинга',
    close: 'Закрыть',
    howToPlay: 'Как играть',
    infoList: [
      'Выберите комнату, затем нажмите кнопку 🔍 для охоты.',
      'Охотник ищет 2 случайные комнаты (1, если активен "Check 1 Room").',
      'Если вашу комнату нашли, вы теряете монеты (показываются красным).',
      'Если вы избежали охоты, вы получаете монеты (показываются зеленым).',
      'Покупайте апгрейды или майнеров, чтобы улучшить шансы и доход.',
      'Забирайте ежедневные награды и выполняйте квесты для бонусных монет.'
    ],
    profile: 'Профиль',
    dailyReward: 'Ежедневная награда',
    dailyText: 'Получите 30 000 XTR раз в день!',
    claimDaily: 'Забрать',
    quest: 'Квест',
    claimQuest: 'Взять',
    settings: 'Настройки',
    settingsText: 'Смените язык и другие параметры.',
    buyFor: 'Купить {name} за {price}?',
    buy: 'Купить',
    cancel: 'Отмена',
    profitHr: 'Прибыль/ч:',
    noEnergy: 'Нет энергии!',
    // New keys for wider translation coverage
    startBtn: '🏠 Начать',
    resetBtn: '🔍 Охота',
    wsTitle: 'Премиум подарки',
    wsSub: '7 дней наград — забирайте по одному в день',
    wsBtnClose: 'Вернуться завтра',
    wsBtnRules: 'Как это работает',
    dayLabel: 'День',
    claimed: 'Забрано',
    casinoTitle: '🎰 Казино',
    casinoSubtitle: 'Вращайте колесо — раз в 2 часа',
    spin: 'КРУТИТЬ',
    ready: 'Готово',
    full: 'Полный',
    coinsBalance: 'Баланс монет'
  },
  en: {
    pickRoomFirst: 'Pick a room first!',
    notEnough: 'Not enough coins!',
    dailyAlready: 'Daily reward already claimed!',
    questAlready: 'Quest already claimed!',
    miningIncome: 'Mining Income:',
    miningShop: 'Mining Shop',
    close: 'Close',
    howToPlay: 'How to Play',
    infoList: [
      'Select a room and then click the 🔍 button to hunt.',
      'The hunter searches 2 random rooms (1 if "Check 1 Room" is active).',
      'If your room is found, you lose coins (shown in red).',
      'If you evade the hunt, you gain coins (shown in green).',
      'Buy upgrades or miners to improve your chances and income.',
      'Claim daily rewards and complete quests for bonus coins.'
    ],
    profile: 'Profile',
    dailyReward: 'Daily Reward',
    dailyText: 'Get 30,000 XTR once a day!',
    claimDaily: 'Claim Daily',
    quest: 'Quest',
    claimQuest: 'Claim Quest',
    settings: 'Settings',
    settingsText: 'Change language and other preferences.',
    buyFor: 'Buy {name} for {price}?',
    buy: 'Buy',
    cancel: 'Cancel',
    profitHr: 'Profit/hr:',
    noEnergy: 'No energy!',
    // New keys for wider translation coverage
    startBtn: '🏠 Start',
    resetBtn: '🔍 Hunt',
    wsTitle: 'Premium Gifts',
    wsSub: '7 days of rewards — claim one per day',
    wsBtnClose: 'Come back tomorrow',
    wsBtnRules: 'How it works',
    dayLabel: 'Day',
    claimed: 'Claimed',
    casinoTitle: '🎰 Casino',
    casinoSubtitle: 'Spin the wheel — once every 2 hours',
    spin: 'SPIN',
    ready: 'Ready',
    full: 'Full',
    coinsBalance: 'Coins balance'
  } };
  let lang = localStorage.getItem('lang') || 'ru';
  function t(key, vars = {}) {
    const val = i18n[lang] && i18n[lang][key];
    if (typeof val === 'string') {
      return val.replace(/\{(\w+)\}/g, (_, k) => vars[k] || '');
    }
    return val || '';
  }
  function applyLang() {
    // UI pieces translated
    document.getElementById('miningLabel') && (document.getElementById('miningLabel').textContent = t('miningIncome'));
    document.getElementById('shopTitle') && (document.getElementById('shopTitle').textContent = t('miningShop'));
    document.getElementById('closeMiningShop') && (document.getElementById('closeMiningShop').textContent = t('close'));
    const cb = document.getElementById('confirmBuy'); const canc = document.getElementById('cancelBuy');
    if (cb) cb.textContent = t('buy');
    if (canc) canc.textContent = t('cancel');
    document.getElementById('infoTitle') && (document.getElementById('infoTitle').textContent = t('howToPlay'));
    document.getElementById('profileTitle') && (document.getElementById('profileTitle').textContent = t('profile'));
    document.getElementById('dailyTitle') && (document.getElementById('dailyTitle').textContent = t('dailyReward'));
    document.getElementById('dailyText') && (document.getElementById('dailyText').textContent = t('dailyText'));
    document.getElementById('claimDaily') && (document.getElementById('claimDaily').textContent = t('claimDaily'));
    document.getElementById('questTitle') && (document.getElementById('questTitle').textContent = t('quest'));
    document.getElementById('claimQuest') && (document.getElementById('claimQuest').textContent = t('claimQuest'));
    document.getElementById('settingsTitle') && (document.getElementById('settingsTitle').textContent = t('settings'));
    document.getElementById('settingsText') && (document.getElementById('settingsText').textContent = t('settingsText'));

    // Info list
    const infoListEl = document.getElementById('infoList');
    if (infoListEl) {
      infoListEl.innerHTML = '';
      (t('infoList') || []).forEach(li => { const el = document.createElement('li'); el.textContent = li; infoListEl.appendChild(el); });
    }

    // TG claim button (profile)
    const claimTgBtn = document.getElementById('claimTgSubscribe');
    if (claimTgBtn) claimTgBtn.textContent = t('claimQuest');

    // Start / Hunt buttons
    const startBtn = document.getElementById('startBtn');
    if (startBtn) startBtn.textContent = t('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    if (resetBtn) resetBtn.textContent = t('resetBtn');

    // Rewards modal title/sub/buttons
    const wsTitleEl = document.getElementById('wsTitle');
    if (wsTitleEl) wsTitleEl.textContent = t('wsTitle');
    const wsSubEl = document.querySelector('#wsModalOverlay .sub');
    if (wsSubEl) wsSubEl.textContent = t('wsSub');
    const btnClose = document.getElementById('wsBtnClose');
    if (btnClose) btnClose.textContent = t('wsBtnClose');
    const btnRules = document.getElementById('wsBtnRules');
    if (btnRules) btnRules.textContent = t('wsBtnRules');

    // Casino translations
    const casinoTitleEl = document.getElementById('casinoTitle');
    if (casinoTitleEl) casinoTitleEl.textContent = t('casinoTitle');
    const casinoSubtitleEl = document.getElementById('casinoSubtitle');
    if (casinoSubtitleEl) casinoSubtitleEl.textContent = t('casinoSubtitle');
    const spinBtn = document.getElementById('spinBtn');
    if (spinBtn) spinBtn.textContent = t('spin');

    // Update coins balance label if exists
    const coinsBalanceCaption = document.querySelector('#wsModalOverlay .header div:last-child div:last-child');
    if (coinsBalanceCaption) coinsBalanceCaption.textContent = t('coinsBalance');

    // Make sure reward cards and other dynamic labels will use translations via t() when rendered
  }

  // ========== Energy ==========
  const MAX_ENERGY = 50;
  const REGEN_INTERVAL_MS = 30 * 1000;
  const LS_ENERGY = 'player_energy_v1';
  const LS_ENERGY_TICK = 'player_energy_tick_v1';

  let energy;
  let energyLastTick;
  (function initEnergyStorage(){
    const raw = localStorage.getItem(LS_ENERGY);
    if (raw === null) {
      energy = MAX_ENERGY;
      energyLastTick = Date.now();
      try {
        localStorage.setItem(LS_ENERGY, String(energy));
        localStorage.setItem(LS_ENERGY_TICK, String(energyLastTick));
      } catch(e){}
    } else {
      energy = +raw;
      if (!Number.isFinite(energy)) energy = MAX_ENERGY;
      energyLastTick = +localStorage.getItem(LS_ENERGY_TICK) || Date.now();
    }
    if (energy >= MAX_ENERGY) energyLastTick = Date.now();
    try {
      localStorage.setItem(LS_ENERGY, String(energy));
      localStorage.setItem(LS_ENERGY_TICK, String(energyLastTick));
    } catch(e){}
  })();

  function loadEnergy() {
    const stored = localStorage.getItem(LS_ENERGY);
    const storedTick = localStorage.getItem(LS_ENERGY_TICK);
    if (stored !== null) energy = +stored;
    if (!Number.isFinite(energy)) energy = MAX_ENERGY;
    energyLastTick = +storedTick || Date.now();

    const now = Date.now();
    if (now > energyLastTick && energy < MAX_ENERGY) {
      const delta = now - energyLastTick;
      const gained = Math.floor(delta / REGEN_INTERVAL_MS);
      if (gained > 0) {
        energy = Math.min(MAX_ENERGY, energy + gained);
        energyLastTick += gained * REGEN_INTERVAL_MS;
      }
    }
    if (energy >= MAX_ENERGY) energyLastTick = Date.now();
    saveEnergy();
    updateEnergyDisplay();
  }

  function saveEnergy() {
    try {
      localStorage.setItem(LS_ENERGY, String(energy));
      localStorage.setItem(LS_ENERGY_TICK, String(energyLastTick));
    } catch (e) { /* ignore */ }
  }

  function updateEnergyDisplay() {
    const el = document.getElementById('energyVal');
    const timerEl = document.getElementById('energyTimer');
    if (el) el.textContent = String(energy);
    if (timerEl) {
      if (energy >= MAX_ENERGY) {
        timerEl.textContent = t('full') || 'Full';
      } else {
        const now = Date.now();
        const delta = now - (energyLastTick || now);
        const rem = REGEN_INTERVAL_MS - (delta % REGEN_INTERVAL_MS);
        const secs = Math.ceil(rem / 1000);
        const mm = Math.floor(secs / 60);
        const ss = secs % 60;
        timerEl.textContent = `${mm>0?mm+'m ':''}${ss}s`;
      }
    }
  }

  function consumeEnergyOne() {
    const now = Date.now();
    if (now > energyLastTick && energy < MAX_ENERGY) {
      const delta = now - energyLastTick;
      const gained = Math.floor(delta / REGEN_INTERVAL_MS);
      if (gained > 0) {
        energy = Math.min(MAX_ENERGY, energy + gained);
        energyLastTick += gained * REGEN_INTERVAL_MS;
      }
    }
    if (energy <= 0) {
      alert(t('noEnergy'));
      return false;
    }
    energy = Math.max(0, energy - 1);
    if (energy < MAX_ENERGY && (!energyLastTick || energyLastTick < Date.now() - 24*3600*1000)) energyLastTick = Date.now();
    saveEnergy();
    updateEnergyDisplay();
    return true;
  }

  setInterval(()=> {
    const now = Date.now();
    if (energy >= MAX_ENERGY) {
      energyLastTick = now;
      saveEnergy();
      updateEnergyDisplay();
      return;
    }
    if (now - energyLastTick >= REGEN_INTERVAL_MS) {
      const gained = Math.floor((now - energyLastTick) / REGEN_INTERVAL_MS);
      if (gained > 0) {
        energy = Math.min(MAX_ENERGY, energy + gained);
        energyLastTick += gained * REGEN_INTERVAL_MS;
        if (energy >= MAX_ENERGY) energyLastTick = now;
        saveEnergy();
        updateEnergyDisplay();
      }
    } else {
      updateEnergyDisplay();
    }
  }, 1000);

  // ========== UI & State ==========
  const roomsContainer = document.querySelector('.house');
  for (let i = 0; i < 8; i++) {
    const d = document.createElement('div');
    d.className = 'room';
    d.dataset.idx = i;
    d.textContent = '+';
    roomsContainer.appendChild(d);
  }
  let selectedRoom = null;

  // coins (XTR) and ton are separate now
  let coins = +localStorage.getItem(LS_COINS) || 0;
  let maxCoins = +localStorage.getItem(LS_MAXCOINS) || coins;
  let ton = +localStorage.getItem(LS_TON) || 0; // TON stored independently

  const coinsVal = document.getElementById('coinsVal');
  let upgrades = JSON.parse(localStorage.getItem(LS_UPGRADES)) || { x2Prize: 0, check1: 0 };
  let check1Expire = +localStorage.getItem('check1Expire') || 0;
  let roundInProgress = false;

  let shieldExpire = +localStorage.getItem('shieldExpire') || 0;
  let doubleIncomeExpire = +localStorage.getItem('doubleIncomeExpire') || 0;
  let luckExpire = +localStorage.getItem('luckExpire') || 0;

  const minersData = [
    { n: "Miner 1", i: 500, p: 7000 },
    { n: "Miner 2", i: 1788, p: 12000 },
    { n: "Miner 3", i: 2358, p: 15000 },
    { n: "Miner 4", i: 3000, p: 20000 },
    { n: "Miner 5", i: 4500, p: 25000 },
    { n: "Miner 6", i: 5200, p: 30000 },
    { n: "Miner 7", i: 6100, p: 35000 },
    { n: "Miner 8", i: 7200, p: 40000 },
    { n: "Miner 9", i: 8500, p: 45000 },
    { n: "Miner 10", i: 9500, p: 50000 }
  ];

  let minersState;
  try {
    const saved = JSON.parse(localStorage.getItem(LS_MINERS));
    if (Array.isArray(saved)) {
      minersState = minersData.map((_, i) => {
        const s = saved[i];
        if (s && typeof s.count === 'number') return { count: s.count };
        return { count: 0 };
      });
    } else {
      minersState = minersData.map(_ => ({ count: 0 }));
    }
  } catch (e) {
    minersState = minersData.map(_ => ({ count: 0 }));
  }

  const miningIncomeValEl = document.getElementById('miningIncomeVal');
  const minersContainerEl = document.querySelector('.miners-container');
  const minersPanelVisible = document.getElementById('minersPanelVisible');
  const miningShop = document.getElementById('miningShop');
  const buyConfirm = document.getElementById('buyConfirm');
  const buyText = document.getElementById('buyText');
  let pendingMiner = null;

  function format(n) {
    return n >= 1e9 ? (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B' :
           n >= 1e6 ? (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M' :
           n >= 1e3 ? (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K' : String(n);
  }

  // TON formatting: always 2 decimals
  function formatTon(n){
    if (!isFinite(n)) return '0.00';
    return Number(n).toFixed(2);
  }
  // expose globally so other modules inside page can use
  window.formatTon = formatTon;

  function save() {
    try {
      localStorage.setItem(LS_COINS, String(coins));
      localStorage.setItem(LS_MAXCOINS, String(maxCoins));
      localStorage.setItem(LS_UPGRADES, JSON.stringify(upgrades));
      localStorage.setItem('check1Expire', check1Expire);
      localStorage.setItem(LS_MINERS, JSON.stringify(minersState));
      localStorage.setItem(LS_LASTTIME, Date.now());
      localStorage.setItem('lang', lang);
      localStorage.setItem('shieldExpire', shieldExpire);
      localStorage.setItem('doubleIncomeExpire', doubleIncomeExpire);
      localStorage.setItem('luckExpire', luckExpire);
      localStorage.setItem(LS_TON, String(ton));
    } catch (e) {
      console.warn('Save failed', e);
    }
  }

 // ========== Withdraw UI implementation (simplified) ==========
  (function(){
    const withdrawBtn = document.getElementById('withdrawBtn');
    const withdrawModal = document.getElementById('withdrawModal');
    const withdrawInput = document.getElementById('withdrawAddressInput');
    const saveAddrBtn = document.getElementById('saveWithdrawAddr');
    const changeAddrBtn = document.getElementById('changeWithdrawAddr');
    const copyAddrBtn = document.getElementById('copyAddrBtn');
    const boundInfo = document.getElementById('boundAddrInfo');
    const withdrawStatus = document.getElementById('withdrawStatus');
    const closeWithdraw = document.getElementById('closeWithdraw');

    function loadBoundAddr(){ return localStorage.getItem(LS_WITHDRAW_ADDR) || ''; }
    function saveBoundAddr(addr){ try{ localStorage.setItem(LS_WITHDRAW_ADDR, addr); }catch(e){} }
    function maskAddr(a){ if(!a) return ''; if(a.length <= 10) return a; return a.slice(0,6) + '...' + a.slice(-6); }

    function renderBoundInfo(){
      const a = loadBoundAddr();
      if(a){
        boundInfo.textContent = 'Привязанный адрес: ' + maskAddr(a);
        if(withdrawInput) withdrawInput.style.display = 'none';
        if(saveAddrBtn) saveAddrBtn.style.display = 'none';
        if(changeAddrBtn) changeAddrBtn.style.display = 'inline-block';
        if(copyAddrBtn) copyAddrBtn.style.display = 'inline-block';
      } else {
        boundInfo.textContent = 'Адрес не привязан.';
        if(withdrawInput) withdrawInput.style.display = 'block';
        if(saveAddrBtn) saveAddrBtn.style.display = 'inline-block';
        if(changeAddrBtn) changeAddrBtn.style.display = 'none';
        if(copyAddrBtn) copyAddrBtn.style.display = 'none';
      }
    }

    function openWithdraw(){
      if (!withdrawModal) return;
      withdrawModal.style.display = 'flex';
      withdrawModal.setAttribute('aria-hidden','false');
      renderBoundInfo();
      updateWithdrawStatus();
    }

    function closeWithdrawModal(){
      if (!withdrawModal) return;
      withdrawModal.style.display = 'none';
      withdrawModal.setAttribute('aria-hidden','true');
    }

    if (withdrawBtn) withdrawBtn.addEventListener('click', openWithdraw);
    if (closeWithdraw) closeWithdraw.addEventListener('click', closeWithdrawModal);

    if (saveAddrBtn) saveAddrBtn.addEventListener('click', ()=>{
      const v = (withdrawInput.value || '').trim();
      if(!v){ alert('Введите адрес'); return; }
      saveBoundAddr(v);
      renderBoundInfo();
      if(withdrawStatus) withdrawStatus.textContent = 'Адрес сохранён.';
      save();
    });

    if (changeAddrBtn) changeAddrBtn.addEventListener('click', ()=>{ 
      if(withdrawInput) withdrawInput.style.display = 'block';
      if(withdrawInput) withdrawInput.value = '';
      if(saveAddrBtn) saveAddrBtn.style.display = 'inline-block';
      if(changeAddrBtn) changeAddrBtn.style.display = 'none';
      if(copyAddrBtn) copyAddrBtn.style.display = 'none';
      if(boundInfo) boundInfo.textContent = 'Введите новый адрес.';
    });

    if (copyAddrBtn) copyAddrBtn.addEventListener('click', ()=>{
      const a = loadBoundAddr();
      if(!a) return;
      navigator.clipboard && navigator.clipboard.writeText(a).then(()=>{ if(withdrawStatus) withdrawStatus.textContent = 'Адрес скопирован.'; }).catch(()=>{ if(withdrawStatus) withdrawStatus.textContent = 'Не удалось скопировать.'; });
    });

    function updateWithdrawStatus(){
      const currentTon = +localStorage.getItem(LS_TON) || ton || 0;
      if(!withdrawStatus) return;
      if(currentTon >= 7){ withdrawStatus.className = 'withdraw-success'; withdrawStatus.textContent = 'Доступно: ' + formatTon(currentTon) + ' TON'; }
      else { withdrawStatus.className = 'withdraw-warning'; withdrawStatus.textContent = 'Недостаточно TON: ' + formatTon(currentTon); }
    }

    renderBoundInfo();
  })();

  // ========== Balances & coins helpers (ensure withdraw UI updates) ==========
  function updateBalancesDisplay(){
    // show coins normally
    if (coinsVal) coinsVal.textContent = format(coins);
    // TON now from independent 'ton' variable (doesn't decrease when spending coins)
    const tonEl = document.getElementById('tonVal');
    if (tonEl) tonEl.textContent = formatTon(ton);
    const wsZex = document.getElementById('wsModalCoinsDisplay');
    if (wsZex) {
      const wsTon = formatTon(ton);
      wsZex.textContent = format(coins) + ' XTR • ' + wsTon + ' TON';
    }
    const casinoBalance = document.getElementById('casinoBalance');
    if (casinoBalance) {
      casinoBalance.textContent = format(coins) + ' XTR • ' + formatTon(ton) + ' TON';
    }
  }

  // When updCoins is called with positive v, we increase coins and also increase TON proportionally.
  // When v is negative (spending), coins decrease but TON stays the same.
  function updCoins(v = 0) {
    if (typeof v !== 'number') v = Number(v) || 0;
    if (v > 0) {
      // earn coins -> also convert earned XTR to TON (so TON only rises on gains)
      const tonGain = v * ZEX_TO_TON;
      ton += tonGain;
    }
    coins += v;
    if (coins < 0) coins = 0;
    if (coins > maxCoins) maxCoins = coins;
    updateBalancesDisplay();
    updUpg();
    updIncome();
    save();
  }

  function getIncome() {
    const base = minersState.reduce((sum, m, i) => {
      const count = (m && typeof m.count === 'number') ? m.count : 0;
      return sum + (count > 0 ? Math.floor(minersData[i].i * Math.pow(1.5, count - 1)) : 0);
    }, 0);
    if (doubleIncomeExpire > Date.now()) return base * 2;
    return base;
  }
  function updIncome() { if (miningIncomeValEl) miningIncomeValEl.textContent = format(getIncome()); }

  // ===== offline gains & income tick =====
  function addOfflineCoins() {
    const last = +localStorage.getItem(LS_LASTTIME) || Date.now();
    const now = Date.now();
    const diffMinutes = (now - last) / 60000;
    if (diffMinutes > 0) {
      const minutesToAward = Math.min(diffMinutes, 180);
      const perMin = Math.floor(getIncome()/60);
      if(perMin > 0) updCoins(perMin * minutesToAward);
    }
    localStorage.setItem(LS_LASTTIME, now);
  }
  addOfflineCoins();

  // income per second (approx)
  setInterval(()=>{ updCoins(Math.floor(getIncome()/3600)); }, 1000);

  // ===== upgrades UI =====
  function updUpg() {
    document.querySelectorAll('.upgrade').forEach(u => {
      let key = u.dataset.key; let base = +u.dataset.basePrice; let count = upgrades[key] || 0;
      let price = base * Math.pow(2,count);
      let priceEl = u.querySelector('.price'); if (priceEl) priceEl.textContent = format(price);
      const badge = u.querySelector('.badge'); if (badge) badge.textContent = count > 0 ? `Lvl ${count}` : 'New';
    });
  }

  document.querySelectorAll('.upgrade').forEach(u=>{
    u.onclick = ()=>{
      let key = u.dataset.key; let base = +u.dataset.basePrice; let count = upgrades[key]||0;
      let price = base * Math.pow(2,count);
      if (coins >= price) {
        upgrades[key] = count+1; updCoins(-price);
        if (key === 'check1') check1Expire = Date.now()+60000;
        if (key === 'shield') shieldExpire = Date.now()+60000;
        if (key === 'incBoost') doubleIncomeExpire = Date.now()+60000;
        if (key === 'luck') luckExpire = Date.now()+60000;
        save(); updUpg();
      } else alert(t('notEnough'));
    };
  });

  function updTimers() {
    const el = document.getElementById('check1Timer');
    if (el) {
      if (check1Expire > Date.now()) el.textContent = '⏳ ' + Math.floor((check1Expire - Date.now())/1000) + 's';
      else el.textContent = '';
    }
    const shEl = document.getElementById('shieldTimer');
    if (shEl) {
      if (shieldExpire > Date.now()) shEl.textContent = '⏳ ' + Math.floor((shieldExpire - Date.now())/1000) + 's';
      else shEl.textContent = '';
    }
    const incEl = document.getElementById('incTimer');
    if (incEl) {
      if (doubleIncomeExpire > Date.now()) incEl.textContent = '⏳ ' + Math.floor((doubleIncomeExpire - Date.now())/1000) + 's';
      else incEl.textContent = '';
    }
    const luckEl = document.getElementById('luckTimer');
    if (luckEl) {
      if (luckExpire > Date.now()) luckEl.textContent = '⏳ ' + Math.floor((luckExpire - Date.now())/1000) + 's';
      else luckEl.textContent = '';
    }
  }
  setInterval(updTimers, 1000);

  document.querySelectorAll('.room').forEach(r => {
    r.onclick = () => {
      if (roundInProgress) return;
      document.querySelectorAll('.room').forEach(x=>x.classList.remove('selected'));
      r.classList.add('selected');
      selectedRoom = +r.dataset.idx;
    };
  });

  document.getElementById('startBtn').onclick = ()=>{
    if (selectedRoom == null) { alert(t('pickRoomFirst')); return; }
    document.querySelectorAll('.room').forEach(r=>r.classList.remove('found','safe'));
  };

  document.getElementById('resetBtn').onclick = ()=>{
    if (selectedRoom == null) { alert(t('pickRoomFirst')); return; }
    if (!consumeEnergyOne()) return;
    roundInProgress = true;
    const numPicks = (check1Expire > Date.now()) ? 1 : 2;
    let picks = [...Array(8).keys()].sort(()=>0.5-Math.random()).slice(0,numPicks);
    document.querySelectorAll('.room').forEach(r=>r.classList.remove('found','safe','highlight'));
    let delay = 0;
    picks.forEach(i=>{
      let room = document.querySelector(`.room[data-idx="${i}"]`);
      setTimeout(()=>{ room.classList.add('highlight'); }, delay);
      setTimeout(()=>{ room.classList.remove('highlight'); }, delay+600);
      delay += 700;
    });
    setTimeout(()=>{
      let prize = 1000, loss = -2000;
      if (upgrades.x2Prize > 0) { prize *= Math.pow(2, upgrades.x2Prize); loss *= Math.pow(2, upgrades.x2Prize); }

      const roomEl = document.querySelector(`.room[data-idx="${selectedRoom}"]`);

      if (picks.includes(selectedRoom)) {
        if (shieldExpire > Date.now()) {
          roomEl.classList.add('safe');
          updCoins(0);
        } else if (luckExpire > Date.now() && Math.random() < 0.5) {
          roomEl.classList.add('safe');
          updCoins(prize);
        } else {
          const room = document.querySelector(`.room[data-idx="${selectedRoom}"]`);
          room.classList.add('found');
          updCoins(loss);
        }
      } else {
        const room = document.querySelector(`.room[data-idx="${selectedRoom}"]`);
        room.classList.add('safe');
        updCoins(prize);
      }
      selectedRoom = null;
      document.querySelectorAll('.room').forEach(r=>r.classList.remove('selected'));
      roundInProgress = false;
    }, delay+700);
  };

  // render miners
  function renderMiners(){
    if (!minersContainerEl) return;
    minersContainerEl.innerHTML = '';
    minersData.forEach((m,i)=>{
      const st = (minersState[i] && typeof minersState[i].count === 'number') ? minersState[i] : { count: 0 };
      const price = m.p * Math.pow(2, st.count);
      const income = st.count > 0 ? Math.floor(m.i * Math.pow(1.5, st.count - 1)) : 0;

      const card = document.createElement('div'); card.className = 'miner-card';
      card.innerHTML = `
        <img class="card-logo" src="logo.png" alt="logo" />
        <h3>${m.n}</h3>
        <div class="income">+${format(income)} / hr</div>
        <div class="bottom">
          <span class="lvl">Lvl ${st.count}</span>
          <span class="price-pill">${format(price)}</span>
        </div>
      `;
      card.onclick = ()=>{
        const currentSt = (minersState[i] && typeof minersState[i].count === 'number') ? minersState[i] : { count: 0 };
        const currentPrice = m.p * Math.pow(2, currentSt.count);
        if (coins >= currentPrice) {
          pendingMiner = i;
          buyText.textContent = t('buyFor', { name: m.n, price: format(currentPrice) });
          buyConfirm.classList.add('show'); buyConfirm.style.display = 'block'; buyConfirm.setAttribute('aria-hidden','false');
        } else { alert(t('notEnough')); }
      };
      minersContainerEl.appendChild(card);
    });
  }

  const miningBtn = document.getElementById('miningBtn');
  const shopBtn = document.getElementById('shopBtn'); // may be null (we removed the button)
  if (miningBtn) miningBtn.onclick = () => { if (miningShop) { miningShop.style.display = 'block'; miningShop.setAttribute('aria-hidden','false'); renderMiners(); } };
  if (shopBtn) shopBtn.onclick = () => { if (miningShop) { miningShop.style.display = 'block'; miningShop.setAttribute('aria-hidden','false'); renderMiners(); } };
  const closeMiningShopBtn = document.getElementById('closeMiningShop');
  if (closeMiningShopBtn) closeMiningShopBtn.onclick = ()=>{ if (miningShop) { miningShop.style.display = 'none'; miningShop.setAttribute('aria-hidden','true'); } };

  // Added: top-right close button for mining shop
  const closeMiningShopTop = document.getElementById('closeMiningShopTop');
  if (closeMiningShopTop) closeMiningShopTop.addEventListener('click', ()=>{ if (miningShop) { miningShop.style.display = 'none'; miningShop.setAttribute('aria-hidden','true'); } });

  document.getElementById('confirmBuy') && (document.getElementById('confirmBuy').onclick = ()=>{
    if (pendingMiner === null) return;
    const i = pendingMiner; const m = minersData[i]; const st = minersState[i] || { count: 0 };
    const price = m.p * Math.pow(2, st.count);
    if (coins >= price) {
      coins -= price; minersState[i] = { count: (st.count || 0) + 1 }; updCoins(0); save(); renderMiners();
    } else alert(t('notEnough'));
    pendingMiner = null;
    buyConfirm.classList.remove('show'); buyConfirm.style.display = 'none'; buyConfirm.setAttribute('aria-hidden','true');
  });
  document.getElementById('cancelBuy') && (document.getElementById('cancelBuy').onclick = ()=>{ pendingMiner = null; buyConfirm.classList.remove('show'); buyConfirm.style.display = 'none'; buyConfirm.setAttribute('aria-hidden','true'); });

  // profile window
  const profileWindowEl = document.getElementById('profileWindow');
  const profileBtnEl = document.getElementById('profileBtn');
  if (profileBtnEl) profileBtnEl.onclick = ()=>{ if (profileWindowEl) { profileWindowEl.style.display = 'block'; profileWindowEl.setAttribute('aria-hidden','false'); } };
  const closeProfileBtn = document.getElementById('closeProfile');
  if (closeProfileBtn) closeProfileBtn.onclick = ()=>{ if (profileWindowEl) { profileWindowEl.style.display = 'none'; profileWindowEl.setAttribute('aria-hidden','true'); } };

  // daily & quest
  let questClaimed = localStorage.getItem('questClaimed') === 'true';
  let lastDaily = +localStorage.getItem('lastDaily') || 0;
  const questStatusEl = document.getElementById('questStatus');
  const dailyStatusEl = document.getElementById('dailyStatus');
  function updateQuestStatus(){ if (questStatusEl) questStatusEl.textContent = questClaimed ? "✅ Completed" : "❌ Not claimed"; }
  function updateDailyStatus(){ if (dailyStatusEl) { const now = Date.now(); const nextAvailable = lastDaily + 24*60*60*1000; if (now >= nextAvailable) dailyStatusEl.textContent = "💰 Available!"; else { const diff = nextAvailable - now; const hours = Math.floor(diff / (1000*60*60)); const minutes = Math.floor((diff % (1000*60*60)) / (1000*60)); dailyStatusEl.textContent = `Next in ${hours}h ${minutes}m`; } } }
  setInterval(updateDailyStatus, 60000); updateDailyStatus(); updateQuestStatus();

  document.getElementById('claimQuest') && (document.getElementById('claimQuest').onclick = ()=>{ if (questClaimed) alert(t('questAlready')); else { updCoins(50000); questClaimed = true; localStorage.setItem('questClaimed','true'); updateQuestStatus(); } });
  document.getElementById('claimDaily') && (document.getElementById('claimDaily').onclick = ()=>{ const now = Date.now(); if (now - lastDaily < 24*60*60*1000) alert(t('dailyAlready')); else { updCoins(30000); lastDaily = now; localStorage.setItem('lastDaily', now); updateDailyStatus(); } });

  // NEW: Telegram subscribe quest logic
  let tgSubscribeClaimed = localStorage.getItem('tgSubscribeClaimed') === 'true';
  const tgStatusEl = document.getElementById('tgQuestStatus');
  function updateTgQuestStatus(){ if (tgStatusEl) tgStatusEl.textContent = tgSubscribeClaimed ? "✅ Completed" : "❌ Not claimed"; }
  const claimTgBtn = document.getElementById('claimTgSubscribe');
  const openTgBtn = document.getElementById('openTgChannel');
  if (claimTgBtn) claimTgBtn.addEventListener('click', ()=>{
    if (tgSubscribeClaimed) { alert(t('questAlready')); return; }
    tgSubscribeClaimed = true;
    localStorage.setItem('tgSubscribeClaimed','true');
    try { updCoins(25000); } catch(e){ console.warn('updCoins missing', e); }
    updateTgQuestStatus();
  });
  if (openTgBtn) openTgBtn.addEventListener('click', ()=>{ /* anchor handles */ });
  updateTgQuestStatus();

  // info window
  const infoWindowEl = document.getElementById('infoWindow');
  const infoBtn = document.getElementById('infoBtn');
  if (infoBtn) infoBtn.onclick = ()=>{ if (infoWindowEl) { infoWindowEl.style.display = 'block'; infoWindowEl.setAttribute('aria-hidden','false'); } };
  const closeInfoBtn = document.getElementById('closeInfo');
  if (closeInfoBtn) closeInfoBtn.onclick = ()=>{ if (infoWindowEl) { infoWindowEl.style.display = 'none'; infoWindowEl.setAttribute('aria-hidden','true'); } };

  // shop toggle & UI init
  const upgradePanel = document.getElementById('upgradePanel');
  if (minersPanelVisible) minersPanelVisible.style.display = 'none';
  if (upgradePanel) upgradePanel.style.display = 'flex';

  const langSelect = document.getElementById('langSelect');
  if (langSelect) {
    langSelect.value = lang;
    langSelect.onchange = ()=>{ lang = langSelect.value; localStorage.setItem('lang', lang); applyLang(); renderMiners(); renderCards && renderCards(); };
  }

  // init
  loadEnergy();
  updateBalancesDisplay();
  updUpg();
  updIncome();
  updTimers();
  renderMiners();
  applyLang();

  document.getElementById('infoWindow') && (document.getElementById('infoWindow').style.display = 'none');
  document.getElementById('infoWindow') && (document.getElementById('infoWindow').setAttribute('aria-hidden','true'));
  document.getElementById('profileWindow') && (document.getElementById('profileWindow').style.display = 'none');
  document.getElementById('profileWindow') && (document.getElementById('profileWindow').setAttribute('aria-hidden','true'));
  if (buyConfirm) { buyConfirm.style.display = 'none'; buyConfirm.setAttribute('aria-hidden','true'); }

  /* ===========================
  Rewards modal logic (uses XTR label)
  ============================ */
  (function(){
    const LS_FIRST = 'ws_first_seen_v2';
    const LS_CLAIMED = 'ws_claimed_v2';
    const MAX_DAYS = 7;
    const amounts = [30000,100000,500000,1000000,3000000,6000000,10000000];

    function safeGetJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        const v = JSON.parse(raw);
        return v;
      }catch(e){ return fallback; }
    }
    function safeSetJSON(key, obj){
      try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
    }

    let firstSeen = +localStorage.getItem(LS_FIRST) || 0;
    if(!firstSeen || isNaN(firstSeen)){
      firstSeen = Date.now();
      try{ localStorage.setItem(LS_FIRST, String(firstSeen)); }catch(e){}
    }

    let claimed = safeGetJSON(LS_CLAIMED, null);
    if(!Array.isArray(claimed) || claimed.length !== MAX_DAYS){
      claimed = new Array(MAX_DAYS).fill(false);
      safeSetJSON(LS_CLAIMED, claimed);
    }

    function daysSinceFirst(){
      const now = Date.now();
      const diffDays = Math.floor((now - firstSeen) / (24*60*60*1000));
      return diffDays;
    }
    function availableCount(){
      return Math.min(MAX_DAYS, daysSinceFirst() + 1);
    }

    function formatFallback(n){
      if (n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
      if (n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
      if (n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
      return String(n);
    }

    function updCoinsPublic(v=0){
      try{
        let cur = +localStorage.getItem(LS_COINS) || 0;
        cur += v;
        if(cur < 0) cur = 0;
        localStorage.setItem(LS_COINS, String(cur));
        const el = document.getElementById('coinsVal');
        if(el) el.textContent = formatFallback(cur);
        // TON: when gaining coins, we also increase TON proportionally here
        let storedTon = +localStorage.getItem(LS_TON) || 0;
        if (v > 0) storedTon += v * ZEX_TO_TON;
        localStorage.setItem(LS_TON, String(storedTon));
        const tonEl = document.getElementById('tonVal');
        if (tonEl) tonEl.textContent = formatTon(storedTon);
      }catch(e){}
    }

    function saveGameStatePublic(){
      try{
        const coinsVal = localStorage.getItem(LS_COINS) || '0';
        localStorage.setItem(LS_COINS, coinsVal);
        safeSetJSON(LS_CLAIMED, claimed);
        localStorage.setItem(LS_FIRST, String(firstSeen));
      }catch(e){}
    }

    function claimRewardFromModalPublic(amount){
      try{
        // use general updCoins if present
        if (typeof window.updCoins === 'function') {
          window.updCoins(amount);
        } else {
          let cur = +localStorage.getItem(LS_COINS) || 0;
          cur += amount;
          localStorage.setItem(LS_COINS, String(cur));
          const cv = document.getElementById('coinsVal');
          if(cv) cv.textContent = formatFallback(cur);
          // also increase TON when gaining XTR
          let storedTon = +localStorage.getItem(LS_TON) || 0;
          storedTon += amount * ZEX_TO_TON;
          localStorage.setItem(LS_TON, String(storedTon));
          const tonEl = document.getElementById('tonVal');
          if (tonEl) tonEl.textContent = formatTon(storedTon);
        }
        saveGameStatePublic();
      }catch(e){}
    }

    window.claimRewardFromModal = window.claimRewardFromModal || claimRewardFromModalPublic;
    window.updCoins = window.updCoins || updCoinsPublic;
    window.saveGameState = window.saveGameState || saveGameStatePublic;
    window.format = window.format || formatFallback;

    const updCoins = window.updCoins;
    const claimRewardFromModal = window.claimRewardFromModal;
    const saveGameState = window.saveGameState;
    const formatNum = window.format;

    const overlay = document.getElementById('wsModalOverlay');
    const gridTop = document.getElementById('rewardsGridTop');
    const gridBottom = document.getElementById('rewardsGridBottom');
    const unlockedCountEl = document.getElementById('wsUnlockedCount');
    const coinsDisplayEl = document.getElementById('wsModalCoinsDisplay');
    const btnClose = document.getElementById('wsBtnClose');
    const btnRules = document.getElementById('wsBtnRules');

    const hiddenTargets = [];
    function hideMainUI(){
      const bodyChildren = Array.from(document.body.children);
      bodyChildren.forEach(ch=>{ if (ch === overlay) return; const prev = ch.style.display || ''; hiddenTargets.push({el: ch, prev}); ch.style.display = 'none'; });
      overlay.classList.remove('hidden');
    }
    function showMainUI(){
      hiddenTargets.forEach(item=>{ try{ item.el.style.display = item.prev || ''; }catch(e){} });
      hiddenTargets.length = 0;
      overlay.classList.add('hidden');
    }

    function renderCards(){
      claimed = safeGetJSON(LS_CLAIMED, claimed) || claimed;

      const avail = availableCount();
      gridTop.innerHTML = '';
      gridBottom.innerHTML = '';

      for(let i=0;i<MAX_DAYS;i++){
        const day = i+1;
        const amount = amounts[i] || 0;
        const card = document.createElement('div');
        card.className = 'rewardCard';
        if (day === 7) card.classList.add('big');

        card.innerHTML = `
          <div class="coinIconSmall">💰</div>
          <div class="dayLabel">${t('dayLabel') || 'Day'} ${day}</div>
          <div class="amount">${formatNum(amount)}</div>
        `;

        const isUnlocked = i < avail;
        const isClaimed = !!claimed[i];

        if(isClaimed){
          card.classList.add('claimed');
          const badge = document.createElement('div');
          badge.className = 'claimBadge';
          badge.textContent = t('claimed') || 'Claimed';
          card.appendChild(badge);
        } else if(isUnlocked){
          card.classList.add('unlocked');
        } else {
          card.classList.add('locked');
        }

        card.addEventListener('click', function onCardClick(){
          claimed = safeGetJSON(LS_CLAIMED, claimed) || claimed;
          const nowClaimed = !!claimed[i];
          const nowAvail = i < availableCount();
          if (!nowAvail || nowClaimed) return;

          card.style.pointerEvents = 'none';
          card.classList.add('pop');
          setTimeout(()=>card.classList.remove('pop'),260);

          claimed[i] = true;
          safeSetJSON(LS_CLAIMED, claimed);

          try {
            if (typeof claimRewardFromModal === 'function') {
              claimRewardFromModal(amounts[i]);
            } else if (typeof updCoins === 'function') {
              updCoins(amounts[i]);
            } else {
              let cur = +localStorage.getItem(LS_COINS) || 0;
              cur += amounts[i];
              localStorage.setItem(LS_COINS, String(cur));
              const mainEl = document.getElementById('coinsVal');
              if (mainEl) mainEl.textContent = formatNum(cur);
            }
            saveGameStatePublic();
          } catch(e){
            console.error('claimReward error', e);
            try { updCoinsPublic(amounts[i]); } catch(e2){}
          }

          const badge = document.createElement('div');
          badge.className = 'claimBadge';
          badge.textContent = t('claimed') || 'Claimed';
          card.appendChild(badge);
          card.classList.remove('unlocked');
          card.classList.add('claimed');
          card.style.pointerEvents = 'none';

          syncCoinsDisplay();
          renderUnlockedCount();
        });

        if(i < 4) gridTop.appendChild(card);
        else gridBottom.appendChild(card);
      }

      renderUnlockedCount();
    }

    function renderUnlockedCount(){
      const avail = availableCount();
      const unlockedNow = Math.min(avail, MAX_DAYS);
      unlockedCountEl.textContent = String(unlockedNow);
    }

    function syncCoinsDisplay(){
      const coinsLocal = +localStorage.getItem(LS_COINS) || 0;
      const tonLocal = +localStorage.getItem(LS_TON) || 0;
      coinsDisplayEl.textContent = formatNum(coinsLocal) + ' XTR • ' + formatTon(tonLocal) + ' TON';
      const mainEl = document.getElementById('coinsVal');
      if (mainEl) mainEl.textContent = formatNum(coinsLocal);
      const tonEl = document.getElementById('tonVal');
      if (tonEl) tonEl.textContent = formatTon(tonLocal);
    }

    if (btnClose) btnClose.addEventListener('click', function(){
      showMainUI();
      saveGameState();
    });

    if (btnRules) btnRules.addEventListener('click', function(){
      alert(t('wsBtnRules') ? t('wsBtnRules') + ': ' + (t('wsSub') || '') : 'Rewards unlock one per day since first visit. Click an unlocked card to claim its coins.');
    });

    hideMainUI();
    renderCards();
    syncCoinsDisplay();

    setInterval(()=>{ renderCards(); syncCoinsDisplay(); }, 60*1000);

    window._wsModal = {
      open: function(){ hideMainUI(); renderCards(); syncCoinsDisplay(); },
      close: function(){ showMainUI(); saveGameState(); },
      getState: function(){ return { firstSeen, claimed: claimed.slice(), available: availableCount() }; },
      forceResetClaims: function(){ claimed = new Array(MAX_DAYS).fill(false); safeSetJSON(LS_CLAIMED,claimed); renderCards(); }
    };

    overlay.tabIndex = -1;
  })();

  /* ===========================
  Casino modal & logic (XTR labels)
  ============================ */
  (function(){
    const casinoBtn = document.getElementById('casinoBtn');
    const casinoModal = document.getElementById('casinoModal');
    const closeCasino = document.getElementById('closeCasino');
    const spinBtn = document.getElementById('spinBtn');
    const casinoCooldownEl = document.getElementById('casinoCooldown');
    const casinoResultEl = document.getElementById('casinoResult');
    const casinoBalanceEl = document.getElementById('casinoBalance');
    const wheelCanvas = document.getElementById('wheelCanvas');
    const ctx = wheelCanvas.getContext('2d');

    const segments = [
      { label: '100K XTR', type: 'zex', value: 100000 },
      { label: '0.10 TON', type: 'ton', value: 0.10 },
      { label: '5K XTR', type: 'zex', value: 5000 },
      { label: '0.50 TON', type: 'ton', value: 0.50 },
      { label: '10K XTR', type: 'zex', value: 10000 },
      { label: '1 TON', type: 'ton', value: 1 },
      { label: '50K XTR', type: 'zex', value: 50000 },
      { label: '0.20 TON', type: 'ton', value: 0.20 },
      { label: '1K XTR', type: 'zex', value: 1000 },
      { label: '2 TON', type: 'ton', value: 2 }
    ];

    const SEG_COUNT = segments.length;
    const COOL_KEY = 'casino_last_spin_v2';
    const COOLDOWN_MS = 2 * 60 * 60 * 1000;

    let rotation = 0;
    let isSpinning = false;

    function drawWheel(){
      const w = wheelCanvas.width;
      const h = wheelCanvas.height;
      const cx = w/2;
      const cy = h/2;
      const radius = Math.min(cx,cy) - 8;
      ctx.clearRect(0,0,w,h);
      const anglePer = 2*Math.PI / SEG_COUNT;
      for(let i=0;i<SEG_COUNT;i++){
        const start = i*anglePer - Math.PI/2;
        const end = start + anglePer;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,radius,start,end);
        ctx.closePath();
        ctx.fillStyle = (i%2===0) ? 'rgba(255,255,255,0.04)' : 'rgba(255,255,255,0.02)';
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.06)';
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.save();
        const textAngle = start + anglePer/2;
        ctx.translate(cx + Math.cos(textAngle)*(radius*0.66), cy + Math.sin(textAngle)*(radius*0.66));
        ctx.rotate(textAngle + Math.PI/2);
        ctx.fillStyle = '#ecf8ff';
        ctx.font = 'bold 22px Inter, system-ui, Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(segments[i].label, 0, 0);
        ctx.restore();
      }

      ctx.beginPath();
      ctx.arc(cx,cy,60,0,2*Math.PI);
      ctx.fillStyle = 'rgba(0,0,0,0.18)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.04)';
      ctx.stroke();
    }

    function render(){
      wheelCanvas.style.transform = `rotate(${rotation}deg)`;
    }

    function getRandomSegmentIndex(){
      return Math.floor(Math.random()*SEG_COUNT);
    }

    function angleForIndex(i){
      const anglePerDeg = 360 / SEG_COUNT;
      const center = i * anglePerDeg + anglePerDeg/2;
      return (360 - center) % 360;
    }

    function spinToIndex(i){
      if (isSpinning) return;
      isSpinning = true;
      spinBtn.disabled = true;
      const baseSpins = 6;
      const targetAngle = angleForIndex(i);
      const randomOffset = (Math.random()*15) - 7.5;
      const finalAngle = baseSpins*360 + targetAngle + randomOffset;
      const duration = 5000 + Math.random()*1000;
      const start = performance.now();
      const from = rotation % 360;
      const to = rotation + finalAngle;
      function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }
      function step(now){
        const elapsed = now - start;
        const p = Math.min(1, elapsed / duration);
        const eased = easeOutCubic(p);
        rotation = from + (to - from) * eased;
        render();
        if(p < 1) requestAnimationFrame(step);
        else {
          isSpinning = false;
          spinBtn.disabled = false;
          const landed = ((360 - (rotation % 360)) + 360) % 360;
          const anglePerDeg = 360 / SEG_COUNT;
          let idx = Math.floor((landed) / anglePerDeg);
          idx = (idx + SEG_COUNT) % SEG_COUNT;
          announcePrize(idx);
        }
      }
      requestAnimationFrame(step);
    }

    function announcePrize(idx){
      const seg = segments[idx];
      if(!seg) return;
      let text = '';
      if(seg.type === 'zex'){
        const amount = Math.round(seg.value);
        try{
          if(typeof window.updCoins === 'function') window.updCoins(amount);
          else {
            let cur = +localStorage.getItem(LS_COINS) || 0;
            cur += amount;
            localStorage.setItem(LS_COINS, String(cur));
            // TON increases on positive XTR gain
            let storedTon = +localStorage.getItem(LS_TON) || 0;
            storedTon += amount * ZEX_TO_TON;
            localStorage.setItem(LS_TON, String(storedTon));
          }
        }catch(e){
          let cur = +localStorage.getItem(LS_COINS) || 0;
          cur += amount;
          localStorage.setItem(LS_COINS, String(cur));
          let storedTon = +localStorage.getItem(LS_TON) || 0;
          storedTon += amount * ZEX_TO_TON;
          localStorage.setItem(LS_TON, String(storedTon));
        }
        text = `+${format(amount)} XTR`;
      } else {
        const tonAmount = seg.value;
        try{
          ton += tonAmount;
          localStorage.setItem(LS_TON, String(ton));
        }catch(e){
          let storedTon = +localStorage.getItem(LS_TON) || 0;
          storedTon += tonAmount;
          localStorage.setItem(LS_TON, String(storedTon));
        }
        text = `+${tonAmount.toFixed(2)} TON`;
      }
      casinoResultEl.textContent = text;
      updateCasinoBalanceDisplay();
      localStorage.setItem(COOL_KEY, String(Date.now()));
      updateCooldownDisplay();
      // persist coins & ton
      localStorage.setItem(LS_COINS, String(coins));
      localStorage.setItem(LS_TON, String(ton));
    }

    function updateCasinoBalanceDisplay(){
      const c = +localStorage.getItem(LS_COINS) || coins || 0;
      const tLocal = +localStorage.getItem(LS_TON) || ton || 0;
      if (casinoBalanceEl) casinoBalanceEl.textContent = format(c) + ' XTR • ' + formatTon(tLocal) + ' TON';
      const mainEl = document.getElementById('coinsVal');
      if(mainEl) mainEl.textContent = format(c);
      const tonEl = document.getElementById('tonVal');
      if(tonEl) tonEl.textContent = formatTon(tLocal);
    }

    function updateCooldownDisplay(){
      const last = +localStorage.getItem(COOL_KEY) || 0;
      const now = Date.now();
      const diff = now - last;
      if(last === 0 || diff >= COOLDOWN_MS){
        casinoCooldownEl.textContent = t('ready') || 'Ready';
        spinBtn.disabled = false;
      } else {
        const rem = COOLDOWN_MS - diff;
        const hours = Math.floor(rem / (1000*60*60));
        const minutes = Math.floor((rem % (1000*60*60)) / (1000*60));
        const seconds = Math.floor((rem % (1000*60)) / 1000);
        casinoCooldownEl.textContent = `${hours}h ${minutes}m ${seconds}s`;
        spinBtn.disabled = true;
      }
    }

    if (casinoBtn) casinoBtn.addEventListener('click', ()=>{
      if (casinoModal) { casinoModal.style.display = 'flex'; casinoModal.setAttribute('aria-hidden','false'); updateCasinoBalanceDisplay(); updateCooldownDisplay(); }
    });
    if (closeCasino) closeCasino.addEventListener('click', ()=>{ if (casinoModal) { casinoModal.style.display = 'none'; casinoModal.setAttribute('aria-hidden','true'); } });

    if (spinBtn) spinBtn.addEventListener('click', ()=>{
      const last = +localStorage.getItem(COOL_KEY) || 0;
      const now = Date.now();
      if(last && now - last < COOLDOWN_MS){
        updateCooldownDisplay();
        return;
      }
      const idx = getRandomSegmentIndex();
      spinToIndex(idx);
    });

    drawWheel();
    render();
    setInterval(updateCooldownDisplay, 1000);

    function format(n){
      if(typeof window.format === 'function') return window.format(n);
      if(n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
      if(n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
      if(n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
      return String(n);
    }

    window._casino = {
      open: ()=>{ if (casinoModal) { casinoModal.style.display = 'flex'; casinoModal.setAttribute('aria-hidden','false'); updateCasinoBalanceDisplay(); updateCooldownDisplay(); } },
      close: ()=>{ if (casinoModal) { casinoModal.style.display = 'none'; casinoModal.setAttribute('aria-hidden','true'); } },
      lastSpin: ()=>+localStorage.getItem(COOL_KEY) || 0
    };
  })();
</script>
</body>
</html>
