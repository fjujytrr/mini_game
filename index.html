<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nebula Vault — Offline Idle Arcade (Single File)</title>
  <meta name="theme-color" content="#12131a" />
  <style>
    /* =============================================================
       NEBULA VAULT — OFFLINE IDLE ARCADE (NO SERVERS)
       All-in-one CSS (modern, minimal, mobile-first)
       ============================================================= */

    :root {
      --bg-0: #0b0d12;        /* deep space */
      --bg-1: #11131b;        /* panels */
      --bg-2: #171a24;        /* cards */
      --ink-0: #eef3ff;       /* primary text */
      --ink-1: #a3b0d0;       /* secondary text */
      --ink-2: #6f7ba0;       /* tertiary text */
      --acc-a: #69d6ff;       /* cyan */
      --acc-b: #8a7dff;       /* violet */
      --acc-c: #00ffaa;       /* mint */
      --acc-d: #ff4d8b;       /* magenta */
      --gold: #ffd86b;
      --warn: #ffae4d;
      --bad: #ff5a63;
      --good: #65ff9b;
      --glass: rgba(255,255,255,.06);
      --glass-2: rgba(255,255,255,.08);
      --shadow-a: 0 10px 30px rgba(0,0,0,.35);
      --shadow-b: 0 6px 20px rgba(0,0,0,.28);
      --r: 16px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink-0);
      background: radial-gradient(1200px 800px at 70% -20%, #1c1940 0%, #10131b 50%, #0b0d12 100%);
      overflow: hidden; /* main app uses internal scroll */
    }

    /* App shell */
    .app { display: grid; grid-template-rows: auto 1fr auto; min-height: 100vh; }

    header.appbar {
      position: sticky; top: 0; z-index: 40; padding: 10px 12px; backdrop-filter: blur(8px) saturate(1.1);
      background: linear-gradient(180deg, rgba(12,14,20,.65), rgba(12,14,20,.35));
      border-bottom: 1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow-b);
    }

    .toprow { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; }
    .brand { display: flex; gap: 10px; align-items: center; font-weight: 900; letter-spacing: .2px; }
    .brand .logo { width: 36px; height: 36px; border-radius: 10px; display: grid; place-items: center; background: linear-gradient(135deg, var(--acc-a), var(--acc-b)); box-shadow: 0 10px 24px rgba(138,125,255,.25); }
    .brand .name { font-size: 18px; }

    .wallet { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    .pill { display: inline-flex; gap: 8px; align-items: center; padding: 8px 10px; border-radius: 999px; font-weight: 800; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); }
    .pill .ico { font-size: 16px; }
    .pill .val { min-width: 48px; text-align: right; color: var(--gold); }
    .pill.energy .val { color: var(--acc-c); }
    .pill.gems .val { color: #9ad3ff; }

    .subrow { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 8px; }
    .progress { height: 8px; background: rgba(255,255,255,.06); border-radius: 999px; overflow: hidden; }
    .progress > i { display: block; height: 100%; width: 40%; background: linear-gradient(90deg, var(--acc-a), var(--acc-b)); box-shadow: 0 6px 16px rgba(105,214,255,.35) inset; border-radius: 999px; }
    .lvl { font-weight: 900; color: var(--acc-a); }

    /* Main */
    main { position: relative; overflow: hidden; }
    .view {
      position: absolute; inset: 0; overflow: auto; padding: 14px; display: none;
      background: transparent; /* pages share background */
    }
    .view.active { display: block; }

    /* tabs */
    nav.tabs { position: sticky; bottom: 0; z-index: 45; background: rgba(14,16,24,.82); backdrop-filter: blur(10px) saturate(1.1); border-top: 1px solid rgba(255,255,255,.06); }
    .tabs .row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; padding: 8px; }
    .tabbtn { background: transparent; border: none; color: var(--ink-1); font-weight: 800; padding: 10px 8px; border-radius: 12px; display: grid; place-items: center; gap: 6px; cursor: pointer; }
    .tabbtn i { font-size: 18px; }
    .tabbtn.active { color: var(--ink-0); background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); }

    /* Cards & grids */
    .grid { display: grid; gap: 12px; }
    .grid.cols2 { grid-template-columns: repeat(2, 1fr); }
    .grid.cols3 { grid-template-columns: repeat(3, 1fr); }
    .grid.cols4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 920px){ .grid.cols4{ grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 720px){ .grid.cols4, .grid.cols3{ grid-template-columns: repeat(2, 1fr); } }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--r);
      padding: 12px; box-shadow: var(--shadow-a);
    }
    .card .title { font-weight: 900; margin-bottom: 6px; color: #e9f2ff; }
    .card .muted { color: var(--ink-1); font-weight: 600; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-weight: 900; border: none; border-radius: 12px; padding: 10px 12px; cursor: pointer; }
    .btn.primary { background: linear-gradient(90deg, var(--acc-a), var(--acc-b)); color: #061019; box-shadow: 0 10px 30px rgba(138,125,255,.22); }
    .btn.ghost { background: transparent; color: var(--ink-0); border: 1px solid rgba(255,255,255,.08); }
    .btn.warn { background: linear-gradient(90deg, #ffc371, #ff5f6d); color: #1a0f0f; }

    .row { display: flex; align-items: center; gap: 10px; }
    .row.space { justify-content: space-between; }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 8px; border: 1px solid rgba(255,255,255,.08); }

    .tag { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.04); }

    /* Animations */
    .pop { animation: pop .18s ease; }
    @keyframes pop { 0%{ transform: scale(1) } 50%{ transform: scale(1.06) } 100%{ transform: scale(1) } }

    .shine { position: relative; overflow: hidden; }
    .shine::after { content: ""; position: absolute; inset: 0; background: linear-gradient(120deg, transparent 40%, rgba(255,255,255,.12), transparent 60%); transform: translateX(-100%); animation: shine 2.4s ease infinite; }
    @keyframes shine { to { transform: translateX(100%) } }

    /* Toasts */
    .toasts { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); display: grid; gap: 8px; z-index: 999; }
    .toast { background: rgba(14,16,24,.88); border: 1px solid rgba(255,255,255,.08); padding: 10px 14px; border-radius: 12px; box-shadow: var(--shadow-b); font-weight: 800; }

    /* Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 200; }
    .modal.show { display: flex; }
    .modal .layer { position: absolute; inset: 0; background: rgba(0,0,0,.6); backdrop-filter: blur(4px); }
    .modal .box { position: relative; width: min(920px, 94vw); max-height: 86vh; overflow: auto; background: var(--bg-1); border: 1px solid rgba(255,255,255,.08); border-radius: 18px; box-shadow: var(--shadow-a); padding: 14px; }

    /* =============================================================
       PAGES
       ============================================================= */

    /* PLAY (Core grid game) */
    .play-wrap { display: grid; gap: 12px; }
    .play-top { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; }
    .rooms { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .tile { position: relative; display: grid; place-items: center; height: 86px; border-radius: 14px; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border: 1px solid rgba(255,255,255,.06); cursor: pointer; transition: transform .2s ease, box-shadow .2s ease; }
    .tile:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.28); }
    .tile.sel { outline: 2px solid var(--acc-a); box-shadow: 0 0 0 4px rgba(105,214,255,.15) inset; }
    .tile .big { font-size: 28px; }
    .tile.found { border-color: var(--bad); box-shadow: 0 0 0 3px rgba(255,90,99,.25) inset; }
    .tile.safe { border-color: var(--good); box-shadow: 0 0 0 3px rgba(101,255,155,.2) inset; }

    .play-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    /* BOOSTS */
    .boost { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; padding: 10px; border-radius: 14px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border: 1px solid rgba(255,255,255,.06); }
    .boost .ico { width: 46px; height: 46px; border-radius: 12px; display: grid; place-items: center; background: linear-gradient(135deg, var(--acc-a), var(--acc-b)); box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .boost .name { font-weight: 900; }
    .boost .desc { color: var(--ink-1); font-size: 12px; }
    .boost .price { font-weight: 900; color: var(--gold); }

    /* MINERS */
    .miner { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; padding: 12px; border-radius: 16px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border: 1px solid rgba(255,255,255,.06); }
    .miner .ico { width: 54px; height: 54px; border-radius: 14px; display: grid; place-items: center; background: linear-gradient(135deg, var(--acc-c), var(--acc-b)); }
    .miner .name { font-weight: 900; }
    .miner .muted { font-size: 12px; }

    /* MISSIONS */
    .mission { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.06); background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); }

    /* ACHIEVEMENTS */
    .ach { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; padding: 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,.06); background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); }
    .ach .ico { width: 48px; height: 48px; border-radius: 12px; display: grid; place-items: center; background: linear-gradient(135deg, #ffc371, #ff5f6d); }

    /* LAB (research tree) */
    .node { position: relative; padding: 10px; border-radius: 14px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border: 1px solid rgba(255,255,255,.06); }

    /* ARCADE mini-games */
    .arcade-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    @media (max-width: 720px){ .arcade-grid{ grid-template-columns: repeat(2, 1fr);} }
    .arc-card { padding: 14px; border-radius: 14px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border: 1px solid rgba(255,255,255,.06); display: grid; gap: 8px; }

    /* SETTINGS */
    .settings { display: grid; gap: 12px; }
    .srow { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 10px; border-radius: 12px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border: 1px solid rgba(255,255,255,.06); }
    select, input[type="range"], input[type="checkbox"] { accent-color: #8dcaff; }

    /* Floating Action Button */
    .fab { position: fixed; right: 16px; bottom: 84px; z-index: 60; }
    .fab .btn { border-radius: 999px; padding: 14px 16px; }

    /* Reward ribbon */
    .ribbon { position: fixed; left: 12px; bottom: 88px; z-index: 60; display: grid; gap: 8px; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
<div class="app" id="app">
  <header class="appbar">
    <div class="toprow">
      <div class="brand">
        <div class="logo">✨</div>
        <div class="name">Nebula Vault</div>
        <span class="tag" id="tagVersion">v1.0 • Offline</span>
      </div>
      <div class="wallet" id="wallet">
        <span class="pill coins"><span class="ico">💰</span><span class="val" id="uiCoins">0</span></span>
        <span class="pill gems"><span class="ico">💎</span><span class="val" id="uiGems">0</span></span>
        <span class="pill energy"><span class="ico">⚡</span><span class="val" id="uiEnergy">0</span></span>
      </div>
    </div>
    <div class="subrow">
      <div class="progress" aria-label="XP progress"><i id="uiXpBar" style="width: 0%"></i></div>
      <div class="lvl" id="uiLvl">LVL 1</div>
    </div>
  </header>

  <main>
    <!-- ===================== PLAY ===================== -->
    <section class="view active" id="view-play">
      <div class="play-wrap">
        <div class="play-top">
          <div class="card row space">
            <div>
              <div class="title" id="t_play_title">Hide & Seek — Cosmic Edition</div>
              <div class="muted" id="t_play_sub">Select a vault cell, then press SCAN. Avoid drones to earn coins.</div>
            </div>
            <div class="row">
              <button class="btn ghost" id="btnResetBoard">↻</button>
              <button class="btn primary" id="btnScan">SCAN</button>
            </div>
          </div>
          <div class="card">
            <div class="row space">
              <div class="muted" id="t_round_info">Round risk</div>
              <div class="tag"><span id="uiRisk">2</span> 🔍</div>
            </div>
            <div class="row space" style="margin-top:6px">
              <div class="muted" id="t_reward">Reward</div>
              <div class="row" style="gap:8px"><span class="tag">+<b id="uiWin">1,000</b></span><span class="tag">-<b id="uiLose">-2,000</b></span></div>
            </div>
          </div>
        </div>

        <div class="rooms" id="rooms"></div>

        <div class="play-actions">
          <button class="btn ghost" id="btnHint">🔦 Hint</button>
          <button class="btn ghost" id="btnDecoy">🛰️ Decoy</button>
          <button class="btn ghost" id="btnShuffle">🎲 Shuffle</button>
        </div>

        <div class="grid cols3">
          <div class="card">
            <div class="title" id="t_income">Passive Income</div>
            <div class="row space"><div class="muted" id="t_income_rate">/hr</div><div class="title" id="uiIncome">0</div></div>
          </div>
          <div class="card">
            <div class="title" id="t_streak">Streak</div>
            <div class="row space"><div class="muted" id="t_streak_sub">consecutive wins</div><div class="title" id="uiStreak">0</div></div>
          </div>
          <div class="card">
            <div class="title" id="t_protect">Protection</div>
            <div class="row space"><div class="muted" id="t_shield_sub">shield secs left</div><div class="title" id="uiShield">0</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== BOOSTS ===================== -->
    <section class="view" id="view-boosts">
      <div class="grid cols2" id="boostsList"></div>
    </section>

    <!-- ===================== MINERS ===================== -->
    <section class="view" id="view-miners">
      <div class="grid" id="minersList"></div>
    </section>

    <!-- ===================== MISSIONS ===================== -->
    <section class="view" id="view-missions">
      <div class="grid" id="missionsList"></div>
    </section>

    <!-- ===================== ACHIEVEMENTS ===================== -->
    <section class="view" id="view-ach">
      <div class="grid" id="achList"></div>
    </section>

    <!-- ===================== LAB ===================== -->
    <section class="view" id="view-lab">
      <div class="grid cols2" id="labList"></div>
    </section>

    <!-- ===================== ARCADE ===================== -->
    <section class="view" id="view-arcade">
      <div class="arcade-grid" id="arcadeGrid"></div>
    </section>

    <!-- ===================== SETTINGS ===================== -->
    <section class="view" id="view-settings">
      <div class="settings">
        <div class="srow">
          <div>
            <div class="title" id="t_lang">Language</div>
            <div class="muted" id="t_lang_sub">Switch interface language.</div>
          </div>
          <select id="selLang">
            <option value="en">English</option>
            <option value="ru">Русский</option>
          </select>
        </div>
        <div class="srow">
          <div>
            <div class="title" id="t_sfx">Sounds</div>
            <div class="muted" id="t_sfx_sub">UI clicks & win/lose jingles.</div>
          </div>
          <label class="row" style="gap:8px"><input type="checkbox" id="cbSfx" checked><span class="tag">SFX</span></label>
        </div>
        <div class="srow">
          <div>
            <div class="title" id="t_reset">Data</div>
            <div class="muted" id="t_reset_sub">Export / import / hard reset.</div>
          </div>
          <div class="row">
            <button class="btn ghost" id="btnExport">Export</button>
            <button class="btn ghost" id="btnImport">Import</button>
            <button class="btn warn" id="btnHardReset">Reset</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <nav class="tabs">
    <div class="row">
      <div class="row" style="gap:8px; padding: 6px 10px; overflow:auto; max-width: 100vw;">
        <button class="tabbtn active" data-view="play"><i>🎯</i><span id="t_tab_play">Play</span></button>
        <button class="tabbtn" data-view="boosts"><i>🚀</i><span id="t_tab_boosts">Boosts</span></button>
        <button class="tabbtn" data-view="miners"><i>⛏️</i><span id="t_tab_miners">Miners</span></button>
        <button class="tabbtn" data-view="missions"><i>📜</i><span id="t_tab_missions">Missions</span></button>
        <button class="tabbtn" data-view="ach"><i>🏆</i><span id="t_tab_ach">Achievements</span></button>
        <button class="tabbtn" data-view="lab"><i>🧪</i><span id="t_tab_lab">Lab</span></button>
        <button class="tabbtn" data-view="arcade"><i>🕹️</i><span id="t_tab_arcade">Arcade</span></button>
        <button class="tabbtn" data-view="settings"><i>⚙️</i><span id="t_tab_settings">Settings</span></button>
      </div>
    </div>
  </nav>

  <div class="fab">
    <button class="btn primary" id="btnDaily">🎁 Daily</button>
  </div>
  <div class="ribbon" id="leftRibbon">
    <button class="btn ghost" id="btnQuests">⭐ Quests</button>
    <button class="btn ghost" id="btnSeason">🎟️ Season</button>
  </div>

  <div class="toasts" id="toasts"></div>

  <!-- ================= MODALS ================= -->
  <div class="modal" id="modalDaily">
    <div class="layer" data-close></div>
    <div class="box">
      <div class="row space">
        <div class="title" id="t_daily_title">Daily Rewards</div>
        <button class="btn ghost" data-close>✖</button>
      </div>
      <div class="grid cols4" id="dailyGrid"></div>
    </div>
  </div>

  <div class="modal" id="modalQuest">
    <div class="layer" data-close></div>
    <div class="box">
      <div class="row space"><div class="title" id="t_quests">Quests</div><button class="btn ghost" data-close>✖</button></div>
      <div class="grid" id="questGrid"></div>
    </div>
  </div>

  <div class="modal" id="modalSeason">
    <div class="layer" data-close></div>
    <div class="box">
      <div class="row space"><div class="title" id="t_season">Season Pass — Free Track</div><button class="btn ghost" data-close>✖</button></div>
      <div class="grid cols4" id="seasonTrack"></div>
    </div>
  </div>

  <div class="modal" id="modalArcade">
    <div class="layer" data-close></div>
    <div class="box" id="arcadeBox">
      <div class="row space"><div class="title" id="arcadeTitle">Arcade</div><button class="btn ghost" data-close>✖</button></div>
      <div id="arcadeInner"></div>
    </div>
  </div>

</div>

<script>
/* ===================================================================
   NEBULA VAULT — FULL OFFLINE SINGLE-FILE GAME
   - No servers, only localStorage
   - RU/EN localization
   - Core hide&seek minigame + boosts, miners, lab, missions, achievements
   - Daily rewards, season track, arcade mini-games
   =================================================================== */

(function(){
  'use strict';

  /* ---------------------------------------------------------------
     UTILITIES
  --------------------------------------------------------------- */
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmt = (n) => {
    n = Math.floor(n);
    if (n >= 1e12) return (n/1e12).toFixed(1).replace(/\.0$/,'') + 'T';
    if (n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
    if (n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
    return String(n);
  };
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const now = () => Date.now();

  function toast(msg){
    const box = document.createElement('div');
    box.className = 'toast pop';
    box.textContent = msg;
    $('#toasts').appendChild(box);
    setTimeout(()=>{ box.remove(); }, 2200);
  }

  function saveLS(key, value){ try { localStorage.setItem(key, JSON.stringify(value)); } catch(e){} }
  function readLS(key, fallback){ try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; } catch(e){ return fallback; } }

  function rngChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  /* ---------------------------------------------------------------
     I18N
  --------------------------------------------------------------- */
  const i18n = {
    en: {
      t_play_title: 'Hide & Seek — Cosmic Edition',
      t_play_sub: 'Select a vault cell, then press SCAN. Avoid drones to earn coins.',
      t_round_info: 'Round risk',
      t_reward: 'Reward',
      t_income: 'Passive Income',
      t_income_rate: '/hr',
      t_streak: 'Streak',
      t_streak_sub: 'consecutive wins',
      t_protect: 'Protection',
      t_shield_sub: 'shield secs left',
      t_tab_play: 'Play', t_tab_boosts: 'Boosts', t_tab_miners: 'Miners', t_tab_missions: 'Missions', t_tab_ach: 'Achievements', t_tab_lab: 'Lab', t_tab_arcade: 'Arcade', t_tab_settings: 'Settings',
      t_daily_title: 'Daily Rewards', t_quests: 'Quests', t_season: 'Season Pass — Free Track',
      t_lang: 'Language', t_lang_sub: 'Switch interface language.', t_sfx: 'Sounds', t_sfx_sub: 'UI clicks & win/lose jingles.', t_reset: 'Data', t_reset_sub: 'Export / import / hard reset.',
      x_pick_first: 'Pick a cell first!', x_not_enough: 'Not enough coins!', x_copied: 'Copied to clipboard', x_import_ok: 'Save imported', x_reset_ok: 'Data wiped',
    },
    ru: {
      t_play_title: 'Прятки — Космическая версия',
      t_play_sub: 'Выберите ячейку хранилища и нажмите SCAN. Уклоняйтесь от дронов, чтобы заработать монеты.',
      t_round_info: 'Риск раунда',
      t_reward: 'Награда',
      t_income: 'Пассивный доход',
      t_income_rate: '/час',
      t_streak: 'Серия побед',
      t_streak_sub: 'подряд',
      t_protect: 'Защита',
      t_shield_sub: 'сек. щита',
      t_tab_play: 'Играть', t_tab_boosts: 'Бусты', t_tab_miners: 'Майнеры', t_tab_missions: 'Задания', t_tab_ach: 'Ачивки', t_tab_lab: 'Лаборатория', t_tab_arcade: 'Аркада', t_tab_settings: 'Настройки',
      t_daily_title: 'Ежедневные награды', t_quests: 'Квесты', t_season: 'Боевой пропуск — Бесплатная ветка',
      t_lang: 'Язык', t_lang_sub: 'Переключить язык интерфейса.', t_sfx: 'Звуки', t_sfx_sub: 'Клики и джинглы побед/поражений.', t_reset: 'Данные', t_reset_sub: 'Экспорт / импорт / полный сброс.',
      x_pick_first: 'Сначала выберите ячейку!', x_not_enough: 'Недостаточно монет!', x_copied: 'Скопировано в буфер', x_import_ok: 'Сохранение импортировано', x_reset_ok: 'Данные удалены',
    }
  };

  const L = new Proxy({}, {
    get(_, k){
      return i18n[state.lang][k] ?? i18n.en[k] ?? String(k);
    }
  });

  function applyI18n(){
    const keys = [
      't_play_title','t_play_sub','t_round_info','t_reward','t_income','t_income_rate','t_streak','t_streak_sub','t_protect','t_shield_sub',
      't_tab_play','t_tab_boosts','t_tab_miners','t_tab_missions','t_tab_ach','t_tab_lab','t_tab_arcade','t_tab_settings',
      't_daily_title','t_quests','t_season','t_lang','t_lang_sub','t_sfx','t_sfx_sub','t_reset','t_reset_sub'
    ];
    keys.forEach(k=>{ const el = document.getElementById(k); if (el) el.textContent = L[k]; });
  }

  /* ---------------------------------------------------------------
     STATE & PERSISTENCE
  --------------------------------------------------------------- */
  const VERSION = 1;
  const LSKEY = 'nebula_vault_save_v1';

  const defaultState = () => ({
    version: VERSION,
    lang: readLS('lang_pref_nv', 'ru'),
    sfx: true,
    coins: 0,
    gems: 0,
    energy: 20,
    lvl: 1, xp: 0, xpTo: 100,
    maxCoins: 0,
    lastTick: now(),
    lastDaily: 0,
    dailyFirstSeen: 0,
    miners: Array.from({length: 10}, (_,i)=>({ lvl: 0 })),
    boosts: {
      oneScan: 0,    // scans reduced by 1
      shield: 0,     // prevents loss (timer)
      x2round: 0,    // doubles reward/loss for N secs
      x2income: 0,   // doubles passive income for N secs
      luck: 0        // 50% evade on found
    },
    timers: {
      shield: 0, x2round: 0, x2income: 0, luck: 0, oneScan: 0
    },
    play: {
      size: 16, selected: null, risk: 2, win: 1000, lose: -2000,
      streak: 0
    },
    missions: {},
    achievements: {},
    lab: { nodes: {} },
    season: { xp: 0, claimed: {} },
  });

  let state = readLS(LSKEY, null) || defaultState();

  function save(){
    state.version = VERSION;
    saveLS(LSKEY, state);
    try { localStorage.setItem('lang_pref_nv', state.lang); } catch(e){}
  }

  /* ---------------------------------------------------------------
     ECONOMY & INCOME
  --------------------------------------------------------------- */
  const minerDefs = [
    { name: 'Ion Drill', baseIncome: 500, basePrice: 7000, icon: '⛰️' },
    { name: 'Plasma Rig', baseIncome: 1200, basePrice: 12000, icon: '🪫' },
    { name: 'Quantum Harvester', baseIncome: 2200, basePrice: 18000, icon: '🌀' },
    { name: 'Neutrino Siphon', baseIncome: 3200, basePrice: 26000, icon: '🧲' },
    { name: 'Dark Matter Scoop', baseIncome: 4800, basePrice: 36000, icon: '🌑' },
    { name: 'Pulsar Array', baseIncome: 6200, basePrice: 46000, icon: '🌟' },
    { name: 'Warp Extractor', baseIncome: 8000, basePrice: 60000, icon: '🚀' },
    { name: 'Hadron Mill', baseIncome: 11000, basePrice: 90000, icon: '⚙️' },
    { name: 'Zero-Point Tap', baseIncome: 16000, basePrice: 130000, icon: '💠' },
    { name: 'Singularity Forge', baseIncome: 24000, basePrice: 200000, icon: '🕳️' },
  ];

  function minerIncomeAt(i, lvl){
    if (lvl <= 0) return 0;
    const base = minerDefs[i].baseIncome;
    return Math.floor(base * Math.pow(1.6, lvl-1));
  }

  function minerPriceAt(i, lvl){
    const base = minerDefs[i].basePrice;
    return Math.floor(base * Math.pow(2, lvl));
  }

  function totalIncome(){
    let base = 0;
    state.miners.forEach((m, i)=>{ base += minerIncomeAt(i, m.lvl); });
    if (state.timers.x2income > now()) base *= 2;
    // lab modifiers
    if (state.lab.nodes['inc_boost_1']) base = Math.floor(base * 1.1);
    if (state.lab.nodes['inc_boost_2']) base = Math.floor(base * 1.2);
    return base;
  }

  function tickEconomy(){
    const t = now();
    const dt = Math.max(0, t - state.lastTick);
    if (dt <= 0) { state.lastTick = t; return; }
    const perSec = totalIncome() / 3600; // /hr -> /sec
    const earned = Math.floor(perSec * (dt/1000));
    if (earned > 0) addCoins(earned);
    state.lastTick = t;
  }

  function addCoins(v){
    state.coins += v;
    if (state.coins > state.maxCoins) state.maxCoins = state.coins;
  }

  function spendCoins(v){
    if (state.coins < v) return false;
    state.coins -= v; return true;
  }

  function addXp(v){
    state.xp += v;
    while (state.xp >= state.xpTo){
      state.xp -= state.xpTo; state.lvl++; state.xpTo = Math.floor(state.xpTo * 1.25 + 20);
      toast('Level up! LVL ' + state.lvl);
    }
  }

  /* ---------------------------------------------------------------
     UI RENDER
  --------------------------------------------------------------- */
  function renderHeader(){
    $('#uiCoins').textContent = fmt(state.coins);
    $('#uiGems').textContent = fmt(state.gems);
    $('#uiEnergy').textContent = fmt(state.energy);
    const pct = clamp(Math.floor(state.xp / state.xpTo * 100), 0, 100);
    $('#uiXpBar').style.width = pct + '%';
    $('#uiLvl').textContent = 'LVL ' + state.lvl;
  }

  // PLAY page
  function ensureBoard(){
    const cont = $('#rooms'); cont.innerHTML = '';
    const N = state.play.size;
    for (let i=0;i<N;i++){
      const d = document.createElement('button');
      d.className = 'tile';
      d.innerHTML = `<div class="big">${['🌌','🛰️','🪐','✨','🔮','🧿','💫','🌠'][i%8]}</div>`;
      d.dataset.idx = i;
      d.addEventListener('click', ()=>{
        $$('.tile').forEach(x=>x.classList.remove('sel'));
        d.classList.add('sel');
        state.play.selected = i; save();
      });
      cont.appendChild(d);
    }
  }

  function renderPlayStats(){
    $('#uiRisk').textContent = state.timers.oneScan && state.timers.oneScan > now() ? 1 : state.play.risk;
    let win = state.play.win, lose = state.play.lose;
    if (state.timers.x2round > now()) { win*=2; lose*=2; }
    if (state.lab.nodes['round_win_1']) win = Math.floor(win*1.15);
    if (state.lab.nodes['round_loss_1']) lose = Math.floor(lose*0.9);
    $('#uiWin').textContent = fmt(win);
    $('#uiLose').textContent = '-' + fmt(Math.abs(lose));
    $('#uiStreak').textContent = state.play.streak;
    const sleft = Math.max(0, Math.ceil((state.timers.shield - now())/1000));
    $('#uiShield').textContent = sleft > 0 ? sleft : '0';
    $('#uiIncome').textContent = fmt(totalIncome());
  }

  function renderBoosts(){
    const boosts = [
      { key: 'oneScan', name: 'Single Scan (60s)', desc: 'Reduces drones to 1 per round for 60s.', price: 20000, icon: '🛰️' },
      { key: 'shield', name: 'Shield (60s)', desc: 'Blocks loss when found for 60s.', price: 25000, icon: '🛡️' },
      { key: 'x2round', name: '×2 Round (60s)', desc: 'Double reward & loss for 60s.', price: 30000, icon: '💥' },
      { key: 'x2income', name: '×2 Income (60s)', desc: 'Double passive income for 60s.', price: 32000, icon: '💵' },
      { key: 'luck', name: 'Lucky Escape (60s)', desc: '50% chance to evade when found.', price: 22000, icon: '🍀' },
    ];
    const host = $('#boostsList'); host.innerHTML = '';
    boosts.forEach(b=>{
      const left = Math.max(0, Math.ceil((state.timers[b.key] - now())/1000));
      const el = document.createElement('div'); el.className = 'boost'; el.innerHTML = `
        <div class="ico">${b.icon}</div>
        <div>
          <div class="name">${b.name}</div>
          <div class="desc">${b.desc} ${left>0?`<b>⏳ ${left}s</b>`:''}</div>
        </div>
        <div class="row">
          <div class="price">${fmt(b.price)}</div>
          <button class="btn primary">Buy</button>
        </div>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        if (!spendCoins(b.price)) { toast(L.x_not_enough); return; }
        const until = now()+60000;
        state.timers[b.key] = until; addXp(5); save(); renderBoosts(); renderPlayStats(); renderHeader();
      });
      host.appendChild(el);
    });
  }

  function renderMiners(){
    const host = $('#minersList'); host.innerHTML = '';
    state.miners.forEach((m, i)=>{
      const income = minerIncomeAt(i, Math.max(1, m.lvl));
      const price = minerPriceAt(i, m.lvl);
      const def = minerDefs[i] || { name: 'Unknown', icon:'🔧' };
      const el = document.createElement('div'); el.className = 'miner'; el.innerHTML = `
        <div class="ico">${def.icon}</div>
        <div>
          <div class="name">${def.name}</div>
          <div class="muted">Lvl ${m.lvl} • +${fmt(income)} / hr</div>
        </div>
        <div class="row">
          <div class="price">${fmt(price)}</div>
          <button class="btn primary">Upgrade</button>
        </div>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        const priceNow = minerPriceAt(i, state.miners[i].lvl);
        if (!spendCoins(priceNow)) { toast(L.x_not_enough); return; }
        state.miners[i].lvl++; addXp(8); save(); renderMiners(); renderHeader(); renderPlayStats();
      });
      host.appendChild(el);
    });
  }

  function renderMissions(){
    const host = $('#missionsList'); host.innerHTML = '';
    const defs = [
      { key: 'm_play_3', name: 'Win 3 rounds', reward: 5000 },
      { key: 'm_spend_100k', name: 'Spend 100K coins', reward: 8000 },
      { key: 'm_upgrade_5', name: 'Upgrade 5 miners', reward: 12000 },
    ];
    defs.forEach(d=>{
      const done = !!state.missions[d.key];
      const el = document.createElement('div'); el.className = 'mission'; el.innerHTML = `
        <div><div class="name">${d.name}</div><div class="muted">Reward: ${fmt(d.reward)}</div></div>
        <button class="btn ${done?'ghost':'primary'}">${done?'Done':'Claim'}</button>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        if (state.missions[d.key]) return;
        addCoins(d.reward); state.missions[d.key] = true; addXp(10); save(); renderMissions(); renderHeader();
      });
      host.appendChild(el);
    });
  }

  function renderAch(){
    const host = $('#achList'); host.innerHTML = '';
    const list = [
      { key: 'a_first_win', name: 'First Steps', desc: 'Win a round.', reward: 2000, icon:'🥇' },
      { key: 'a_10k', name: 'Pocket Change', desc: 'Collect 10K coins.', reward: 4000, icon:'💰' },
      { key: 'a_miner_3', name: 'Engineer', desc: 'Own 3 miners (lvl ≥1).', reward: 6000, icon:'🛠️' },
    ];
    list.forEach(a=>{
      const done = !!state.achievements[a.key];
      const el = document.createElement('div'); el.className = 'ach'; el.innerHTML = `
        <div class="ico">${a.icon}</div>
        <div>
          <div class="name">${a.name}</div>
          <div class="muted">${a.desc}</div>
        </div>
        <button class="btn ${done?'ghost':'primary'}">${done?'Claimed':'Claim'}</button>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        if (state.achievements[a.key]) return;
        addCoins(a.reward); state.achievements[a.key] = true; addXp(6); save(); renderAch(); renderHeader();
      });
      host.appendChild(el);
    });
  }

  function renderLab(){
    const host = $('#labList'); host.innerHTML = '';
    const nodes = [
      { key: 'inc_boost_1', name: 'Income +10%', price: 50000, icon:'📈' },
      { key: 'inc_boost_2', name: 'Income +20%', price: 120000, icon:'📈' },
      { key: 'round_win_1', name: 'Round Reward +15%', price: 75000, icon:'🎯' },
      { key: 'round_loss_1', name: 'Loss -10%', price: 90000, icon:'🛡️' },
    ];
    nodes.forEach(n=>{
      const bought = !!state.lab.nodes[n.key];
      const el = document.createElement('div'); el.className = 'node card'; el.innerHTML = `
        <div class="row space"><div class="title">${n.icon} ${n.name}</div><div class="tag">${fmt(n.price)}</div></div>
        <div class="row" style="justify-content:end"><button class="btn ${bought?'ghost':'primary'}">${bought?'Installed':'Research'}</button></div>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        if (state.lab.nodes[n.key]) return;
        if (!spendCoins(n.price)) { toast(L.x_not_enough); return; }
        state.lab.nodes[n.key] = true; addXp(12); save(); renderLab(); renderHeader(); renderPlayStats();
      });
      host.appendChild(el);
    });
  }

  function renderDaily(){
    const host = $('#dailyGrid'); host.innerHTML = '';
    if (!state.dailyFirstSeen) state.dailyFirstSeen = now();
    const days = Math.min(7, Math.floor((now() - state.dailyFirstSeen)/(24*3600*1000)) + 1);
    const rewards = [30000, 100000, 500000, 1000000, 3000000, 6000000, 10000000];
    for (let i=0;i<7;i++){
      const unlocked = i < days;
      const claimed = !!state.season.claimed['d'+i];
      const el = document.createElement('div'); el.className = 'card shine'; el.innerHTML = `
        <div class="row space"><div class="title">Day ${i+1}</div>${claimed?'<span class="tag">✔</span>':''}</div>
        <div class="row space"><div class="muted">${fmt(rewards[i])}</div><button class="btn ${unlocked&&!claimed?'primary':'ghost'}">${unlocked? (claimed?'Claimed':'Claim') : 'Locked'}</button></div>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        if (!unlocked || claimed) return;
        addCoins(rewards[i]); state.season.claimed['d'+i] = true; addXp(10); save(); renderDaily(); renderHeader();
      });
      host.appendChild(el);
    }
  }

  function renderSeason(){
    const host = $('#seasonTrack'); host.innerHTML = '';
    const nodes = Array.from({length: 12}, (_,i)=>({
      idx:i+1, need: (i+1)*50, reward: (i%3===0? '💎 '+(5+i) : '💰 '+fmt(5000*(i+1)))
    }));
    nodes.forEach(n=>{
      const claimKey = 's'+n.idx;
      const can = state.season.xp >= n.need;
      const done = !!state.season.claimed[claimKey];
      const el = document.createElement('div'); el.className = 'card'; el.innerHTML = `
        <div class="title">Tier ${n.idx}</div>
        <div class="muted">Need ${n.need} XP</div>
        <div class="row space" style="margin-top:6px"><div class="tag">${n.reward}</div><button class="btn ${can&&!done?'primary':'ghost'}">${done?'Claimed': can?'Claim':'Locked'}</button></div>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        if (!can || done) return;
        // give reward
        if (n.reward.startsWith('💎')){ const g = parseInt(n.reward.split(' ')[1]); state.gems += g; }
        else { const amt = 5000*(n.idx); addCoins(amt); }
        state.season.claimed[claimKey] = true; save(); renderSeason(); renderHeader();
      });
      host.appendChild(el);
    });
  }

  function renderArcadeMenu(){
    const host = $('#arcadeGrid'); host.innerHTML = '';
    const cards = [
      { key:'tap', name:'Nebula Tapper', desc:'Tap to earn within time limit.', icon:'👆', run: startTapper },
      { key:'mem', name:'Memory Flip', desc:'Remember symbols & match.', icon:'🧠', run: startMemory },
      { key:'dash', name:'Astro Dash', desc:'Dodge meteors (auto).', icon:'🛰️', run: startDash },
    ];
    cards.forEach(c=>{
      const el = document.createElement('div'); el.className = 'arc-card'; el.innerHTML = `
        <div class="title">${c.icon} ${c.name}</div>
        <div class="muted">${c.desc}</div>
        <div class="row" style="justify-content:end"><button class="btn primary">Play</button></div>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        $('#arcadeTitle').textContent = c.name; $('#modalArcade').classList.add('show'); c.run();
      });
      host.appendChild(el);
    });
  }

  /* ---------------------------------------------------------------
     CORE GAME LOGIC (PLAY)
  --------------------------------------------------------------- */
  let boardBusy = false;
  function performScan(){
    if (boardBusy) return; boardBusy = true;
    if (state.play.selected == null){ toast(L.x_pick_first); boardBusy = false; return; }

    const risk = (state.timers.oneScan && state.timers.oneScan > now()) ? 1 : state.play.risk;
    const picks = shuffle(Array.from({length: state.play.size},(_,i)=>i)).slice(0, risk);

    // animate tiles
    let t=0; picks.forEach(idx=>{
      const tile = document.querySelector(`.tile[data-idx="${idx}"]`);
      setTimeout(()=>{ tile.classList.add('pop'); setTimeout(()=>tile.classList.remove('pop'), 220); }, t);
      t+=200;
    });

    setTimeout(()=>{
      const sel = state.play.selected;
      const winLose = picks.includes(sel) ? 'lose' : 'win';
      const tile = document.querySelector(`.tile[data-idx="${sel}"]`);
      $$('.tile').forEach(x=>{ x.classList.remove('found','safe','sel'); });

      let win = state.play.win, lose = state.play.lose;
      if (state.timers.x2round > now()) { win*=2; lose*=2; }
      if (state.lab.nodes['round_win_1']) win = Math.floor(win*1.15);
      if (state.lab.nodes['round_loss_1']) lose = Math.floor(lose*0.9);

      if (winLose==='lose'){
        if (state.timers.shield > now()){
          tile.classList.add('safe');
          toast('Shield blocked loss');
        } else if (state.timers.luck > now() && Math.random()<0.5){
          tile.classList.add('safe'); addCoins(win); addXp(2); state.play.streak++; toast('Lucky escape + reward');
        } else {
          tile.classList.add('found'); addCoins(lose); state.play.streak = 0; addXp(1);
        }
      } else {
        tile.classList.add('safe'); addCoins(win); state.play.streak++; addXp(3);
      }
      state.play.selected = null; save(); renderPlayStats(); renderHeader();
      boardBusy = false;
    }, Math.max(600, t+200));
  }

  function shuffle(a){
    for (let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }

  /* ---------------------------------------------------------------
     ARCADE MINI-GAMES (inline, simple, rewarding)
  --------------------------------------------------------------- */
  function mountArcade(inner){ const box = $('#arcadeInner'); box.innerHTML=''; box.appendChild(inner); }

  // Tapper
  function startTapper(){
    const root = document.createElement('div'); root.innerHTML = `
      <div class="card"><div class="row space"><div class="title">Time: <span id="tapTime">15</span>s</div><div class="title">Score: <span id="tapScore">0</span></div></div></div>
      <div class="card" style="display:grid;place-items:center;height:220px"><button class="btn primary" id="tapBtn" style="font-size:24px">TAP</button></div>
      <div class="row" style="justify-content:end"><button class="btn ghost" data-close>Close</button></div>
    `;
    mountArcade(root);
    let time=15, score=0, timer=null;
    const btn = root.querySelector('#tapBtn');
    btn.addEventListener('click', ()=>{ score++; root.querySelector('#tapScore').textContent = score; btn.classList.add('pop'); setTimeout(()=>btn.classList.remove('pop'),160); });
    function tick(){ time--; root.querySelector('#tapTime').textContent = time; if (time<=0){ clearInterval(timer); finish(); } }
    timer = setInterval(tick,1000);
    function finish(){
      const reward = score*50; addCoins(reward); addXp(Math.floor(score/3)); toast('Arcade reward: '+fmt(reward)); save(); renderHeader();
    }
  }

  // Memory Flip (simplified)
  function startMemory(){
    const symbols = ['🌟','🌙','🪐','☄️','🌈','🔥'];
    const pool = shuffle([...symbols, ...symbols]);
    const root = document.createElement('div'); root.innerHTML = `
      <div class="card"><div class="row space"><div class="title">Matches: <span id="mMatch">0</span>/6</div><div class="title">Moves: <span id="mMoves">0</span></div></div></div>
      <div class="card" style="padding:12px"><div class="grid cols3" id="mGrid"></div></div>
      <div class="row" style="justify-content:end"><button class="btn ghost" data-close>Close</button></div>
    `;
    mountArcade(root);
    const grid = root.querySelector('#mGrid');
    let first=null, lock=false, moves=0, match=0;
    pool.forEach((sym,i)=>{
      const b = document.createElement('button'); b.className='btn ghost'; b.style.height='64px'; b.dataset.sym=sym; b.textContent='?';
      b.addEventListener('click', ()=>{
        if (lock||b.classList.contains('ok')||b===first) return; b.textContent=sym; b.classList.add('pop');
        if (!first) first=b; else { lock=true; moves++; root.querySelector('#mMoves').textContent=moves; setTimeout(()=>{
          if (first.dataset.sym===b.dataset.sym){ first.classList.add('ok'); b.classList.add('ok'); match++; root.querySelector('#mMatch').textContent=match; if (match===symbols.length){ const reward = 4000 + Math.max(0, 2000 - moves*150); addCoins(reward); addXp(12); toast('Memory reward: '+fmt(reward)); save(); renderHeader(); }
          } else { first.textContent='?'; b.textContent='?'; }
          first=null; lock=false;
        }, 500); }
      });
      grid.appendChild(b);
    });
  }

  // Astro Dash (auto runner mock)
  function startDash(){
    const root = document.createElement('div'); root.innerHTML = `
      <div class="card"><div class="title">Survive 20s — auto dodge!</div></div>
      <canvas id="dashCanvas" width="640" height="200" style="width:100%; background: rgba(255,255,255,.04); border-radius:12px"></canvas>
      <div class="row" style="justify-content:end"><button class="btn ghost" data-close>Close</button></div>
    `;
    mountArcade(root);
    const cvs = root.querySelector('#dashCanvas'); const ctx = cvs.getContext('2d');
    let t0 = performance.now(); let alive = true; let time=0; const player = {x:40,y:100};
    const rocks=[];
    function spawn(){ rocks.push({x:640, y: 30+Math.random()*140, r: 6+Math.random()*12}); }
    function step(t){
      const dt = (t - t0)/1000; t0=t; if (!alive) return; time+=dt; if (Math.random()<0.1) spawn();
      ctx.clearRect(0,0,640,200);
      // AI dodge simple
      let nearest = rocks.find(r=>r.x>player.x && r.x-player.x<90);
      if (nearest){ if (nearest.y<player.y) player.y+=60*dt; else player.y-=60*dt; }
      player.y = clamp(player.y, 20, 180);
      // draw player
      ctx.fillStyle = '#8ae6ff'; ctx.beginPath(); ctx.arc(player.x, player.y, 8, 0, Math.PI*2); ctx.fill();
      // rocks
      ctx.fillStyle = '#ff829e';
      for (let i=rocks.length-1;i>=0;i--){ const r=rocks[i]; r.x -= 140*dt; ctx.beginPath(); ctx.arc(r.x, r.y, r.r, 0, Math.PI*2); ctx.fill(); if (r.x<-20) rocks.splice(i,1); if (Math.hypot(r.x-player.x, r.y-player.y) < r.r+8){ alive=false; finish(); } }
      if (alive) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
    function finish(){ const reward = Math.floor(5000 * Math.min(1, time/20)); addCoins(reward); addXp(10); toast('Dash reward: '+fmt(reward)); save(); renderHeader(); }
  }

  /* ---------------------------------------------------------------
     EVENTS & NAVIGATION
  --------------------------------------------------------------- */
  function bindNav(){
    $$('.tabbtn').forEach(b=>{
      b.addEventListener('click', ()=>{
        $$('.tabbtn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
        const v = b.dataset.view; $$('.view').forEach(x=>x.classList.remove('active')); $('#view-'+v).classList.add('active');
      });
    });
  }

  function bindPlay(){
    $('#btnScan').addEventListener('click', performScan);
    $('#btnResetBoard').addEventListener('click', ()=>{ ensureBoard(); state.play.selected = null; save(); });
    $('#btnHint').addEventListener('click', ()=>{ const idx = Math.floor(Math.random()*state.play.size); const t = document.querySelector(`[data-idx="${idx}"]`); t.classList.add('pop');});
    $('#btnDecoy').addEventListener('click', ()=>{ state.timers.luck = now()+15000; toast('Lucky + shielded for 15s'); state.timers.shield = Math.max(state.timers.shield, now()+8000); save(); renderPlayStats(); });
    $('#btnShuffle').addEventListener('click', ()=>{ ensureBoard(); state.play.selected = null; toast('Shuffled'); });
  }

  function bindModals(){
    $$('#modalDaily [data-close], #modalQuest [data-close], #modalSeason [data-close], #modalArcade [data-close], .modal .layer').forEach(x=>{
      x.addEventListener('click', ()=> x.closest('.modal').classList.remove('show'));
    });
    $('#btnDaily').addEventListener('click', ()=>{ renderDaily(); $('#modalDaily').classList.add('show'); });
    $('#btnQuests').addEventListener('click', ()=>{ renderMissions(); $('#modalQuest').classList.add('show'); });
    $('#btnSeason').addEventListener('click', ()=>{ renderSeason(); $('#modalSeason').classList.add('show'); });
  }

  function bindSettings(){
    $('#selLang').value = state.lang; $('#selLang').addEventListener('change', ()=>{
      state.lang = $('#selLang').value; save(); applyI18n(); toast('Language: '+state.lang); });
    $('#cbSfx').checked = !!state.sfx; $('#cbSfx').addEventListener('change', ()=>{ state.sfx = $('#cbSfx').checked; save(); });

    $('#btnExport').addEventListener('click', ()=>{
      const data = JSON.stringify(state); navigator.clipboard.writeText(data).then(()=>toast(L.x_copied));
    });
    $('#btnImport').addEventListener('click', ()=>{
      const raw = prompt('Paste save JSON here:');
      try{ const obj = JSON.parse(raw); state = obj; save(); reloadAll(); toast(L.x_import_ok); }catch(e){ alert('Invalid JSON'); }
    });
    $('#btnHardReset').addEventListener('click', ()=>{
      if (!confirm('Reset all local data?')) return; localStorage.clear(); state = defaultState(); save(); reloadAll(); toast(L.x_reset_ok);
    });
  }

  /* ---------------------------------------------------------------
     INIT & MAIN LOOP
  --------------------------------------------------------------- */
  function reloadAll(){ applyI18n(); ensureBoard(); renderPlayStats(); renderBoosts(); renderMiners(); renderMissions(); renderAch(); renderLab(); renderArcadeMenu(); renderHeader(); }

  // initial render
  applyI18n(); ensureBoard(); renderPlayStats(); renderBoosts(); renderMiners(); renderMissions(); renderAch(); renderLab(); renderArcadeMenu(); renderHeader();

  bindNav(); bindPlay(); bindModals(); bindSettings();

  // economy tick + autosave
  setInterval(()=>{ tickEconomy(); renderHeader(); save(); }, 1000);
  setInterval(()=>{ renderBoosts(); renderPlayStats(); save(); }, 1000);

  // expose simple API for potential extensions.
  window.NV = { state, save, addCoins, spendCoins, fmt };

})();
</script>
</body>
</html>
