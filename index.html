<!-- === TON WALLET: button + modal + TonConnect SDK (paste before </body>) === -->

<!-- TonConnect SDK + UI (CDN) -->
<script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

<!-- Wallet modal -->
<style>
  /* –ø—Ä–æ—Å—Ç–æ–π —Å—Ç–∏–ª—å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–æ—à–µ–ª—å–∫–∞ */
  #walletModal { display:none; position:fixed; inset:0; z-index:12000; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); }
  #walletModal .card { width:92%; max-width:520px; border-radius:12px; padding:18px; box-shadow:0 18px 60px rgba(0,0,0,0.7); background:linear-gradient(180deg,#121214,#1b1b1f); color:var(--text-light); border:1px solid rgba(255,255,255,0.04); }
  #walletModal .card h3 { margin:0 0 8px; font-size:18px; color:#ecf8ff; }
  #walletModal .row { display:flex; gap:8px; align-items:center; margin-top:12px; }
  #walletModal button { padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800; }
  #walletModal .btnPrimary { background:linear-gradient(90deg,var(--wm-accentC,#00D8FF),#00A8FF); color:#000; }
  #walletModal .btnGhost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text-light); }
  #walletModal .addr { font-family:monospace; padding:8px 10px; background:rgba(255,255,255,0.02); border-radius:8px; margin-top:10px; word-break:break-all; }
  #walletModal .hint { margin-top:8px; color:var(--birch,#EDE4C8); font-size:13px; }
</style>

<div id="walletModal" role="dialog" aria-hidden="true">
  <div class="card" role="document" aria-label="Wallet connect">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>–ö–æ—à–µ–ª–µ–∫ ‚Äî TON</h3>
      <button id="closeWalletModal" class="btnGhost">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="walletContent">
      <p class="hint">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Tonkeeper (—á–µ—Ä–µ–∑ TonConnect). –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å Tonkeeper –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ.</p>

      <!-- –ö–æ—Ä–µ–Ω—å –¥–ª—è TonConnect UI (–µ—Å–ª–∏ UI –¥–æ—Å—Ç—É–ø–µ–Ω, —Ç—É–¥–∞ –ø–æ–º–µ—Å—Ç–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞) -->
      <div id="walletConnectRoot" style="margin-top:12px;"></div>

      <div style="display:flex;gap:8px;margin-top:12px;">
        <button id="walletConnectBtn" class="btnPrimary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è (—Ä—É—á–Ω–æ–π)</button>
        <button id="walletDisconnectBtn" class="btnGhost" style="display:none;">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
      </div>

      <div id="walletStatus" style="margin-top:10px;">
        <div id="walletAddrBox" style="display:none;">
          <div style="font-size:13px;color:var(--birch,#EDE4C8);">–ê–¥—Ä–µ—Å:</div>
          <div id="walletAddress" class="addr">‚Äî</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –î–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É –≤ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é (–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π .bottom-menu) -->
<script>
  (function(){
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
    try {
      const bottom = document.querySelector('.bottom-menu');
      if (bottom && !document.getElementById('walletBtn')) {
        const btn = document.createElement('button');
        btn.id = 'walletBtn';
        btn.className = 'btnGhost';
        btn.title = '–ö–æ—à–µ–ª–µ–∫';
        btn.textContent = 'üëõ';
        // –í—Å—Ç–∞–≤–∏–º –ø–µ—Ä–µ–¥ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–Ω–æ–ø–∫–æ–π (—á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫)
        bottom.insertBefore(btn, bottom.lastElementChild);
      }
    } catch(e){ console.warn('walletBtn insert failed', e); }

    // DOM refs
    const walletBtn = document.getElementById('walletBtn');
    const walletModal = document.getElementById('walletModal');
    const closeWalletModal = document.getElementById('closeWalletModal');
    const walletConnectBtn = document.getElementById('walletConnectBtn');
    const walletDisconnectBtn = document.getElementById('walletDisconnectBtn');
    const walletAddressEl = document.getElementById('walletAddress');
    const walletAddrBox = document.getElementById('walletAddrBox');
    const walletConnectRoot = document.getElementById('walletConnectRoot');

    // TonConnect instances (if available)
    let connector = null;
    let tonConnectUI = null;

    // safe init (if SDKs are loaded)
    function initTon() {
      try {
        if (window.TonConnectSDK && !connector) {
          // manifestUrl —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–ª–æ–∂–∏—Ç—å –≤ –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞: tonconnect-manifest.json
          connector = new TonConnectSDK.TonConnect({ manifestUrl: window.location.origin + '/tonconnect-manifest.json' });
          // —Å–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
          connector.onStatusChange((payload) => {
            // payload –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å connected, account, permissions
            try {
              if (payload?.account) {
                showAddress(payload.account);
              } else if (connector?.account) {
                showAddress(connector.account);
              } else {
                hideAddress();
              }
            } catch(e){ console.warn('statusChange err', e); }
          });
          // –ø–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
          try { connector.restoreConnection(); } catch(e){}
        }
      } catch(e){ console.warn('initTon connector error', e); }

      try {
        if (window.TON_CONNECT_UI && !tonConnectUI) {
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º UI (–æ–Ω —Å–∞–º –ø–æ–º–µ—Å—Ç–∏—Ç –∫–Ω–æ–ø–∫—É –≤ #walletConnectRoot)
          tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: window.location.origin + '/tonconnect-manifest.json',
            buttonRootId: 'walletConnectRoot'
          });
          // –ï—Å–ª–∏ UI –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Ç–æ–¥ open/pop, –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –µ–≥–æ. –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –Ω–∏–∂–µ.
        }
      } catch(e){ console.warn('initTon UI error', e); }
    }

    function openModal() {
      walletModal.style.display = 'flex';
      walletModal.setAttribute('aria-hidden','false');
      initTon();
      // –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      if (connector && connector.connected) {
        if (connector.account) showAddress(connector.account);
      } else {
        hideAddress();
      }
    }
    function closeModal() {
      walletModal.style.display = 'none';
      walletModal.setAttribute('aria-hidden','true');
    }

    function showAddress(addr) {
      walletAddrBox.style.display = 'block';
      walletDisconnectBtn.style.display = 'inline-block';
      walletAddressEl.textContent = (addr?.address) ? addr.address : (typeof addr === 'string' ? addr : JSON.stringify(addr));
    }
    function hideAddress() {
      walletAddrBox.style.display = 'none';
      walletDisconnectBtn.style.display = 'none';
      walletAddressEl.textContent = '‚Äî';
    }

    // Try to connect using TonConnect UI if available, else use SDK fallback to open universal link / qr
    async function connectWallet() {
      try {
        // If TonConnect UI available, prefer it (it will show wallet selector & QR)
        if (tonConnectUI && typeof tonConnectUI.open === 'function') {
          try { tonConnectUI.open(); return; } catch(e){ /* fallthrough */ }
        }
        // Fallback: use TonConnect SDK directly
        if (connector) {
          // Try to connect: the connect() expects a wallet source object OR will show UI via built-in bridges.
          // Minimal walletSource for Tonkeeper (universal link) - using Tonkeeper website as universalLink (wallet will handle it)
          const walletSource = { universalLink: 'https://tonkeeper.com' };
          const link = connector.connect(walletSource);
          // connector.connect returns universal link (string) or promise ‚Äî if string, open it, else handle promise
          if (typeof link === 'string') {
            // open as window (for browser extension/system will catch)
            window.open(link, '_blank');
          } else if (link && typeof link.then === 'function') {
            const result = await link;
            // result may contain info; wait for onStatusChange to update address
          }
        } else {
          alert('TonConnect SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ CDN —Å–∫—Ä–∏–ø—Ç–æ–≤.');
        }
      } catch (e) {
        console.warn('connectWallet err', e);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞ (—Å–º. console).');
      }
    }

    async function disconnectWallet() {
      try {
        if (connector && typeof connector.disconnect === 'function') {
          await connector.disconnect();
        }
      } catch(e){ console.warn('disconnect err', e); }
      hideAddress();
    }

    // handlers
    walletBtn && walletBtn.addEventListener('click', openModal);
    closeWalletModal && closeWalletModal.addEventListener('click', closeModal);
    walletConnectBtn && walletConnectBtn.addEventListener('click', connectWallet);
    walletDisconnectBtn && walletDisconnectBtn.addEventListener('click', disconnectWallet);

    // init on load (non-blocking)
    setTimeout(initTon, 500);
  })();
</script>
<!-- === /TON WALLET === -->
