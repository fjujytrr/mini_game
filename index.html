<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hide & Seek ‚Äî DApp —Å Tonkeeper</title>
  <style>
    :root{ --bg:#0f1113; --card:#121316; --muted:#bfc9d6; --accent:#00D8FF; --glass: rgba(255,255,255,0.02); color-scheme: dark; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#0b0c0e,#131418); color:#e6f0ff}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px;gap:12px}
    .coin-panel{display:flex;align-items:center;gap:12px;background:var(--glass);padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .house{height:50vh;display:flex;align-items:center;justify-content:center;border-radius:12px;margin:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
    .controls{display:flex;gap:8px;padding:10px}
    .btnPrimary{background:linear-gradient(90deg,var(--accent),#00A8FF);border:none;padding:10px 14px;border-radius:10px;color:#000;font-weight:700;cursor:pointer}
    .btnGhost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:9px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
    .bottom-nav{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:center;pointer-events:none}
    .nav-wrap{pointer-events:auto;background:var(--glass);display:flex;gap:8px;padding:8px;border-radius:40px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 14px 40px rgba(0,0,0,0.6)}
    .nav-wrap button{background:transparent;border:none;font-size:20px;padding:8px;border-radius:10px;color:inherit;cursor:pointer}
    /* wallet modal */
    #walletModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.6));z-index:11000}
    #walletModal .card{width:95%;max-width:420px;background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .wallet-row{display:flex;justify-content:space-between;gap:8px;margin-top:8px}
    .small-muted{color:var(--muted);font-size:13px}
    pre{background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;overflow:auto;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="coin-panel">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:44px;height:44px;border-radius:50%;overflow:hidden;background:#fff"><img src="logo.png" alt="logo" style="width:100%;height:100%;object-fit:cover"></div>
        <div>
          <div style="font-size:12px;color:var(--muted)">ZEX</div>
          <div id="coinsVal" style="font-weight:900">0</div>
        </div>
      </div>
      <div style="margin-left:16px;display:flex;align-items:center;gap:8px">
        <div style="font-size:12px;color:var(--muted)">TON</div>
        <div id="tonVal" style="font-weight:900">0.00</div>
      </div>
    </div>
    <div style="font-size:14px;color:var(--muted)">Hide & Seek ‚Äî DApp</div>
  </header>

  <main>
    <div class="house">–ó–æ–Ω–∞ –∏–≥—Ä—ã</div>
    <div class="controls">
      <button class="btnPrimary" id="startBtn">Start</button>
      <button class="btnGhost" id="resetBtn">Reset</button>
    </div>
  </main>

  <!-- Wallet modal -->
  <div id="walletModal" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="walletTitle">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 id="walletTitle" style="margin:0">–ü–æ–¥–∫–ª—é—á–∏—Ç—å TON-–∫–æ—à–µ–ª–µ–∫</h3>
        <button id="closeWallet" class="btnGhost">‚úï</button>
      </div>
      <p class="small-muted">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Tonkeeper –∏–ª–∏ –¥—Ä—É–≥–æ–π –∫–æ—à–µ–ª—ë–∫ —á–µ—Ä–µ–∑ TON Connect.</p>

      <div class="wallet-row">
        <div>
          <div class="small-muted">–°—Ç–∞—Ç—É—Å</div>
          <div id="walletStatus" style="font-weight:900">Not connected</div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">–ê–¥—Ä–µ—Å</div>
          <div id="walletAddr">‚Äî</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
        <button id="connectWalletBtn" class="btnPrimary">Connect</button>
        <button id="disconnectWalletBtn" class="btnGhost" style="display:none">Disconnect</button>
      </div>

      <div style="margin-top:12px" class="small-muted">
        –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–ª–æ–∂–∏—Ç—å <code>/tonconnect-manifest.json</code> –≤ –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞. –ü—Ä–∏–º–µ—Ä:
        <pre>{
  "url": "https://your-domain.com",
  "name": "HideAndSeek DApp",
  "iconUrl": "https://your-domain.com/icon-192.png"
}</pre>
      </div>
    </div>
  </div>

  <!-- bottom navigation -->
  <div class="bottom-nav">
    <div class="nav-wrap">
      <button id="navHome" title="Home">üè†</button>
      <button id="miningBtn" title="Mining">‚õèÔ∏è</button>
      <button id="casinoBtn" title="Casino">üé∞</button>
      <button id="profileBtn" title="Profile">üë§</button>
      <!-- wallet button -->
      <button id="walletBtn" title="Wallet">üëõ</button>
    </div>
  </div>

  <!-- TonConnect SDK -->
  <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>

  <script>
  // ---------- –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤ (–ø—Ä–∏–º–µ—Ä) ----------
  const coinsVal = document.getElementById('coinsVal');
  const tonVal = document.getElementById('tonVal');
  let coins = +localStorage.getItem('coins') || 0;
  let ton = +localStorage.getItem('ton') || 0.00;
  function renderBalances(){ coinsVal.textContent = (coins>=1000? (coins/1000).toFixed(1)+'K':String(coins)); tonVal.textContent = Number(ton).toFixed(2) }
  renderBalances();
  document.getElementById('startBtn').addEventListener('click', ()=>{ coins += 100; localStorage.setItem('coins', coins); renderBalances() });
  document.getElementById('resetBtn').addEventListener('click', ()=>{ coins=0; localStorage.setItem('coins', coins); renderBalances() });

  // ---------- TON CONNECT: —É—Å—Ç–æ–π—á–∏–≤—ã–π, –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥ ----------
  (async function initTonConnect() {
    // —Ä–∞–∑–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç—ã –≤ —Ä–∞–∑–Ω—ã—Ö —Å–±–æ—Ä–∫–∞—Ö
    const TonConnectExports = window.TonConnectSDK || window.TonConnect || window.TonConnect;
    if (!TonConnectExports) {
      console.warn('TonConnect SDK –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ CDN —Å–∫—Ä–∏–ø—Ç–∞.');
      // –î–∞–∂–µ –µ—Å–ª–∏ SDK –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –¥–µ–ª–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ UI-—Ö—ç–Ω–¥–ª–µ—Ä—ã.
      attachWalletUIWithoutSDK();
      return;
    }

    // –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–ª—É—á–∏—Ç—å manifest (–µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω).
    const manifestUrl = window.location.origin + '/tonconnect-manifest.json';
    let gotManifest = false;
    try {
      const resp = await fetch(manifestUrl, {cache: "no-store"});
      if (resp.ok) {
        // –ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –≤–∞–ª–∏–¥–Ω—ã–π –ª–∏ JSON
        await resp.json();
        gotManifest = true;
        console.log('tonconnect-manifest.json –Ω–∞–π–¥–µ–Ω –∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω');
      } else {
        console.warn('tonconnect-manifest.json HTTP status:', resp.status);
      }
    } catch (e) {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å tonconnect-manifest.json:', e);
    }

    // –°–æ–∑–¥–∞—ë–º connector –±–µ–∑–æ–ø–∞—Å–Ω–æ (—É—á–∏—Ç—ã–≤–∞—è —Ä–∞–∑–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç—ã)
    let connector;
    try {
      // TonConnectExports –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–ª–∞—Å—Å–æ–º –∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–º —Å –ø–æ–ª–µ–º TonConnect
      const TonConnectClass = TonConnectExports.TonConnect ? TonConnectExports.TonConnect : TonConnectExports;
      if (gotManifest) {
        connector = new TonConnectClass({ manifestUrl });
      } else {
        connector = new TonConnectClass();
      }
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ TonConnect connector:', e);
      attachWalletUIWithoutSDK();
      return;
    }

    // UI —ç–ª–µ–º–µ–Ω—Ç—ã
    const walletBtn = document.getElementById('walletBtn');
    const walletModal = document.getElementById('walletModal');
    const closeWallet = document.getElementById('closeWallet');
    const connectBtn = document.getElementById('connectWalletBtn');
    const disconnectBtn = document.getElementById('disconnectWalletBtn');
    const walletStatusEl = document.getElementById('walletStatus');
    const walletAddrEl = document.getElementById('walletAddr');

    // helper to safely extract address
    function extractAddress(info) {
      try {
        if (!info) return null;
        if (info.account && info.account.address) return info.account.address;
        if (info.wallet && info.wallet.account && info.wallet.account.address) return info.wallet.account.address;
        // sometimes connector exposes wallet/account directly
        if (connector && connector.wallet && connector.wallet.account && connector.wallet.account.address) return connector.wallet.account.address;
        if (connector && connector.account && connector.account.address) return connector.account.address;
      } catch (e) {
        console.warn('extractAddress error', e);
      }
      return null;
    }

    // update UI
    function updateWalletUI(info) {
      const addr = extractAddress(info);
      if (addr) {
        walletStatusEl.textContent = 'Connected';
        walletAddrEl.textContent = addr;
        connectBtn.style.display = 'none';
        disconnectBtn.style.display = 'inline-block';
      } else {
        walletStatusEl.textContent = 'Not connected';
        walletAddrEl.textContent = '‚Äî';
        connectBtn.style.display = 'inline-block';
        disconnectBtn.style.display = 'none';
      }
    }

    // subscribe to status changes (if available)
    try {
      connector.onStatusChange?.((info) => {
        console.log('TonConnect status change', info);
        updateWalletUI(info);
      });
    } catch (e) {
      console.warn('onStatusChange subscription failed', e);
    }

    // restore connection if previously connected
    try { connector.restoreConnection?.(); } catch (e) { console.warn('restoreConnection failed', e); }

    // connect button
    connectBtn.addEventListener('click', async () => {
      try {
        await connector.connect();
        // status change handler –æ–±–Ω–æ–≤–∏—Ç UI
      } catch (err) {
        console.error('connector.connect error', err);
        // –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        let friendly = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞.';
        if (err && err.message) friendly += '\n\n' + err.message;
        friendly += '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ: 1) –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ tonconnect-manifest.json (–∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ –Ω–µ–≥–æ), 2) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ –∫–æ—à–µ–ª—ë–∫/—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, 3) –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.';
        alert(friendly);
      }
    });

    // disconnect button
    disconnectBtn.addEventListener('click', async () => {
      try {
        await connector.disconnect();
      } catch (e) { console.warn('disconnect error', e); }
      updateWalletUI(null);
    });

    // open/close modal
    walletBtn.addEventListener('click', ()=> {
      walletModal.style.display = 'flex';
      walletModal.setAttribute('aria-hidden', 'false');
      // –æ–±–Ω–æ–≤–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      try {
        // –µ—Å–ª–∏ connector –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π info - –ø–µ—Ä–µ–¥–∞–¥–∏–º –≤ update
        const current = connector.wallet || connector.account || null;
        updateWalletUI(current);
      } catch (e) { console.warn(e); }
    });
    closeWallet.addEventListener('click', ()=> {
      walletModal.style.display = 'none';
      walletModal.setAttribute('aria-hidden', 'true');
    });

    // expose for debug
    window._tonConnector = connector;
    // –Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI (–≤–¥—Ä—É–≥ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ)
    try { updateWalletUI(connector.wallet || connector.account || null); } catch(e){}
  })();

  // –ï—Å–ª–∏ SDK —Å–æ–≤—Å–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –ø–∞–¥–∞–µ–º –º—è–≥–∫–æ: –ø–æ–¥–∫–ª—é—á–∏–º –∫–Ω–æ–ø–∫–∏, –Ω–æ –±–µ–∑ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞.
  function attachWalletUIWithoutSDK(){
    const walletBtn = document.getElementById('walletBtn');
    const walletModal = document.getElementById('walletModal');
    const closeWallet = document.getElementById('closeWallet');
    const connectBtn = document.getElementById('connectWalletBtn');
    const disconnectBtn = document.getElementById('disconnectWalletBtn');
    const walletStatusEl = document.getElementById('walletStatus');
    const walletAddrEl = document.getElementById('walletAddr');

    walletBtn?.addEventListener('click', ()=> {
      walletModal.style.display = 'flex';
      walletModal.setAttribute('aria-hidden','false');
      walletStatusEl.textContent = 'SDK not loaded';
      walletAddrEl.textContent = '‚Äî';
      connectBtn.onclick = ()=> alert('TonConnect SDK –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω. –î–æ–±–∞–≤—å—Ç–µ <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>');
    });
    closeWallet?.addEventListener('click', ()=> {
      walletModal.style.display = 'none';
      walletModal.setAttribute('aria-hidden','true');
    });
    disconnectBtn.style.display = 'none';
  }
  </script>
</body>
</html>
