<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hide & Seek ‚Äî Premium Emoji (Updated)</title>
  <style>
:root{   --accent-cyan: #00D8FF;   --birch: #EDE4C8;   --purple-frame: #7a4bff;   --deep-purple: #5a2ecc;   --glass: rgba(255,255,255,0.06); }
/* –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ */ html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(120deg,#3b2a7a,#8aa7ff);background-size:200% 200%;animation:gradientBG 15s ease infinite;color:#fff;overflow:hidden} @keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}} body{display:flex;flex-direction:column;align-items:center;min-height:100vh} /* Header */ header{width:95%;margin:15px 0;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.08);border-radius:12px;padding:10px;backdrop-filter:blur(5px)} .coin-panel{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:16px;box-shadow:0 0 12px rgba(0,216,255,0.08)} .coin-logo{width:48px;height:48px;border-radius:50%;object-fit:cover;border:3px solid var(--purple-frame);box-shadow:0 6px 18px rgba(122,75,255,0.18);background:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;color:#000} .coin-panel .val{font-weight:800;font-size:18px;color:var(--accent-cyan)} /* TON panel */ .ton-panel{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:12px;background:transparent} .ton-logo{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;background:transparent;color:#000;border:3px solid rgba(255,255,255,0.06);box-shadow:0 6px 18px rgba(255,193,7,0.06);object-fit:cover} .ton-val{font-weight:800;font-size:14px;color:#ffeaa7} /* –î–æ–º: —Å–µ—Ç–∫–∞ –∫–æ–º–Ω–∞—Ç */ .house{position:relative;width:95%;max-width:500px;margin:20px 0;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(4,1fr);gap:12px} .room{background:rgba(255,255,255,0.06);border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:28px;color:#fff;cursor:pointer;transition:transform .3s,box-shadow .3s;position:relative;border:2px solid rgba(255,255,255,0.14)} .room:hover{transform:scale(1.05);box-shadow:0 0 18px rgba(0,216,255,0.14)} .room.selected{border-color:var(--accent-cyan);box-shadow:0 0 12px var(--accent-cyan)} .room.found{border-color:#FF0054;box-shadow:0 0 12px #FF0054;animation:foundAnim 1s ease} .room.safe{border-color:#39FF14;box-shadow:0 0 12px #39FF14;animation:safeAnim .8s ease} .room.highlight{box-shadow:0 0 22px 4px var(--accent-cyan);transition:box-shadow .3s} @keyframes foundAnim{0%{transform:scale(1)}50%{transform:rotate(10deg) scale(1.15)}100%{transform:scale(1)}} @keyframes safeAnim{0%{transform:scale(1)}50%{transform:rotate(-10deg) scale(0.95)}100%{transform:scale(1)}} /* –ö–æ–Ω—Ç—Ä–æ–ª—ã */ .controls{width:90%;display:flex;justify-content:space-between;margin-bottom:15px} button{flex:1;margin:0 5px;padding:14px;font-size:20px;border:none;border-radius:12px;cursor:pointer;color:#000;background:var(--accent-cyan);box-shadow:0 4px 12px rgba(0,216,255,0.25);transition:transform .2s,box-shadow .2s} button:active{transform:scale(.98);box-shadow:0 2px 6px rgba(0,216,255,0.18)} button.secondary{background:rgba(0,0,0,0.36);color:#fff;border:1px solid rgba(255,255,255,0.06);box-shadow:0 3px 8px rgba(0,216,255,0.12)} /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */ .bottom-menu{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);Width:90%;max-width:620px;display:flex;justify-content:space-around;gap:8px;background:rgba(0,0,0,0.28);padding:6px 12px;border-radius:16px;backdrop-filter:blur(5px);box-shadow:0 0 12px rgba(0,216,255,0.18)} .bottom-menu button{background:transparent;color:#fff;font-size:22px;transition:transform .2s;padding:8px 10px;border-radius:10px} .bottom-menu button:hover{transform:scale(1.12);color:var(--accent-cyan)} /* –ê–ø–≥—Ä–µ–π–¥—ã */ .upgrade-panel{display:flex;gap:12px;margin:10px 0;overflow-x:auto;padding:12px 10px;width:95%;justify-content:flex-start;align-items:stretch} .upgrade{flex:0 0 auto;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));padding:16px;border-radius:16px;text-align:left;min-width:220px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06);transition:transform .18s,box-shadow .18s} .upgrade:hover{transform:translateY(-6px)} .upgrade h3{margin:0 0 8px;font-size:16px;color:var(--accent-cyan)} .upgrade p{margin:0;font-size:14px;color:#eee} .upgrade .price{margin-top:10px;font-weight:800;color:var(--birch);font-size:16px} .upgrade .badge{display:inline-block;margin-top:8px;padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.18);font-weight:700;color:#fff;font-size:12px} /* Mining info */ .mining-info{margin:10px 0;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:14px;width:95%;text-align:center;box-shadow:0 2px 6px rgba(0,216,255,0.06)} /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ –ø–∞–Ω–µ–ª—å –Ω–∞–≥—Ä–∞–¥ */ /* –°–¥–µ–ª–∞–Ω–æ: —Ñ–æ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ .glass –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π (–ø–æ –≤–∞—à–µ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é) */ #wsModalOverlay{ --wm-accentA:#3b2a7a; --wm-accentB:#8aa7ff; --wm-accentC:#00D8FF; --wm-birch:#EDE4C8; z-index:10000; position:fixed; inset:0; display:flex; align-items:flex-start; justify-content:center; font-family:Inter,system-ui,Arial,sans-serif; } #wsModalOverlay.hidden{ display:none; } #wsModalOverlay .bgLayer{ position:absolute; inset:0; background:linear-gradient(120deg,var(--wm-accentA),var(--wm-accentB)); display:block; overflow:hidden; opacity:0.06; } #wsModalOverlay .bgImage{ position:absolute; inset:0; background-image:url('fon.png'); background-size:cover; background-position:center; filter:blur(6px) saturate(1.05); mix-blend-mode:overlay; opacity:0.12; } /* –û–¢–õ–ê–î–ö–ê: —Ñ–æ–Ω .glass —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */ #wsModalOverlay .glass{ position:relative; width:100%; max-width:980px; margin:0 auto; box-sizing:border-box; padding:18px; border-radius:18px 18px 0 0; backdrop-filter: blur(8px) saturate(1.05); background:transparent; box-shadow: 0 -12px 40px rgba(0,0,0,0.25); display:flex; flex-direction:column; gap:12px; overflow:hidden; } /* Rewards */ .rewardsShell{ display:flex; flex-direction:column; gap:12px; } .rewardsContainer{ background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(255,255,255,0.01)); border-radius:14px; padding:12px; box-shadow:0 8px 30px rgba(0,0,0,0.36); border:1px solid rgba(255,255,255,0.04); max-height: calc(70vh - 110px); overflow:auto; } .rewardsGridTop{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; } .rewardsGridBottom{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; } .rewardCard{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:12px; min-height:86px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; transition:transform .16s ease, box-shadow .16s ease; cursor:pointer; border:1px solid rgba(255,255,255,0.04); } .rewardCard:hover{ transform:translateY(-6px); } .rewardCard.pop{ animation:pop .26s ease; } @keyframes pop{ 0%{ transform:scale(1); } 50%{ transform:scale(1.06);} 100%{ transform:scale(1); } } .rewardCard .coinIconSmall{ width:44px; height:44px; border-radius:50%; background:linear-gradient(90deg,var(--wm-accentC),#00A8FF); display:flex; align-items:center; justify-content:center; font-weight:800; color:#000; margin-bottom:8px; border:2px solid rgba(255,255,255,0.06); box-shadow:0 8px 18px rgba(0,216,255,0.08); } .rewardCard .dayLabel{ font-weight:800; color:#ecf8ff; margin-bottom:6px; } .rewardCard .amount{ font-weight:900; font-size:16px; color:var(--wm-accentC); text-shadow: 0 6px 18px rgba(0,216,255,0.08); } .rewardCard.locked{ opacity:0.36; pointer-events:auto; } .rewardCard.locked .overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(0,0,0,0.36), rgba(0,0,0,0.6)); border-radius:12px; color:#fff; font-weight:800; text-align:center; padding:6px; font-size:13px; } .rewardCard.unlocked{ box-shadow:0 10px 30px rgba(0,216,255,0.06); border:1px solid rgba(0,216,255,0.12); } .rewardCard.claimed{ opacity:0.9; pointer-events:none; } .rewardCard .claimBadge{ position:absolute; top:8px; right:8px; background:linear-gradient(90deg,#FFD54A,#FFC107); color:#000; padding:6px 8px; border-radius:999px; font-weight:800; box-shadow:0 6px 20px rgba(255,193,7,0.12); font-size:12px; } .rewardCard.big{ min-height:120px; padding:18px; } /* Casino modal (wheel) */ #casinoModal{ position:fixed; inset:0; z-index:11000; display:none; align-items:center; justify-content:center; padding:24px; box-sizing:border-box; } #casinoModal .panel{ width:100%; max-width:760px; border-radius:14px; padding:18px; box-sizing:border-box; background:transparent; box-shadow:0 10px 30px rgba(0,0,0,0.36); border:1px solid rgba(255,255,255,0.04); } .casino-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; } .casino-title{ font-weight:900; color:#ecf8ff; display:flex;align-items:center;gap:10px } .wheel-wrap{ display:flex; gap:18px; align-items:center; justify-content:center; flex-wrap:wrap; } .wheel{ width:320px; height:320px; border-radius:50%; position:relative; box-shadow:0 12px 40px rgba(0,0,0,0.4); border:8px solid rgba(255,255,255,0.03); overflow:hidden; } .wheel .inner{ width:100%; height:100%; border-radius:50%; transition:transform 4s cubic-bezier(.08,.9,.2,1); transform:rotate(0deg); } .pointer{ width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-bottom:28px solid #fff; position:relative; top:-12px; transform:translateY(-50%); margin:0 auto; filter:drop-shadow(0 6px 12px rgba(0,0,0,0.4)); } .spin-btn{ padding:12px 18px; border-radius:12px; font-weight:900; border:none; cursor:pointer; background:linear-gradient(90deg,var(--accent-cyan),#00A8FF); color:#000; box-shadow:0 12px 36px rgba(0,216,255,0.18); } .prizes-list{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:12px; } .prize-chip{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04); text-align:center; font-weight:800 } .casino-footer{ display:flex; justify-content:space-between; align-items:center; margin-top:12px; } .small-muted{ color:var(--birch); font-weight:700 } /* Responsive */ @media (max-width:720px){ .wheel{ width:260px;height:260px } .panel{ padding:12px } .bottom-menu{max-width:520px} }   </style>
</head>
<body>
  <header>
    <div></div><!-- –ø—É—Å—Ç–æ–π –±–ª–æ–∫ –≤–º–µ—Å—Ç–æ —É–¥–∞–ª—ë–Ω–Ω–æ–π —à–∫–∞–ª—ã –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π -->
    <div class="coin-panel" aria-live="polite" aria-atomic="true">
      <div style="display:flex;align-items:center;gap:12px;">
        <img class="coin-logo" id="zexLogo" src="logo.png" alt="ZEX" />
        <div>
          <div style="font-size:12px;color:var(--birch);font-weight:800">ZEX</div>
          <div class="val" id="coinsVal">0</div>
        </div>
      </div>

      <div class="ton-panel" style="margin-left:8px;">
        <img class="ton-logo" id="tonLogo" src="ton.png" alt="TON" />
        <div>
          <div style="font-size:12px;color:var(--birch);font-weight:800">TON</div>
          <div class="ton-val" id="tonVal">0</div>
        </div>
      </div>
    </div>
  </header>

   <div class="house"></div>

   <div class="controls">
    <button id="startBtn">üè†</button>
    <button class="secondary" id="resetBtn">üîç</button>
  </div>

  <!-- –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–∞–Ω–µ–ª—å –∞–ø–≥—Ä–µ–π–¥–æ–≤ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ -->
  <div class="upgrade-panel" id="upgradePanel">
    <div class="upgrade" data-key="x2Prize" data-base-price="20000">
      <h3>x2 Prize / x2 Loss</h3>
      <p>Double rewards & penalties</p>
      <div class="price">20,000</div>
      <div class="badge">Boost</div>
    </div>
    <div class="upgrade" data-key="check1" data-base-price="20000">
      <h3>Check 1 Room Only</h3>
      <p>Hunter checks 1 room only (1 min)</p>
      <div class="price">20,000</div>
      <div class="timer" id="check1Timer"></div>
    </div>

    <!-- –ù–æ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç 1 –º–∏–Ω—É—Ç—É) -->
    <div class="upgrade" data-key="shield" data-base-price="25000">
      <h3>Shield (1m)</h3>
      <p>Protects you from loss for 1 minute</p>
      <div class="price">25,000</div>
      <div class="timer" id="shieldTimer"></div>
      <div class="badge">Defence</div>
    </div>

    <div class="upgrade" data-key="incBoost" data-base-price="30000">
      <h3>Double Income (1m)</h3>
      <p>Mining income √ó2 for 1 minute</p>
      <div class="price">30,000</div>
      <div class="timer" id="incTimer"></div>
      <div class="badge">Income</div>
    </div>

    <div class="upgrade" data-key="luck" data-base-price="22000">
      <h3>Lucky Escape (1m)</h3>
      <p>50% chance to evade if hunted (1 minute)</p>
      <div class="price">22,000</div>
      <div class="timer" id="luckTimer"></div>
      <div class="badge">Chance</div>
    </div>
  </div>

  <div class="mining-info">
    <strong id="miningLabel">Mining Income:</strong> <span id="miningIncomeVal">0</span>/hr
  </div>

  <!-- –°–∫—Ä—ã—Ç–∞—è –ø–∞–Ω–µ–ª—å –º–∞–π–Ω–µ—Ä–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–º) -->
  <div class="miners-panel" id="minersPanelVisible" aria-hidden="true"></div>

  <!-- Modal mining shop (fullscreen modal) -->
  <div id="miningShop" aria-hidden="true">
    <h2 id="shopTitle">Mining Shop</h2>
    <div class="miners-container"></div>
    <button id="closeMiningShop" style="margin-top:12px;width:100%;padding:12px;font-size:18px;border:none;border-radius:12px;background:rgba(0,0,0,0.22);color:#fff;cursor:pointer;">Close</button>
  </div>

  <!-- Buy confirm -->
  <div id="buyConfirm" aria-hidden="true">
    <div class="confirm-box">
      <p id="buyText"></p>
      <div style="display:flex;justify-content:center;">
        <button id="confirmBuy">Buy</button>
        <button id="cancelBuy">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Info window (—Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è, –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è) -->
  <div id="infoWindow" aria-hidden="true">
    <div class="content">
      <h2 id="infoTitle">How to Play</h2>
      <ul id="infoList">
        <li>Select a room and then click the üîç button to hunt.</li>
        <li>The hunter searches 2 random rooms (1 if "Check 1 Room" is active).</li>
        <li>If your room is found, you lose coins (shown in red).</li>
        <li>If you evade the hunt, you gain coins (shown in green).</li>
        <li>Buy upgrades or miners to improve your chances and income.</li>
        <li>Claim daily rewards and complete quests for bonus coins.</li>
      </ul>
      <button id="closeInfo">Close</button>
    </div>
  </div>

  <!-- Profile window (—Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è, –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è) -->
  <div id="profileWindow" aria-hidden="true">
    <div class="content">
      <h2 id="profileTitle">Profile</h2>

       <div style="margin-bottom:16px;padding:16px;background:rgba(0,0,0,0.06);border-radius:12px;">
        <h3 id="dailyTitle" style="margin-bottom:8px;font-size:18px;color:#ecf8ff">Daily Reward</h3>
        <p id="dailyText" style="margin-bottom:12px;color:#fff">Get 30,000 coins once a day!</p>
        <button id="claimDaily" style="width:100%;padding:12px;font-size:16px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--accent-cyan),#00A8FF);color:#000;cursor:pointer;font-weight:700;">Claim Daily</button>
        <p id="dailyStatus" style="margin-top:8px;color:var(--birch);font-weight:600;text-align:center;"></p>
      </div>

       <div style="margin-bottom:16px;padding:16px;background:rgba(0,0,0,0.06);border-radius:12px;">
        <h3 id="questTitle" style="margin-bottom:8px;font-size:18px;color:#ecf8ff">Quest</h3>
        <p id="questText" style="margin-bottom:12px;color:#fff">Subscribe to get bonus coins!</p>
        <button id="claimQuest" style="width:100%;padding:12px;font-size:16px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--accent-cyan),#00A8FF);color:#000;cursor:pointer;font-weight:700;">Claim Quest</button>
        <p id="questStatus" style="margin-top:8px;color:var(--birch);font-weight:600;text-align:center;"></p>
      </div>

       <div class="settings-card">
        <div class="settings-row">
          <div>
            <h3 id="settingsTitle">Settings</h3>
            <p id="settingsText">Change language and other preferences.</p>
          </div>
          <div>
            <select id="langSelect" class="select-lang">
              <option value="ru">–†—É—Å—Å–∫–∏–π</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
      </div>

      <button id="closeProfile" style="width:100%;padding:14px;font-size:18px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--accent-cyan),#00A8FF);color:#000;cursor:pointer;font-weight:700;">Close</button>
    </div>
  </div>

  <!-- Casino modal -->
  <div id="casinoModal" aria-hidden="true" role="dialog" aria-label="Casino wheel">
    <div class="panel" role="document" aria-modal="true">
      <div class="casino-header">
        <div class="casino-title">üé∞ Casino ‚Äî Wheel of Fortune</div>
        <div style="text-align:right">
          <div style="font-weight:800;color:var(--accent-cyan);font-size:16px" id="casinoBalance">0 ZEX ‚Ä¢ 0 TON</div>
          <div style="font-size:12px;color:var(--birch)">Spin once every 2 hours</div>
        </div>
      </div>

      <div class="wheel-wrap">
        <div>
          <div class="pointer" id="wheelPointer" aria-hidden="true"></div>
          <div class="wheel" aria-hidden="true">
            <div class="inner" id="wheelInner" role="img" aria-label="Wheel">
              <!-- wheel sectors are drawn with conic-gradient via JS/CSS -->
            </div>
          </div>
        </div>

        <div style="max-width:320px;">
          <div style="margin-bottom:12px;">
            <button class="spin-btn" id="spinBtn">Spin the Wheel</button>
          </div>
          <div class="small-muted" id="spinStatus">Ready to spin</div>

          <div class="prizes-list" id="prizesList" style="margin-top:12px;"></div>
        </div>
      </div>

      <div class="casino-footer">
        <div class="small-muted">Good luck!</div>
        <div>
          <button class="btnGhost" id="closeCasino">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-menu">
    <button id="infoBtn" class="secondary">‚Ñπ</button>
    <button id="shopBtn" class="secondary">üõí</button>
    <button id="miningBtn" class="secondary">‚õè</button>
    <button id="casinoBtn" class="secondary">üé∞</button>
    <button id="profileBtn" class="secondary">üë§</button>
  </div>

  <script>
  /* ==========================    JS (–¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞–∑–∏–Ω–æ + –ª–æ–≥–æ—Ç–∏–ø—ã)    ========================== */ 

 // ========== –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ) ========== 
 const i18n = {
  ru: { pickRoomFirst: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É!', notEnough: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', dailyAlready: '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–∞!', questAlready: '–ö–≤–µ—Å—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω!', miningIncome: '–î–æ—Ö–æ–¥ –º–∞–π–Ω–∏–Ω–≥–∞:', miningShop: '–ú–∞–≥–∞–∑–∏–Ω –º–∞–π–Ω–∏–Ω–≥–∞', close: '–ó–∞–∫—Ä—ã—Ç—å', howToPlay: '–ö–∞–∫ –∏–≥—Ä–∞—Ç—å', infoList: ['–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É üîç –¥–ª—è –æ—Ö–æ—Ç—ã.','–û—Ö–æ—Ç–Ω–∏–∫ –∏—â–µ—Ç 2 —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã (1, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω "Check 1 Room").','–ï—Å–ª–∏ –≤–∞—à—É –∫–æ–º–Ω–∞—Ç—É –Ω–∞—à–ª–∏, –≤—ã —Ç–µ—Ä—è–µ—Ç–µ –º–æ–Ω–µ—Ç—ã (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–º).','–ï—Å–ª–∏ –≤—ã –∏–∑–±–µ–∂–∞–ª–∏ –æ—Ö–æ—Ç—ã, –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –º–æ–Ω–µ—Ç—ã (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∑–µ–ª–µ–Ω—ã–º).','–ü–æ–∫—É–ø–∞–π—Ç–µ –∞–ø–≥—Ä–µ–π–¥—ã –∏–ª–∏ –º–∞–π–Ω–µ—Ä–æ–≤, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å —à–∞–Ω—Å—ã –∏ –¥–æ—Ö–æ–¥.','–ó–∞–±–∏—Ä–∞–π—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –∏ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –∫–≤–µ—Å—Ç—ã –¥–ª—è –±–æ–Ω—É—Å–Ω—ã—Ö –º–æ–Ω–µ—Ç.'], profile: '–ü—Ä–æ—Ñ–∏–ª—å', dailyReward: '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞', dailyText: '–ü–æ–ª—É—á–∏—Ç–µ 30 000 –º–æ–Ω–µ—Ç —Ä–∞–∑ –≤ –¥–µ–Ω—å!', claimDaily: '–ó–∞–±—Ä–∞—Ç—å', quest: '–ö–≤–µ—Å—Ç', claimQuest: '–í–∑—è—Ç—å', settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', settingsText: '–°–º–µ–Ω–∏—Ç–µ —è–∑—ã–∫ –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.', buyFor: '–ö—É–ø–∏—Ç—å {name} –∑–∞ {price}?', buy: '–ö—É–ø–∏—Ç—å', cancel: '–û—Ç–º–µ–Ω–∞', profitHr: '–ü—Ä–∏–±—ã–ª—å/—á:' },
  en: { pickRoomFirst: 'Pick a room first!', notEnough: 'Not enough coins!', dailyAlready: 'Daily reward already claimed!', questAlready: 'Quest already claimed!', miningIncome: 'Mining Income:', miningShop: 'Mining Shop', close: 'Close', howToPlay: 'How to Play', infoList: ['Select a room and then click the üîç button to hunt.','The hunter searches 2 random rooms (1 if "Check 1 Room" is active).','If your room is found, you lose coins (shown in red).','If you evade the hunt, you gain coins (shown in green).','Buy upgrades or miners to improve your chances and income.','Claim daily rewards and complete quests for bonus coins.'], profile: 'Profile', dailyReward: 'Daily Reward', dailyText: 'Get 30,000 coins once a day!', claimDaily: 'Claim Daily', quest: 'Quest', claimQuest: 'Claim Quest', settings: 'Settings', settingsText: 'Change language and other preferences.', buyFor: 'Buy {name} for {price}?', buy: 'Buy', cancel: 'Cancel', profitHr: 'Profit/hr:' }
};
let lang = localStorage.getItem('lang') || 'ru';
function t(key, vars = {}) { const val = i18n[lang][key]; if (typeof val === 'string') return val.replace(/\{(\w+)\}/g, (_, k) => vars[k] || ''); return val; }
function applyLang(){ document.getElementById('miningLabel').textContent = t('miningIncome'); document.getElementById('shopTitle').textContent = t('miningShop'); document.getElementById('closeMiningShop') && (document.getElementById('closeMiningShop').textContent = t('close')); document.getElementById('confirmBuy') && (document.getElementById('confirmBuy').textContent = t('buy')); document.getElementById('cancelBuy') && (document.getElementById('cancelBuy').textContent = t('cancel')); document.getElementById('infoTitle').textContent = t('howToPlay'); document.getElementById('profileTitle').textContent = t('profile'); document.getElementById('dailyTitle').textContent = t('dailyReward'); document.getElementById('dailyText').textContent = t('dailyText'); document.getElementById('claimDaily') && (document.getElementById('claimDaily').textContent = t('claimDaily')); document.getElementById('questTitle').textContent = t('quest'); document.getElementById('claimQuest') && (document.getElementById('claimQuest').textContent = t('claimQuest')); document.getElementById('settingsTitle').textContent = t('settings'); document.getElementById('settingsText').textContent = t('settingsText'); document.getElementById('closeInfo').textContent = t('close'); document.getElementById('closeProfile').textContent = t('close'); const infoListEl = document.getElementById('infoList'); infoListEl.innerHTML = ''; t('infoList').forEach(li => { const el = document.createElement('li'); el.textContent = li; infoListEl.appendChild(el); }); }

// ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è ==========
// —Å–æ–∑–¥–∞—ë–º –∫–æ–º–Ω–∞—Ç—ã
const roomsContainer = document.querySelector('.house');
for (let i = 0; i < 8; i++) {
  const d = document.createElement('div');
  d.className = 'room';
  d.dataset.idx = i;
  d.textContent = '+';
  roomsContainer.appendChild(d);
}
let selectedRoom = null; let coins = +localStorage.getItem('coins') || 0; let maxCoins = +localStorage.getItem('maxCoins') || coins; const coinsVal = document.getElementById('coinsVal'); let upgrades = JSON.parse(localStorage.getItem('upgrades')) || { x2Prize: 0, check1: 0 }; let check1Expire = +localStorage.getItem('check1Expire') || 0; let roundInProgress = false;

// –ù–æ–≤—ã–µ expire-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–æ–≤ –Ω–∞ 1 –º–∏–Ω—É—Ç—É
let shieldExpire = +localStorage.getItem('shieldExpire') || 0;
let doubleIncomeExpire = +localStorage.getItem('doubleIncomeExpire') || 0;
let luckExpire = +localStorage.getItem('luckExpire') || 0;

// –º–∞–π–Ω–µ—Ä—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞)
const minersData = [
  { n: "Miner 1", i: 500, p: 7000 },
  { n: "Miner 2", i: 1788, p: 12000 },
  { n: "Miner 3", i: 2358, p: 15000 },
  { n: "Miner 4", i: 3000, p: 20000 },
  { n: "Miner 5", i: 4500, p: 25000 },
  { n: "Miner 6", i: 5200, p: 30000 },
  { n: "Miner 7", i: 6100, p: 35000 },
  { n: "Miner 8", i: 7200, p: 40000 },
  { n: "Miner 9", i: 8500, p: 45000 },
  { n: "Miner 10", i: 9500, p: 50000 }
];

// ======= –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è minersState
let minersState; try {
  const saved = JSON.parse(localStorage.getItem('minersState'));
  if (Array.isArray(saved)) {
    minersState = minersData.map((_, i) => {
      const s = saved[i];
      if (s && typeof s.count === 'number') return { count: s.count };
      return { count: 0 };
    });
  } else {
    minersState = minersData.map(_ => ({ count: 0 }));
  }
} catch (e) {
  minersState = minersData.map(_ => ({ count: 0 }));
}

const miningIncomeValEl = document.getElementById('miningIncomeVal'); const minersContainerEl = document.querySelector('.miners-container'); const minersPanelVisible = document.getElementById('minersPanelVisible'); const miningShop = document.getElementById('miningShop'); const buyConfirm = document.getElementById('buyConfirm'); const buyText = document.getElementById('buyText'); let pendingMiner = null;

// —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª 
function format(n) {
  return n >= 1e9 ? (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B' :
         n >= 1e6 ? (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M' :
         n >= 1e3 ? (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K' : String(n);
}

// —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TON (—Ç–æ–Ω–∫–∞—è –¥—Ä–æ–±—å)
function formatTon(n){
  if (!isFinite(n)) return '0';
  if (n === 0) return '0';
  if (n < 0.000001) return '<0.000001';
  return Number(n.toFixed(6)).toString();
}

// —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ 
function save() {
  try {
    localStorage.setItem('coins', coins);
    localStorage.setItem('maxCoins', maxCoins);
    localStorage.setItem('upgrades', JSON.stringify(upgrades));
    localStorage.setItem('check1Expire', check1Expire);
    localStorage.setItem('minersState', JSON.stringify(minersState));
    localStorage.setItem('lastTime', Date.now());
    localStorage.setItem('lang', lang);
    // –Ω–æ–≤—ã–µ expire
    localStorage.setItem('shieldExpire', shieldExpire);
    localStorage.setItem('doubleIncomeExpire', doubleIncomeExpire);
    localStorage.setItem('luckExpire', luckExpire);
  } catch (e) {
    console.warn('Save failed', e);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ZEX –∏ TON
function updateBalancesDisplay(){
  // ZEX
  coinsVal.textContent = format(coins);
  // TON = coins * 0.000003 (–ø–æ –ø—Ä–∞–≤–∏–ª—É 1000 ZEX = 0.003 TON)
  const ton = coins * 0.000003;
  const tonEl = document.getElementById('tonVal');
  if (tonEl) tonEl.textContent = formatTon(ton);
  // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤ –∫–∞–∑–∏–Ω–æ-–º–æ–¥–∞–ª (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç)
  const casinoBalance = document.getElementById('casinoBalance');
  if (casinoBalance) casinoBalance.textContent = format(coins) + ' ZEX ‚Ä¢ ' + formatTon(ton);
  // –∏ rewards modal
  const wsZex = document.getElementById('wsModalCoinsDisplay');
  if (wsZex) wsZex.textContent = format(coins) + ' ZEX ‚Ä¢ ' + formatTon(ton) + ' TON';
}

// –æ–±–Ω–æ–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã 
function updCoins(v = 0) {
  coins += v;
  if (coins < 0) coins = 0;
  if (coins > maxCoins) maxCoins = coins;
  updateBalancesDisplay();
  updUpg();
  updIncome();
  save();
}

// –¥–æ—Ö–æ–¥ –≤ —á–∞—Å
function getIncome() {
  const base = minersState.reduce((sum, m, i) => {
    const count = (m && typeof m.count === 'number') ? m.count : 0;
    return sum + (count > 0 ? Math.floor(minersData[i].i * Math.pow(1.5, count - 1)) : 0);
  }, 0);
  if (doubleIncomeExpire > Date.now()) return base * 2;
  return base;
}
function updIncome() { miningIncomeValEl.textContent = format(getIncome()); }

 // –æ—Ñ—Ñ–ª–∞–π–Ω-–¥–æ—Ö–æ–¥ 
function addOfflineCoins() {
  const last = +localStorage.getItem('lastTime') || Date.now();
  const now = Date.now();
  const diffMinutes = (now - last) / 60000;
  if (diffMinutes > 0) {
    const minutesToAward = Math.min(diffMinutes, 180);
    updCoins(Math.floor(getIncome()/60 * minutesToAward));
  }
  localStorage.setItem('lastTime', now);
}
addOfflineCoins();

// –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
setInterval(()=>{ updCoins(Math.floor(getIncome()/3600)); }, 1000);

// –∞–ø–¥–µ–π—Ç—ã –∞–ø–≥—Ä–µ–π–¥–æ–≤ 
function updUpg() {
  document.querySelectorAll('.upgrade').forEach(u => {
    let key = u.dataset.key; let base = +u.dataset.basePrice; let count = upgrades[key] || 0;
    let price = base * Math.pow(2,count);
    let priceEl = u.querySelector('.price'); if (priceEl) priceEl.textContent = format(price);
    const badge = u.querySelector('.badge'); if (badge) badge.textContent = count > 0 ? `Lvl ${count}` : 'New';
  });
}

// –∞–ø–≥—Ä–µ–π–¥—ã –∫–ª–∏–∫–∏
document.querySelectorAll('.upgrade').forEach(u=>{
  u.onclick = ()=>{
    let key = u.dataset.key; let base = +u.dataset.basePrice; let count = upgrades[key]||0;
    let price = base * Math.pow(2,count);
    if (coins >= price) {
      upgrades[key] = count+1; updCoins(-price);
      if (key === 'check1') check1Expire = Date.now()+60000;
      if (key === 'shield') shieldExpire = Date.now()+60000;
      if (key === 'incBoost') doubleIncomeExpire = Date.now()+60000;
      if (key === 'luck') luckExpire = Date.now()+60000;
      save(); updUpg();
    } else alert(t('notEnough'));
  };
});

// —Ç–∞–π–º–µ—Ä—ã check1 + –Ω–æ–≤—ã–µ —Ç–∞–π–º–µ—Ä—ã
function updTimers() {
  const el = document.getElementById('check1Timer');
  if (el) el.textContent = check1Expire > Date.now() ? '‚è≥ ' + Math.floor((check1Expire - Date.now())/1000) + 's' : '';

  const shEl = document.getElementById('shieldTimer');
  if (shEl) shEl.textContent = shieldExpire > Date.now() ? '‚è≥ ' + Math.floor((shieldExpire - Date.now())/1000) + 's' : '';

  const incEl = document.getElementById('incTimer');
  if (incEl) incEl.textContent = doubleIncomeExpire > Date.now() ? '‚è≥ ' + Math.floor((doubleIncomeExpire - Date.now())/1000) + 's' : '';

  const luckEl = document.getElementById('luckTimer');
  if (luckEl) luckEl.textContent = luckExpire > Date.now() ? '‚è≥ ' + Math.floor((luckExpire - Date.now())/1000) + 's' : '';
}
setInterval(updTimers, 1000);

// –≤—ã–±–æ—Ä –∫–æ–º–Ω–∞—Ç—ã
document.querySelectorAll('.room').forEach(r => {
  r.onclick = () => {
    if (roundInProgress) return;
    document.querySelectorAll('.room').forEach(x=>x.classList.remove('selected'));
    r.classList.add('selected');
    selectedRoom = +r.dataset.idx;
  };
});

// start button
document.getElementById('startBtn').onclick = ()=>{
  if (selectedRoom == null) { alert(t('pickRoomFirst')); return; }
  document.querySelectorAll('.room').forEach(r=>r.classList.remove('found','safe'));
};

// reset / hunt
document.getElementById('resetBtn').onclick = ()=>{
  if (selectedRoom == null) { alert(t('pickRoomFirst')); return; }
  roundInProgress = true;
  const numPicks = (check1Expire > Date.now()) ? 1 : 2;
  let picks = [...Array(8).keys()].sort(()=>0.5-Math.random()).slice(0,numPicks);
  document.querySelectorAll('.room').forEach(r=>r.classList.remove('found','safe','highlight'));
  let delay = 0;
  picks.forEach(i=>{
    let room = document.querySelector(`.room[data-idx="${i}"]`);
    setTimeout(()=>{ room.classList.add('highlight'); }, delay);
    setTimeout(()=>{ room.classList.remove('highlight'); }, delay+600);
    delay += 700;
  });
  setTimeout(()=>{
    let prize = 1000, loss = -2000;
    if (upgrades.x2Prize > 0) { prize *= Math.pow(2, upgrades.x2Prize); loss *= Math.pow(2, upgrades.x2Prize); }

    const roomEl = document.querySelector(`.room[data-idx="${selectedRoom}"]`);

    if (picks.includes(selectedRoom)) {
      if (shieldExpire > Date.now()) {
        roomEl.classList.add('safe');
        updCoins(0);
      } else if (luckExpire > Date.now() && Math.random() < 0.5) {
        roomEl.classList.add('safe');
        updCoins(prize);
      } else {
        const room = document.querySelector(`.room[data-idx="${selectedRoom}"]`);
        room.classList.add('found');
        updCoins(loss);
      }
    } else {
      const room = document.querySelector(`.room[data-idx="${selectedRoom}"]`);
      room.classList.add('safe');
      updCoins(prize);
    }
    selectedRoom = null;
    document.querySelectorAll('.room').forEach(r=>r.classList.remove('selected'));
    roundInProgress = false;
  }, delay+700);
};

// render miners cards (—Ç–æ–ª—å–∫–æ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ)
function renderMiners(){
  if (!minersContainerEl) return;
  minersContainerEl.innerHTML = '';
  minersData.forEach((m,i)=>{
    const st = (minersState[i] && typeof minersState[i].count === 'number') ? minersState[i] : { count: 0 };
    const price = m.p * Math.pow(2, st.count);
    const income = st.count > 0 ? Math.floor(m.i * Math.pow(1.5, st.count - 1)) : 0;
     const card = document.createElement('div'); card.className = 'miner-card';
    card.innerHTML = `
      <img class="card-logo" src="logo.png" alt="logo" />
      <h3>${m.n}</h3>
      <div class="income">+${format(income)} / hr</div>
      <div class="bottom">
        <span class="lvl">Lvl ${st.count}</span>
        <span class="price-pill">${format(price)}</span>
      </div>
    `;
    card.onclick = ()=>{
      const currentSt = (minersState[i] && typeof minersState[i].count === 'number') ? minersState[i] : { count: 0 };
      const currentPrice = m.p * Math.pow(2, currentSt.count);
      if (coins >= currentPrice) {
        pendingMiner = i;
        buyText.textContent = t('buyFor', { name: m.n, price: format(currentPrice) });
        buyConfirm.classList.add('show'); buyConfirm.style.display = 'block'; buyConfirm.setAttribute('aria-hidden','false');
      } else { alert(t('notEnough')); }
    };
    minersContainerEl.appendChild(card);
  });
}

// mining shop open/close
const miningBtn = document.getElementById('miningBtn'); const shopBtn = document.getElementById('shopBtn');
miningBtn.onclick = () => { miningShop.style.display = 'block'; miningShop.setAttribute('aria-hidden','false'); renderMiners(); };
shopBtn.onclick = () => { miningShop.style.display = 'block'; miningShop.setAttribute('aria-hidden','false'); renderMiners(); };
document.getElementById('closeMiningShop').onclick = ()=>{ miningShop.style.display = 'none'; miningShop.setAttribute('aria-hidden','true'); };

// buy confirm actions
document.getElementById('confirmBuy').onclick = ()=>{
  if (pendingMiner === null) return;
  const i = pendingMiner; const m = minersData[i]; const st = minersState[i] || { count: 0 };
  const price = m.p * Math.pow(2, st.count);
  if (coins >= price) {
    coins -= price; minersState[i] = { count: (st.count || 0) + 1 }; updCoins(0); save(); renderMiners();
  } else alert(t('notEnough'));
  pendingMiner = null;
  buyConfirm.classList.remove('show'); buyConfirm.style.display = 'none'; buyConfirm.setAttribute('aria-hidden','true');
};
document.getElementById('cancelBuy').onclick = ()=>{ pendingMiner = null; buyConfirm.classList.remove('show'); buyConfirm.style.display = 'none'; buyConfirm.setAttribute('aria-hidden','true'); };

// profile window 
const profileWindowEl = document.getElementById('profileWindow'); document.getElementById('profileBtn').onclick = ()=>{ profileWindowEl.style.display = 'block'; profileWindowEl.setAttribute('aria-hidden','false'); };
document.getElementById('closeProfile').onclick = ()=>{ profileWindowEl.style.display = 'none'; profileWindowEl.setAttribute('aria-hidden','true'); };

// daily & quest 
let questClaimed = localStorage.getItem('questClaimed') === 'true'; let lastDaily = +localStorage.getItem('lastDaily') || 0; const questStatusEl = document.getElementById('questStatus'); const dailyStatusEl = document.getElementById('dailyStatus'); function updateQuestStatus(){ questStatusEl.textContent = questClaimed ? "‚úÖ Completed" : "‚ùå Not claimed"; } function updateDailyStatus(){ const now = Date.now(); const nextAvailable = lastDaily + 24*60*60*1000; if (now >= nextAvailable) dailyStatusEl.textContent = "üí∞ Available!"; else { const diff = nextAvailable - now; const hours = Math.floor(diff / (1000*60*60)); const minutes = Math.floor((diff % (1000*60*60)) / (1000*60)); dailyStatusEl.textContent = `Next in ${hours}h ${minutes}m`; } } setInterval(updateDailyStatus, 60000); updateDailyStatus(); updateQuestStatus();

document.getElementById('claimQuest').onclick = ()=>{ if (questClaimed) alert(t('questAlready')); else { updCoins(50000); questClaimed = true; localStorage.setItem('questClaimed','true'); updateQuestStatus(); } };
document.getElementById('claimDaily').onclick = ()=>{ const now = Date.now(); if (now - lastDaily < 24*60*60*1000) alert(t('dailyAlready')); else { updCoins(30000); lastDaily = now; localStorage.setItem('lastDaily', now); updateDailyStatus(); } };

// info window 
const infoWindowEl = document.getElementById('infoWindow'); document.getElementById('infoBtn').onclick = ()=>{ infoWindowEl.style.display = 'block'; infoWindowEl.setAttribute('aria-hidden','false'); };
document.getElementById('closeInfo').onclick = ()=>{ infoWindowEl.style.display = 'none'; infoWindowEl.setAttribute('aria-hidden','true'); };

// shop toggle: —Ç–µ–ø–µ—Ä—å shopBtn –∏ miningBtn –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –º–∞–≥–∞–∑–∏–Ω; –Ω–∞ –≥–ª–∞–≤–Ω–æ–º ‚Äî —Ç–æ–ª—å–∫–æ upgradePanel –≤–∏–¥–Ω–∞
const upgradePanel = document.getElementById('upgradePanel'); minersPanelVisible.style.display = 'none'; upgradePanel.style.display = 'flex';

// language selector 
const langSelect = document.getElementById('langSelect'); langSelect.value = lang; langSelect.onchange = ()=>{ lang = langSelect.value; localStorage.setItem('lang', lang); applyLang(); renderMiners(); };

// init UI
updateBalancesDisplay(); updUpg(); updIncome(); updTimers(); renderMiners(); applyLang();

// ensure windows hidden on load
document.getElementById('infoWindow').style.display = 'none'; document.getElementById('infoWindow').setAttribute('aria-hidden','true');
document.getElementById('profileWindow').style.display = 'none'; document.getElementById('profileWindow').setAttribute('aria-hidden','true');
buyConfirm.style.display = 'none'; buyConfirm.setAttribute('aria-hidden','true');

/* =========================================
   Casino wheel implementation
   ========================================= */
const casinoBtn = document.getElementById('casinoBtn');
const casinoModal = document.getElementById('casinoModal');
const closeCasino = document.getElementById('closeCasino');
const spinBtn = document.getElementById('spinBtn');
const wheelInner = document.getElementById('wheelInner');
const spinStatus = document.getElementById('spinStatus');
const prizesList = document.getElementById('prizesList');
const WHEEL_COOLDOWN = 2 * 60 * 60 * 1000; // 2 hours
const LS_LAST_SPIN = 'casino_last_spin_ts';

// define prizes (mixture of ZEX and TON)
const prizes = [
  { type: 'zex', amount: 1000 },
  { type: 'zex', amount: 5000 },
  { type: 'zex', amount: 25000 },
  { type: 'zex', amount: 100000 },
  { type: 'ton', amount: 0.1 },
  { type: 'ton', amount: 0.25 },
  { type: 'ton', amount: 0.5 },
  { type: 'ton', amount: 2 }
];

function buildWheelSectors(){
  const seg = prizes.length;
  const colors = ['#4facfe','#00d2ff','#9b7bff','#ffd166','#ffd7a6','#8ae6b0','#ff8a8a','#c3b3ff'];
  const step = 360/seg;
  let gradientParts = [];
  for(let i=0;i<seg;i++){
    const from = i*step;
    const to = (i+1)*step;
    gradientParts.push(`${colors[i % colors.length]} ${from}deg ${to}deg`);
  }
  const css = `conic-gradient(${gradientParts.join(',')})`;
  wheelInner.style.background = css;

  // write labels via absolutely positioned spans inside wheelInner
  wheelInner.innerHTML = ''; // clear
  const radius = 140; // for positioning labels (approx)
  for(let i=0;i<seg;i++){
    const angle = (i + 0.5) * step; // middle of segment
    const el = document.createElement('div');
    el.className = 'sector-label';
    el.style.position = 'absolute';
    el.style.left = '50%';
    el.style.top = '50%';
    el.style.transform = `rotate(${angle}deg) translate(${radius}px) rotate(${90}deg)`;
    el.style.transformOrigin = '0 0';
    el.style.fontSize = '13px';
    el.style.fontWeight = '800';
    el.style.color = '#000';
    el.style.textShadow = '0 2px 6px rgba(255,255,255,0.6)';
    el.innerText = prizes[i].type === 'zex' ? `${prizes[i].amount} ZEX` : `${prizes[i].amount} TON`;
    wheelInner.appendChild(el);
  }
}

function renderPrizesList(){
  prizesList.innerHTML = '';
  prizes.forEach(p => {
    const div = document.createElement('div');
    div.className = 'prize-chip';
    div.textContent = p.type === 'zex' ? `${p.amount} ZEX` : `${p.amount} TON`;
    prizesList.appendChild(div);
  });
}

function getLastSpinTs(){ return +localStorage.getItem(LS_LAST_SPIN) || 0; }
function setLastSpinTs(ts){ localStorage.setItem(LS_LAST_SPIN, String(ts)); }

function timeUntilNextSpin(){
  const last = getLastSpinTs();
  const now = Date.now();
  const diff = last + WHEEL_COOLDOWN - now;
  return diff > 0 ? diff : 0;
}

function formatRemaining(ms){
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  return `${h}h ${m}m`;
}

function updateSpinStatusUI(){
  const rem = timeUntilNextSpin();
  if (rem === 0){
    spinStatus.textContent = 'Ready to spin';
    spinBtn.disabled = false;
  } else {
    spinStatus.textContent = 'Next spin: ' + formatRemaining(rem);
    spinBtn.disabled = true;
  }
}

// spin logic
let spinning = false;
let currentRotation = 0;

spinBtn.addEventListener('click', ()=>{
  if (spinning) return;
  const rem = timeUntilNextSpin();
  if (rem > 0) { updateSpinStatusUI(); return; }

  spinning = true;
  spinBtn.disabled = true;
  spinStatus.textContent = 'Spinning‚Ä¶';

  // pick random prize index
  const idx = Math.floor(Math.random() * prizes.length);

  // calculate rotation target so that chosen sector lands under pointer (pointer at top)
  const sectors = prizes.length;
  const sectorAngle = 360 / sectors;
  // center of sector idx angle (relative)
  // wheelInner initial orientation 0deg -> top alignment may vary; we'll rotate to align label positions
  const extra = (sectorAngle * idx) + sectorAngle/2;
  // do multiple full rotations
  const full = 360 * (Math.floor(Math.random()*3) + 4); // 4-6 full turns
  const randomOffset = (Math.random() * (sectorAngle/2)) - (sectorAngle/4); // small offset for randomness
  const target = full + extra + randomOffset;

  // animate
  wheelInner.style.transition = 'transform 4s cubic-bezier(.08,.9,.2,1)';
  currentRotation = (currentRotation + target) % 3600000;
  wheelInner.style.transform = `rotate(${currentRotation}deg)`;

  // after animation ends -> award prize
  function onEnd(){
    wheelInner.style.transition = '';
    spinning = false;
    setLastSpinTs(Date.now());
    updateSpinStatusUI();

    const prize = prizes[idx];
    if (prize.type === 'zex'){
      // award ZEX directly
      updCoins(prize.amount);
      alert(`You won ${prize.amount} ZEX!`);
    } else {
      // prize.type == 'ton' -> convert TON to ZEX using TON = ZEX * 0.000003 => ZEX = TON / 0.000003
      const zexFromTon = Math.round(prize.amount / 0.000003);
      updCoins(zexFromTon);
      alert(`You won ${prize.amount} TON (‚âà ${format(zexFromTon)} ZEX)!`);
    }

    wheelInner.removeEventListener('transitionend', onEnd);
  }
  wheelInner.addEventListener('transitionend', onEnd, { once: true });
});

// open/close casino modal
casinoBtn.onclick = ()=>{
  buildWheelSectors();
  renderPrizesList();
  updateSpinStatusUI();
  casinoModal.style.display = 'flex';
  casinoModal.setAttribute('aria-hidden','false');
  // sync balance
  const ton = coins * 0.000003;
  document.getElementById('casinoBalance').textContent = format(coins) + ' ZEX ‚Ä¢ ' + formatTon(ton);
};
closeCasino.onclick = ()=>{
  casinoModal.style.display = 'none';
  casinoModal.setAttribute('aria-hidden','true');
};

// periodic update of spin cooldown
setInterval(updateSpinStatusUI, 10000);

// initialize wheel UI immediately (but not show modal)
buildWheelSectors();
renderPrizesList();
updateSpinStatusUI();

  </script>

  <!-- Rewards modal script (keeps previous behavior) -->
  <script>
  (function(){
    // ====== Config ======
    const LS_FIRST = 'ws_first_seen_v2';
    const LS_CLAIMED = 'ws_claimed_v2';
    const MAX_DAYS = 7;
    const amounts = [30000,100000,500000,1000000,3000000,6000000,10000000];

    // ====== Safe LS utils ======
    function safeGetJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        const v = JSON.parse(raw);
        return v;
      }catch(e){ return fallback; }
    }
    function safeSetJSON(key, obj){
      try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
    }

    // Ensure first seen exists
    let firstSeen = +localStorage.getItem(LS_FIRST) || 0;
    if(!firstSeen || isNaN(firstSeen)){
      firstSeen = Date.now();
      try{ localStorage.setItem(LS_FIRST, String(firstSeen)); }catch(e){}
    }

    // claimed array safe init
    let claimed = safeGetJSON(LS_CLAIMED, null);
    if(!Array.isArray(claimed) || claimed.length !== MAX_DAYS){
      claimed = new Array(MAX_DAYS).fill(false);
      safeSetJSON(LS_CLAIMED, claimed);
    }

    // compute availability
    function daysSinceFirst(){
      const now = Date.now();
      const diffDays = Math.floor((now - firstSeen) / (24*60*60*1000));
      return diffDays;
    }
    function availableCount(){
      return Math.min(MAX_DAYS, daysSinceFirst() + 1);
    }

    // format fallback - reuse existing format functions if present
    function formatFallback(n){
      if (window.format) return window.format(n);
      if (n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
      if (n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
      if (n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
      return String(n);
    }

    // updater fallback
    function updCoinsPublic(v=0){
      if (typeof window.updCoins === 'function'){
        try{ window.updCoins(v); return; }catch(e){}
      }
      try{
        let cur = +localStorage.getItem('coins') || 0;
        cur += v;
        if(cur < 0) cur = 0;
        localStorage.setItem('coins', String(cur));
        const el = document.getElementById('coinsVal');
        if(el) el.textContent = formatFallback(cur);
      }catch(e){}
    }

    function saveGameStatePublic(){
      if (typeof window.save === 'function'){
        try{ window.save(); return; }catch(e){} // original game save function
      }
      try{
        const coins = localStorage.getItem('coins') || '0';
        localStorage.setItem('coins', coins);
        safeSetJSON(LS_CLAIMED, claimed);
        localStorage.setItem(LS_FIRST, String(firstSeen));
      }catch(e){}
    }

    function claimRewardFromModalPublic(amount){
      if (typeof window.claimRewardFromModal === 'function'){
        try{ window.claimRewardFromModal(amount); saveGameStatePublic(); return; }catch(e) { }
      }
      try{
        if (typeof window.updCoins === 'function') {
          window.updCoins(amount);
        } else {
          let cur = +localStorage.getItem('coins') || 0;
          cur += amount;
          localStorage.setItem('coins', String(cur));
          const cv = document.getElementById('coinsVal');
          if(cv) cv.textContent = formatFallback(cur);
        }
        saveGameStatePublic();
      }catch(e){}
    }

    window.claimRewardFromModal = window.claimRewardFromModal || claimRewardFromModalPublic;

    // Modal DOM & logic
    const overlay = document.getElementById('wsModalOverlay');
    const gridTop = document.getElementById('rewardsGridTop');
    const gridBottom = document.getElementById('rewardsGridBottom');
    const unlockedCountEl = document.getElementById('wsUnlockedCount');
    const coinsDisplayEl = document.getElementById('wsModalCoinsDisplay');
    const btnClose = document.getElementById('wsBtnClose');
    const btnRules = document.getElementById('wsBtnRules');

    // Hide main page children while modal is visible.
    const hiddenTargets = [];
    function hideMainUI(){
      const bodyChildren = Array.from(document.body.children);
      bodyChildren.forEach(ch=>{
        if (ch === overlay) return;
        const prev = ch.style.display || '';
        hiddenTargets.push({el: ch, prev});
        ch.style.display = 'none';
      });
      overlay.classList.remove('hidden');
    }
    function showMainUI(){
      hiddenTargets.forEach(item=>{
        try{ item.el.style.display = item.prev || ''; }catch(e){}
      });
      hiddenTargets.length = 0;
      overlay.classList.add('hidden');
    }

    function renderCards(){
      claimed = safeGetJSON(LS_CLAIMED, claimed) || claimed;
      const avail = availableCount();
      gridTop.innerHTML = '';
      gridBottom.innerHTML = '';

      for(let i=0;i<MAX_DAYS;i++){
        const day = i+1;
        const amount = amounts[i] || 0;
        const card = document.createElement('div');
        card.className = 'rewardCard';
        if (day === 7) card.classList.add('big');

        card.innerHTML = `
          <div class="coinIconSmall">üí∞</div>
          <div class="dayLabel">Day ${day}</div>
          <div class="amount">${formatFallback(amount)}</div>
        `;

        const isUnlocked = i < avail;
        const isClaimed = !!claimed[i];

        if(isClaimed){
          card.classList.add('claimed');
          const badge = document.createElement('div');
          badge.className = 'claimBadge';
          badge.textContent = 'Claimed';
          card.appendChild(badge);
        } else if(isUnlocked){
          card.classList.add('unlocked');
        } else {
          card.classList.add('locked');
          const overlayEl = document.createElement('div');
          overlayEl.className = 'overlay';
          overlayEl.textContent = '';
          card.appendChild(overlayEl);
        }

        card.addEventListener('click', function onCardClick(){
          claimed = safeGetJSON(LS_CLAIMED, claimed) || claimed;
          const nowClaimed = !!claimed[i];
          const nowAvail = i < availableCount();
          if (!nowAvail || nowClaimed) return;
          card.style.pointerEvents = 'none';
          card.classList.add('pop');
          setTimeout(()=>card.classList.remove('pop'),260);
          claimed[i] = true;
          safeSetJSON(LS_CLAIMED, claimed);

          try {
            if (typeof window.claimRewardFromModal === 'function') {
              window.claimRewardFromModal(amounts[i]);
            } else if (typeof window.updCoins === 'function') {
              window.updCoins(amounts[i]);
            } else {
              let cur = +localStorage.getItem('coins') || 0;
              cur += amounts[i];
              localStorage.setItem('coins', String(cur));
              const mainEl = document.getElementById('coinsVal');
              if (mainEl) mainEl.textContent = formatFallback(cur);
            }
          } catch(e){
            try { updCoinsPublic(amounts[i]); } catch(e2){}
          }

          const badge = document.createElement('div');
          badge.className = 'claimBadge';
          badge.textContent = 'Claimed';
          card.appendChild(badge);
          card.classList.remove('unlocked');
          card.classList.add('claimed');
          card.style.pointerEvents = 'none';

          syncCoinsDisplay();
          renderUnlockedCount();

        });

        if(i < 4) gridTop.appendChild(card);
        else gridBottom.appendChild(card);
      }

      renderUnlockedCount();
    }

    function renderUnlockedCount(){
      const avail = availableCount();
      const unlockedNow = Math.min(avail, MAX_DAYS);
      unlockedCountEl.textContent = String(unlockedNow);
    }

    function syncCoinsDisplay(){
      const coins = +localStorage.getItem('coins') || 0;
      const ton = coins * 0.000003;
      coinsDisplayEl.textContent = formatFallback(coins) + ' ZEX ‚Ä¢ ' + (ton < 0.000001 && ton > 0 ? '<0.000001' : Number(ton.toFixed(6)).toString()) + ' TON';
      const mainEl = document.getElementById('coinsVal');
      if (mainEl) mainEl.textContent = formatFallback(coins);
      const tonEl = document.getElementById('tonVal');
      if (tonEl) tonEl.textContent = (ton < 0.000001 && ton > 0) ? '<0.000001' : Number(ton.toFixed(6)).toString();
    }

    btnClose.addEventListener('click', function(){
      showMainUI();
      saveGameStatePublic();
    });

    btnRules.addEventListener('click', function(){
      alert('Rewards unlock one per day since first visit. Click an unlocked card to claim its coins.');
    });

    hideMainUI();
    renderCards();
    syncCoinsDisplay();

    setInterval(()=>{ renderCards(); syncCoinsDisplay(); }, 60*1000);

    window._wsModal = {
      open: function(){ hideMainUI(); renderCards(); syncCoinsDisplay(); },
      close: function(){ showMainUI(); saveGameStatePublic(); },
      getState: function(){ return { firstSeen, claimed: claimed.slice(), available: availableCount() }; },
      forceResetClaims: function(){ claimed = new Array(MAX_DAYS).fill(false); safeSetJSON(LS_CLAIMED,claimed); renderCards(); }
    };

    overlay.tabIndex = -1;
  })();
  </script>

</body>
</html>
