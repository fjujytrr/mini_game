<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hide & Seek ‚Äî Premium Emoji (Updated)</title>
  <style>
:root{
  --accent-cyan: #00D8FF;
  --birch: #EDE4C8;
  --purple-frame: #7a4bff;
  --deep-purple: #5a2ecc;
  --glass: rgba(255,255,255,0.06);
}
/* –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ */
html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(120deg,#3b2a7a,#8aa7ff);background-size:200% 200%;animation:gradientBG 15s ease infinite;color:#fff;overflow:hidden}
@keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
body{display:flex;flex-direction:column;align-items:center;min-height:100vh}
/* Header */
header{width:95%;margin:15px 0;display:flex;justify-content:space-between;align-items:center;background:transparent;border-radius:12px;padding:10px;backdrop-filter:blur(5px)}
/* –≠–Ω–µ—Ä–≥–∏—è –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É */
.energy-panel{
  display:flex;
  align-items:center;
  gap:8px;
  background:rgba(0,0,0,0.16);
  padding:6px 10px;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.15);
  min-width:120px;
  max-width:220px;
  font-weight:800;
  color:#fff;
}
.energy-panel .icon{font-size:18px;margin-right:6px}
.energy-panel .val{font-size:16px;color:var(--accent-cyan);line-height:1}
.energy-panel .timer{font-size:11px;color:var(--birch);line-height:1}

/* –ë–∞–ª–∞–Ω—Å ‚Äî —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ —Ñ–æ–Ω) */
.coin-panel{display:flex;align-items:center;gap:10px;background:rgba(0,0,0,0.28);padding:6px 10px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.18);margin-left:auto;min-width:120px;max-width:240px;justify-content:flex-end}
/* –õ–æ–≥–æ—Ç–∏–ø—ã —Ç–µ–ø–µ—Ä—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è; —É–º–µ–Ω—å—à–µ–Ω—ã —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–≥–æ –ø—Ä–∞–≤–æ–≥–æ —É–≥–ª–∞ */
.coin-logo, .ton-logo{display:inline-flex;align-items:center;justify-content:center;border-radius:50%;overflow:hidden;flex:0 0 auto}
.coin-logo{width:36px;height:36px;border:2px solid var(--purple-frame);box-shadow:0 6px 14px rgba(122,75,255,0.12);background:#fff}
.coin-logo img{width:100%;height:100%;object-fit:cover;display:block}
.coin-panel .val{font-weight:800;font-size:14px;color:var(--accent-cyan);line-height:1}
.ton-panel{display:flex;align-items:center;gap:8px;padding:4px 8px;border-radius:10px;background:transparent;margin-left:6px}
.ton-logo{width:30px;height:30px;border:2px solid rgba(255,255,255,0.06);box-shadow:0 6px 12px rgba(255,193,7,0.08);background:#fff}
.ton-logo img{width:100%;height:100%;object-fit:cover;display:block}
.ton-val{font-weight:800;font-size:12px;color:#ffeaa7;line-height:1}
/* –î–æ–º: —Å–µ—Ç–∫–∞ –∫–æ–º–Ω–∞—Ç */
.house{position:relative;width:95%;max-width:500px;margin:20px 0;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(4,1fr);gap:12px}
.room{background:rgba(255,255,255,0.06);border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:28px;color:#fff;cursor:pointer;transition:transform .3s,box-shadow .3s;position:relative;border:2px solid rgba(255,255,255,0.14)}
.room:hover{transform:scale(1.05);box-shadow:0 0 18px rgba(0,216,255,0.14)}
.room.selected{border-color:var(--accent-cyan);box-shadow:0 0 12px var(--accent-cyan)}
.room.found{border-color:#FF0054;box-shadow:0 0 12px #FF0054;animation:foundAnim 1s ease}
.room.safe{border-color:#39FF14;box-shadow:0 0 12px #39FF14;animation:safeAnim .8s ease}
.room.highlight{box-shadow:0 0 22px 4px var(--accent-cyan);transition:box-shadow .3s}
@keyframes foundAnim{0%{transform:scale(1)}50%{transform:rotate(10deg) scale(1.15)}100%{transform:scale(1)}}
@keyframes safeAnim{0%{transform:scale(1)}50%{transform:rotate(-10deg) scale(0.95)}100%{transform:scale(1)}}
/* –ö–æ–Ω—Ç—Ä–æ–ª—ã */
.controls{width:90%;display:flex;justify-content:space-between;margin-bottom:15px}
button{flex:1;margin:0 5px;padding:14px;font-size:20px;border:none;border-radius:12px;cursor:pointer;color:#000;background:var(--accent-cyan);box-shadow:0 4px 12px rgba(0,216,255,0.25);transition:transform .2s,box-shadow .2s}
button:active{transform:scale(.98);box-shadow:0 2px 6px rgba(0,216,255,0.18)}
button.secondary{background:rgba(0,0,0,0.36);color:#fff;border:1px solid rgba(255,255,255,0.06);box-shadow:0 3px 8px rgba(0,216,255,0.12)}
/* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
.bottom-menu{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);Width:90%;max-width:480px;display:flex;justify-content:space-around;gap:8px;background:rgba(0,0,0,0.28);padding:6px 0;border-radius:16px;backdrop-filter:blur(5px);box-shadow:0 0 12px rgba(0,216,255,0.18)}
.bottom-menu button{background:transparent;color:#fff;font-size:22px;transition:transform .2s}
.bottom-menu button:hover{transform:scale(1.16);color:var(--accent-cyan)}
/* –ê–ø–≥—Ä–µ–π–¥—ã */
.upgrade-panel{display:flex;gap:12px;margin:10px 0;overflow-x:auto;padding:12px 10px;width:95%;justify-content:flex-start;align-items:stretch}
.upgrade{flex:0 0 auto;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));padding:16px;border-radius:16px;text-align:left;min-width:220px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06);transition:transform .18s,box-shadow .18s}
.upgrade:hover{transform:translateY(-6px)}
.upgrade h3{margin:0 0 8px;font-size:16px;color:var(--accent-cyan)}
.upgrade p{margin:0;font-size:14px;color:#eee}
.upgrade .price{margin-top:10px;font-weight:800;color:var(--birch);font-size:16px}
.upgrade .badge{display:inline-block;margin-top:8px;padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.18);font-weight:700;color:#fff;font-size:12px}
/* Mining info */
.mining-info{margin:10px 0;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:14px;width:95%;text-align:center;box-shadow:0 2px 6px rgba(0,216,255,0.06)}
/* –í–∏–¥–∏–º–∞—è –ø–∞–Ω–µ–ª—å –º–∞–π–Ω–µ—Ä–æ–≤ ‚Äî —É–±–∏—Ä–∞–µ–º —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ */
.miners-panel{display:none;width:95%;max-width:900px;gap:12px;padding:10px;overflow-x:auto;align-items:flex-start;margin-bottom:12px;background:transparent;border-radius:12px}
.miners-panel .miner-card{display:none}
/* –ú–æ–¥–∞–ª—å–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω –º–∞–π–Ω–µ—Ä–æ–≤ (–ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π) */
#miningShop{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:900;background:linear-gradient(120deg,#3b2a7a,#8aa7ff);color:#fff;padding:28px;box-sizing:border-box;overflow-y:auto;border:none}
#miningShop h2{color:#ecf8ff;text-align:center;margin-bottom:10px}
#miningShop .miners-container{display:flex;flex-wrap:wrap;gap:18px;justify-content:center;padding:8px 6px}
#miningShop .miner-card{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));color:#fff;border-radius:14px;padding:12px;width:160px;display:flex;flex-direction:column;align-items:center;gap:8px;box-shadow:0 10px 30px rgba(0,0,0,0.28);cursor:pointer;transition:transform .18s,box-shadow .18s;border:1px solid rgba(255,255,255,0.06)}
#miningShop .miner-card:hover{transform:translateY(-8px);box-shadow:0 18px 40px rgba(0,0,0,0.35)}
#miningShop .card-logo{width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid var(--purple-frame);background:#fff;box-shadow:0 6px 18px rgba(122,75,255,0.12)}
#miningShop .miner-card h3{margin:6px 0 2px;font-size:16px;color:#f0fbff}
#miningShop .miner-card .income{color:var(--birch);font-weight:800}
#miningShop .miner-card .bottom{width:100%;Display:flex;justify-content:space-between;font-weight:800;font-size:14px;margin-top:6px}
#miningShop .price-pill{background:rgba(0,0,0,0.14);padding:6px 8px;border-radius:10px;font-weight:800}
/* –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏: —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ */
#buyConfirm{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;background:transparent;padding:0;box-sizing:border-box}
#buyConfirm .confirm-box{max-width:520px;margin:0;background:linear-gradient(120deg, rgba(90,46,204,0.95), rgba(122,75,255,0.95));border:2px solid var(--accent-cyan);border-radius:12px;padding:14px;text-align:center;box-shadow:0 8px 30px rgba(122,75,255,0.18)}
#buyConfirm.show{display:block}
#buyConfirm p{color:#fff;margin:8px 0}
#buyConfirm button{margin:6px 6px;padding:8px 12px;font-weight:700;background:var(--accent-cyan);color:#000;border:none;border-radius:8px}
/* Info & Profile: —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–µ, –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –∫–∞–∫ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω */
#infoWindow, #profileWindow{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:800;background:linear-gradient(120deg,#3b2a7a,#8aa7ff);color:#fff;padding:28px;box-sizing:border-box;overflow-y:auto}
#infoWindow .content, #profileWindow .content{max-width:1100px;margin:24px auto;border-radius:16px;padding:18px;background:rgba(0,0,0,0.22);color:#fff;box-shadow:0 10px 30px rgba(0,0,0,0.28);border:1px solid rgba(255,255,255,0.04)}
#infoWindow h2, #profileWindow h2{color:#ecf8ff;margin-bottom:10px}
#infoWindow ul{color:#eaf2ff;padding-left:20px}
#infoWindow ul li::before{content:'‚Ä¢ ';color:var(--accent-cyan);font-weight:600}
#infoWindow button, #profileWindow button{width:100%;margin-top:12px;padding:12px;font-size:18px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--accent-cyan),#00A8FF);color:#000;cursor:pointer;font-weight:700}
/* Profile specific content */
.settings-card{margin-top:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.settings-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
.select-lang{Padding:8px 10px;border-radius:8px;border:none;font-weight:700}
/* –ê–¥–∞–ø—Ç–∏–≤ */
@media (max-width:520px){
  .coin-logo{width:32px;height:32px;border-width:2px}
  button{font-size:18px;padding:12px}
  #miningShop .miner-card{width:46%}
  .upgrade{min-width:160px}
}

/* ========== Casino wheel styles ========== */
.casino-modal{display:none;position:fixed;inset:0;z-index:11000;align-items:center;justify-content:center;background:linear-gradient(120deg,#3b2a7a88,#8aa7ff88);backdrop-filter:blur(6px);padding:20px;box-sizing:border-box}
.casino-modal .card{width:100%;max-width:820px;background:linear-gradient(120deg,#3b2a7a,#8aa7ff);border-radius:16px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.04);display:flex;gap:12px;flex-direction:column}
.casino-header{display:flex;justify-content:space-between;align-items:center;color:#ecf8ff}
.casino-body{display:flex;gap:18px;align-items:center;flex-wrap:wrap;justify-content:center}
.wheel-wrap{position:relative;width:380px;height:380px;display:flex;align-items:center;justify-content:center}
#wheelCanvas{width:100%;height:100%;border-radius:50%;box-shadow:0 12px 40px rgba(0,0,0,0.45)}
.wheel-pointer{position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:26px solid #fff;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.28))}
.casino-controls{display:flex;flex-direction:column;gap:8px;min-width:220px}
.spin-btn{padding:12px 18px;border-radius:12px;border:none;font-weight:900;cursor:pointer;background:linear-gradient(90deg,var(--accent-cyan),#00A8FF);color:#000;box-shadow:0 12px 36px rgba(0,216,255,0.18)}
.casino-note{color:var(--birch);font-weight:700}
.casino-result{font-weight:900;color:var(--accent-cyan);font-size:18px}
.spin-btn[disabled]{opacity:0.45;cursor:not-allowed;transform:none;box-shadow:none}

/* Rewards modal styles */
#wsModalOverlay{ --wm-accentA:#3b2a7a; --wm-accentB:#8aa7ff; --wm-accentC:#00D8FF; --wm-birch:#EDE4C8; z-index:10000; position:fixed; inset:0; display:flex; align-items:flex-start; justify-content:center; font-family:Inter,system-ui,Arial,sans-serif; }
#wsModalOverlay.hidden{ display:none; }
#wsModalOverlay .bgLayer{ position:absolute; inset:0; background:linear-gradient(120deg,var(--wm-accentA),var(--wm-accentB)); display:block; overflow:hidden; }
#wsModalOverlay .bgImage{ position:absolute; inset:0; background-image:url('fon.png'); background-size:cover; background-position:center; filter:blur(6px) saturate(1.05); mix-blend-mode:overlay; opacity:0.28; }

#wsModalOverlay .glass{ position:relative; width:100%; max-width:980px; margin:0 auto; box-sizing:border-box; padding:18px; border-radius:18px 18px 0 0; backdrop-filter: blur(8px) saturate(1.05); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 -12px 40px rgba(0,0,0,0.45); display:flex; flex-direction:column; gap:12px; overflow:hidden; }

/* Rewards shell */
.rewardsShell{ display:flex; flex-direction:column; gap:12px; }
.rewardsContainer{ background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(255,255,255,0.02)); border-radius:14px; padding:12px; box-shadow:0 8px 30px rgba(0,0,0,0.36); border:1px solid rgba(255,255,255,0.04);
  max-height: calc(70vh - 110px); overflow:auto;
}

.rewardsGridTop{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; }
.rewardsGridBottom{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
.rewardCard{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:12px; min-height:86px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; transition:transform .16s ease, box-shadow .16s ease; cursor:pointer; border:1px solid rgba(255,255,255,0.04); }
.rewardCard:hover{ transform:translateY(-6px); }
.rewardCard.pop{ animation:pop .26s ease; }
@keyframes pop{ 0%{ transform:scale(1); } 50%{ transform:scale(1.06);} 100%{ transform:scale(1); } }

.rewardCard .coinIconSmall{ width:44px; height:44px; border-radius:50%; background:linear-gradient(90deg,var(--wm-accentC),#00A8FF); display:flex; align-items:center; justify-content:center; font-weight:800; color:#000; margin-bottom:8px; border:2px solid rgba(255,255,255,0.06); box-shadow:0 8px 18px rgba(0,216,255,0.08); }
.rewardCard .dayLabel{ font-weight:800; color:#ecf8ff; margin-bottom:6px; }
.rewardCard .amount{ font-weight:900; font-size:16px; color:var(--wm-accentC); text-shadow: 0 6px 18px rgba(0,216,255,0.08); }
.rewardCard.locked{ opacity:0.36; pointer-events:auto; }
.rewardCard.unlocked{ box-shadow:0 10px 30px rgba(0,216,255,0.06); border:1px solid rgba(0,216,255,0.12); }
.rewardCard.claimed{ opacity:0.9; pointer-events:none; }
.rewardCard .claimBadge{ position:absolute; top:8px; right:8px; background:linear-gradient(90deg,#FFD54A,#FFC107); color:#000; padding:6px 8px; border-radius:999px; font-weight:800; box-shadow:0 6px 20px rgba(255,193,7,0.12); font-size:12px; }

.rewardCard.big{ min-height:120px; padding:18px; }

/* Bottom actions */
.wsActions{ display:flex; gap:12px; margin-top:12px; align-items:center; justify-content:space-between; }
.wsActions .left{ color:var(--wm-birch); font-weight:700; }
.btnPrimary{
  padding:12px 18px; border-radius:12px; font-weight:900; border:none; cursor:pointer;
  background:linear-gradient(90deg,var(--wm-accentC),#00A8FF); color:#000; box-shadow:0 12px 36px rgba(0,216,255,0.18);
}
.btnGhost{
  padding:10px 14px; border-radius:12px; font-weight:800; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#ecf8ff; cursor:pointer;
}

/* Responsive tweaks */
@media (max-width:720px){
  .rewardsContainer{ max-height: calc(60vh - 90px); }
  .rewardsGridTop{ grid-template-columns:repeat(2,1fr); }
  .rewardsGridBottom{ grid-template-columns:repeat(2,1fr); }
  .glass{ padding:12px; border-radius:12px 12px 0 0; }
  .rewardCard.big{ min-height:100px; }
}
  </style>
</head>
<body>
  <header>
    <!-- –≠–Ω–µ—Ä–≥–∏—è ‚Äî –≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª -->
    <div class="energy-panel" id="energyPanel" aria-live="polite" aria-atomic="true">
      <div class="icon">‚ö°</div>
      <div style="display:flex;flex-direction:column;align-items:flex-start;">
        <div style="font-size:11px;color:var(--birch);font-weight:800">Energy</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="val" id="energyVal">50</div>
          <div class="timer" id="energyTimer">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- coin-panel —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ–Ω (—É–¥–∞–ª—ë–Ω –æ–±—â–∏–π —Ñ–æ–Ω header) -->
    <div class="coin-panel" aria-live="polite" aria-atomic="true">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="coin-logo" title="ZEX">
          <img src="logo.png" alt="ZEX logo" />
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;line-height:1;">
          <div style="font-size:11px;color:var(--birch);font-weight:800">ZEX</div>
          <div class="val" id="coinsVal">0</div>
        </div>
      </div>
       <div class="ton-panel" style="margin-left:6px;">
        <div class="ton-logo" title="TON">
          <img src="ton.png" alt="TON logo" />
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;line-height:1;">
          <div style="font-size:11px;color:var(--birch);font-weight:800">TON</div>
          <div class="ton-val" id="tonVal">0</div>
        </div>
      </div>
    </div>
  </header>

    <div class="house"></div>

    <div class="controls">
    <button id="startBtn">üè†</button>
    <button class="secondary" id="resetBtn">üîç</button>
  </div>

  <!-- –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–∞–Ω–µ–ª—å –∞–ø–≥—Ä–µ–π–¥–æ–≤ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ -->
  <div class="upgrade-panel" id="upgradePanel">
    <div class="upgrade" data-key="x2Prize" data-base-price="20000">
      <h3>x2 Prize / x2 Loss</h3>
      <p>Double rewards & penalties</p>
      <div class="price">20,000</div>
      <div class="badge">Boost</div>
    </div>
    <div class="upgrade" data-key="check1" data-base-price="20000">
      <h3>Check 1 Room Only</h3>
      <p>Hunter checks 1 room only (1 min)</p>
      <div class="price">20,000</div>
      <div class="timer" id="check1Timer"></div>
    </div>

    <!-- –ù–æ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç 1 –º–∏–Ω—É—Ç—É) -->
    <div class="upgrade" data-key="shield" data-base-price="25000">
      <h3>Shield (1m)</h3>
      <p>Protects you from loss for 1 minute</p>
      <div class="price">25,000</div>
      <div class="timer" id="shieldTimer"></div>
      <div class="badge">Defence</div>
    </div>

    <div class="upgrade" data-key="incBoost" data-base-price="30000">
      <h3>Double Income (1m)</h3>
      <p>Mining income √ó2 for 1 minute</p>
      <div class="price">30,000</div>
      <div class="timer" id="incTimer"></div>
      <div class="badge">Income</div>
    </div>

    <div class="upgrade" data-key="luck" data-base-price="22000">
      <h3>Lucky Escape (1m)</h3>
      <p>50% chance to evade if hunted (1 minute)</p>
      <div class="price">22,000</div>
      <div class="timer" id="luckTimer"></div>
      <div class="badge">Chance</div>
    </div>
  </div>

  <div class="mining-info">
    <strong id="miningLabel">Mining Income:</strong> <span id="miningIncomeVal">0</span>/hr
  </div>

  <!-- –°–∫—Ä—ã—Ç–∞—è –ø–∞–Ω–µ–ª—å –º–∞–π–Ω–µ—Ä–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–º) -->
  <div class="miners-panel" id="minersPanelVisible" aria-hidden="true"></div>

  <!-- Modal mining shop (fullscreen modal) -->
  <div id="miningShop" aria-hidden="true">
    <h2 id="shopTitle">Mining Shop</h2>
    <div class="miners-container"></div>
    <button id="closeMiningShop" style="margin-top:12px;width:100%;padding:12px;font-size:18px;border:none;border-radius:12px;background:rgba(0,0,0,0.22);color:#fff;cursor:pointer;">Close</button>
  </div>

  <!-- Buy confirm -->
  <div id="buyConfirm" aria-hidden="true">
    <div class="confirm-box">
      <p id="buyText"></p>
      <div style="display:flex;justify-content:center;">
        <button id="confirmBuy">Buy</button>
        <button id="cancelBuy">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Info window (—Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è, –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è) -->
  <div id="infoWindow" aria-hidden="true">
    <div class="content">
      <h2 id="infoTitle">How to Play</h2>
      <ul id="infoList">
        <li>Select a room and then click the üîç button to hunt.</li>
        <li>The hunter searches 2 random rooms (1 if "Check 1 Room" is active).</li>
        <li>If your room is found, you lose coins (shown in red).</li>
        <li>If you evade the hunt, you gain coins (shown in green).</li>
        <li>Buy upgrades or miners to improve your chances and income.</li>
        <li>Claim daily rewards and complete quests for bonus coins.</li>
      </ul>
      <button id="closeInfo">Close</button>
    </div>
  </div>

  <!-- Profile window (—Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è, –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è) -->
  <div id="profileWindow" aria-hidden="true">
    <div class="content">
      <h2 id="profileTitle">Profile</h2>
        <div style="margin-bottom:16px;padding:16px;background:rgba(0,0,0,0.06);border-radius:12px;">
        <h3 id="dailyTitle" style="margin-bottom:8px;font-size:18px;color:#ecf8ff">Daily Reward</h3>
        <p id="dailyText" style="margin-bottom:12px;color:#fff">Get 30,000 coins once a day!</p>
        <button id="claimDaily" style="width:100%;padding:12px;font-size:16px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--accent-cyan),#00A8FF);color:#000;cursor:pointer;font-weight:700;">Claim Daily</button>
        <p id="dailyStatus" style="margin-top:8px;color:var(--birch);font-weight:600;text-align:center;"></p>
      </div>
        <div style="margin-bottom:16px;padding:16px;background:rgba(0,0,0,0.06);border-radius:12px;">
        <h3 id="questTitle" style="margin-bottom:8px;font-size:18px;color:#ecf8ff">Quest</h3>
        <p id="questText" style="margin-bottom:12px;color:#fff">Subscribe to get bonus coins!</p>
        <button id="claimQuest" style="width:100%;padding:12px;font-size:16px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--accent-cyan),#00A8FF);color:#000;cursor:pointer;font-weight:700;">Claim Quest</button>
        <p id="questStatus" style="margin-top:8px;color:var(--birch);font-weight:600;text-align:center;"></p>
      </div>
        <div class="settings-card">
        <div class="settings-row">
          <div>
            <h3 id="settingsTitle">Settings</h3>
            <p id="settingsText">Change language and other preferences.</p>
          </div>
          <div>
            <select id="langSelect" class="select-lang">
              <option value="ru">–†—É—Å—Å–∫–∏–π</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
      </div>

      <button id="closeProfile" style="width:100%;padding:14px;font-size:18px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--accent-cyan),#00A8FF);color:#000;cursor:pointer;font-weight:700;">Close</button>
    </div>
  </div>

  <div class="bottom-menu">
    <button id="infoBtn" class="secondary">‚Ñπ</button>
    <button id="shopBtn" class="secondary">üõí</button>
    <button id="miningBtn" class="secondary">‚õè</button>
    <button id="profileBtn" class="secondary">üë§</button>
    <!-- New casino button -->
    <button id="casinoBtn" class="secondary" title="Casino">üé∞</button>
  </div>

  <script>
  /* ==========================
   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π JS (–≥–æ—Ç–æ–≤–æ)
   ========================== */
  // ========== –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è ==========
  const i18n = {
  ru: {
    pickRoomFirst: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É!',
    notEnough: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!',
    dailyAlready: '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–∞!',
    questAlready: '–ö–≤–µ—Å—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω!',
    miningIncome: '–î–æ—Ö–æ–¥ –º–∞–π–Ω–∏–Ω–≥–∞:',
    miningShop: '–ú–∞–≥–∞–∑–∏–Ω –º–∞–π–Ω–∏–Ω–≥–∞',
    close: '–ó–∞–∫—Ä—ã—Ç—å',
    howToPlay: '–ö–∞–∫ –∏–≥—Ä–∞—Ç—å',
    infoList: [
      '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É üîç –¥–ª—è –æ—Ö–æ—Ç—ã.',
      '–û—Ö–æ—Ç–Ω–∏–∫ –∏—â–µ—Ç 2 —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã (1, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω "Check 1 Room").',
      '–ï—Å–ª–∏ –≤–∞—à—É –∫–æ–º–Ω–∞—Ç—É –Ω–∞—à–ª–∏, –≤—ã —Ç–µ—Ä—è–µ—Ç–µ –º–æ–Ω–µ—Ç—ã (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–º).',
      '–ï—Å–ª–∏ –≤—ã –∏–∑–±–µ–∂–∞–ª–∏ –æ—Ö–æ—Ç—ã, –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –º–æ–Ω–µ—Ç—ã (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∑–µ–ª–µ–Ω—ã–º).',
      '–ü–æ–∫—É–ø–∞–π—Ç–µ –∞–ø–≥—Ä–µ–π–¥—ã –∏–ª–∏ –º–∞–π–Ω–µ—Ä–æ–≤, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å —à–∞–Ω—Å—ã –∏ –¥–æ—Ö–æ–¥.',
      '–ó–∞–±–∏—Ä–∞–π—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –∏ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –∫–≤–µ—Å—Ç—ã –¥–ª—è –±–æ–Ω—É—Å–Ω—ã—Ö –º–æ–Ω–µ—Ç.'
    ],
    profile: '–ü—Ä–æ—Ñ–∏–ª—å',
    dailyReward: '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞',
    dailyText: '–ü–æ–ª—É—á–∏—Ç–µ 30 000 –º–æ–Ω–µ—Ç —Ä–∞–∑ –≤ –¥–µ–Ω—å!',
    claimDaily: '–ó–∞–±—Ä–∞—Ç—å',
    quest: '–ö–≤–µ—Å—Ç',
    claimQuest: '–í–∑—è—Ç—å',
    settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
    settingsText: '–°–º–µ–Ω–∏—Ç–µ —è–∑—ã–∫ –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.',
    buyFor: '–ö—É–ø–∏—Ç—å {name} –∑–∞ {price}?',
    buy: '–ö—É–ø–∏—Ç—å',
    cancel: '–û—Ç–º–µ–Ω–∞',
    profitHr: '–ü—Ä–∏–±—ã–ª—å/—á:',
    noEnergy: '–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!'
  },
  en: {
    pickRoomFirst: 'Pick a room first!',
    notEnough: 'Not enough coins!',
    dailyAlready: 'Daily reward already claimed!',
    questAlready: 'Quest already claimed!',
    miningIncome: 'Mining Income:',
    miningShop: 'Mining Shop',
    close: 'Close',
    howToPlay: 'How to Play',
    infoList: [
      'Select a room and then click the üîç button to hunt.',
      'The hunter searches 2 random rooms (1 if "Check 1 Room" is active).',
      'If your room is found, you lose coins (shown in red).',
      'If you evade the hunt, you gain coins (shown in green).',
      'Buy upgrades or miners to improve your chances and income.',
      'Claim daily rewards and complete quests for bonus coins.'
    ],
    profile: 'Profile',
    dailyReward: 'Daily Reward',
    dailyText: 'Get 30,000 coins once a day!',
    claimDaily: 'Claim Daily',
    quest: 'Quest',
    claimQuest: 'Claim Quest',
    settings: 'Settings',
    settingsText: 'Change language and other preferences.',
    buyFor: 'Buy {name} for {price}?',
    buy: 'Buy',
    cancel: 'Cancel',
    profitHr: 'Profit/hr:',
    noEnergy: 'No energy!'
  } };
  let lang = localStorage.getItem('lang') || 'ru';
  function t(key, vars = {}) {
    const val = i18n[lang][key];
    if (typeof val === 'string') {
      return val.replace(/\{(\w+)\}/g, (_, k) => vars[k] || '');
    }
    return val;
  }
  function applyLang() {
    document.getElementById('miningLabel').textContent = t('miningIncome');
    document.getElementById('shopTitle').textContent = t('miningShop');
    document.getElementById('closeMiningShop').textContent = t('close');
    document.getElementById('confirmBuy').textContent = t('buy');
    document.getElementById('cancelBuy').textContent = t('cancel');
    document.getElementById('infoTitle').textContent = t('howToPlay');
    document.getElementById('profileTitle').textContent = t('profile');
    document.getElementById('dailyTitle').textContent = t('dailyReward');
    document.getElementById('dailyText').textContent = t('dailyText');
    document.getElementById('claimDaily').textContent = t('claimDaily');
    document.getElementById('questTitle').textContent = t('quest');
    document.getElementById('claimQuest').textContent = t('claimQuest');
    document.getElementById('settingsTitle').textContent = t('settings');
    document.getElementById('settingsText').textContent = t('settingsText');
    document.getElementById('closeInfo').textContent = t('close');

    // info list
    const infoListEl = document.getElementById('infoList');
    infoListEl.innerHTML = '';
    t('infoList').forEach(li => { const el = document.createElement('li'); el.textContent = li; infoListEl.appendChild(el); });
  }

  // ========== Energy system ==========
  const MAX_ENERGY = 50;
  const REGEN_INTERVAL_MS = 30 * 1000; // 30 —Å–µ–∫—É–Ω–¥
  const LS_ENERGY = 'player_energy_v1';
  const LS_ENERGY_TICK = 'player_energy_tick_v1';

  // Ensure first-time visitor gets full energy (50).
  let energy;
  let energyLastTick;
  (function initEnergyStorage(){
    const raw = localStorage.getItem(LS_ENERGY);
    if (raw === null) {
      energy = MAX_ENERGY;
      energyLastTick = Date.now();
      try {
        localStorage.setItem(LS_ENERGY, String(energy));
        localStorage.setItem(LS_ENERGY_TICK, String(energyLastTick));
      } catch(e){}
    } else {
      energy = +raw;
      if (!Number.isFinite(energy)) energy = MAX_ENERGY;
      energyLastTick = +localStorage.getItem(LS_ENERGY_TICK) || Date.now();
    }
    if (energy >= MAX_ENERGY) energyLastTick = Date.now();
    try {
      localStorage.setItem(LS_ENERGY, String(energy));
      localStorage.setItem(LS_ENERGY_TICK, String(energyLastTick));
    } catch(e){}
  })();

  function loadEnergy() {
    const stored = localStorage.getItem(LS_ENERGY);
    const storedTick = localStorage.getItem(LS_ENERGY_TICK);
    if (stored !== null) energy = +stored;
    if (!Number.isFinite(energy)) energy = MAX_ENERGY;
    energyLastTick = +storedTick || Date.now();

    const now = Date.now();
    if (now > energyLastTick && energy < MAX_ENERGY) {
      const delta = now - energyLastTick;
      const gained = Math.floor(delta / REGEN_INTERVAL_MS);
      if (gained > 0) {
        energy = Math.min(MAX_ENERGY, energy + gained);
        energyLastTick += gained * REGEN_INTERVAL_MS;
      }
    }
    if (energy >= MAX_ENERGY) energyLastTick = Date.now();
    saveEnergy();
    updateEnergyDisplay();
  }

  function saveEnergy() {
    try {
      localStorage.setItem(LS_ENERGY, String(energy));
      localStorage.setItem(LS_ENERGY_TICK, String(energyLastTick));
    } catch (e) { /* ignore */ }
  }

  function updateEnergyDisplay() {
    const el = document.getElementById('energyVal');
    const timerEl = document.getElementById('energyTimer');
    if (el) el.textContent = String(energy);
    if (timerEl) {
      if (energy >= MAX_ENERGY) {
        timerEl.textContent = 'Full';
      } else {
        const now = Date.now();
        const delta = now - (energyLastTick || now);
        const rem = REGEN_INTERVAL_MS - (delta % REGEN_INTERVAL_MS);
        const secs = Math.ceil(rem / 1000);
        const mm = Math.floor(secs / 60);
        const ss = secs % 60;
        timerEl.textContent = `${mm>0?mm+'m ':''}${ss}s`;
      }
    }
  }

  function consumeEnergyOne() {
    const now = Date.now();
    if (now > energyLastTick && energy < MAX_ENERGY) {
      const delta = now - energyLastTick;
      const gained = Math.floor(delta / REGEN_INTERVAL_MS);
      if (gained > 0) {
        energy = Math.min(MAX_ENERGY, energy + gained);
        energyLastTick += gained * REGEN_INTERVAL_MS;
      }
    }
    if (energy <= 0) {
      alert(t('noEnergy'));
      return false;
    }
    energy = Math.max(0, energy - 1);
    if (energy < MAX_ENERGY && (!energyLastTick || energyLastTick < Date.now() - 24*3600*1000)) energyLastTick = Date.now();
    saveEnergy();
    updateEnergyDisplay();
    return true;
  }

  setInterval(()=> {
    const now = Date.now();
    if (energy >= MAX_ENERGY) {
      energyLastTick = now;
      saveEnergy();
      updateEnergyDisplay();
      return;
    }
    if (now - energyLastTick >= REGEN_INTERVAL_MS) {
      const gained = Math.floor((now - energyLastTick) / REGEN_INTERVAL_MS);
      if (gained > 0) {
        energy = Math.min(MAX_ENERGY, energy + gained);
        energyLastTick += gained * REGEN_INTERVAL_MS;
        if (energy >= MAX_ENERGY) energyLastTick = now;
        saveEnergy();
        updateEnergyDisplay();
      }
    } else {
      updateEnergyDisplay();
    }
  }, 1000);

  // ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è ==========
  const roomsContainer = document.querySelector('.house');
  for (let i = 0; i < 8; i++) {
    const d = document.createElement('div');
    d.className = 'room';
    d.dataset.idx = i;
    d.textContent = '+';
    roomsContainer.appendChild(d);
  }
  let selectedRoom = null;
  let coins = +localStorage.getItem('coins') || 0;
  let maxCoins = +localStorage.getItem('maxCoins') || coins;
  const coinsVal = document.getElementById('coinsVal');
  let upgrades = JSON.parse(localStorage.getItem('upgrades')) || { x2Prize: 0, check1: 0 };
  let check1Expire = +localStorage.getItem('check1Expire') || 0;
  let roundInProgress = false;

  let shieldExpire = +localStorage.getItem('shieldExpire') || 0;
  let doubleIncomeExpire = +localStorage.getItem('doubleIncomeExpire') || 0;
  let luckExpire = +localStorage.getItem('luckExpire') || 0;

  const minersData = [
    { n: "Miner 1", i: 500, p: 7000 },
    { n: "Miner 2", i: 1788, p: 12000 },
    { n: "Miner 3", i: 2358, p: 15000 },
    { n: "Miner 4", i: 3000, p: 20000 },
    { n: "Miner 5", i: 4500, p: 25000 },
    { n: "Miner 6", i: 5200, p: 30000 },
    { n: "Miner 7", i: 6100, p: 35000 },
    { n: "Miner 8", i: 7200, p: 40000 },
    { n: "Miner 9", i: 8500, p: 45000 },
    { n: "Miner 10", i: 9500, p: 50000 }
  ];

  let minersState;
  try {
    const saved = JSON.parse(localStorage.getItem('minersState'));
    if (Array.isArray(saved)) {
      minersState = minersData.map((_, i) => {
        const s = saved[i];
        if (s && typeof s.count === 'number') return { count: s.count };
        return { count: 0 };
      });
    } else {
      minersState = minersData.map(_ => ({ count: 0 }));
    }
  } catch (e) {
    minersState = minersData.map(_ => ({ count: 0 }));
  }

  const miningIncomeValEl = document.getElementById('miningIncomeVal');
  const minersContainerEl = document.querySelector('.miners-container');
  const minersPanelVisible = document.getElementById('minersPanelVisible');
  const miningShop = document.getElementById('miningShop');
  const buyConfirm = document.getElementById('buyConfirm');
  const buyText = document.getElementById('buyText');
  let pendingMiner = null;

  // —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª
  function format(n) {
    return n >= 1e9 ? (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B' :
           n >= 1e6 ? (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M' :
           n >= 1e3 ? (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K' : String(n);
  }

  // –ù–æ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è: 1000 ZEX = 0.002 TON -> –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 0.000002
  const ZEX_TO_TON = 0.000002;
  function formatTon(n){
    if (!isFinite(n)) return '0';
    if (n === 0) return '0';
    if (n < 0.000001) return '<0.000001';
    return Number(n.toFixed(6)).toString();
  }

  function save() {
    try {
      localStorage.setItem('coins', coins);
      localStorage.setItem('maxCoins', maxCoins);
      localStorage.setItem('upgrades', JSON.stringify(upgrades));
      localStorage.setItem('check1Expire', check1Expire);
      localStorage.setItem('minersState', JSON.stringify(minersState));
      localStorage.setItem('lastTime', Date.now());
      localStorage.setItem('lang', lang);
      localStorage.setItem('shieldExpire', shieldExpire);
      localStorage.setItem('doubleIncomeExpire', doubleIncomeExpire);
      localStorage.setItem('luckExpire', luckExpire);
    } catch (e) {
      console.warn('Save failed', e);
    }
  }

  function updateBalancesDisplay(){
    // ZEX
    coinsVal.textContent = format(coins);
    // TON = coins * ZEX_TO_TON
    const ton = coins * ZEX_TO_TON;
    const tonEl = document.getElementById('tonVal');
    if (tonEl) tonEl.textContent = formatTon(ton);
    const wsZex = document.getElementById('wsModalCoinsDisplay');
    if (wsZex) {
      const wsTon = formatTon(ton);
      wsZex.textContent = format(coins) + ' ZEX ‚Ä¢ ' + wsTon + ' TON';
    }
    const casinoBalance = document.getElementById('casinoBalance');
    if (casinoBalance) {
      casinoBalance.textContent = format(coins) + ' ZEX ‚Ä¢ ' + formatTon(ton) + ' TON';
    }
  }

  function updCoins(v = 0) {
    coins += v;
    if (coins < 0) coins = 0;
    if (coins > maxCoins) maxCoins = coins;
    updateBalancesDisplay();
    updUpg();
    updIncome();
    save();
  }

  function getIncome() {
    const base = minersState.reduce((sum, m, i) => {
      const count = (m && typeof m.count === 'number') ? m.count : 0;
      return sum + (count > 0 ? Math.floor(minersData[i].i * Math.pow(1.5, count - 1)) : 0);
    }, 0);
    if (doubleIncomeExpire > Date.now()) return base * 2;
    return base;
  }
  function updIncome() { miningIncomeValEl.textContent = format(getIncome()); }

  function addOfflineCoins() {
    const last = +localStorage.getItem('lastTime') || Date.now();
    const now = Date.now();
    const diffMinutes = (now - last) / 60000;
    if (diffMinutes > 0) {
      const minutesToAward = Math.min(diffMinutes, 180);
      updCoins(Math.floor(getIncome()/60 * minutesToAward));
    }
    localStorage.setItem('lastTime', now);
  }
  addOfflineCoins();

  setInterval(()=>{ updCoins(Math.floor(getIncome()/3600)); }, 1000);

  function updUpg() {
    document.querySelectorAll('.upgrade').forEach(u => {
      let key = u.dataset.key; let base = +u.dataset.basePrice; let count = upgrades[key] || 0;
      let price = base * Math.pow(2,count);
      let priceEl = u.querySelector('.price'); if (priceEl) priceEl.textContent = format(price);
      const badge = u.querySelector('.badge'); if (badge) badge.textContent = count > 0 ? `Lvl ${count}` : 'New';
    });
  }

  document.querySelectorAll('.upgrade').forEach(u=>{
    u.onclick = ()=>{
      let key = u.dataset.key; let base = +u.dataset.basePrice; let count = upgrades[key]||0;
      let price = base * Math.pow(2,count);
      if (coins >= price) {
        upgrades[key] = count+1; updCoins(-price);
        if (key === 'check1') check1Expire = Date.now()+60000;
        if (key === 'shield') shieldExpire = Date.now()+60000;
        if (key === 'incBoost') doubleIncomeExpire = Date.now()+60000;
        if (key === 'luck') luckExpire = Date.now()+60000;
        save(); updUpg();
      } else alert(t('notEnough'));
    };
  });

  function updTimers() {
    const el = document.getElementById('check1Timer');
    if (check1Expire > Date.now()) el.textContent = '‚è≥ ' + Math.floor((check1Expire - Date.now())/1000) + 's';
    else el.textContent = '';

    const shEl = document.getElementById('shieldTimer');
    if (shieldExpire > Date.now()) shEl.textContent = '‚è≥ ' + Math.floor((shieldExpire - Date.now())/1000) + 's';
    else shEl.textContent = '';

    const incEl = document.getElementById('incTimer');
    if (doubleIncomeExpire > Date.now()) incEl.textContent = '‚è≥ ' + Math.floor((doubleIncomeExpire - Date.now())/1000) + 's';
    else incEl.textContent = '';

    const luckEl = document.getElementById('luckTimer');
    if (luckExpire > Date.now()) luckEl.textContent = '‚è≥ ' + Math.floor((luckExpire - Date.now())/1000) + 's';
    else luckEl.textContent = '';
  }
  setInterval(updTimers, 1000);

  document.querySelectorAll('.room').forEach(r => {
    r.onclick = () => {
      if (roundInProgress) return;
      document.querySelectorAll('.room').forEach(x=>x.classList.remove('selected'));
      r.classList.add('selected');
      selectedRoom = +r.dataset.idx;
    };
  });

  document.getElementById('startBtn').onclick = ()=>{
    if (selectedRoom == null) { alert(t('pickRoomFirst')); return; }
    document.querySelectorAll('.room').forEach(r=>r.classList.remove('found','safe'));
  };

  document.getElementById('resetBtn').onclick = ()=>{
    if (selectedRoom == null) { alert(t('pickRoomFirst')); return; }
    if (!consumeEnergyOne()) return;
    roundInProgress = true;
    const numPicks = (check1Expire > Date.now()) ? 1 : 2;
    let picks = [...Array(8).keys()].sort(()=>0.5-Math.random()).slice(0,numPicks);
    document.querySelectorAll('.room').forEach(r=>r.classList.remove('found','safe','highlight'));
    let delay = 0;
    picks.forEach(i=>{
      let room = document.querySelector(`.room[data-idx="${i}"]`);
      setTimeout(()=>{ room.classList.add('highlight'); }, delay);
      setTimeout(()=>{ room.classList.remove('highlight'); }, delay+600);
      delay += 700;
    });
    setTimeout(()=>{
      let prize = 1000, loss = -2000;
      if (upgrades.x2Prize > 0) { prize *= Math.pow(2, upgrades.x2Prize); loss *= Math.pow(2, upgrades.x2Prize); }

      const roomEl = document.querySelector(`.room[data-idx="${selectedRoom}"]`);

      if (picks.includes(selectedRoom)) {
        if (shieldExpire > Date.now()) {
          roomEl.classList.add('safe');
          updCoins(0);
        } else if (luckExpire > Date.now() && Math.random() < 0.5) {
          roomEl.classList.add('safe');
          updCoins(prize);
        } else {
          const room = document.querySelector(`.room[data-idx="${selectedRoom}"]`);
          room.classList.add('found');
          updCoins(loss);
        }
      } else {
        const room = document.querySelector(`.room[data-idx="${selectedRoom}"]`);
        room.classList.add('safe');
        updCoins(prize);
      }
      selectedRoom = null;
      document.querySelectorAll('.room').forEach(r=>r.classList.remove('selected'));
      roundInProgress = false;
    }, delay+700);
  };

  function renderMiners(){
    if (!minersContainerEl) return;
    minersContainerEl.innerHTML = '';
    minersData.forEach((m,i)=>{
      const st = (minersState[i] && typeof minersState[i].count === 'number') ? minersState[i] : { count: 0 };
      const price = m.p * Math.pow(2, st.count);
      const income = st.count > 0 ? Math.floor(m.i * Math.pow(1.5, st.count - 1)) : 0;

      const card = document.createElement('div'); card.className = 'miner-card';
      card.innerHTML = `
        <img class="card-logo" src="logo.png" alt="logo" />
        <h3>${m.n}</h3>
        <div class="income">+${format(income)} / hr</div>
        <div class="bottom">
          <span class="lvl">Lvl ${st.count}</span>
          <span class="price-pill">${format(price)}</span>
        </div>
      `;
      card.onclick = ()=>{
        const currentSt = (minersState[i] && typeof minersState[i].count === 'number') ? minersState[i] : { count: 0 };
        const currentPrice = m.p * Math.pow(2, currentSt.count);
        if (coins >= currentPrice) {
          pendingMiner = i;
          buyText.textContent = t('buyFor', { name: m.n, price: format(currentPrice) });
          buyConfirm.classList.add('show'); buyConfirm.style.display = 'block'; buyConfirm.setAttribute('aria-hidden','false');
        } else { alert(t('notEnough')); }
      };
      minersContainerEl.appendChild(card);
    });
  }

  const miningBtn = document.getElementById('miningBtn');
  const shopBtn = document.getElementById('shopBtn');
  miningBtn.onclick = () => { miningShop.style.display = 'block'; miningShop.setAttribute('aria-hidden','false'); renderMiners(); };
  shopBtn.onclick = () => { miningShop.style.display = 'block'; miningShop.setAttribute('aria-hidden','false'); renderMiners(); };
  document.getElementById('closeMiningShop').onclick = ()=>{ miningShop.style.display = 'none'; miningShop.setAttribute('aria-hidden','true'); };

  document.getElementById('confirmBuy').onclick = ()=>{
    if (pendingMiner === null) return;
    const i = pendingMiner; const m = minersData[i]; const st = minersState[i] || { count: 0 };
    const price = m.p * Math.pow(2, st.count);
    if (coins >= price) {
      coins -= price; minersState[i] = { count: (st.count || 0) + 1 }; updCoins(0); save(); renderMiners();
    } else alert(t('notEnough'));
    pendingMiner = null;
    buyConfirm.classList.remove('show'); buyConfirm.style.display = 'none'; buyConfirm.setAttribute('aria-hidden','true');
  };
  document.getElementById('cancelBuy').onclick = ()=>{ pendingMiner = null; buyConfirm.classList.remove('show'); buyConfirm.style.display = 'none'; buyConfirm.setAttribute('aria-hidden','true'); };

  const profileWindowEl = document.getElementById('profileWindow');
  document.getElementById('profileBtn').onclick = ()=>{ profileWindowEl.style.display = 'block'; profileWindowEl.setAttribute('aria-hidden','false'); };
  document.getElementById('closeProfile').onclick = ()=>{ profileWindowEl.style.display = 'none'; profileWindowEl.setAttribute('aria-hidden','true'); };

  let questClaimed = localStorage.getItem('questClaimed') === 'true';
  let lastDaily = +localStorage.getItem('lastDaily') || 0;
  const questStatusEl = document.getElementById('questStatus');
  const dailyStatusEl = document.getElementById('dailyStatus');
  function updateQuestStatus(){ questStatusEl.textContent = questClaimed ? "‚úÖ Completed" : "‚ùå Not claimed"; }
  function updateDailyStatus(){ const now = Date.now(); const nextAvailable = lastDaily + 24*60*60*1000; if (now >= nextAvailable) dailyStatusEl.textContent = "üí∞ Available!"; else { const diff = nextAvailable - now; const hours = Math.floor(diff / (1000*60*60)); const minutes = Math.floor((diff % (1000*60*60)) / (1000*60)); dailyStatusEl.textContent = `Next in ${hours}h ${minutes}m`; } }
  setInterval(updateDailyStatus, 60000); updateDailyStatus(); updateQuestStatus();

  document.getElementById('claimQuest').onclick = ()=>{ if (questClaimed) alert(t('questAlready')); else { updCoins(50000); questClaimed = true; localStorage.setItem('questClaimed','true'); updateQuestStatus(); } };
  document.getElementById('claimDaily').onclick = ()=>{ const now = Date.now(); if (now - lastDaily < 24*60*60*1000) alert(t('dailyAlready')); else { updCoins(30000); lastDaily = now; localStorage.setItem('lastDaily', now); updateDailyStatus(); } };

  const infoWindowEl = document.getElementById('infoWindow');
  document.getElementById('infoBtn').onclick = ()=>{ infoWindowEl.style.display = 'block'; infoWindowEl.setAttribute('aria-hidden','false'); };
  document.getElementById('closeInfo').onclick = ()=>{ infoWindowEl.style.display = 'none'; infoWindowEl.setAttribute('aria-hidden','true'); };

  const upgradePanel = document.getElementById('upgradePanel');
  minersPanelVisible.style.display = 'none';
  upgradePanel.style.display = 'flex';

  const langSelect = document.getElementById('langSelect');
  langSelect.value = lang;
  langSelect.onchange = ()=>{ lang = langSelect.value; localStorage.setItem('lang', lang); applyLang(); renderMiners(); };

  // init UI
  loadEnergy();
  updateBalancesDisplay();
  updUpg();
  updIncome();
  updTimers();
  renderMiners();
  applyLang();

  document.getElementById('infoWindow').style.display = 'none';
  document.getElementById('infoWindow').setAttribute('aria-hidden','true');
  document.getElementById('profileWindow').style.display = 'none';
  document.getElementById('profileWindow').setAttribute('aria-hidden','true');
  buyConfirm.style.display = 'none';
  buyConfirm.setAttribute('aria-hidden','true');
  </script>

  <!-- =================== Rewards modal: –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É =================== -->
  <div id="wsModalOverlay" aria-hidden="false" role="dialog" aria-label="Daily rewards modal">
    <div class="bgLayer" aria-hidden="true">
      <div class="bgImage" aria-hidden="true"></div>
    </div>

    <div class="glass" role="document" aria-modal="true">
      <div class="header">
        <div class="title">
          <div class="coinIcon">üíé</div>
          <div>
            <div style="font-size:18px">Premium Gifts</div>
            <div class="sub">7 days of rewards ‚Äî claim one per day</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800;color:var(--wm-accentC);font-size:18px" id="wsModalCoinsDisplay">0 ZEX ‚Ä¢ 0 TON</div>
          <div style="font-size:12px;color:var(--wm-birch)">Coins balance</div>
        </div>
      </div>

      <div class="rewardsShell" id="rewardsShell">
        <div class="rewardsContainer" id="rewardsContainer">
          <div class="rewardsGridTop" id="rewardsGridTop" aria-hidden="false"></div>
          <div style="height:8px"></div>
          <div class="rewardsGridBottom" id="rewardsGridBottom" aria-hidden="false"></div>

          <div class="wsActions">
            <div class="left">Unlocked: <span id="wsUnlockedCount" style="font-weight:900;color:var(--wm-accentC)">0</span>/7</div>
            <div style="display:flex;gap:10px">
              <button class="btnGhost" id="wsBtnRules">How it works</button>
              <button class="btnPrimary" id="wsBtnClose">Come back tomorrow</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // ====== Config ======
    const LS_FIRST = 'ws_first_seen_v2';
    const LS_CLAIMED = 'ws_claimed_v2';
    const MAX_DAYS = 7;
    const amounts = [30000,100000,500000,1000000,3000000,6000000,10000000];

    // ====== Safe LS utils ======
    function safeGetJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        const v = JSON.parse(raw);
        return v;
      }catch(e){ return fallback; }
    }
    function safeSetJSON(key, obj){
      try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
    }

    // Ensure first seen exists
    let firstSeen = +localStorage.getItem(LS_FIRST) || 0;
    if(!firstSeen || isNaN(firstSeen)){
      firstSeen = Date.now();
      try{ localStorage.setItem(LS_FIRST, String(firstSeen)); }catch(e){}
    }

    // claimed array safe init
    let claimed = safeGetJSON(LS_CLAIMED, null);
    if(!Array.isArray(claimed) || claimed.length !== MAX_DAYS){
      claimed = new Array(MAX_DAYS).fill(false);
      safeSetJSON(LS_CLAIMED, claimed);
    }

    // compute availability
    function daysSinceFirst(){
      const now = Date.now();
      const diffDays = Math.floor((now - firstSeen) / (24*60*60*1000));
      return diffDays;
    }
    function availableCount(){
      return Math.min(MAX_DAYS, daysSinceFirst() + 1);
    }

    // ====== Expose/Connect to game API (safe wrappers) ======
    const _orig_claim = window.claimRewardFromModal instanceof Function ? window.claimRewardFromModal : null;
    const _orig_upd = window.updCoins instanceof Function ? window.updCoins : null;
    const _orig_save = window.save instanceof Function ? window.save : null;
    const _orig_format = window.format instanceof Function ? window.format : null;

    function formatFallback(n){
      if (typeof _orig_format === 'function') return _orig_format(n);
      if (n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
      if (n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
      if (n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
      return String(n);
    }

    function updCoinsPublic(v=0){
      if (typeof _orig_upd === 'function'){
        try{ _orig_upd(v); return; }catch(e){}
      }
      try{
        let cur = +localStorage.getItem('coins') || 0;
        cur += v;
        if(cur < 0) cur = 0;
        localStorage.setItem('coins', String(cur));
        const el = document.getElementById('coinsVal');
        if(el) el.textContent = formatFallback(cur);
        const tonEl = document.getElementById('tonVal');
        if(tonEl) {
          const ton = cur * ZEX_TO_TON;
          tonEl.textContent = (ton < 0.000001 && ton > 0) ? '<0.000001' : Number(ton.toFixed(6)).toString();
        }
      }catch(e){}
    }

    function saveGameStatePublic(){
      if (typeof window.save === 'function'){
        try{ window.save(); return; }catch(e){} // original game save function
      }
      try{
        const coins = localStorage.getItem('coins') || '0';
        localStorage.setItem('coins', coins);
        safeSetJSON(LS_CLAIMED, claimed);
        localStorage.setItem(LS_FIRST, String(firstSeen));
      }catch(e){}
    }

    function claimRewardFromModalPublic(amount){
      if (typeof _orig_claim === 'function'){
        try{ _orig_claim(amount); saveGameStatePublic(); return; }catch(e){ }
      }
      try{
        if (typeof _orig_upd === 'function') {
          _orig_upd(amount);
        } else if (typeof window.updCoins === 'function') {
          window.updCoins(amount);
        } else {
          let cur = +localStorage.getItem('coins') || 0;
          cur += amount;
          localStorage.setItem('coins', String(cur));
          const cv = document.getElementById('coinsVal');
          if(cv) cv.textContent = formatFallback(cur);
          const tonEl = document.getElementById('tonVal');
          if(tonEl) { const ton = cur * ZEX_TO_TON; tonEl.textContent = (ton < 0.000001 && ton > 0) ? '<0.000001' : Number(ton.toFixed(6)).toString(); }
        }
        saveGameStatePublic();
      }catch(e){}
    }

    window.claimRewardFromModal = window.claimRewardFromModal || claimRewardFromModalPublic;
    window.updCoins = window.updCoins || updCoinsPublic;
    window.saveGameState = window.saveGameState || saveGameStatePublic;
    window.format = window.format || formatFallback;

    const updCoins = window.updCoins;
    const claimRewardFromModal = window.claimRewardFromModal;
    const saveGameState = window.saveGameState;
    const formatNum = window.format;

    // ====== Modal DOM & logic ======
    const overlay = document.getElementById('wsModalOverlay');
    const gridTop = document.getElementById('rewardsGridTop');
    const gridBottom = document.getElementById('rewardsGridBottom');
    const unlockedCountEl = document.getElementById('wsUnlockedCount');
    const coinsDisplayEl = document.getElementById('wsModalCoinsDisplay');
    const btnClose = document.getElementById('wsBtnClose');
    const btnRules = document.getElementById('wsBtnRules');

    // Hide main page children while modal is visible.
    const hiddenTargets = [];
    function hideMainUI(){
      const bodyChildren = Array.from(document.body.children);
      bodyChildren.forEach(ch=>{ if (ch === overlay) return; const prev = ch.style.display || ''; hiddenTargets.push({el: ch, prev}); ch.style.display = 'none'; });
      overlay.classList.remove('hidden');
    }
    function showMainUI(){
      hiddenTargets.forEach(item=>{ try{ item.el.style.display = item.prev || ''; }catch(e){} });
      hiddenTargets.length = 0;
      overlay.classList.add('hidden');
    }

    // Build cards (1..7).
    function renderCards(){
      // reload claimed from storage to stay in sync with other tabs
      claimed = safeGetJSON(LS_CLAIMED, claimed) || claimed;

      const avail = availableCount();
      gridTop.innerHTML = '';
      gridBottom.innerHTML = '';

      for(let i=0;i<MAX_DAYS;i++){
        const day = i+1;
        const amount = amounts[i] || 0;
        const card = document.createElement('div');
        card.className = 'rewardCard';
        if (day === 7) card.classList.add('big');

        card.innerHTML = `
          <div class="coinIconSmall">üí∞</div>
          <div class="dayLabel">Day ${day}</div>
          <div class="amount">${formatNum(amount)}</div>
        `;

        const isUnlocked = i < avail;
        const isClaimed = !!claimed[i];

        if(isClaimed){
          card.classList.add('claimed');
          const badge = document.createElement('div');
          badge.className = 'claimBadge';
          badge.textContent = 'Claimed';
          card.appendChild(badge);
        } else if(isUnlocked){
          card.classList.add('unlocked');
        } else {
          card.classList.add('locked');
          const overlayEl = document.createElement('div');
          overlayEl.className = 'overlay';
          overlayEl.textContent = '';
          card.appendChild(overlayEl);
        }

        // Attach a safe click handler which checks current availability/claimed state at click moment
        card.addEventListener('click', function onCardClick(){
          // Re-read claimed/availability to avoid stale closures
          claimed = safeGetJSON(LS_CLAIMED, claimed) || claimed;
          const nowClaimed = !!claimed[i];
          const nowAvail = i < availableCount();
          if (!nowAvail || nowClaimed) return; // not ready or already claimed

          // Prevent double clicks immediately
          card.style.pointerEvents = 'none';

          // optimistic UI
          card.classList.add('pop');
          setTimeout(()=>card.classList.remove('pop'),260);

          // mark claimed and persist
          claimed[i] = true;
          safeSetJSON(LS_CLAIMED, claimed);

          // Try to credit the coins robustly. Use game's API when available, otherwise fallback.
          try {
            if (typeof claimRewardFromModal === 'function') {
              claimRewardFromModal(amounts[i]);
            } else if (typeof updCoins === 'function') {
              updCoins(amounts[i]);
            } else {
              let cur = +localStorage.getItem('coins') || 0;
              cur += amounts[i];
              localStorage.setItem('coins', String(cur));
              const mainEl = document.getElementById('coinsVal');
              if (mainEl) mainEl.textContent = formatNum(cur);
            }
            saveGameStatePublic();
          } catch(e){
            console.error('claimReward error', e);
            try { updCoinsPublic(amounts[i]); } catch(e2){}
          }

          // Update card UI to claimed
          const badge = document.createElement('div');
          badge.className = 'claimBadge';
          badge.textContent = 'Claimed';
          card.appendChild(badge);
          card.classList.remove('unlocked');
          card.classList.add('claimed');
          card.style.pointerEvents = 'none';

          // Sync displays
          syncCoinsDisplay();
          renderUnlockedCount();
        });

        if(i < 4) gridTop.appendChild(card);
        else gridBottom.appendChild(card);
      }

      renderUnlockedCount();
    }

    function renderUnlockedCount(){
      const avail = availableCount();
      const unlockedNow = Math.min(avail, MAX_DAYS);
      unlockedCountEl.textContent = String(unlockedNow);
    }

    function syncCoinsDisplay(){
      const coins = +localStorage.getItem('coins') || 0;
      const ton = coins * ZEX_TO_TON;
      coinsDisplayEl.textContent = formatNum(coins) + ' ZEX ‚Ä¢ ' + (ton < 0.000001 && ton > 0 ? '<0.000001' : Number(ton.toFixed(6)).toString()) + ' TON';
      const mainEl = document.getElementById('coinsVal');
      if (mainEl) mainEl.textContent = formatNum(coins);
      const tonEl = document.getElementById('tonVal');
      if (tonEl) tonEl.textContent = (ton < 0.000001 && ton > 0) ? '<0.000001' : Number(ton.toFixed(6)).toString();
    }

    btnClose.addEventListener('click', function(){
      showMainUI();
      saveGameState();
    });

    btnRules.addEventListener('click', function(){
      alert('Rewards unlock one per day since first visit. Click an unlocked card to claim its coins.');
    });

    hideMainUI();
    renderCards();
    syncCoinsDisplay();

    // refresh UI each minute in case time-based availability changes
    setInterval(()=>{ renderCards(); syncCoinsDisplay(); }, 60*1000);

    window._wsModal = {
      open: function(){ hideMainUI(); renderCards(); syncCoinsDisplay(); },
      close: function(){ showMainUI(); saveGameState(); },
      getState: function(){ return { firstSeen, claimed: claimed.slice(), available: availableCount() }; },
      forceResetClaims: function(){ claimed = new Array(MAX_DAYS).fill(false); safeSetJSON(LS_CLAIMED,claimed); renderCards(); }
    };

    overlay.tabIndex = -1;
  })();
  </script>

  <!-- ================= Casino modal & logic ================= -->
  <div id="casinoModal" class="casino-modal" aria-hidden="true" role="dialog" aria-label="Casino wheel">
    <div class="card" role="document">
      <div class="casino-header">
        <div>
          <div style="font-size:20px;font-weight:900">üé∞ Casino</div>
          <div style="color:var(--birch);font-weight:700">Spin the wheel ‚Äî once every 2 hours</div>
        </div>
        <div id="casinoBalance" style="text-align:right;font-weight:800;color:var(--accent-cyan)">0 ZEX ‚Ä¢ 0 TON</div>
      </div>

      <div class="casino-body">
        <div class="wheel-wrap">
          <canvas id="wheelCanvas" width="800" height="800" aria-hidden="false"></canvas>
          <div class="wheel-pointer" aria-hidden="true"></div>
        </div>

        <div class="casino-controls">
          <div class="casino-note">Next spin in: <span id="casinoCooldown">Ready</span></div>
          <button id="spinBtn" class="spin-btn">SPIN</button>
          <div>Result: <span id="casinoResult" class="casino-result">‚Äî</span></div>
          <button id="closeCasino" class="btnGhost" style="padding:8px 12px;border-radius:10px;">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // Casino wheel implementation
    const casinoBtn = document.getElementById('casinoBtn');
    const casinoModal = document.getElementById('casinoModal');
    const closeCasino = document.getElementById('closeCasino');
    const spinBtn = document.getElementById('spinBtn');
    const casinoCooldownEl = document.getElementById('casinoCooldown');
    const casinoResultEl = document.getElementById('casinoResult');
    const casinoBalanceEl = document.getElementById('casinoBalance');
    const wheelCanvas = document.getElementById('wheelCanvas');
    const ctx = wheelCanvas.getContext('2d');

    // Config: segments mixing TON and ZEX (max TON 2, max coins 100k)
    // Each segment: {label, type: 'ton'|'zex', value}
    const segments = [
      { label: '100K ZEX', type: 'zex', value: 100000 },
      { label: '0.1 TON', type: 'ton', value: 0.1 },
      { label: '5K ZEX', type: 'zex', value: 5000 },
      { label: '0.5 TON', type: 'ton', value: 0.5 },
      { label: '10K ZEX', type: 'zex', value: 10000 },
      { label: '1 TON', type: 'ton', value: 1 },
      { label: '50K ZEX', type: 'zex', value: 50000 },
      { label: '0.2 TON', type: 'ton', value: 0.2 },
      { label: '1K ZEX', type: 'zex', value: 1000 },
      { label: '2 TON', type: 'ton', value: 2 }
    ];

    const SEG_COUNT = segments.length;

    // Conversion: 1000 ZEX = 0.002 TON => 1 TON = 1000 / 0.002 = 500000 ZEX
    const TON_TO_ZEX = 1000 / 0.002;

    // cooldown: 2 hours
    const COOL_KEY = 'casino_last_spin_v2';
    const COOLDOWN_MS = 2 * 60 * 60 * 1000;

    // wheel state
    let rotation = 0; // degrees
    let isSpinning = false;

    // draw wheel
    function drawWheel(){
      const w = wheelCanvas.width;
      const h = wheelCanvas.height;
      const cx = w/2;
      const cy = h/2;
      const radius = Math.min(cx,cy) - 8;
      ctx.clearRect(0,0,w,h);
      const anglePer = 2*Math.PI / SEG_COUNT;
      for(let i=0;i<SEG_COUNT;i++){
        const start = i*anglePer - Math.PI/2;
        const end = start + anglePer;
        // alternate colors
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,radius,start,end);
        ctx.closePath();
        ctx.fillStyle = (i%2===0) ? 'rgba(255,255,255,0.04)' : 'rgba(255,255,255,0.02)';
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.06)';
        ctx.lineWidth = 2;
        ctx.stroke();

        // draw label
        ctx.save();
        const textAngle = start + anglePer/2;
        ctx.translate(cx + Math.cos(textAngle)*(radius*0.66), cy + Math.sin(textAngle)*(radius*0.66));
        ctx.rotate(textAngle + Math.PI/2);
        ctx.fillStyle = '#ecf8ff';
        ctx.font = 'bold 22px Inter, system-ui, Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const label = segments[i].label;
        // wrap if long
        const lines = label.split(' ');
        ctx.fillText(label, 0, 0);
        ctx.restore();
      }

      // draw center
      ctx.beginPath();
      ctx.arc(cx,cy,60,0,2*Math.PI);
      ctx.fillStyle = 'rgba(0,0,0,0.18)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.04)';
      ctx.stroke();
    }

    // render with rotation
    function render(){
      // rotate canvas via CSS transform on container
      wheelCanvas.style.transform = `rotate(${rotation}deg)`;
    }

    // random spin: pick segment index uniformly, compute target rotation so that segment center aligns to pointer (top)
    function getRandomSegmentIndex(){
      return Math.floor(Math.random()*SEG_COUNT);
    }

    // mapping index -> angle to bring its center to top (pointer)
    function angleForIndex(i){
      // each segment center angle in degrees (0 at top since we drew with -PI/2 offset)
      const anglePerDeg = 360 / SEG_COUNT;
      // center of segment i measured clockwise from top:
      const center = i * anglePerDeg + anglePerDeg/2;
      // We need to rotate wheel so that that center lands at top (0deg rotation). Because positive rotation rotates clockwise for CSS,
      // targetRotation such that ((initialRotation + targetRotation) mod 360) === -center (since we want the segment center at 0 deg)
      // Simpler: compute target = 360 * k + (360 - center)
      return (360 - center) % 360;
    }

    // perform spin animation
    function spinToIndex(i){
      if (isSpinning) return;
      isSpinning = true;
      spinBtn.disabled = true;
      const baseSpins = 6; // full revolutions
      const targetAngle = angleForIndex(i);
      const randomOffset = (Math.random()*15) - 7.5; // small jitter
      const finalAngle = baseSpins*360 + targetAngle + randomOffset;
      const duration = 5000 + Math.random()*1000; // ms
      // animate rotation from current rotation to current + finalAngle
      const start = performance.now();
      const from = rotation % 360;
      const to = rotation + finalAngle;
      function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }
      function step(now){
        const elapsed = now - start;
        const p = Math.min(1, elapsed / duration);
        const eased = easeOutCubic(p);
        rotation = from + (to - from) * eased;
        render();
        if(p < 1) requestAnimationFrame(step);
        else {
          // finished
          isSpinning = false;
          spinBtn.disabled = false;
          // compute chosen index from rotation
          const landed = ((360 - (rotation % 360)) + 360) % 360; // angle at top
          const anglePerDeg = 360 / SEG_COUNT;
          let idx = Math.floor((landed) / anglePerDeg);
          // ensure idx in range
          idx = (idx + SEG_COUNT) % SEG_COUNT;
          announcePrize(idx);
        }
      }
      requestAnimationFrame(step);
    }

    function announcePrize(idx){
      const seg = segments[idx];
      if(!seg) return;
      let text = '';
      if(seg.type === 'zex'){
        // award ZEX directly
        const amount = Math.round(seg.value);
        // use game's updater if available
        try{
          if(typeof window.updCoins === 'function') window.updCoins(amount);
          else updCoinsPublic(amount);
        }catch(e){ updCoinsPublic(amount); }
        text = `+${format(amount)} ZEX`;
      } else {
        // TON -> convert to ZEX and award as ZEX (since game tracks coins)
        const tonAmount = seg.value;
        const zexAmount = Math.round(tonAmount * TON_TO_ZEX);
        try{
          if(typeof window.updCoins === 'function') window.updCoins(zexAmount);
          else updCoinsPublic(zexAmount);
        }catch(e){ updCoinsPublic(zexAmount); }
        text = `+${tonAmount} TON (~${format(zexAmount)} ZEX)`;
      }
      casinoResultEl.textContent = text;
      // update shared display
      updateCasinoBalanceDisplay();
      // set last spin
      localStorage.setItem(COOL_KEY, String(Date.now()));
      updateCooldownDisplay();
    }

    function updateCasinoBalanceDisplay(){
      const c = +localStorage.getItem('coins') || 0;
      const ton = c * ZEX_TO_TON;
      casinoBalanceEl.textContent = format(c) + ' ZEX ‚Ä¢ ' + (ton < 0.000001 && ton > 0 ? '<0.000001' : Number(ton.toFixed(6)).toString()) + ' TON';
      // also sync main UI
      const mainEl = document.getElementById('coinsVal');
      if(mainEl) mainEl.textContent = format(c);
      const tonEl = document.getElementById('tonVal');
      if(tonEl) tonEl.textContent = (ton < 0.000001 && ton > 0) ? '<0.000001' : Number(ton.toFixed(6)).toString();
    }

    function updateCooldownDisplay(){
      const last = +localStorage.getItem(COOL_KEY) || 0;
      const now = Date.now();
      const diff = now - last;
      if(last === 0 || diff >= COOLDOWN_MS){
        casinoCooldownEl.textContent = 'Ready';
        spinBtn.disabled = false;
      } else {
        const rem = COOLDOWN_MS - diff;
        const hours = Math.floor(rem / (1000*60*60));
        const minutes = Math.floor((rem % (1000*60*60)) / (1000*60));
        const seconds = Math.floor((rem % (1000*60)) / 1000);
        casinoCooldownEl.textContent = `${hours}h ${minutes}m ${seconds}s`;
        spinBtn.disabled = true;
      }
    }

    // events
    casinoBtn.addEventListener('click', ()=>{
      casinoModal.style.display = 'flex';
      casinoModal.setAttribute('aria-hidden','false');
      updateCasinoBalanceDisplay();
      updateCooldownDisplay();
    });
    closeCasino.addEventListener('click', ()=>{
      casinoModal.style.display = 'none';
      casinoModal.setAttribute('aria-hidden','true');
    });

    // spin click: check cooldown
    spinBtn.addEventListener('click', ()=>{
      const last = +localStorage.getItem(COOL_KEY) || 0;
      const now = Date.now();
      if(last && now - last < COOLDOWN_MS){
        updateCooldownDisplay();
        return;
      }
      // pick random segment and spin to it
      const idx = getRandomSegmentIndex();
      spinToIndex(idx);
    });

    // initial draw and animation frame
    drawWheel();
    render();

    // refresh cooldown every second
    setInterval(updateCooldownDisplay, 1000);

    // helper for formatting numbers (reuse existing format if present)
    function format(n){
      if(typeof window.format === 'function') return window.format(n);
      if(n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
      if(n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
      if(n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
      return String(n);
    }

    // expose for debugging if needed
    window._casino = {
      open: ()=>{ casinoModal.style.display = 'flex'; casinoModal.setAttribute('aria-hidden','false'); updateCasinoBalanceDisplay(); updateCooldownDisplay(); },
      close: ()=>{ casinoModal.style.display = 'none'; casinoModal.setAttribute('aria-hidden','true'); },
      lastSpin: ()=>+localStorage.getItem(COOL_KEY) || 0
    };

  })();
  </script>
</body>
</html>
