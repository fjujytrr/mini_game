<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hide & Seek ‚Äî –ú–∏–Ω–∏-–∏–≥—Ä–∞</title>
  <style>
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --accent:#7dd3fc;
      --ok:#16a34a;
      --bad:#ef4444;
      --muted:#94a3b8;
      --card:#071020;
      --glass: rgba(255,255,255,0.03);
    }
    body{
      margin:0;
      font-family: Inter, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #041025 0%, #072033 100%);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
    }
    .wrap{
      max-width:960px;
      margin:20px auto;
      padding:20px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:14px;
    }
    h1{font-size:20px;margin:0}
    .coins{
      background:var(--glass);
      padding:10px 14px;
      border-radius:10px;
      display:flex;
      gap:10px;
      align-items:center;
      box-shadow:0 4px 18px rgba(0,0,0,0.45);
    }
    .coins .val{font-weight:700;font-size:18px}
    .sub{color:var(--muted);font-size:13px}
    .house{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:18px;
      border-radius:12px;
      box-shadow:0 8px 30px rgba(2,6,23,0.6);
    }

    /* grid for 8 rooms: 4 x 2 */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-bottom:12px;
    }
    .room{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-radius:8px;
      height:110px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      cursor:pointer;
      position:relative;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      border:2px solid rgba(255,255,255,0.03);
      user-select:none;
    }
    .room:hover{ transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.5);}
    .room .label{font-weight:700;font-size:14px}
    .room .hint{font-size:12px;color:var(--muted)}
    .room.selected{border-color:var(--accent); box-shadow:0 10px 28px rgba(34,211,238,0.08);}
    .room.checking{outline:4px solid rgba(255,255,255,0.03); border-color: #fbbf24;}
    .room.found{border-color:var(--bad); box-shadow:0 12px 36px rgba(239,68,68,0.12)}
    .room.safe{border-color:var(--ok); box-shadow:0 12px 36px rgba(16,185,129,0.08)}
    .overlay{
      position:absolute;
      top:8px; right:8px;
      background:rgba(0,0,0,0.4);
      padding:6px 8px;
      border-radius:8px;
      font-size:12px;
      color:var(--muted);
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:10px;
    }
    button{
      background:linear-gradient(180deg,var(--accent), #17b4df);
      border:none; color:#012; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;
      box-shadow:0 6px 18px rgba(18,80,100,0.12);
    }
    button.secondary{
      background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted);
    }
    .log{
      margin-top:12px;
      padding:10px;
      border-radius:8px;
      background:rgba(6,12,20,0.5);
      font-size:14px;
      min-height:46px;
      color:#dbeafe;
    }
    .hint-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px;color:var(--muted);font-size:13px}
    @media (max-width:720px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
      .room{ height:92px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Hide & Seek ‚Äî Mini App</h1>
        <div class="sub">–°–ø—Ä—è—á—å—Å—è, –æ—Ö–æ—Ç–Ω–∏–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç 2 –∫–æ–º–Ω–∞—Ç—ã. –ù–∞–π–¥—É—Ç ‚Äî ‚àí2000, –Ω–µ –Ω–∞–π–¥—É—Ç ‚Äî +1000</div>
      </div>
      <div class="coins" aria-live="polite">
        <div style="font-size:20px">üí∞ <span class="val" id="coinsVal">0</span></div>
        <div style="text-align:right">
          <div class="sub">–ë–∞–ª–∞–Ω—Å</div>
          <div class="sub" id="playerRoomText">–°–ø—Ä—è—Ç–∞–Ω: ‚Äî</div>
        </div>
      </div>
    </header>

    <section class="house">
      <div class="grid" id="roomsGrid">
        <!-- JS —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 8 –∫–æ–º–Ω–∞—Ç -->
      </div>

      <div class="hint-row">
        <div class="sub">–ù–∞–∂–º–∏ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É, —á—Ç–æ–±—ã —Å–ø—Ä—è—Ç–∞—Ç—å—Å—è</div>
        <div class="sub">–ö–æ–º–Ω–∞—Ç: <strong id="roomsCount">8</strong></div>
      </div>

      <div class="controls">
        <button id="startBtn">–ù–∞—á–∞—Ç—å —Ä–∞—É–Ω–¥</button>
        <button class="secondary" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        <button class="secondary" id="againBtn" style="display:none">–ò–≥—Ä–∞—Ç—å –µ—â—ë</button>
      </div>

      <div class="log" id="log">–ì–æ—Ç–æ–≤ –∫ –∏–≥—Ä–µ ‚Äî –≤—ã–±–µ—Ä–∏ –∫–æ–º–Ω–∞—Ç—É –∏ –∂–º–∏ ¬´–ù–∞—á–∞—Ç—å —Ä–∞—É–Ω–¥¬ª.</div>
    </section>
  </div>

  <script>
    // –ù–ê–°–¢–†–û–ô–ö–ò
    const NUM_ROOMS = 8;                      // –∫–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ 8)
    const STORAGE_KEY = 'hide_seek_coins_v1'; // –∫–ª—é—á localStorage
    const START_COINS = 5000;                 // –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
    const PENALTY = 2000;
    const REWARD = 1000;
    const CHECK_DELAY = 900;                  // ms –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏

    // DOM
    const grid = document.getElementById('roomsGrid');
    const coinsVal = document.getElementById('coinsVal');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const againBtn = document.getElementById('againBtn');
    const logEl = document.getElementById('log');
    const playerRoomText = document.getElementById('playerRoomText');
    const roomsCountSpan = document.getElementById('roomsCount');

    roomsCountSpan.textContent = NUM_ROOMS;

    // —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let coins = loadCoins();
    let selectedRoom = null;
    let busy = false;

    // Telegram WebApp (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –∏–∑ Telegram)
    const tg = window.Telegram?.WebApp ?? null;
    if(tg){
      try{ tg.init(); tg.expand(); }catch(e){}
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateCoinsUI();
    renderRooms();

    startBtn.addEventListener('click', startRound);
    resetBtn.addEventListener('click', ()=>{
      if (busy) return;
      if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏ –Ω–∞—á–∞—Ç—å —Å ' + START_COINS + ' –º–æ–Ω–µ—Ç?')) {
        coins = START_COINS;
        saveCoins(); updateCoinsUI();
        log('–ë–∞–ª–∞–Ω—Å —Å–±—Ä–æ—à–µ–Ω.');
      }
    });
    againBtn.addEventListener('click', ()=>{
      if (busy) return;
      resetHighlights();
      againBtn.style.display='none';
      log('–í—ã–±–µ—Ä–∏ –∫–æ–º–Ω–∞—Ç—É –∏ –Ω–∞—á–Ω–∏ –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥.');
    });

    function loadCoins(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw === null) {
        localStorage.setItem(STORAGE_KEY, String(START_COINS));
        return START_COINS;
      }
      const v = parseInt(raw,10);
      return isNaN(v) ? START_COINS : v;
    }
    function saveCoins(){
      localStorage.setItem(STORAGE_KEY, String(coins));
    }
    function updateCoinsUI(){
      coinsVal.textContent = coins;
      playerRoomText.textContent = '–°–ø—Ä—è—Ç–∞–Ω: ' + (selectedRoom === null ? '‚Äî' : ('–ö–æ–º–Ω–∞—Ç–∞ ' + (selectedRoom+1)));
    }

    function renderRooms(){
      grid.innerHTML = '';
      for(let i=0;i<NUM_ROOMS;i++){
        const d = document.createElement('div');
        d.className = 'room';
        d.dataset.idx = i;
        d.innerHTML = <div class="label">–ö–æ–º–Ω–∞—Ç–∞ ${i+1}</div><div class="hint">–©—ë–ª–∫–Ω–∏, —á—Ç–æ–±—ã —Å–ø—Ä—è—Ç–∞—Ç—å—Å—è</div>;
        d.addEventListener('click', ()=> selectRoom(i));
        grid.appendChild(d);
      }
    }

    function selectRoom(i){
      if (busy) return;
      const prev = grid.querySelector('.room.selected');
      if (prev) prev.classList.remove('selected');
      const node = grid.querySelector('.room[data-idx="'+i+'"]');
      if (node) node.classList.add('selected');
      selectedRoom = i;
      updateCoinsUI();
      log(–¢—ã —Å–ø—Ä—è—Ç–∞–ª—Å—è –≤ –∫–æ–º–Ω–∞—Ç–µ ${i+1}. –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Ä–∞—É–Ω–¥.);
    }

    function pickTwoRandom(n){
      const a = Math.floor(Math.random()*n);
      let b;
      do { b = Math.floor(Math.random()*n); } while (b===a);
      // –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—à–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫, —á—Ç–æ–±—ã –±—ã–ª–æ —Å–ª—É—á–∞–π–Ω–æ –∫—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º
      return Math.random()<0.5 ? [a,b] : [b,a];
    }

    function delay(ms){ return new Promise(res=>setTimeout(res,ms)); }

    async function startRound(){
      if (busy) return;
      if (selectedRoom === null) {
        alert('–í—ã–±–µ—Ä–∏ –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –ø—Ä—è—Ç–æ–∫.');
        return;
      }

      busy = true;
      startBtn.disabled = true;
      resetBtn.disabled = true;
      againBtn.style.display='none';
      log('–û—Ö–æ—Ç–Ω–∏–∫ –∏—â–µ—Ç...');

      // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø–æ–¥—Å–≤–µ—Ç–æ–∫
      resetHighlights();

      const checks = pickTwoRandom(NUM_ROOMS);
      // –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ –æ—á–µ—Ä–µ–¥–∏
      let found = false;
      for (let step=0; step<checks.length; step++){
        const idx = checks[step];
        const node = grid.querySelector('.room[data-idx="'+idx+'"]');
        node.classList.add('checking');
        // –∫—Ä–∞—Ç–∫–∏–π overlay
        let ov = node.querySelector('.overlay');
        if (!ov){
          ov = document.createElement('div');
          ov.className='overlay';
          node.appendChild(ov);
        }
        ov.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞...';
        // –Ω–µ–º–Ω–æ–≥–æ –∑–∞–¥–µ—Ä–∂–∏–º, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ
        await delay(CHECK_DELAY);
        // –µ—Å–ª–∏ –Ω–∞—à–ª–∏ ‚Äî –ø–æ–º–µ—Ç–∏—Ç—å –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (–∏–≥—Ä–∞ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –¥–≤—É—Ö –∫–æ–º–Ω–∞—Ç; –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—à–ª–∏ –≤ –ø–µ—Ä–≤–æ–π ‚Äî –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —à—Ç—Ä–∞—Ñ)
        if (idx === selectedRoom){
          node.classList.remove('checking');
          node.classList.add('found');
          ov.textContent = '‚ùå –ù–∞—à–ª–∏!';
          found = true;
          // –≤–∏–∑—É–∞–ª—å–Ω–æ –¥–∞—Ç—å –∑–Ω–∞—Ç—å, –∏ –ø–æ–¥–æ–∂–¥–∞—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
          await delay(600);
          // –µ—Å–ª–∏ –Ω–∞—à–ª–∏ –≤ –ø–µ—Ä–≤–æ–π ‚Äî hunter –≤—Å—ë —Ä–∞–≤–Ω–æ –º–æ–≥ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤—Ç–æ—Ä—É—é, –Ω–æ –Ω–∞–º –ª–æ–≥–∏–∫–∞: –∫–∞–∫ —Ç–æ–ª—å–∫–æ –Ω–∞–π–¥–µ–Ω ‚Äî –∏–≥—Ä–æ–∫ —Ç–µ—Ä—è–µ—Ç –º–æ–Ω–µ—Ç—ã.
          // –û—Å—Ç–∞–Ω–æ–≤–∏–º –¥–∞–ª—å–Ω–µ–π—à–µ–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ, –Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏–º –≤—Ç–æ—Ä—É—é –±—ã—Å—Ç—Ä–æ
          break;
        } else {
          node.classList.remove('checking');
          node.classList.add('safe');
          ov.textContent = '‚úÖ –ù–µ –∑–¥–µ—Å—å';
          await delay(300);
        }
      }

      // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ, –Ω—É–∂–Ω–æ –µ—â—ë –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ç–æ—Ä—É—é (–µ—Å–ª–∏ –Ω–∞—à–ª–∏ –≤ –ø–µ—Ä–≤–æ–π ‚Äî –º—ã —É–∂–µ –Ω–∞—à–ª–∏ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏)
      if (!found){
        // –µ—Å–ª–∏ checks[0] –±—ã–ª –Ω–µ —Ä–∞–≤–µ–Ω selectedRoom –∏ –º—ã –Ω–µ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ found, –∏ checks[1] == selectedRoom ‚Äî –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
        if (checks[1] === selectedRoom){
          const node = grid.querySelector('.room[data-idx="'+checks[1]+'"]');
          // –ø–æ–¥—á—ë—Ä–∫–Ω—É—Ç—å –∫–∞–∫ –Ω–∞–π–¥–µ–Ω–æ
          node.classList.add('found');
          const ov = node.querySelector('.overlay') ?? (()=>{const o=document.createElement('div');o.className='overlay';node.appendChild(o);return o;})();
          ov.textContent = '‚ùå –ù–∞—à–ª–∏!';
          found = true;
        }
      }

      // –∏—Ç–æ–≥
      if (found){
        coins -= PENALTY;
        log(–û—Ö–æ—Ç–Ω–∏–∫ –Ω–∞—à—ë–ª —Ç–µ–±—è ‚Äî ${PENALTY} –º–æ–Ω–µ—Ç —Å–ø–∏—Å–∞–Ω–æ.);
      } else {
        coins += REWARD;
        log(–û—Ö–æ—Ç–Ω–∏–∫ –Ω–µ –Ω–∞—à—ë–ª ‚Äî –ø–æ–ª—É—á–µ–Ω–æ +${REWARD} –º–æ–Ω–µ—Ç.);
      }
      saveCoins();
      updateCoinsUI();

      // –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–µ—â—ë"
      againBtn.style.display='inline-block';
      startBtn.disabled = false;
      resetBtn.disabled = false;
      busy = false;

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ bot (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –∏–∑ Telegram)
      if (tg){
        try{
          // Telegram.WebApp.sendData –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ –±–æ—Ç–∞ (update). –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ª–æ–≥–∏–∫–∏ —É –±–æ—Ç–∞.
          const payload = {
            action:'round_result',
            found: found,
            checked: checks,
            chosen: selectedRoom,
            coins: coins,
            timestamp: Date.now()
          };
          tg.sendData(JSON.stringify(payload));
        }catch(e){
          console.warn('Telegram sendData error', e);
        }
      }
    }

    function resetHighlights(){
      const all = grid.querySelectorAll('.room');
      all.forEach(n=>{
        n.classList.remove('checking','found','safe','selected');
        const ov = n.querySelector('.overlay');
        if (ov) ov.remove();
      });
      // –µ—Å–ª–∏ –±—ã–ª –≤—ã–±—Ä–∞–Ω room ‚Äî –≤–∏–∑—É–∞–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å selection
      if (selectedRoom !== null){
        const sel = grid.querySelector('.room[data-idx="'+selectedRoom+'"]');
        if (sel) sel.classList.add('selected');
      }
      updateCoinsUI();
    }

    function log(text){
      logEl.textContent = text;
    }

    // –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ logo ‚Äî –±—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –º–æ–Ω–µ—Ç (–¥–ª—è —Ç–µ—Å—Ç–∞)
    // (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤ —Ä–µ–ª–∏–∑–µ)
    coinsVal.addEventListener('dblclick', ()=>{
      coins += 1000; saveCoins(); updateCoinsUI(); log('–¢–µ—Å—Ç: +1000 –º–æ–Ω–µ—Ç (–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫).');
    });

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã–±–æ—Ä–∞ –∫–æ–º–Ω–∞—Ç –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Ä–∞—É–Ω–¥–∞
    document.addEventListener('visibilitychange', ()=> {
      // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–≤–µ—Ä–Ω—É–ª ‚Äî –Ω–∏—á–µ–≥–æ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ, –Ω–æ –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      saveCoins();
    });
  </script>
</body>
</html>
