<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hide & Seek — Premium Emoji (Gray Theme)</title>
  <style>
:root{
  /* Цветовая схема: серый / светло-серый, белые шрифты, зелёный для прибыли */
  --bg-from: #2f3438;      /* тёмно-серый фон */
  --bg-to:   #bfc4c6;      /* светло-серый фон */
  --container-from: #3b3f42;
  --container-to:   #dfe2e3;
  --muted: #9aa0a3;       /* muted text */
  --text: #ffffff;        /* основной цвет текста */
  --profit-green: #39b54a;
  --accent-gradient-a: #6aa84f; /* мягкий зелёный акцент */
  --accent-gradient-b: #9fd17b;
  --card-shadow: rgba(0,0,0,0.22);
  --glass: rgba(255,255,255,0.03);
}

/* Базовая страница */
html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(120deg,var(--bg-from),var(--bg-to));background-size:200% 200%;animation:gradientBG 18s ease infinite;color:var(--text);overflow:hidden}
@keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
body{display:flex;flex-direction:column;align-items:center;min-height:100vh}

/* Header */
header{width:95%;margin:15px 0;display:flex;justify-content:space-between;align-items:center;background:transparent;border-radius:12px;padding:10px;}

/* Энергия в левом верхнем углу */
.energy-panel{
  display:flex;
  align-items:center;
  gap:8px;
  background:linear-gradient(180deg,var(--container-from),var(--container-to));
  padding:8px 12px;
  border-radius:12px;
  box-shadow:0 8px 30px var(--card-shadow);
  min-width:140px;
  max-width:260px;
  font-weight:800;
  color:var(--text);
}
.energy-panel .icon{font-size:18px;margin-right:6px}
.energy-panel .val{font-size:16px;color:var(--accent-gradient-a);line-height:1}
.energy-panel .timer{font-size:12px;color:var(--muted);line-height:1}

/* Баланс — отдельный контейнер (справа, уменьшен) */
.coin-panel{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,var(--container-from),#ececec);padding:6px 10px;border-radius:12px;box-shadow:0 8px 30px var(--card-shadow);margin-left:auto;min-width:120px;max-width:240px;justify-content:flex-end;color:var(--text)}
.coin-logo, .ton-logo{display:inline-flex;align-items:center;justify-content:center;border-radius:50%;overflow:hidden;flex:0 0 auto}
.coin-logo{width:36px;height:36px;border:2px solid rgba(0,0,0,0.12);background:#fff}
.coin-logo img{width:100%;height:100%;object-fit:cover;display:block}
.coin-panel .val{font-weight:800;font-size:14px;color:var(--text);line-height:1}
.ton-panel{display:flex;align-items:center;gap:8px;padding:4px 8px;border-radius:10px;background:transparent;margin-left:6px}
.ton-logo{width:30px;height:30px;border:2px solid rgba(0,0,0,0.08);background:#fff}
.ton-logo img{width:100%;height:100%;object-fit:cover;display:block}
.ton-val{font-weight:800;font-size:12px;color:var(--muted);line-height:1}

/* Дом: сетка комнат */
.house{position:relative;width:95%;max-width:520px;margin:20px 0;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(4,1fr);gap:12px}
.room{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
  border-radius:12px;
  display:flex;align-items:center;justify-content:center;font-weight:800;font-size:26px;color:var(--text);cursor:pointer;transition:transform .28s,box-shadow .28s;position:relative;border:1px solid rgba(0,0,0,0.12);
  box-shadow:0 10px 40px rgba(0,0,0,0.25);
}
.room:hover{transform:translateY(-6px)}
.room.selected{outline:3px solid rgba(89,89,89,0.5)}
.room.found{border-color:#c94b4b;box-shadow:0 0 12px rgba(201,75,75,0.22);animation:foundAnim 1s ease}
.room.safe{border-color:var(--profit-green);box-shadow:0 0 12px rgba(57,181,74,0.16);animation:safeAnim .8s ease}
.room.highlight{box-shadow:0 0 18px 4px rgba(89,89,89,0.12);transition:box-shadow .2s}
@keyframes foundAnim{0%{transform:scale(1)}50%{transform:rotate(6deg) scale(1.08)}100%{transform:scale(1)}}
@keyframes safeAnim{0%{transform:scale(1)}50%{transform:rotate(-6deg) scale(0.98)}100%{transform:scale(1)}}

/* Контролы */
.controls{width:90%;display:flex;justify-content:space-between;margin-bottom:15px}
button{flex:1;margin:0 5px;padding:12px;font-size:18px;border:none;border-radius:12px;cursor:pointer;color:#fff;background:linear-gradient(90deg,var(--accent-gradient-a),var(--accent-gradient-b));box-shadow:0 8px 30px rgba(0,0,0,0.25);transition:transform .16s}
button:active{transform:scale(.98);box-shadow:0 6px 18px rgba(0,0,0,0.2)}
button.secondary{background:linear-gradient(180deg,rgba(0,0,0,0.18),rgba(255,255,255,0.02));color:var(--text);border:1px solid rgba(0,0,0,0.08);box-shadow:0 6px 18px rgba(0,0,0,0.18)}

/* Нижнее меню */
.bottom-menu{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);Width:90%;max-width:520px;display:flex;justify-content:space-around;gap:8px;background:linear-gradient(180deg,var(--container-from),var(--container-to));padding:8px 10px;border-radius:14px;box-shadow:0 12px 40px var(--card-shadow)}
.bottom-menu button{background:transparent;color:var(--text);font-size:20px;transition:transform .16s}
.bottom-menu button:hover{transform:scale(1.08);color:var(--accent-gradient-a)}

/* Апгрейды */
.upgrade-panel{display:flex;gap:12px;margin:10px 0;overflow-x:auto;padding:12px 10px;width:95%;justify-content:flex-start;align-items:stretch}
.upgrade{flex:0 0 auto;background:linear-gradient(180deg,#4a4c4e,#e9ebec);color:var(--text);padding:14px;border-radius:12px;text-align:left;min-width:220px;cursor:pointer;box-shadow:0 10px 30px var(--card-shadow);border:1px solid rgba(0,0,0,0.08);transition:transform .16s}
.upgrade:hover{transform:translateY(-6px)}
.upgrade h3{margin:0 0 8px;font-size:15px;color:var(--text)}
.upgrade p{margin:0;font-size:13px;color:var(--muted)}
.upgrade .price{margin-top:10px;font-weight:800;color:var(--text);font-size:15px}
.upgrade .badge{display:inline-block;margin-top:8px;padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.12);font-weight:700;color:var(--text);font-size:12px}

/* Mining info */
.mining-info{margin:10px 0;padding:10px 12px;background:linear-gradient(180deg,var(--container-from),var(--container-to));border-radius:12px;width:95%;text-align:center;box-shadow:0 8px 30px var(--card-shadow);color:var(--text)}
.mining-info .profit { color: var(--profit-green); font-weight:900; }

/* Модальные панели (магазин, инфо, профиль) — светло-серые карточки с градиентом */
#miningShop, #infoWindow, #profileWindow{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:900;padding:28px;box-sizing:border-box;overflow-y:auto;
  background:linear-gradient(120deg,var(--bg-from),var(--bg-to));
  color:var(--text);
}
#miningShop .miners-container, #infoWindow .content, #profileWindow .content{
  max-width:1100px;margin:24px auto;border-radius:12px;padding:18px;background:linear-gradient(180deg,var(--container-from),var(--container-to));color:var(--text);box-shadow:0 12px 40px var(--card-shadow);border:1px solid rgba(0,0,0,0.06)
}
#miningShop h2{color:var(--text);text-align:center;margin-bottom:10px}

/* Rewards modal (keeps neutral gray look with gradient) */
#wsModalOverlay{ --wm-accentA:var(--bg-from); --wm-accentB:var(--bg-to); z-index:10000; position:fixed; inset:0; display:flex; align-items:flex-start; justify-content:center; font-family:Inter,system-ui,Arial,sans-serif; }
#wsModalOverlay .bgLayer{ position:absolute; inset:0; background:linear-gradient(120deg,var(--wm-accentA),var(--wm-accentB)); display:block; overflow:hidden; }
#wsModalOverlay .glass{ position:relative; width:100%; max-width:980px; margin:0 auto; box-sizing:border-box; padding:18px; border-radius:18px 18px 0 0; backdrop-filter: blur(6px); background:linear-gradient(180deg,var(--container-from),var(--container-to)); box-shadow: 0 -12px 40px var(--card-shadow); display:flex; flex-direction:column; gap:12px; overflow:hidden; color:var(--text) }

/* Reward cards adjusted to gray scheme */
.rewardCard{ background:linear-gradient(180deg,#4b4d4f,#e6e7e8); color:var(--text); border-radius:12px; padding:12px; min-height:86px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; transition:transform .12s ease, box-shadow .12s ease; cursor:pointer; border:1px solid rgba(0,0,0,0.06); }
.rewardCard .amount{ font-weight:900; font-size:16px; color:var(--profit-green); text-shadow:none; }

/* Casino modal — теперь фон в стиле главного экрана и НЕ прозрачный */
.casino-modal{display:none;position:fixed;inset:0;z-index:11000;align-items:center;justify-content:center;background:linear-gradient(120deg,var(--bg-from),var(--bg-to));padding:20px;box-sizing:border-box}
.casino-modal .card{width:100%;max-width:820px;background:linear-gradient(180deg,var(--container-from),var(--container-to));border-radius:12px;padding:18px;box-shadow:0 20px 60px var(--card-shadow);border:1px solid rgba(0,0,0,0.06);display:flex;gap:12px;flex-direction:column;color:var(--text)}
.casino-header{display:flex;justify-content:space-between;align-items:center;color:var(--text)}
.casino-note{color:var(--muted);font-weight:700}
.casino-result{font-weight:900;color:var(--profit-green);font-size:18px}

/* Responsive tweaks */
@media (max-width:720px){
  .house{max-width:420px}
  .coin-logo{width:32px;height:32px}
  .ton-logo{width:28px;height:28px}
  .energy-panel{min-width:120px}
  .rewardsContainer{ max-height: calc(60vh - 90px); }
  .rewardsGridTop{ grid-template-columns:repeat(2,1fr); }
  .rewardsGridBottom{ grid-template-columns:repeat(2,1fr); }
}
  </style>
</head>
<body>
  <header>
    <!-- Энергия — верхний левый угол -->
    <div class="energy-panel" id="energyPanel" aria-live="polite" aria-atomic="true">
      <div class="icon">⚡</div>
      <div style="display:flex;flex-direction:column;align-items:flex-start;">
        <div style="font-size:11px;color:var(--muted);font-weight:800">Energy</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="val" id="energyVal">50</div>
          <div class="timer" id="energyTimer">—</div>
        </div>
      </div>
    </div>

    <!-- coin-panel -->
    <div class="coin-panel" aria-live="polite" aria-atomic="true">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="coin-logo" title="ZEX">
          <img src="logo.png" alt="ZEX logo" />
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;line-height:1;">
          <div style="font-size:11px;color:var(--muted);font-weight:800">ZEX</div>
          <div class="val" id="coinsVal">0</div>
        </div>
      </div>
       <div class="ton-panel" style="margin-left:8px;">
        <div class="ton-logo" title="TON">
          <img src="ton.png" alt="TON logo" />
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;line-height:1;">
          <div style="font-size:11px;color:var(--muted);font-weight:800">TON</div>
          <div class="ton-val" id="tonVal">0</div>
        </div>
      </div>
    </div>
  </header>

  <div class="house" aria-hidden="false"></div>

  <div class="controls">
    <button id="startBtn">🏠</button>
    <button class="secondary" id="resetBtn">🔍</button>
  </div>

  <!-- Апгрейды -->
  <div class="upgrade-panel" id="upgradePanel">
    <div class="upgrade" data-key="x2Prize" data-base-price="20000">
      <h3>x2 Prize / x2 Loss</h3>
      <p>Double rewards & penalties</p>
      <div class="price">20,000</div>
      <div class="badge">Boost</div>
    </div>
    <div class="upgrade" data-key="check1" data-base-price="20000">
      <h3>Check 1 Room Only</h3>
      <p>Hunter checks 1 room only (1 min)</p>
      <div class="price">20,000</div>
      <div class="timer" id="check1Timer"></div>
    </div>

    <div class="upgrade" data-key="shield" data-base-price="25000">
      <h3>Shield (1m)</h3>
      <p>Protects you from loss for 1 minute</p>
      <div class="price">25,000</div>
      <div class="timer" id="shieldTimer"></div>
      <div class="badge">Defence</div>
    </div>

    <div class="upgrade" data-key="incBoost" data-base-price="30000">
      <h3>Double Income (1m)</h3>
      <p>Mining income ×2 for 1 minute</p>
      <div class="price">30,000</div>
      <div class="timer" id="incTimer"></div>
      <div class="badge">Income</div>
    </div>

    <div class="upgrade" data-key="luck" data-base-price="22000">
      <h3>Lucky Escape (1m)</h3>
      <p>50% chance to evade if hunted (1 minute)</p>
      <div class="price">22,000</div>
      <div class="timer" id="luckTimer"></div>
      <div class="badge">Chance</div>
    </div>
  </div>

  <div class="mining-info">
    <strong id="miningLabel">Mining Income:</strong> <span id="miningIncomeVal" class="profit">0</span>/hr
  </div>

  <div class="miners-panel" id="minersPanelVisible" aria-hidden="true"></div>

  <!-- Modal mining shop -->
  <div id="miningShop" aria-hidden="true">
    <div class="miners-container"></div>
    <button id="closeMiningShop" style="margin-top:12px;width:100%;padding:12px;font-size:18px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--accent-gradient-a),var(--accent-gradient-b));color:#fff;cursor:pointer;font-weight:700;">Close</button>
  </div>

  <!-- Buy confirm -->
  <div id="buyConfirm" aria-hidden="true" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000">
    <div style="max-width:520px;margin:0;background:linear-gradient(180deg,var(--container-from),var(--container-to));border-radius:12px;padding:14px;text-align:center;box-shadow:0 12px 40px var(--card-shadow);border:1px solid rgba(0,0,0,0.06)">
      <p id="buyText" style="color:var(--text)"></p>
      <div style="display:flex;justify-content:center;">
        <button id="confirmBuy" style="margin:6px 6px;padding:8px 12px;font-weight:700;background:linear-gradient(90deg,var(--accent-gradient-a),var(--accent-gradient-b));color:#fff;border:none;border-radius:8px">Buy</button>
        <button id="cancelBuy" style="margin:6px 6px;padding:8px 12px;font-weight:700;background:transparent;color:var(--text);border:1px solid rgba(0,0,0,0.08);border-radius:8px">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Info window -->
  <div id="infoWindow" aria-hidden="true">
    <div class="content">
      <h2 id="infoTitle">How to Play</h2>
      <ul id="infoList">
        <li>Select a room, then press 🔍 to hunt.</li>
        <li>The hunter searches 2 random rooms (1 if "Check 1 Room" is active).</li>
        <li>If your room is found, you lose coins (shown red).</li>
        <li>If you evade, you gain coins (green).</li>
        <li>Buy upgrades or miners to improve chances and income.</li>
        <li>Claim daily rewards and quests for bonuses.</li>
      </ul>
      <button id="closeInfo" style="margin-top:12px;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent-gradient-a),var(--accent-gradient-b));color:#fff">Close</button>
    </div>
  </div>

  <!-- Profile window -->
  <div id="profileWindow" aria-hidden="true">
    <div class="content">
      <h2 id="profileTitle">Profile</h2>
      <div style="margin-bottom:16px;padding:16px;border-radius:12px;background:linear-gradient(180deg,#4b4d4f,#e6e7e8);color:var(--text)">
        <h3 id="dailyTitle" style="margin-bottom:8px;font-size:18px;color:var(--text)">Daily Reward</h3>
        <p id="dailyText" style="margin-bottom:12px;color:var(--text)">Get 30,000 coins once a day!</p>
        <button id="claimDaily" style="width:100%;padding:12px;font-size:16px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--accent-gradient-a),var(--accent-gradient-b));color:#fff;cursor:pointer;font-weight:700;">Claim Daily</button>
        <p id="dailyStatus" style="margin-top:8px;color:var(--muted);font-weight:600;text-align:center;"></p>
      </div>
      <div style="margin-bottom:16px;padding:16px;border-radius:12px;background:linear-gradient(180deg,#4b4d4f,#e6e7e8);color:var(--text)">
        <h3 id="questTitle" style="margin-bottom:8px;font-size:18px;color:var(--text)">Quest</h3>
        <p id="questText" style="margin-bottom:12px;color:var(--text)">Subscribe to get bonus coins!</p>
        <button id="claimQuest" style="width:100%;padding:12px;font-size:16px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--accent-gradient-a),var(--accent-gradient-b));color:#fff;cursor:pointer;font-weight:700;">Claim Quest</button>
        <p id="questStatus" style="margin-top:8px;color:var(--muted);font-weight:600;text-align:center;"></p>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <h3 id="settingsTitle" style="margin:0;color:var(--text)">Settings</h3>
          <p id="settingsText" style="margin:0;color:var(--muted)">Change language and other preferences.</p>
        </div>
        <div>
          <select id="langSelect" class="select-lang" style="padding:8px;border-radius:8px;border:none;font-weight:700">
            <option value="ru">Русский</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>

      <button id="closeProfile" style="width:100%;padding:14px;margin-top:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent-gradient-a),var(--accent-gradient-b));color:#fff;cursor:pointer;font-weight:700;">Close</button>
    </div>
  </div>

  <div class="bottom-menu">
    <button id="infoBtn" class="secondary">ℹ</button>
    <button id="shopBtn" class="secondary">🛒</button>
    <button id="miningBtn" class="secondary">⛏</button>
    <button id="profileBtn" class="secondary">👤</button>
    <button id="casinoBtn" class="secondary" title="Casino">🎰</button>
  </div>

<script>
/* ==========================
  JS — сохранена логика, только стили изменены
   ========================== */

/* ========== Локализация ========== */
const i18n = {
  ru: {
    pickRoomFirst: 'Сначала выберите комнату!',
    notEnough: 'Недостаточно монет!',
    dailyAlready: 'Ежедневная награда уже получена!',
    questAlready: 'Квест уже выполнен!',
    miningIncome: 'Доход майнинга:',
    miningShop: 'Магазин майнинга',
    close: 'Закрыть',
    howToPlay: 'Как играть',
    infoList: [
      'Выберите комнату, затем нажмите кнопку 🔍 для охоты.',
      'Охотник ищет 2 случайные комнаты (1, если активен "Check 1 Room").',
      'Если вашу комнату нашли, вы теряете монеты (показываются красным).',
      'Если вы избежали охоты, вы получаете монеты (показываются зеленым).',
      'Покупайте апгрейды или майнеров, чтобы улучшить шансы и доход.',
      'Забирайте ежедневные награды и выполняйте квесты для бонусных монет.'
    ],
    profile: 'Профиль',
    dailyReward: 'Ежедневная награда',
    dailyText: 'Получите 30 000 монет раз в день!',
    claimDaily: 'Забрать',
    quest: 'Квест',
    claimQuest: 'Взять',
    settings: 'Настройки',
    settingsText: 'Смените язык и другие параметры.',
    buyFor: 'Купить {name} за {price}?',
    buy: 'Купить',
    cancel: 'Отмена',
    profitHr: 'Прибыль/ч:',
    noEnergy: 'Нет энергии!'
  },
  en: {
    pickRoomFirst: 'Pick a room first!',
    notEnough: 'Not enough coins!',
    dailyAlready: 'Daily reward already claimed!',
    questAlready: 'Quest already claimed!',
    miningIncome: 'Mining Income:',
    miningShop: 'Mining Shop',
    close: 'Close',
    howToPlay: 'How to Play',
    infoList: [
      'Select a room and then click the 🔍 button to hunt.',
      'The hunter searches 2 random rooms (1 if "Check 1 Room" is active).',
      'If your room is found, you lose coins (shown in red).',
      'If you evade the hunt, you gain coins (shown in green).',
      'Buy upgrades or miners to improve your chances and income.',
      'Claim daily rewards and complete quests for bonus coins.'
    ],
    profile: 'Profile',
    dailyReward: 'Daily Reward',
    dailyText: 'Get 30,000 coins once a day!',
    claimDaily: 'Claim Daily',
    quest: 'Quest',
    claimQuest: 'Claim Quest',
    settings: 'Settings',
    settingsText: 'Change language and other preferences.',
    buyFor: 'Buy {name} for {price}?',
    buy: 'Buy',
    cancel: 'Cancel',
    profitHr: 'Profit/hr:',
    noEnergy: 'No energy!'
  }
};
let lang = localStorage.getItem('lang') || 'ru';
function t(key, vars = {}) {
  const val = i18n[lang][key];
  if (typeof val === 'string') {
    return val.replace(/\{(\w+)\}/g, (_, k) => vars[k] || '');
  }
  return val;
}
function applyLang() {
  document.getElementById('miningLabel').textContent = t('miningIncome');
  document.getElementById('shopTitle')?.textContent = t('miningShop');
  document.getElementById('closeMiningShop')?.textContent = t('close');
  document.getElementById('confirmBuy')?.textContent = t('buy');
  document.getElementById('cancelBuy')?.textContent = t('cancel');
  document.getElementById('infoTitle').textContent = t('howToPlay');
  document.getElementById('profileTitle').textContent = t('profile');
  document.getElementById('dailyTitle').textContent = t('dailyReward');
  document.getElementById('dailyText').textContent = t('dailyText');
  document.getElementById('claimDaily').textContent = t('claimDaily');
  document.getElementById('questTitle').textContent = t('quest');
  document.getElementById('claimQuest').textContent = t('claimQuest');
  document.getElementById('settingsTitle').textContent = t('settings');
  document.getElementById('settingsText').textContent = t('settingsText');
  document.getElementById('closeInfo').textContent = t('close');

  const infoListEl = document.getElementById('infoList');
  infoListEl.innerHTML = '';
  t('infoList').forEach(li => { const el = document.createElement('li'); el.textContent = li; infoListEl.appendChild(el); });
}

/* ========== Energy system ========== */
const MAX_ENERGY = 50;
const REGEN_INTERVAL_MS = 30 * 1000; // 30 секунд
const LS_ENERGY = 'player_energy_v1';
const LS_ENERGY_TICK = 'player_energy_tick_v1';

let energy;
let energyLastTick;
(function initEnergyStorage(){
  const raw = localStorage.getItem(LS_ENERGY);
  if (raw === null) {
    energy = MAX_ENERGY;
    energyLastTick = Date.now();
    try {
      localStorage.setItem(LS_ENERGY, String(energy));
      localStorage.setItem(LS_ENERGY_TICK, String(energyLastTick));
    } catch(e){}
  } else {
    energy = +raw;
    if (!Number.isFinite(energy)) energy = MAX_ENERGY;
    energyLastTick = +localStorage.getItem(LS_ENERGY_TICK) || Date.now();
  }
  if (energy >= MAX_ENERGY) energyLastTick = Date.now();
  try {
    localStorage.setItem(LS_ENERGY, String(energy));
    localStorage.setItem(LS_ENERGY_TICK, String(energyLastTick));
  } catch(e){}
})();

function loadEnergy() {
  const stored = localStorage.getItem(LS_ENERGY);
  const storedTick = localStorage.getItem(LS_ENERGY_TICK);
  if (stored !== null) energy = +stored;
  if (!Number.isFinite(energy)) energy = MAX_ENERGY;
  energyLastTick = +storedTick || Date.now();

  const now = Date.now();
  if (now > energyLastTick && energy < MAX_ENERGY) {
    const delta = now - energyLastTick;
    const gained = Math.floor(delta / REGEN_INTERVAL_MS);
    if (gained > 0) {
      energy = Math.min(MAX_ENERGY, energy + gained);
      energyLastTick += gained * REGEN_INTERVAL_MS;
    }
  }
  if (energy >= MAX_ENERGY) energyLastTick = Date.now();
  saveEnergy();
  updateEnergyDisplay();
}

function saveEnergy() {
  try {
    localStorage.setItem(LS_ENERGY, String(energy));
    localStorage.setItem(LS_ENERGY_TICK, String(energyLastTick));
  } catch (e) { /* ignore */ }
}

function updateEnergyDisplay() {
  const el = document.getElementById('energyVal');
  const timerEl = document.getElementById('energyTimer');
  if (el) el.textContent = String(energy);
  if (timerEl) {
    if (energy >= MAX_ENERGY) {
      timerEl.textContent = 'Full';
    } else {
      const now = Date.now();
      const delta = now - (energyLastTick || now);
      const rem = REGEN_INTERVAL_MS - (delta % REGEN_INTERVAL_MS);
      const secs = Math.ceil(rem / 1000);
      const mm = Math.floor(secs / 60);
      const ss = secs % 60;
      timerEl.textContent = `${mm>0?mm+'m ':''}${ss}s`;
    }
  }
}

function consumeEnergyOne() {
  const now = Date.now();
  if (now > energyLastTick && energy < MAX_ENERGY) {
    const delta = now - energyLastTick;
    const gained = Math.floor(delta / REGEN_INTERVAL_MS);
    if (gained > 0) {
      energy = Math.min(MAX_ENERGY, energy + gained);
      energyLastTick += gained * REGEN_INTERVAL_MS;
    }
  }
  if (energy <= 0) {
    alert(t('noEnergy'));
    return false;
  }
  energy = Math.max(0, energy - 1);
  if (energy < MAX_ENERGY && (!energyLastTick || energyLastTick < Date.now() - 24*3600*1000)) energyLastTick = Date.now();
  saveEnergy();
  updateEnergyDisplay();
  return true;
}

setInterval(()=> {
  const now = Date.now();
  if (energy >= MAX_ENERGY) {
    energyLastTick = now;
    saveEnergy();
    updateEnergyDisplay();
    return;
  }
  if (now - energyLastTick >= REGEN_INTERVAL_MS) {
    const gained = Math.floor((now - energyLastTick) / REGEN_INTERVAL_MS);
    if (gained > 0) {
      energy = Math.min(MAX_ENERGY, energy + gained);
      energyLastTick += gained * REGEN_INTERVAL_MS;
      if (energy >= MAX_ENERGY) energyLastTick = now;
      saveEnergy();
      updateEnergyDisplay();
    }
  } else {
    updateEnergyDisplay();
  }
}, 1000);

/* ========== Инициализация UI и состояния ========== */
const roomsContainer = document.querySelector('.house');
for (let i = 0; i < 8; i++) {
  const d = document.createElement('div');
  d.className = 'room';
  d.dataset.idx = i;
  d.textContent = '+';
  roomsContainer.appendChild(d);
}
let selectedRoom = null;
let coins = +localStorage.getItem('coins') || 0;
let maxCoins = +localStorage.getItem('maxCoins') || coins;
const coinsVal = document.getElementById('coinsVal');
let upgrades = JSON.parse(localStorage.getItem('upgrades')) || { x2Prize: 0, check1: 0 };
let check1Expire = +localStorage.getItem('check1Expire') || 0;
let roundInProgress = false;

let shieldExpire = +localStorage.getItem('shieldExpire') || 0;
let doubleIncomeExpire = +localStorage.getItem('doubleIncomeExpire') || 0;
let luckExpire = +localStorage.getItem('luckExpire') || 0;

const minersData = [
  { n: "Miner 1", i: 500, p: 7000 },
  { n: "Miner 2", i: 1788, p: 12000 },
  { n: "Miner 3", i: 2358, p: 15000 },
  { n: "Miner 4", i: 3000, p: 20000 },
  { n: "Miner 5", i: 4500, p: 25000 },
  { n: "Miner 6", i: 5200, p: 30000 },
  { n: "Miner 7", i: 6100, p: 35000 },
  { n: "Miner 8", i: 7200, p: 40000 },
  { n: "Miner 9", i: 8500, p: 45000 },
  { n: "Miner 10", i: 9500, p: 50000 }
];

let minersState;
try {
  const saved = JSON.parse(localStorage.getItem('minersState'));
  if (Array.isArray(saved)) {
    minersState = minersData.map((_, i) => {
      const s = saved[i];
      if (s && typeof s.count === 'number') return { count: s.count };
      return { count: 0 };
    });
  } else {
    minersState = minersData.map(_ => ({ count: 0 }));
  }
} catch (e) {
  minersState = minersData.map(_ => ({ count: 0 }));
}

const miningIncomeValEl = document.getElementById('miningIncomeVal');
const minersContainerEl = document.querySelector('.miners-container');
const minersPanelVisible = document.getElementById('minersPanelVisible');
const miningShop = document.getElementById('miningShop');
const buyConfirm = document.getElementById('buyConfirm');
const buyText = document.getElementById('buyText');
let pendingMiner = null;

function format(n) {
  return n >= 1e9 ? (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B' :
         n >= 1e6 ? (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M' :
         n >= 1e3 ? (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K' : String(n);
}

/* Конверсия: 1000 ZEX = 0.002 TON => коэффициент 0.000002 */
const ZEX_TO_TON = 0.000002;
function formatTon(n){
  if (!isFinite(n)) return '0';
  if (n === 0) return '0';
  if (n < 0.000001) return '<0.000001';
  return Number(n.toFixed(6)).toString();
}

function save() {
  try {
    localStorage.setItem('coins', coins);
    localStorage.setItem('maxCoins', maxCoins);
    localStorage.setItem('upgrades', JSON.stringify(upgrades));
    localStorage.setItem('check1Expire', check1Expire);
    localStorage.setItem('minersState', JSON.stringify(minersState));
    localStorage.setItem('lastTime', Date.now());
    localStorage.setItem('lang', lang);
    localStorage.setItem('shieldExpire', shieldExpire);
    localStorage.setItem('doubleIncomeExpire', doubleIncomeExpire);
    localStorage.setItem('luckExpire', luckExpire);
  } catch (e) {
    console.warn('Save failed', e);
  }
}

function updateBalancesDisplay(){
  coinsVal.textContent = format(coins);
  const ton = coins * ZEX_TO_TON;
  const tonEl = document.getElementById('tonVal');
  if (tonEl) tonEl.textContent = formatTon(ton);
  const wsZex = document.getElementById('wsModalCoinsDisplay');
  if (wsZex) wsZex.textContent = format(coins) + ' ZEX • ' + formatTon(ton);
  const casinoBalance = document.getElementById('casinoBalance');
  if (casinoBalance) casinoBalance.textContent = format(coins) + ' ZEX • ' + formatTon(ton);
}

function updCoins(v = 0) {
  coins += v;
  if (coins < 0) coins = 0;
  if (coins > maxCoins) maxCoins = coins;
  updateBalancesDisplay();
  updUpg();
  updIncome();
  save();
}

function getIncome() {
  const base = minersState.reduce((sum, m, i) => {
    const count = (m && typeof m.count === 'number') ? m.count : 0;
    return sum + (count > 0 ? Math.floor(minersData[i].i * Math.pow(1.5, count - 1)) : 0);
  }, 0);
  if (doubleIncomeExpire > Date.now()) return base * 2;
  return base;
}
function updIncome() { if (miningIncomeValEl) miningIncomeValEl.textContent = format(getIncome()); }

function addOfflineCoins() {
  const last = +localStorage.getItem('lastTime') || Date.now();
  const now = Date.now();
  const diffMinutes = (now - last) / 60000;
  if (diffMinutes > 0) {
    const minutesToAward = Math.min(diffMinutes, 180);
    updCoins(Math.floor(getIncome()/60 * minutesToAward));
  }
  localStorage.setItem('lastTime', now);
}
addOfflineCoins();

setInterval(()=>{ updCoins(Math.floor(getIncome()/3600)); }, 1000);

function updUpg() {
  document.querySelectorAll('.upgrade').forEach(u => {
    let key = u.dataset.key; let base = +u.dataset.basePrice; let count = upgrades[key] || 0;
    let price = base * Math.pow(2,count);
    let priceEl = u.querySelector('.price'); if (priceEl) priceEl.textContent = format(price);
    const badge = u.querySelector('.badge'); if (badge) badge.textContent = count > 0 ? `Lvl ${count}` : 'New';
  });
}

document.querySelectorAll('.upgrade').forEach(u=>{
  u.onclick = ()=>{
    let key = u.dataset.key; let base = +u.dataset.basePrice; let count = upgrades[key]||0;
    let price = base * Math.pow(2,count);
    if (coins >= price) {
      upgrades[key] = count+1; updCoins(-price);
      if (key === 'check1') check1Expire = Date.now()+60000;
      if (key === 'shield') shieldExpire = Date.now()+60000;
      if (key === 'incBoost') doubleIncomeExpire = Date.now()+60000;
      if (key === 'luck') luckExpire = Date.now()+60000;
      save(); updUpg();
    } else alert(t('notEnough'));
  };
});

function updTimers() {
  const el = document.getElementById('check1Timer');
  if (el) el.textContent = (check1Expire > Date.now()) ? '⏳ ' + Math.floor((check1Expire - Date.now())/1000) + 's' : '';

  const shEl = document.getElementById('shieldTimer');
  if (shEl) shEl.textContent = (shieldExpire > Date.now()) ? '⏳ ' + Math.floor((shieldExpire - Date.now())/1000) + 's' : '';

  const incEl = document.getElementById('incTimer');
  if (incEl) incEl.textContent = (doubleIncomeExpire > Date.now()) ? '⏳ ' + Math.floor((doubleIncomeExpire - Date.now())/1000) + 's' : '';

  const luckEl = document.getElementById('luckTimer');
  if (luckEl) luckEl.textContent = (luckExpire > Date.now()) ? '⏳ ' + Math.floor((luckExpire - Date.now())/1000) + 's' : '';
}
setInterval(updTimers, 1000);

document.querySelectorAll('.room').forEach(r => {
  r.onclick = () => {
    if (roundInProgress) return;
    document.querySelectorAll('.room').forEach(x=>x.classList.remove('selected'));
    r.classList.add('selected');
    selectedRoom = +r.dataset.idx;
  };
});

document.getElementById('startBtn').onclick = ()=>{
  if (selectedRoom == null) { alert(t('pickRoomFirst')); return; }
  document.querySelectorAll('.room').forEach(r=>r.classList.remove('found','safe'));
};

document.getElementById('resetBtn').onclick = ()=>{
  if (selectedRoom == null) { alert(t('pickRoomFirst')); return; }
  if (!consumeEnergyOne()) return;
  roundInProgress = true;
  const numPicks = (check1Expire > Date.now()) ? 1 : 2;
  let picks = [...Array(8).keys()].sort(()=>0.5-Math.random()).slice(0,numPicks);
  document.querySelectorAll('.room').forEach(r=>r.classList.remove('found','safe','highlight'));
  let delay = 0;
  picks.forEach(i=>{
    let room = document.querySelector(`.room[data-idx="${i}"]`);
    setTimeout(()=>{ room.classList.add('highlight'); }, delay);
    setTimeout(()=>{ room.classList.remove('highlight'); }, delay+600);
    delay += 700;
  });
  setTimeout(()=>{
    let prize = 1000, loss = -2000;
    if (upgrades.x2Prize > 0) { prize *= Math.pow(2, upgrades.x2Prize); loss *= Math.pow(2, upgrades.x2Prize); }

    const roomEl = document.querySelector(`.room[data-idx="${selectedRoom}"]`);

    if (picks.includes(selectedRoom)) {
      if (shieldExpire > Date.now()) {
        roomEl.classList.add('safe');
        updCoins(0);
      } else if (luckExpire > Date.now() && Math.random() < 0.5) {
        roomEl.classList.add('safe');
        updCoins(prize);
      } else {
        const room = document.querySelector(`.room[data-idx="${selectedRoom}"]`);
        room.classList.add('found');
        updCoins(loss);
      }
    } else {
      const room = document.querySelector(`.room[data-idx="${selectedRoom}"]`);
      room.classList.add('safe');
      updCoins(prize);
    }
    selectedRoom = null;
    document.querySelectorAll('.room').forEach(r=>r.classList.remove('selected'));
    roundInProgress = false;
  }, delay+700);
};

function renderMiners(){
  if (!minersContainerEl) return;
  minersContainerEl.innerHTML = '';
  minersData.forEach((m,i)=>{
    const st = (minersState[i] && typeof minersState[i].count === 'number') ? minersState[i] : { count: 0 };
    const price = m.p * Math.pow(2, st.count);
    const income = st.count > 0 ? Math.floor(m.i * Math.pow(1.5, st.count - 1)) : 0;

    const card = document.createElement('div'); card.className = 'miner-card';
    card.style.background = 'linear-gradient(180deg,#4b4d4f,#e6e7e8)';
    card.style.borderRadius = '12px';
    card.style.padding = '12px';
    card.style.minWidth = '140px';
    card.style.display = 'flex';
    card.style.flexDirection = 'column';
    card.style.alignItems = 'center';
    card.style.justifyContent = 'center';
    card.style.gap = '8px';
    card.innerHTML = `
      <img class="card-logo" src="logo.png" alt="logo" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid rgba(0,0,0,0.06);background:#fff" />
      <h3 style="margin:0;color:var(--text)">${m.n}</h3>
      <div class="income" style="color:var(--profit-green);font-weight:800">+${format(income)} / hr</div>
      <div class="bottom" style="width:100%;display:flex;justify-content:space-between;font-weight:800;font-size:14px;margin-top:6px">
        <span class="lvl">Lvl ${st.count}</span>
        <span class="price-pill">${format(price)}</span>
      </div>
    `;
    card.onclick = ()=>{
      const currentSt = (minersState[i] && typeof minersState[i].count === 'number') ? minersState[i] : { count: 0 };
      const currentPrice = m.p * Math.pow(2, currentSt.count);
      if (coins >= currentPrice) {
        pendingMiner = i;
        buyText.textContent = t('buyFor', { name: m.n, price: format(currentPrice) });
        buyConfirm.style.display = 'block'; buyConfirm.setAttribute('aria-hidden','false');
      } else { alert(t('notEnough')); }
    };
    minersContainerEl.appendChild(card);
  });
}

const miningBtn = document.getElementById('miningBtn');
const shopBtn = document.getElementById('shopBtn');
miningBtn.onclick = () => { miningShop.style.display = 'block'; miningShop.setAttribute('aria-hidden','false'); renderMiners(); };
shopBtn.onclick = () => { miningShop.style.display = 'block'; miningShop.setAttribute('aria-hidden','false'); renderMiners(); };
document.getElementById('closeMiningShop').onclick = ()=>{ miningShop.style.display = 'none'; miningShop.setAttribute('aria-hidden','true'); };

document.getElementById('confirmBuy').onclick = ()=>{
  if (pendingMiner === null) return;
  const i = pendingMiner; const m = minersData[i]; const st = minersState[i] || { count: 0 };
  const price = m.p * Math.pow(2, st.count);
  if (coins >= price) {
    coins -= price; minersState[i] = { count: (st.count || 0) + 1 }; updCoins(0); save(); renderMiners();
  } else alert(t('notEnough'));
  pendingMiner = null;
  buyConfirm.style.display = 'none'; buyConfirm.setAttribute('aria-hidden','true');
};
document.getElementById('cancelBuy').onclick = ()=>{ pendingMiner = null; buyConfirm.style.display = 'none'; buyConfirm.setAttribute('aria-hidden','true'); };

const profileWindowEl = document.getElementById('profileWindow');
document.getElementById('profileBtn').onclick = ()=>{ profileWindowEl.style.display = 'block'; profileWindowEl.setAttribute('aria-hidden','false'); };
document.getElementById('closeProfile').onclick = ()=>{ profileWindowEl.style.display = 'none'; profileWindowEl.setAttribute('aria-hidden','true'); };

let questClaimed = localStorage.getItem('questClaimed') === 'true';
let lastDaily = +localStorage.getItem('lastDaily') || 0;
const questStatusEl = document.getElementById('questStatus');
const dailyStatusEl = document.getElementById('dailyStatus');
function updateQuestStatus(){ if (questStatusEl) questStatusEl.textContent = questClaimed ? "✅ Completed" : "❌ Not claimed"; }
function updateDailyStatus(){ const now = Date.now(); const nextAvailable = lastDaily + 24*60*60*1000; if (now >= nextAvailable) dailyStatusEl.textContent = "💰 Available!"; else { const diff = nextAvailable - now; const hours = Math.floor(diff / (1000*60*60)); const minutes = Math.floor((diff % (1000*60*60)) / (1000*60)); dailyStatusEl.textContent = `Next in ${hours}h ${minutes}m`; } }
setInterval(updateDailyStatus, 60000); updateDailyStatus(); updateQuestStatus();

document.getElementById('claimQuest').onclick = ()=>{ if (questClaimed) alert(t('questAlready')); else { updCoins(50000); questClaimed = true; localStorage.setItem('questClaimed','true'); updateQuestStatus(); } };
document.getElementById('claimDaily').onclick = ()=>{ const now = Date.now(); if (now - lastDaily < 24*60*60*1000) alert(t('dailyAlready')); else { updCoins(30000); lastDaily = now; localStorage.setItem('lastDaily', now); updateDailyStatus(); } };

const infoWindowEl = document.getElementById('infoWindow');
document.getElementById('infoBtn').onclick = ()=>{ infoWindowEl.style.display = 'block'; infoWindowEl.setAttribute('aria-hidden','false'); };
document.getElementById('closeInfo').onclick = ()=>{ infoWindowEl.style.display = 'none'; infoWindowEl.setAttribute('aria-hidden','true'); };

const upgradePanel = document.getElementById('upgradePanel');
minersPanelVisible.style.display = 'none';
upgradePanel.style.display = 'flex';

const langSelect = document.getElementById('langSelect');
langSelect.value = lang;
langSelect.onchange = ()=>{ lang = langSelect.value; localStorage.setItem('lang', lang); applyLang(); renderMiners(); };

/* init UI */
loadEnergy();
updateBalancesDisplay();
updUpg();
updIncome();
updTimers();
renderMiners();
applyLang();

document.getElementById('infoWindow').style.display = 'none';
document.getElementById('infoWindow').setAttribute('aria-hidden','true');
document.getElementById('profileWindow').style.display = 'none';
document.getElementById('profileWindow').setAttribute('aria-hidden','true');

</script>

<!-- Rewards modal (keeps gray look) -->
<div id="wsModalOverlay" aria-hidden="false" role="dialog" aria-label="Daily rewards modal">
  <div class="bgLayer" aria-hidden="true"></div>
  <div class="glass" role="document" aria-modal="true">
    <div class="header" style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(90deg,var(--accent-gradient-a),var(--accent-gradient-b));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900">💎</div>
        <div>
          <div style="font-size:18px;font-weight:900">Premium Gifts</div>
          <div style="color:var(--muted);font-weight:700;font-size:13px">7 days of rewards — claim one per day</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:800;color:var(--profit-green);font-size:16px" id="wsModalCoinsDisplay">0 ZEX • 0 TON</div>
        <div style="font-size:12px;color:var(--muted)">Coins balance</div>
      </div>
    </div>

    <div class="rewardsShell">
      <div class="rewardsContainer" id="rewardsContainer">
        <div class="rewardsGridTop" id="rewardsGridTop" aria-hidden="false"></div>
        <div style="height:8px"></div>
        <div class="rewardsGridBottom" id="rewardsGridBottom" aria-hidden="false"></div>

        <div class="wsActions" style="margin-top:12px">
          <div class="left" style="color:var(--muted)">Unlocked: <span id="wsUnlockedCount" style="font-weight:900;color:var(--profit-green)">0</span>/7</div>
          <div style="display:flex;gap:10px">
            <button class="btnGhost" id="wsBtnRules" style="border:1px solid rgba(0,0,0,0.06);padding:10px 14px;border-radius:10px;background:transparent;color:var(--text)">How it works</button>
            <button class="btnPrimary" id="wsBtnClose" style="background:linear-gradient(90deg,var(--accent-gradient-a),var(--accent-gradient-b));padding:12px 18px;border-radius:10px;color:#fff;border:none">Come back tomorrow</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const LS_FIRST = 'ws_first_seen_v2';
  const LS_CLAIMED = 'ws_claimed_v2';
  const MAX_DAYS = 7;
  const amounts = [30000,100000,500000,1000000,3000000,6000000,10000000];

  function safeGetJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      const v = JSON.parse(raw);
      return v;
    }catch(e){ return fallback; }
  }
  function safeSetJSON(key, obj){
    try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
  }

  let firstSeen = +localStorage.getItem(LS_FIRST) || 0;
  if(!firstSeen || isNaN(firstSeen)){
    firstSeen = Date.now();
    try{ localStorage.setItem(LS_FIRST, String(firstSeen)); }catch(e){}
  }

  let claimed = safeGetJSON(LS_CLAIMED, null);
  if(!Array.isArray(claimed) || claimed.length !== MAX_DAYS){
    claimed = new Array(MAX_DAYS).fill(false);
    safeSetJSON(LS_CLAIMED, claimed);
  }

  function daysSinceFirst(){
    const now = Date.now();
    const diffDays = Math.floor((now - firstSeen) / (24*60*60*1000));
    return diffDays;
  }
  function availableCount(){
    return Math.min(MAX_DAYS, daysSinceFirst() + 1);
  }

  const _orig_claim = window.claimRewardFromModal instanceof Function ? window.claimRewardFromModal : null;
  const _orig_upd = window.updCoins instanceof Function ? window.updCoins : null;
  const _orig_save = window.save instanceof Function ? window.save : null;
  const _orig_format = window.format instanceof Function ? window.format : null;

  function formatFallback(n){
    if (typeof _orig_format === 'function') return _orig_format(n);
    if (n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
    if (n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
    return String(n);
  }

  function updCoinsPublic(v=0){
    if (typeof _orig_upd === 'function'){
      try{ _orig_upd(v); return; }catch(e){}
    }
    try{
      let cur = +localStorage.getItem('coins') || 0;
      cur += v;
      if(cur < 0) cur = 0;
      localStorage.setItem('coins', String(cur));
      const el = document.getElementById('coinsVal');
      if(el) el.textContent = formatFallback(cur);
      const tonEl = document.getElementById('tonVal');
      if(tonEl) {
        const ton = cur * 0.000002;
        tonEl.textContent = (ton < 0.000001 && ton > 0) ? '<0.000001' : Number(ton.toFixed(6)).toString();
      }
    }catch(e){}
  }

  function saveGameStatePublic(){
    if (typeof window.save === 'function'){
      try{ window.save(); return; }catch(e){} 
    }
    try{
      const coins = localStorage.getItem('coins') || '0';
      localStorage.setItem('coins', coins);
      safeSetJSON(LS_CLAIMED, claimed);
      localStorage.setItem(LS_FIRST, String(firstSeen));
    }catch(e){}
  }

  function claimRewardFromModalPublic(amount){
    if (typeof _orig_claim === 'function'){
      try{ _orig_claim(amount); saveGameStatePublic(); return; }catch(e){ }
    }
    try{
      if (typeof _orig_upd === 'function') {
        _orig_upd(amount);
      } else if (typeof window.updCoins === 'function') {
        window.updCoins(amount);
      } else {
        let cur = +localStorage.getItem('coins') || 0;
        cur += amount;
        localStorage.setItem('coins', String(cur));
        const cv = document.getElementById('coinsVal');
        if(cv) cv.textContent = formatFallback(cur);
        const tonEl = document.getElementById('tonVal');
        if(tonEl) { const ton = cur * 0.000002; tonEl.textContent = (ton < 0.000001 && ton > 0) ? '<0.000001' : Number(ton.toFixed(6)).toString(); }
      }
      saveGameStatePublic();
    }catch(e){}
  }

  window.claimRewardFromModal = window.claimRewardFromModal || claimRewardFromModalPublic;
  window.updCoins = window.updCoins || updCoinsPublic;
  window.saveGameState = window.saveGameState || saveGameStatePublic;
  window.format = window.format || formatFallback;

  const updCoins = window.updCoins;
  const claimRewardFromModal = window.claimRewardFromModal;
  const saveGameState = window.saveGameState;
  const formatNum = window.format;

  const overlay = document.getElementById('wsModalOverlay');
  const gridTop = document.getElementById('rewardsGridTop');
  const gridBottom = document.getElementById('rewardsGridBottom');
  const unlockedCountEl = document.getElementById('wsUnlockedCount');
  const coinsDisplayEl = document.getElementById('wsModalCoinsDisplay');
  const btnClose = document.getElementById('wsBtnClose');
  const btnRules = document.getElementById('wsBtnRules');

  const hiddenTargets = [];
  function hideMainUI(){
    const bodyChildren = Array.from(document.body.children);
    bodyChildren.forEach(ch=>{ if (ch === overlay) return; const prev = ch.style.display || ''; hiddenTargets.push({el: ch, prev}); ch.style.display = 'none'; });
    overlay.classList.remove('hidden');
  }
  function showMainUI(){
    hiddenTargets.forEach(item=>{ try{ item.el.style.display = item.prev || ''; }catch(e){} });
    hiddenTargets.length = 0;
    overlay.classList.add('hidden');
  }

  function renderCards(){
    claimed = safeGetJSON(LS_CLAIMED, claimed) || claimed;

    const avail = availableCount();
    gridTop.innerHTML = '';
    gridBottom.innerHTML = '';

    for(let i=0;i<MAX_DAYS;i++){
      const day = i+1;
      const amount = amounts[i] || 0;
      const card = document.createElement('div');
      card.className = 'rewardCard';
      if (day === 7) card.style.minHeight = '120px';

      card.innerHTML = `
        <div class="coinIconSmall">💰</div>
        <div class="dayLabel">Day ${day}</div>
        <div class="amount">${formatNum(amount)}</div>
      `;

      const isUnlocked = i < avail;
      const isClaimed = !!claimed[i];

      if(isClaimed){
        card.classList.add('claimed');
        const badge = document.createElement('div');
        badge.className = 'claimBadge';
        badge.textContent = 'Claimed';
        card.appendChild(badge);
      } else if(isUnlocked){
        card.classList.add('unlocked');
      } else {
        card.classList.add('locked');
        const overlayEl = document.createElement('div');
        overlayEl.className = 'overlay';
        overlayEl.textContent = '';
        card.appendChild(overlayEl);
      }

      card.addEventListener('click', function onCardClick(){
        claimed = safeGetJSON(LS_CLAIMED, claimed) || claimed;
        const nowClaimed = !!claimed[i];
        const nowAvail = i < availableCount();
        if (!nowAvail || nowClaimed) return;

        card.style.pointerEvents = 'none';
        card.classList.add('pop');
        setTimeout(()=>card.classList.remove('pop'),260);

        claimed[i] = true;
        safeSetJSON(LS_CLAIMED, claimed);

        try {
          if (typeof claimRewardFromModal === 'function') {
            claimRewardFromModal(amounts[i]);
          } else if (typeof updCoins === 'function') {
            updCoins(amounts[i]);
          } else {
            let cur = +localStorage.getItem('coins') || 0;
            cur += amounts[i];
            localStorage.setItem('coins', String(cur));
            const mainEl = document.getElementById('coinsVal');
            if (mainEl) mainEl.textContent = formatNum(cur);
          }
          saveGameStatePublic();
        } catch(e){
          console.error('claimReward error', e);
          try { updCoinsPublic(amounts[i]); } catch(e2){}
        }

        const badge = document.createElement('div');
        badge.className = 'claimBadge';
        badge.textContent = 'Claimed';
        card.appendChild(badge);
        card.classList.remove('unlocked');
        card.classList.add('claimed');
        card.style.pointerEvents = 'none';

        syncCoinsDisplay();
        renderUnlockedCount();
      });

      if(i < 4) gridTop.appendChild(card);
      else gridBottom.appendChild(card);
    }

    renderUnlockedCount();
  }

  function renderUnlockedCount(){
    const avail = availableCount();
    const unlockedNow = Math.min(avail, MAX_DAYS);
    unlockedCountEl.textContent = String(unlockedNow);
  }

  function syncCoinsDisplay(){
    const coins = +localStorage.getItem('coins') || 0;
    const ton = coins * 0.000002;
    coinsDisplayEl.textContent = formatNum(coins) + ' ZEX • ' + (ton < 0.000001 && ton > 0 ? '<0.000001' : Number(ton.toFixed(6)).toString()) + ' TON';
    const mainEl = document.getElementById('coinsVal');
    if (mainEl) mainEl.textContent = formatNum(coins);
    const tonEl = document.getElementById('tonVal');
    if (tonEl) tonEl.textContent = (ton < 0.000001 && ton > 0) ? '<0.000001' : Number(ton.toFixed(6)).toString();
  }

  btnClose.addEventListener('click', function(){
    showMainUI();
    saveGameState();
  });

  btnRules.addEventListener('click', function(){
    alert('Rewards unlock one per day since first visit. Click an unlocked card to claim its coins.');
  });

  hideMainUI();
  renderCards();
  syncCoinsDisplay();

  setInterval(()=>{ renderCards(); syncCoinsDisplay(); }, 60*1000);

  window._wsModal = {
    open: function(){ hideMainUI(); renderCards(); syncCoinsDisplay(); },
    close: function(){ showMainUI(); saveGameState(); },
    getState: function(){ return { firstSeen, claimed: claimed.slice(), available: availableCount() }; },
    forceResetClaims: function(){ claimed = new Array(MAX_DAYS).fill(false); safeSetJSON(LS_CLAIMED,claimed); renderCards(); }
  };

  overlay.tabIndex = -1;
})();
</script>

<!-- Casino modal & logic (unchanged core logic) -->
<div id="casinoModal" class="casino-modal" aria-hidden="true" role="dialog" aria-label="Casino wheel">
  <div class="card" role="document">
    <div class="casino-header">
      <div>
        <div style="font-size:20px;font-weight:900">🎰 Casino</div>
        <div style="color:var(--muted);font-weight:700">Spin the wheel — once every 2 hours</div>
      </div>
      <div id="casinoBalance" style="text-align:right;font-weight:800;color:var(--profit-green)">0 ZEX • 0 TON</div>
    </div>
    <div class="casino-body">
      <div class="wheel-wrap">
        <canvas id="wheelCanvas" width="800" height="800" aria-hidden="false"></canvas>
        <div class="wheel-pointer" aria-hidden="true"></div>
      </div>
      <div class="casino-controls">
        <div class="casino-note">Next spin in: <span id="casinoCooldown">Ready</span></div>
        <button id="spinBtn" class="spin-btn" style="background:linear-gradient(90deg,var(--accent-gradient-a),var(--accent-gradient-b));color:#fff">SPIN</button>
        <div>Result: <span id="casinoResult" class="casino-result">—</span></div>
        <button id="closeCasino" class="btnGhost" style="padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const casinoBtn = document.getElementById('casinoBtn');
  const casinoModal = document.getElementById('casinoModal');
  const closeCasino = document.getElementById('closeCasino');
  const spinBtn = document.getElementById('spinBtn');
  const casinoCooldownEl = document.getElementById('casinoCooldown');
  const casinoResultEl = document.getElementById('casinoResult');
  const casinoBalanceEl = document.getElementById('casinoBalance');
  const wheelCanvas = document.getElementById('wheelCanvas');
  const ctx = wheelCanvas.getContext('2d');

  const segments = [
    { label: '100K ZEX', type: 'zex', value: 100000 },
    { label: '0.1 TON', type: 'ton', value: 0.1 },
    { label: '5K ZEX', type: 'zex', value: 5000 },
    { label: '0.5 TON', type: 'ton', value: 0.5 },
    { label: '10K ZEX', type: 'zex', value: 10000 },
    { label: '1 TON', type: 'ton', value: 1 },
    { label: '50K ZEX', type: 'zex', value: 50000 },
    { label: '0.2 TON', type: 'ton', value: 0.2 },
    { label: '1K ZEX', type: 'zex', value: 1000 },
    { label: '2 TON', type: 'ton', value: 2 }
  ];

  const SEG_COUNT = segments.length;
  const TON_TO_ZEX = 1000 / 0.002; // 1 TON = 500000 ZEX
  const COOL_KEY = 'casino_last_spin_v2';
  const COOLDOWN_MS = 2 * 60 * 60 * 1000;

  let rotation = 0;
  let isSpinning = false;

  function drawWheel(){
    const w = wheelCanvas.width;
    const h = wheelCanvas.height;
    const cx = w/2;
    const cy = h/2;
    const radius = Math.min(cx,cy) - 8;
    ctx.clearRect(0,0,w,h);
    const anglePer = 2*Math.PI / SEG_COUNT;
    for(let i=0;i<SEG_COUNT;i++){
      const start = i*anglePer - Math.PI/2;
      const end = start + anglePer;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,radius,start,end);
      ctx.closePath();
      ctx.fillStyle = (i%2===0) ? 'rgba(255,255,255,0.03)' : 'rgba(255,255,255,0.01)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,0.06)';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.save();
      const textAngle = start + anglePer/2;
      ctx.translate(cx + Math.cos(textAngle)*(radius*0.66), cy + Math.sin(textAngle)*(radius*0.66));
      ctx.rotate(textAngle + Math.PI/2);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 20px Inter, system-ui, Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const label = segments[i].label;
      ctx.fillText(label, 0, 0);
      ctx.restore();
    }

    ctx.beginPath();
    ctx.arc(cx,cy,60,0,2*Math.PI);
    ctx.fillStyle = 'rgba(0,0,0,0.12)';
    ctx.fill();
    ctx.strokeStyle = 'rgba(0,0,0,0.06)';
    ctx.stroke();
  }

  function render(){
    wheelCanvas.style.transform = `rotate(${rotation}deg)`;
  }

  function getRandomSegmentIndex(){
    return Math.floor(Math.random()*SEG_COUNT);
  }

  function angleForIndex(i){
    const anglePerDeg = 360 / SEG_COUNT;
    const center = i * anglePerDeg + anglePerDeg/2;
    return (360 - center) % 360;
  }

  function spinToIndex(i){
    if (isSpinning) return;
    isSpinning = true;
    spinBtn.disabled = true;
    const baseSpins = 6;
    const targetAngle = angleForIndex(i);
    const randomOffset = (Math.random()*15) - 7.5;
    const finalAngle = baseSpins*360 + targetAngle + randomOffset;
    const duration = 5000 + Math.random()*1000;
    const start = performance.now();
    const from = rotation % 360;
    const to = rotation + finalAngle;
    function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }
    function step(now){
      const elapsed = now - start;
      const p = Math.min(1, elapsed / duration);
      const eased = easeOutCubic(p);
      rotation = from + (to - from) * eased;
      render();
      if(p < 1) requestAnimationFrame(step);
      else {
        isSpinning = false;
        spinBtn.disabled = false;
        const landed = ((360 - (rotation % 360)) + 360) % 360;
        const anglePerDeg = 360 / SEG_COUNT;
        let idx = Math.floor((landed) / anglePerDeg);
        idx = (idx + SEG_COUNT) % SEG_COUNT;
        announcePrize(idx);
      }
    }
    requestAnimationFrame(step);
  }

  function announcePrize(idx){
    const seg = segments[idx];
    if(!seg) return;
    let text = '';
    if(seg.type === 'zex'){
      const amount = Math.round(seg.value);
      try{
        if(typeof window.updCoins === 'function') window.updCoins(amount);
        else updCoinsPublic(amount);
      }catch(e){ updCoinsPublic(amount); }
      text = `+${format(amount)} ZEX`;
    } else {
      const tonAmount = seg.value;
      const zexAmount = Math.round(tonAmount * TON_TO_ZEX);
      try{
        if(typeof window.updCoins === 'function') window.updCoins(zexAmount);
        else updCoinsPublic(zexAmount);
      }catch(e){ updCoinsPublic(zexAmount); }
      text = `+${tonAmount} TON (~${format(zexAmount)} ZEX)`;
    }
    casinoResultEl.textContent = text;
    updateCasinoBalanceDisplay();
    localStorage.setItem(COOL_KEY, String(Date.now()));
    updateCooldownDisplay();
  }

  function updateCasinoBalanceDisplay(){
    const c = +localStorage.getItem('coins') || 0;
    const ton = c * 0.000002;
    casinoBalanceEl.textContent = format(c) + ' ZEX • ' + (ton < 0.000001 && ton > 0 ? '<0.000001' : Number(ton.toFixed(6)).toString()) + ' TON';
    const mainEl = document.getElementById('coinsVal');
    if(mainEl) mainEl.textContent = format(c);
    const tonEl = document.getElementById('tonVal');
    if(tonEl) tonEl.textContent = (ton < 0.000001 && ton > 0) ? '<0.000001' : Number(ton.toFixed(6)).toString();
  }

  function updateCooldownDisplay(){
    const last = +localStorage.getItem(COOL_KEY) || 0;
    const now = Date.now();
    const diff = now - last;
    if(last === 0 || diff >= COOLDOWN_MS){
      casinoCooldownEl.textContent = 'Ready';
      spinBtn.disabled = false;
    } else {
      const rem = COOLDOWN_MS - diff;
      const hours = Math.floor(rem / (1000*60*60));
      const minutes = Math.floor((rem % (1000*60*60)) / (1000*60));
      const seconds = Math.floor((rem % (1000*60)) / 1000);
      casinoCooldownEl.textContent = `${hours}h ${minutes}m ${seconds}s`;
      spinBtn.disabled = true;
    }
  }

  casinoBtn.addEventListener('click', ()=>{
    casinoModal.style.display = 'flex';
    casinoModal.setAttribute('aria-hidden','false');
    updateCasinoBalanceDisplay();
    updateCooldownDisplay();
  });
  closeCasino.addEventListener('click', ()=>{
    casinoModal.style.display = 'none';
    casinoModal.setAttribute('aria-hidden','true');
  });

  spinBtn.addEventListener('click', ()=>{
    const last = +localStorage.getItem(COOL_KEY) || 0;
    const now = Date.now();
    if(last && now - last < COOLDOWN_MS){
      updateCooldownDisplay();
      return;
    }
    const idx = getRandomSegmentIndex();
    spinToIndex(idx);
  });

  drawWheel();
  render();
  setInterval(updateCooldownDisplay, 1000);

  function format(n){
    if(n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
    if(n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
    if(n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
    return String(n);
  }

  window._casino = {
    open: ()=>{ casinoModal.style.display = 'flex'; casinoModal.setAttribute('aria-hidden','false'); updateCasinoBalanceDisplay(); updateCooldownDisplay(); },
    close: ()=>{ casinoModal.style.display = 'none'; casinoModal.setAttribute('aria-hidden','true'); },
    lastSpin: ()=>+localStorage.getItem(COOL_KEY) || 0
  };
})();
</script>

</body>
</html>
