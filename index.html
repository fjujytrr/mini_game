<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hide & Seek ‚Äî Premium Plus (Enhanced)</title>
  <meta name="description" content="Enhanced Hide & Seek game ‚Äî coins, gems, miners, arena battles, rewards, achievements. Single-file HTML/CSS/JS." />
  <style>
:root{
  --accent-cyan:#00D8FF;
  --birch:#EDE4C8;
  --purple-frame:#7a4bff;
  --deep-purple:#5a2ecc;
  --glass:rgba(255,255,255,0.06);
  --bg-a:#3b2a7a;
  --bg-b:#8aa7ff;
}
/* ---------- Base & animated gradient ---------- */
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(120deg,var(--bg-a),var(--bg-b));background-size:200% 200%;animation:gradientBG 18s ease infinite;color:#fff}
@keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
body{display:flex;flex-direction:column;align-items:center;min-height:100vh}
.container{width:100%;max-width:1100px;margin:18px;padding-bottom:80px}
header{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(0,0,0,0.22);border-radius:12px}
.header-left{display:flex;align-items:center;gap:12px}
.brand{display:flex;gap:10px;align-items:center}
.brand .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accent-cyan),#00A8FF);display:flex;align-items:center;justify-content:center;color:#000;font-weight:900;font-size:20px;box-shadow:0 8px 28px rgba(0,216,255,0.12)}
.brand h1{margin:0;font-size:18px}
.level-bar{display:flex;gap:6px;background:rgba(0,0,0,0.16);padding:6px 10px;border-radius:12px;align-items:center}
.level{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);font-weight:700;color:#eee;cursor:pointer}
.level.active{background:var(--accent-cyan);color:#000;box-shadow:0 0 8px var(--accent-cyan)}
.coin-panel{display:flex;align-items:center;gap:10px;background:rgba(0,0,0,0.28);padding:8px 12px;border-radius:16px}
.coin-logo{width:44px;height:44px;border-radius:10px;object-fit:cover;border:3px solid var(--purple-frame);background:#fff}
.vals{display:flex;gap:12px;align-items:center}
.vals .val{font-weight:800;color:var(--accent-cyan)}
.main-grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:18px}
.left-col{display:flex;flex-direction:column;gap:14px}
/* ---------- House grid (rooms) ---------- */
.house{position:relative;width:100%;max-width:680px;margin:0 auto;display:grid;grid-template-columns:repeat(4,1fr);grid-auto-rows:120px;gap:12px}
.room{background:rgba(255,255,255,0.04);border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:#fff;cursor:pointer;transition:transform .25s,box-shadow .25s,filter .25s;position:relative;border:2px solid rgba(255,255,255,0.08)}
.room:hover{transform:translateY(-6px);filter:brightness(1.06)}
.room.selected{border-color:var(--accent-cyan);box-shadow:0 12px 40px rgba(0,216,255,0.10)}
.room.found{border-color:#FF0054;box-shadow:0 10px 30px rgba(255,16,78,0.08);animation:foundAnim 1s ease}
.room.safe{border-color:#39FF14;box-shadow:0 10px 30px rgba(57,255,20,0.06);animation:safeAnim .8s ease}
.room .mini{position:absolute;left:8px;top:8px;font-size:12px;background:rgba(0,0,0,0.28);padding:6px;border-radius:8px}
@keyframes foundAnim{0%{transform:scale(1)}50%{transform:rotate(8deg) scale(1.06)}100%{transform:scale(1)}}
@keyframes safeAnim{0%{transform:scale(1)}50%{transform:rotate(-8deg) scale(0.96)}100%{transform:scale(1)}}
/* ---------- Controls ---------- */
.controls{display:flex;gap:8px}
.controls button{flex:1;padding:12px;border-radius:12px;border:none;font-weight:800;cursor:pointer}
.btn-Primary{background:linear-gradient(90deg,var(--accent-cyan),#00A8FF);color:#000}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
/* ---------- Right sidebar ---------- */
.sidebar{background:rgba(0,0,0,0.18);padding:12px;border-radius:12px;display:flex;flex-direction:column;gap:12px}
.upgrade-panel{display:flex;flex-direction:column;gap:10px;max-height:360px;overflow:auto;padding-right:6px}
.upgrade{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);cursor:pointer}
.upgrade h3{margin:0;font-size:14px;color:var(--accent-cyan)}
.upgrade p{margin:0;font-size:12px;color:#ddd}
/* ---------- Miners list compact ---------- */
.miners-list{display:flex;flex-direction:column;gap:8px;max-height:180px;overflow:auto}
.miner{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:rgba(0,0,0,0.06)}
.miner .meta{font-weight:700}
/* ---------- Reward modal styles preserved (kept compatible) ---------- */
#wsModalOverlay{position:fixed;inset:0;display:flex;align-items:flex-end;justify-content:center}
#wsModalOverlay.hidden{display:none}
#wsModalOverlay .glass{width:100%;max-width:980px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:18px;padding:18px;color:#fff}
/* ---------- Arena (Hamster Kombat inspired) ---------- */
.arena{background:linear-gradient(180deg,rgba(0,0,0,0.18),rgba(255,255,255,0.02));padding:12px;border-radius:12px;display:flex;flex-direction:column;gap:8px}
.arena .fighters{display:flex;gap:10px;align-items:center;justify-content:space-between}
.fighter{flex:1;background:rgba(255,255,255,0.03);border-radius:12px;padding:8px;text-align:center}
.fighter .avatar{width:96px;height:96px;border-radius:14px;margin:6px auto;background:linear-gradient(90deg,#fff3,#fff3);display:flex;align-items:center;justify-content:center;font-size:36px;color:#000}
.progress-bar{height:10px;background:rgba(0,0,0,0.12);border-radius:999px;overflow:hidden}
.progress{height:100%;background:linear-gradient(90deg,#FFD54A,#FFC107);width:0%}
/* ---------- Achievements & leaderboard ---------- */
.panel{padding:12px;border-radius:12px;background:rgba(0,0,0,0.06);border:1px solid rgba(255,255,255,0.03)}
.ach-list{display:flex;flex-direction:column;gap:6px}
.ach{display:flex;gap:8px;align-items:center}
.leaderboard{display:flex;flex-direction:column;gap:8px}
/* ---------- Particles canvas (background sparkle) ---------- */
#fxCanvas{position:fixed;left:0;top:0;pointer-events:none;z-index:1}
/* ---------- Responsive ---------- */
@media (max-width:980px){
  .main-grid{grid-template-columns:1fr;}
  .sidebar{order:2}
}
  </style>
</head>
<body>
  <div id="fxCanvasWrap"><canvas id="fxCanvas"></canvas></div>
  <div class="container">
    <header>
      <div class="header-left">
        <div class="brand">
          <div class="logo">HS+</div>
          <div>
            <h1>Hide & Seek ‚Äî Premium Plus</h1>
            <div style="font-size:12px;color:var(--birch);">Keep the design ‚Äî but add depth, fun & battles</div>
          </div>
        </div>
        <div class="level-bar" id="levelBar"></div>
      </div>
      <div class="coin-panel">
        <img class="coin-logo" src="logo.png" alt="logo"/>
        <div class="vals">
          <div class="val">Coins: <span id="coinsVal">0</span></div>
          <div class="val">Gems: <span id="gemsVal">0</span></div>
        </div>
      </div>
    </header>

    <div class="main-grid">
      <div class="left-col">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div style="font-weight:900;font-size:16px">Your House</div>
            <div class="controls" style="width:360px">
              <button id="startBtn" class="btn-Primary">üè† Start</button>
              <button id="resetBtn" class="btn-ghost">üîç Hunt</button>
              <button id="arenaBtn" class="btn-ghost">‚öîÔ∏è Arena</button>
            </div>
          </div>
          <div class="house" id="house"></div>
        </div>

        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900">Miners & Income</div><div id="miningLabel">Mining Income: <span id="miningIncomeVal">0</span>/hr</div></div>
          <div class="miners-list" id="minersList"></div>
        </div>

        <div class="panel arena" id="arenaPanel" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>Arena ‚Äî Hamster Kombat</strong><div><button id="closeArena" class="btn-ghost">Close</button></div></div>
          <div class="fighters">
            <div class="fighter" id="fighterA">
              <div class="name">You</div>
              <div class="avatar" id="avatarA">üêπ</div>
              <div class="hp">HP <span id="hpA">100</span></div>
              <div class="progress-bar"><div class="progress" id="barA"></div></div>
            </div>
            <div style="width:12px"></div>
            <div class="fighter" id="fighterB">
              <div class="name">Opponent</div>
              <div class="avatar" id="avatarB">ü¶ù</div>
              <div class="hp">HP <span id="hpB">100</span></div>
              <div class="progress-bar"><div class="progress" id="barB"></div></div>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px"><button id="startFight" class="btn-Primary">Begin Fight</button><button id="autoFight" class="btn-ghost">Auto</button><div style="flex:1"></div><div id="fightLog" style="font-size:13px;color:var(--birch)"></div></div>
        </div>

      </div>

      <aside class="sidebar">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900">Upgrades</div><div style="font-size:12px;color:var(--birch)" id="boostLabel">Active boosts: 0</div></div>
          <div class="upgrade-panel" id="upgradePanel"></div>
        </div>

        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900">Rewards</div><div id="streak" style="font-size:12px;color:var(--birch)">Streak: 0</div></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="openRewards" class="btn-Primary" style="flex:1">Daily</button>
            <button id="openShop" class="btn-ghost" style="flex:1">Shop</button>
          </div>
        </div>

        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900">Achievements</div><div id="achCount" style="font-size:12px;color:var(--birch)">0</div></div>
          <div class="ach-list" id="achList"></div>
        </div>

        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900">Leaderboard (local)</div><button id="resetLeaderboard" class="btn-ghost">Reset</button></div>
          <div class="leaderboard" id="leaderboard"></div>
        </div>
      </aside>
    </div>

  </div>

  <!-- Reward Modal (keeps ws modal API compatibility) -->
  <div id="wsModalOverlay" class="hidden" role="dialog" aria-label="Daily rewards modal">
    <div class="glass">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">Premium Gifts</div>
        <div>Coins: <span id="wsModalCoinsDisplay">0</span></div>
      </div>
      <div style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px" id="wsGrid"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="wsClose" class="btn-ghost">Close</button></div>
    </div>
  </div>

  <script>
/* =========================
   Enhanced game script
   - Preserves public API functions: updCoins, save, format
   - Adds: Gems currency, Arena mini-game, achievements, leaderboard, particles, auto-income
   - Designed as single-file, progressive enhancement
   =========================*/

// ---------- Utilities & safe wrappers ----------
function now(){return Date.now();}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

// number format utility compatible with original
function format(n){
  if (n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
  if (n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
  if (n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
  return String(n);
}

// ---------- State ----------
let coins = +localStorage.getItem('coins') || 0;
let gems = +localStorage.getItem('gems') || 0;
let maxCoins = +localStorage.getItem('maxCoins') || coins;
let lang = localStorage.getItem('lang') || 'ru';

// upgrades state
let upgrades = JSON.parse(localStorage.getItem('upgrades')) || { x2Prize:0, check1:0, shield:0, incBoost:0, luck:0 };
let expires = JSON.parse(localStorage.getItem('expires')) || { check1:0, shield:0, inc:0, luck:0 };

// miners
const minersData = [
  {n:'Miner 1', i:500, p:7000}, {n:'Miner 2', i:1788, p:12000}, {n:'Miner 3', i:2358, p:15000},
  {n:'Miner 4', i:3000, p:20000}, {n:'Miner 5', i:4500, p:25000}, {n:'Miner 6', i:5200, p:30000}
];
let minersState = (function(){
  try{ const s = JSON.parse(localStorage.getItem('minersState')); if(Array.isArray(s) && s.length===minersData.length) return s; }catch(e){}
  return minersData.map(_=>({count:0}));
})();

// rooms & gameplay
const ROOM_COUNT = 8;
let selectedRoom = null; let roundInProgress=false;

// achievements & leaderboard
let achievements = JSON.parse(localStorage.getItem('achievements')) || {};
let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];

// reward modal state (compatible keys)
const LS_FIRST = 'ws_first_seen_v2';
const LS_CLAIMED = 'ws_claimed_v2';
const MAX_DAYS = 7;
let firstSeen = +localStorage.getItem(LS_FIRST) || 0; if(!firstSeen){ firstSeen = Date.now(); localStorage.setItem(LS_FIRST,String(firstSeen)); }
let claimed = (function(){try{const c=JSON.parse(localStorage.getItem(LS_CLAIMED));if(Array.isArray(c) && c.length===MAX_DAYS) return c;}catch(e){}const a=new Array(MAX_DAYS).fill(false); localStorage.setItem(LS_CLAIMED,JSON.stringify(a)); return a; })();

// FX canvas
const fxCanvas = document.getElementById('fxCanvas'); const fxCtx = fxCanvas.getContext('2d');
function resizeFX(){ fxCanvas.width = window.innerWidth; fxCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeFX); resizeFX();
let particles = [];
function spawnParticle(x,y,dx,dy,life,sz){ particles.push({x,y,dx,dy,life,sz}); }
function stepParticles(dt){ particles = particles.filter(p=>p.life>0); particles.forEach(p=>{ p.x += p.dx*dt; p.y += p.dy*dt; p.life -= dt; }); }
function drawParticles(){ fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height); particles.forEach(p=>{ fxCtx.globalAlpha = clamp(p.life,0,1); fxCtx.fillStyle = 'rgba(255,255,255,0.9)'; fxCtx.beginPath(); fxCtx.arc(p.x,p.y,p.sz,0,Math.PI*2); fxCtx.fill(); }); fxCtx.globalAlpha=1; }
setInterval(()=>{ stepParticles(0.016); drawParticles(); }, 16);

// spawn subtle background particles
setInterval(()=>{ const x=Math.random()*fxCanvas.width; const y=20+Math.random()*fxCanvas.height*0.5; spawnParticle(x,y,(Math.random()-0.5)*0.3,0.1+Math.random()*0.2,1+Math.random()*1,1+Math.random()*2); }, 300);

// ---------- Save / public API ----------
function save(){ try{
  localStorage.setItem('coins', String(coins));
  localStorage.setItem('gems', String(gems));
  localStorage.setItem('maxCoins', String(maxCoins));
  localStorage.setItem('upgrades', JSON.stringify(upgrades));
  localStorage.setItem('expires', JSON.stringify(expires));
  localStorage.setItem('minersState', JSON.stringify(minersState));
  localStorage.setItem('achievements', JSON.stringify(achievements));
  localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
  localStorage.setItem(LS_CLAIMED, JSON.stringify(claimed));
  localStorage.setItem(LS_FIRST, String(firstSeen));
} catch(e){console.warn('save failed',e);} }

// updater (public) ‚Äî keep compatibility with page's code
function updCoins(v=0){ coins = Math.max(0, coins + v); if(coins > maxCoins) maxCoins = coins; renderCoins(); save(); }
window.updCoins = window.updCoins || updCoins;
window.save = window.save || save;
window.format = window.format || format;

function renderCoins(){ document.getElementById('coinsVal').textContent = format(coins); document.getElementById('gemsVal').textContent = format(gems); document.getElementById('wsModalCoinsDisplay').textContent = format(coins); }
renderCoins();

// ---------- Income calculation ----------
function minerIncomePerHour(){
  return minersState.reduce((s,m,i)=>{ const cnt = (m && typeof m.count==='number')?m.count:0; if(cnt<=0) return s; return s + Math.floor(minersData[i].i * Math.pow(1.5, cnt-1)); },0) * (expires.inc > Date.now()?2:1);
}
function updIncome(){ document.getElementById('miningIncomeVal').textContent = format(minerIncomePerHour()); }
updIncome();

// offline award similar to original
(function addOffline(){ const last = +localStorage.getItem('lastTime') || Date.now(); const nowt = Date.now(); const diffMinutes = Math.floor((nowt-last)/60000); if(diffMinutes>0){ const minutesToAward = Math.min(diffMinutes, 180); const amt = Math.floor(minerIncomePerHour()/60 * minutesToAward); if(amt>0) updCoins(amt); } localStorage.setItem('lastTime', String(nowt)); })();

// periodic income (every second small chunk)
setInterval(()=>{ const inc = Math.floor(minerIncomePerHour()/3600); if(inc>0) updCoins(inc); }, 1000);

// ---------- UI: build rooms ----------
const houseEl = document.getElementById('house');
for(let i=0;i<ROOM_COUNT;i++){ const d = document.createElement('div'); d.className = 'room'; d.dataset.idx = i; d.innerHTML = `<div class="mini">#${i+1}</div><div class="big">üëÄ</div>`; houseEl.appendChild(d);
  d.addEventListener('click', ()=>{ if(roundInProgress) return; document.querySelectorAll('.room').forEach(x=>x.classList.remove('selected')); d.classList.add('selected'); selectedRoom = i; }); }

// levels display
const levelBar = document.getElementById('levelBar'); [10000,100000,1000000,5000000,10000000].forEach(v=>{ const el=document.createElement('div'); el.className='level'; el.dataset.val=v; el.textContent = format(v); levelBar.appendChild(el); });
function updLv(){ document.querySelectorAll('.level').forEach(l=>l.classList.toggle('active', maxCoins >= +l.dataset.val)); }
updLv();

// ---------- Upgrades panel ----------
const upgradePanelEl = document.getElementById('upgradePanel');
const upgradeDefs = [
  {key:'x2Prize', title:'x2 Prize / Loss', desc:'Double reward & loss', base:20000},
  {key:'check1', title:'Check 1 Room', desc:'Hunter checks 1 room (1m)', base:20000},
  {key:'shield', title:'Shield (1m)', desc:'Prevent one loss', base:25000},
  {key:'inc', title:'Double Income (1m)', desc:'Income √ó2 for 1 minute', base:30000},
  {key:'luck', title:'Lucky Escape (1m)', desc:'50% evasion if hunted', base:22000}
];
function renderUpgrades(){ upgradePanelEl.innerHTML=''; upgradeDefs.forEach(u=>{ const el=document.createElement('div'); el.className='upgrade'; const count = upgrades[u.key]||0; const price = Math.floor(u.base*Math.pow(2,count)); el.innerHTML = `<div><h3>${u.title}</h3><p>${u.desc}</p></div><div style="text-align:right"><div style="font-weight:900">${format(price)}</div><div style="font-size:12px;color:var(--birch)">Lvl ${count}</div></div>`; el.addEventListener('click', ()=>{ if(coins < price){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!'); return;} upgrades[u.key]=(upgrades[u.key]||0)+1; coins -= price; // apply duration upgrades
        if(u.key==='check1') expires.check1 = Date.now()+60000;
        if(u.key==='shield') expires.shield = Date.now()+60000;
        if(u.key==='inc') expires.inc = Date.now()+60000;
        if(u.key==='luck') expires.luck = Date.now()+60000;
        updCoins(0); renderUpgrades(); }); upgradePanelEl.appendChild(el); }); }
renderUpgrades();

// ---------- Miners list ----------
const minersListEl = document.getElementById('minersList');
function renderMiners(){ minersListEl.innerHTML=''; minersData.forEach((m,i)=>{ const st = minersState[i]||{count:0}; const price = Math.floor(m.p*Math.pow(2,st.count)); const income = st.count>0?Math.floor(m.i*Math.pow(1.5,st.count-1)):0; const el = document.createElement('div'); el.className='miner'; el.innerHTML = `<div><div style="font-weight:900">${m.n}</div><div style="font-size:12px;color:var(--birch)">+${format(income)}/hr</div></div><div style="text-align:right"><div style="font-weight:900">Lvl ${st.count}</div><div style="font-size:12px">${format(price)}</div></div>`; el.addEventListener('click', ()=>{ if(coins < price){ alert('Not enough'); return;} coins -= price; minersState[i].count = (minersState[i].count||0)+1; updCoins(0); renderMiners(); updIncome(); }); minersListEl.appendChild(el); }); }
renderMiners();

// ---------- Hunt / game round ----------
const startBtn = document.getElementById('startBtn'); const resetBtn = document.getElementById('resetBtn');
startBtn.addEventListener('click', ()=>{ if(selectedRoom==null){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É!'); return;} document.querySelectorAll('.room').forEach(r=>r.classList.remove('found','safe')); spawnParticle(200+Math.random()*400,200, (Math.random()-0.5)*2, -2,1,4); });
resetBtn.addEventListener('click', ()=>{
  if(selectedRoom==null){ alert('Pick a room first!'); return; }
  roundInProgress = true;
  const numPicks = (expires.check1 > Date.now()) ? 1 : 2;
  let picks = [...Array(ROOM_COUNT).keys()].sort(()=>0.5-Math.random()).slice(0,numPicks);
  document.querySelectorAll('.room').forEach(r=>r.classList.remove('found','safe','selected'));
  // animate highlights
  let delay=0; picks.forEach(i=>{ setTimeout(()=>{ const room = document.querySelector(`.room[data-idx='${i}']`); room.classList.add('selected'); setTimeout(()=>room.classList.remove('selected'),600); }, delay); delay+=600; });
  setTimeout(()=>{
    // prize & loss base
    let prize = 1000, loss = -2000;
    if(upgrades.x2Prize>0) { prize *= Math.pow(2, upgrades.x2Prize); loss *= Math.pow(2, upgrades.x2Prize); }
    const roomEl = document.querySelector(`.room[data-idx='${selectedRoom}']`);
    let applied = false;
    if(picks.includes(selectedRoom)){
      if(expires.shield > Date.now()){
        roomEl.classList.add('safe'); spawnParticle(roomEl.offsetLeft+30, roomEl.offsetTop+20, 0, -1,1.4,3); // shield
      } else if(expires.luck > Date.now() && Math.random()<0.5){
        roomEl.classList.add('safe'); updCoins(prize); applied=true; spawnParticle(roomEl.offsetLeft+30, roomEl.offsetTop+20, 0, -2,1.5,4);
      } else {
        roomEl.classList.add('found'); updCoins(loss); applied=true;
      }
    } else {
      roomEl.classList.add('safe'); updCoins(prize); applied=true;
    }
    // achievement: first win
    if(applied && (!achievements.firstWin)){
      achievements.firstWin = {when:Date.now(), note:'First successful outcome'}; spawnParticle(100,100,1,-1,1.8,5); document.getElementById('achCount').textContent = Object.keys(achievements).length; save(); renderAchievements(); }
    selectedRoom = null; roundInProgress=false; renderCoins(); }, delay+400);
});

// ---------- Reward modal (keeps API) ----------
const wsOverlay = document.getElementById('wsModalOverlay'); const wsGrid = document.getElementById('wsGrid'); const wsClose = document.getElementById('wsClose');
function daysSinceFirst(){ return Math.floor((Date.now() - firstSeen)/(24*60*60*1000)); }
function availableCount(){ return Math.min(MAX_DAYS, daysSinceFirst()+1); }
function renderWS(){ wsGrid.innerHTML=''; const avail = availableCount(); for(let i=0;i<MAX_DAYS;i++){ const day=i+1; const amt=[30000,100000,500000,1000000,3000000,6000000,10000000][i]||0; const card=document.createElement('div'); card.style.padding='12px'; card.style.borderRadius='10px'; card.style.background='rgba(255,255,255,0.02)'; card.innerHTML = `<div style="font-weight:900">Day ${day}</div><div style="font-size:13px">${format(amt)}</div>`; if(claimed[i]){ card.style.opacity=0.6; card.innerHTML += `<div style="font-size:12px;color:var(--birch)">Claimed</div>`; } else if(i<avail){ card.style.cursor='pointer'; card.addEventListener('click', ()=>{ claimed[i]=true; try{ // prefer public API
      if(typeof window.claimRewardFromModal === 'function') window.claimRewardFromModal(amt); else if(typeof updCoins==='function') updCoins(amt); else { coins += amt; renderCoins(); }
    }catch(e){} save(); renderWS(); }); } else { card.style.opacity=0.36; card.innerHTML += `<div style="font-size:12px;color:var(--birch)">Locked</div>`; } wsGrid.appendChild(card); }
}
wsClose.addEventListener('click', ()=>{ wsOverlay.classList.add('hidden'); save(); });

// open handler
document.getElementById('openRewards').addEventListener('click', ()=>{ wsOverlay.classList.remove('hidden'); renderWS(); });

// ---------- Achievements ----------
function renderAchievements(){ const el = document.getElementById('achList'); el.innerHTML=''; Object.keys(achievements).forEach(k=>{ const v=achievements[k]; const row = document.createElement('div'); row.className='ach'; row.innerHTML = `<div style="width:36px;height:36px;border-radius:8px;background:#FFD54A;color:#000;display:flex;align-items:center;justify-content:center;font-weight:900">üèÜ</div><div><div style="font-weight:800">${k}</div><div style="font-size:12px;color:var(--birch)">${new Date(v.when).toLocaleString()}</div></div>`; el.appendChild(row); }); document.getElementById('achCount').textContent = Object.keys(achievements).length; }
renderAchievements();

// ---------- Leaderboard ----------
function renderLeaderboard(){ const el = document.getElementById('leaderboard'); el.innerHTML=''; leaderboard.slice(0,8).forEach((r,i)=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.fontWeight='700'; row.innerHTML = `<div>${i+1}. ${r.name}</div><div>${format(r.score)}</div>`; el.appendChild(row); }); }
renderLeaderboard();

document.getElementById('resetLeaderboard').addEventListener('click', ()=>{ leaderboard=[]; save(); renderLeaderboard(); });

// ---------- Arena (Hamster Kombat inspired) ----------
const arenaPanel = document.getElementById('arenaPanel'); const arenaBtn = document.getElementById('arenaBtn'); const closeArena = document.getElementById('closeArena'); const startFightBtn = document.getElementById('startFight'); const autoFightBtn = document.getElementById('autoFight');
const hpAel = document.getElementById('hpA'); const hpBel = document.getElementById('hpB'); const barA = document.getElementById('barA'); const barB = document.getElementById('barB'); const fightLog = document.getElementById('fightLog');
let fightState = null; function newFight(){ fightState = {hpA:100, hpB:100, atkA:10+Math.floor(Math.random()*8), defA:5+Math.floor(Math.random()*4), atkB:8+Math.floor(Math.random()*10), defB:4+Math.floor(Math.random()*5), log:[]}; updateFightUI(); }
function updateFightUI(){ hpAel.textContent = fightState.hpA; hpBel.textContent = fightState.hpB; barA.style.width = fightState.hpA+'%'; barB.style.width = fightState.hpB+'%'; fightLog.textContent = fightState.log.slice(-4).join('\n'); }
function fightStep(){ if(!fightState) return; const hitA = Math.max(0, fightState.atkA - fightState.defB + Math.floor((Math.random()-0.5)*10)); const hitB = Math.max(0, fightState.atkB - fightState.defA + Math.floor((Math.random()-0.5)*10)); fightState.hpB = Math.max(0, fightState.hpB - hitA); fightState.log.push(`You hit ${hitA}`); spawnParticle( Math.random()*600, Math.random()*200+200, (Math.random()-0.5)*4, -2,1,3 ); if(fightState.hpB<=0){ fightState.log.push('Opponent defeated'); updCoins( Math.floor(500 + Math.random()*1500) ); achievements.arenaWins = achievements.arenaWins? achievements.arenaWins+1:1; save(); renderAchievements(); updateLeaderboardEntry(); newFight(); return; } fightState.hpA = Math.max(0, fightState.hpA - hitB); fightState.log.push(`You took ${hitB}`); if(fightState.hpA<=0){ fightState.log.push('You were defeated'); // consolation gems
      gems += Math.floor(1+Math.random()*4); save(); renderCoins(); newFight(); return; } updateFightUI(); }

arenaBtn.addEventListener('click', ()=>{ arenaPanel.style.display = 'block'; newFight(); }); closeArena.addEventListener('click', ()=>{ arenaPanel.style.display = 'none'; save(); });
startFightBtn.addEventListener('click', ()=>{ fightStep(); });
let autoInterval = null; autoFightBtn.addEventListener('click', ()=>{ if(autoInterval){ clearInterval(autoInterval); autoInterval=null; autoFightBtn.textContent='Auto'; } else { autoInterval = setInterval(()=>fightStep(), 900); autoFightBtn.textContent='Stop'; } });

// ---------- Leaderboard helper ----------
function updateLeaderboardEntry(){ const name = localStorage.getItem('playerName') || 'Player'; const score = coins; const idx = leaderboard.findIndex(r=>r.name===name); if(idx>=0){ leaderboard[idx].score = Math.max(leaderboard[idx].score, score); } else leaderboard.push({name,score}); leaderboard.sort((a,b)=>b.score-a.score); leaderboard = leaderboard.slice(0,30); save(); renderLeaderboard(); }

// ---------- UI init ----------
function initUI(){ renderCoins(); renderUpgrades(); renderMiners(); updIncome(); renderAchievements(); renderLeaderboard(); document.getElementById('streak').textContent = 'Streak: ' + (localStorage.getItem('streak')||0);
}
initUI();

// ---------- small helpers & bindings ----------
window.claimRewardFromModal = window.claimRewardFromModal || function(amount){ updCoins(amount); save(); };

// quick particle on clicks
document.body.addEventListener('click', (e)=>{ spawnParticle(e.clientX, e.clientY, (Math.random()-0.5)*2, -1-Math.random()*2, 0.8+Math.random()*0.6, 2+Math.random()*4); });

// autosave
setInterval(()=>{ save(); }, 5000);

// expose some debug functions
window._game = { state: ()=>({coins,gems,mines:minersState,upgrades,expires}), resetAll: ()=>{ localStorage.clear(); location.reload(); } };

// ensure canvas keeps size
resizeFX();

</script>
</body>
</html>
